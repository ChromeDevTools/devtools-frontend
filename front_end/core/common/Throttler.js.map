{
  "version": 3,
  "sources": ["../../../../../../front_end/core/common/Throttler.ts"],
  "sourcesContent": ["// Copyright 2014 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nexport class Throttler {\n  readonly #timeout: number;\n  #isRunningProcess: boolean;\n  #asSoonAsPossible: boolean;\n  #process: (() => (void|Promise<unknown>))|null;\n  #lastCompleteTime: number;\n  #scheduler = Promise.withResolvers<unknown>();\n  #processTimeout?: number;\n\n  constructor(timeout: number) {\n    this.#timeout = timeout;\n    this.#isRunningProcess = false;\n    this.#asSoonAsPossible = false;\n    this.#process = null;\n    this.#lastCompleteTime = 0;\n  }\n\n  #processCompleted(): void {\n    this.#lastCompleteTime = this.#getTime();\n    this.#isRunningProcess = false;\n    if (this.#process) {\n      this.#schedule(false);\n    }\n  }\n\n  get process(): (() => (void|Promise<unknown>))|null {\n    return this.#process;\n  }\n\n  get processCompleted(): Promise<unknown>|null {\n    return this.#process ? this.#scheduler.promise : null;\n  }\n\n  #onTimeout(): void {\n    this.#processTimeout = undefined;\n    this.#asSoonAsPossible = false;\n    this.#isRunningProcess = true;\n\n    void Promise.resolve()\n        .then(this.#process)\n        .catch(console.error.bind(console))\n        .then(this.#processCompleted.bind(this))\n        .then(this.#scheduler.resolve);\n    this.#scheduler = Promise.withResolvers();\n    this.#process = null;\n  }\n\n  async schedule(process: () => (void|Promise<unknown>), scheduling = Scheduling.DEFAULT): Promise<void> {\n    // Deliberately skip previous #process.\n    this.#process = process;\n\n    // Run the first scheduled task instantly.\n    const hasScheduledTasks = Boolean(this.#processTimeout) || this.#isRunningProcess;\n    const okToFire = this.#getTime() - this.#lastCompleteTime > this.#timeout;\n    const asSoonAsPossible = scheduling === Scheduling.AS_SOON_AS_POSSIBLE ||\n        (scheduling === Scheduling.DEFAULT && !hasScheduledTasks && okToFire);\n\n    const forceTimerUpdate = asSoonAsPossible && !this.#asSoonAsPossible;\n    this.#asSoonAsPossible = this.#asSoonAsPossible || asSoonAsPossible;\n\n    this.#schedule(forceTimerUpdate);\n\n    await this.#scheduler.promise;\n  }\n\n  #schedule(forceTimerUpdate: boolean): void {\n    if (this.#isRunningProcess) {\n      return;\n    }\n    if (this.#processTimeout && !forceTimerUpdate) {\n      return;\n    }\n\n    clearTimeout(this.#processTimeout);\n\n    const timeout = this.#asSoonAsPossible ? 0 : this.#timeout;\n    this.#processTimeout = window.setTimeout(this.#onTimeout.bind(this), timeout);\n  }\n\n  #getTime(): number {\n    return window.performance.now();\n  }\n}\n\nexport const enum Scheduling {\n  // If the throttler has run another task recently (i.e. time since the last run is less then the\n  // throttling delay), schedule the task to be run after the throttling delay. Otherwise scheule\n  // the task after the next tick.\n  DEFAULT = 'Default',\n  // Schedule the task to run at the next tick, even if the throttler has run another task recently.\n  AS_SOON_AS_POSSIBLE = 'AsSoonAsPossible',\n  // Schedule the task to run after the throttling delay, even if the throttler has not run any\n  // task recently.\n  DELAYED = 'Delayed',\n}\n"],
  "mappings": ";AAIO,aAAM,UAAU;AAAA,EACZ;AAAA,EACT;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA,aAAa,QAAQ,cAAuB;AAAA,EAC5C;AAAA,EAEA,YAAY,SAAiB;AAC3B,SAAK,WAAW;AAChB,SAAK,oBAAoB;AACzB,SAAK,oBAAoB;AACzB,SAAK,WAAW;AAChB,SAAK,oBAAoB;AAAA,EAC3B;AAAA,EAEA,oBAA0B;AACxB,SAAK,oBAAoB,KAAK,SAAS;AACvC,SAAK,oBAAoB;AACzB,QAAI,KAAK,UAAU;AACjB,WAAK,UAAU,KAAK;AAAA,IACtB;AAAA,EACF;AAAA,EAEA,IAAI,UAAgD;AAClD,WAAO,KAAK;AAAA,EACd;AAAA,EAEA,IAAI,mBAA0C;AAC5C,WAAO,KAAK,WAAW,KAAK,WAAW,UAAU;AAAA,EACnD;AAAA,EAEA,aAAmB;AACjB,SAAK,kBAAkB;AACvB,SAAK,oBAAoB;AACzB,SAAK,oBAAoB;AAEzB,SAAK,QAAQ,QAAQ,EAChB,KAAK,KAAK,QAAQ,EAClB,MAAM,QAAQ,MAAM,KAAK,OAAO,CAAC,EACjC,KAAK,KAAK,kBAAkB,KAAK,IAAI,CAAC,EACtC,KAAK,KAAK,WAAW,OAAO;AACjC,SAAK,aAAa,QAAQ,cAAc;AACxC,SAAK,WAAW;AAAA,EAClB;AAAA,EAEA,MAAM,SAAS,SAAwC,aAAa,yBAAmC;AAErG,SAAK,WAAW;AAGhB,UAAM,oBAAoB,QAAQ,KAAK,eAAe,KAAK,KAAK;AAChE,UAAM,WAAW,KAAK,SAAS,IAAI,KAAK,oBAAoB,KAAK;AACjE,UAAM,mBAAmB,eAAe,gDACnC,eAAe,2BAAsB,CAAC,qBAAqB;AAEhE,UAAM,mBAAmB,oBAAoB,CAAC,KAAK;AACnD,SAAK,oBAAoB,KAAK,qBAAqB;AAEnD,SAAK,UAAU,gBAAgB;AAE/B,UAAM,KAAK,WAAW;AAAA,EACxB;AAAA,EAEA,UAAU,kBAAiC;AACzC,QAAI,KAAK,mBAAmB;AAC1B;AAAA,IACF;AACA,QAAI,KAAK,mBAAmB,CAAC,kBAAkB;AAC7C;AAAA,IACF;AAEA,iBAAa,KAAK,eAAe;AAEjC,UAAM,UAAU,KAAK,oBAAoB,IAAI,KAAK;AAClD,SAAK,kBAAkB,OAAO,WAAW,KAAK,WAAW,KAAK,IAAI,GAAG,OAAO;AAAA,EAC9E;AAAA,EAEA,WAAmB;AACjB,WAAO,OAAO,YAAY,IAAI;AAAA,EAChC;AACF;AAEO,WAAW,aAAX,kBAAWA,gBAAX;AAIL,EAAAA,YAAA,aAAU;AAEV,EAAAA,YAAA,yBAAsB;AAGtB,EAAAA,YAAA,aAAU;AATM,SAAAA;AAAA,GAAA;",
  "names": ["Scheduling"]
}
