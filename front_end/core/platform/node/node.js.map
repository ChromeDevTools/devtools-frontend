{
  "version": 3,
  "sources": ["../../../../../../../front_end/core/platform/node/HostRuntime.ts"],
  "sourcesContent": ["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as WorkerThreads from 'node:worker_threads';\n\nimport type * as Api from '../api/api.js';\n\nclass NodeWorkerScope implements Api.HostRuntime.WorkerScope {\n  postMessage(message: unknown): void {\n    WorkerThreads.parentPort?.postMessage(message);\n  }\n\n  set onmessage(listener: (event: Api.HostRuntime.WorkerMessageEvent) => void) {\n    WorkerThreads.parentPort?.on('message', data => {\n      listener({data});\n    });\n  }\n}\n\nclass NodeWorker implements Api.HostRuntime.Worker {\n  readonly #workerPromise: Promise<WorkerThreads.Worker>;\n  #disposed = false;\n  #rejectWorkerPromise?: (error: Error) => void;\n\n  constructor(url: string) {\n    this.#workerPromise = new Promise((resolve, reject) => {\n      this.#rejectWorkerPromise = reject;\n      const worker = new WorkerThreads.Worker(new URL(url));\n      worker.once('message', (message: unknown) => {\n        if (message === 'workerReady') {\n          resolve(worker);\n        }\n      });\n      worker.on('error', reject);\n    });\n  }\n\n  postMessage(message: unknown): void {\n    void this.#workerPromise.then(worker => {\n      if (!this.#disposed) {\n        worker.postMessage(message);\n      }\n    });\n  }\n\n  dispose(): void {\n    this.#disposed = true;\n    void this.#workerPromise.then(worker => worker.terminate());\n  }\n\n  terminate(immediately?: boolean): void {\n    if (immediately) {\n      this.#rejectWorkerPromise?.(new Error('Worker terminated'));\n    }\n    this.dispose();\n  }\n\n  set onmessage(listener: (event: unknown) => void) {\n    void this.#workerPromise.then(worker => {\n      worker.on('message', data => {\n        if (!this.#disposed) {\n          listener({data});\n        }\n      });\n    });\n  }\n\n  set onerror(listener: (event: unknown) => void) {\n    void this.#workerPromise.then(worker => {\n      worker.on('error', (error: Error) => {\n        if (!this.#disposed) {\n          listener({type: 'error', ...error});\n        }\n      });\n    });\n  }\n}\n\nexport const HOST_RUNTIME: Api.HostRuntime.HostRuntime = {\n  createWorker(url: string): Api.HostRuntime.Worker {\n    return new NodeWorker(url);\n  },\n  workerScope: new NodeWorkerScope(),\n};\n"],
  "mappings": ";;;;;;;AAAA;;;;AAIA,YAAY,mBAAmB;AAI/B,IAAM,kBAAN,MAAqB;EACnB,YAAY,SAAgB;AAC1B,IAAc,0BAAY,YAAY,OAAO;EAC/C;EAEA,IAAI,UAAU,UAA6D;AACzE,IAAc,0BAAY,GAAG,WAAW,UAAO;AAC7C,eAAS,EAAC,KAAI,CAAC;IACjB,CAAC;EACH;;AAGF,IAAM,aAAN,MAAgB;EACL;EACT,YAAY;EACZ;EAEA,YAAY,KAAW;AACrB,SAAK,iBAAiB,IAAI,QAAQ,CAAC,SAAS,WAAU;AACpD,WAAK,uBAAuB;AAC5B,YAAM,SAAS,IAAkB,qBAAO,IAAI,IAAI,GAAG,CAAC;AACpD,aAAO,KAAK,WAAW,CAAC,YAAoB;AAC1C,YAAI,YAAY,eAAe;AAC7B,kBAAQ,MAAM;QAChB;MACF,CAAC;AACD,aAAO,GAAG,SAAS,MAAM;IAC3B,CAAC;EACH;EAEA,YAAY,SAAgB;AAC1B,SAAK,KAAK,eAAe,KAAK,YAAS;AACrC,UAAI,CAAC,KAAK,WAAW;AACnB,eAAO,YAAY,OAAO;MAC5B;IACF,CAAC;EACH;EAEA,UAAO;AACL,SAAK,YAAY;AACjB,SAAK,KAAK,eAAe,KAAK,YAAU,OAAO,UAAS,CAAE;EAC5D;EAEA,UAAU,aAAqB;AAC7B,QAAI,aAAa;AACf,WAAK,uBAAuB,IAAI,MAAM,mBAAmB,CAAC;IAC5D;AACA,SAAK,QAAO;EACd;EAEA,IAAI,UAAU,UAAkC;AAC9C,SAAK,KAAK,eAAe,KAAK,YAAS;AACrC,aAAO,GAAG,WAAW,UAAO;AAC1B,YAAI,CAAC,KAAK,WAAW;AACnB,mBAAS,EAAC,KAAI,CAAC;QACjB;MACF,CAAC;IACH,CAAC;EACH;EAEA,IAAI,QAAQ,UAAkC;AAC5C,SAAK,KAAK,eAAe,KAAK,YAAS;AACrC,aAAO,GAAG,SAAS,CAAC,UAAgB;AAClC,YAAI,CAAC,KAAK,WAAW;AACnB,mBAAS,EAAC,MAAM,SAAS,GAAG,MAAK,CAAC;QACpC;MACF,CAAC;IACH,CAAC;EACH;;AAGK,IAAM,eAA4C;EACvD,aAAa,KAAW;AACtB,WAAO,IAAI,WAAW,GAAG;EAC3B;EACA,aAAa,IAAI,gBAAe;;",
  "names": []
}
