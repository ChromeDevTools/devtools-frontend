{"version":3,"file":"DevToolsCDPConnection.js","sourceRoot":"","sources":["../../../../../../front_end/core/protocol_client/DevToolsCDPConnection.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport {\n  type CDPCommandRequest,\n  type CDPConnection,\n  type CDPConnectionObserver,\n  type CDPError,\n  CDPErrorStatus,\n  type CDPReceivableMessage,\n  type Command,\n  type CommandParams,\n  type CommandResult\n} from './CDPConnection.js';\nimport type {ConnectionTransport} from './ConnectionTransport.js';\nimport {InspectorBackend, type MessageError, type QualifiedName, test} from './InspectorBackend.js';\n\ninterface CallbackWithDebugInfo {\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\n  resolve: (response: {result: CommandResult<any>}|{error: CDPError}) => void;\n  method: string;\n  sessionId: string|undefined;\n}\n\ntype Callback = (error: MessageError|null, arg1: Object|null) => void;\n\nconst LongPollingMethods = new Set<string>(['CSS.takeComputedStyleUpdates']);\n\nexport class DevToolsCDPConnection implements CDPConnection {\n  readonly #transport: ConnectionTransport;\n  #lastMessageId = 1;\n  #pendingResponsesCount = 0;\n  readonly #pendingLongPollingMessageIds = new Set<number>();\n  #pendingScripts: Array<() => void> = [];\n  readonly #callbacks = new Map<number, CallbackWithDebugInfo>();\n  readonly #observers = new Set<CDPConnectionObserver>();\n\n  constructor(transport: ConnectionTransport) {\n    this.#transport = transport;\n\n    test.deprecatedRunAfterPendingDispatches = this.deprecatedRunAfterPendingDispatches.bind(this);\n    test.sendRawMessage = this.sendRawMessageForTesting.bind(this);\n\n    this.#transport.setOnMessage(this.onMessage.bind(this));\n    this.#transport.setOnDisconnect(reason => {\n      this.#observers.forEach(observer => observer.onDisconnect(reason));\n    });\n  }\n\n  observe(observer: CDPConnectionObserver): void {\n    this.#observers.add(observer);\n  }\n\n  unobserve(observer: CDPConnectionObserver): void {\n    this.#observers.delete(observer);\n  }\n\n  send<T extends Command>(method: T, params: CommandParams<T>, sessionId: string|undefined):\n      Promise<{result: CommandResult<T>}|{error: CDPError}> {\n    const messageId = ++this.#lastMessageId;\n    const messageObject: Partial<CDPCommandRequest<T>> = {\n      id: messageId,\n      method,\n    };\n\n    if (params) {\n      messageObject.params = params;\n    }\n    if (sessionId) {\n      messageObject.sessionId = sessionId;\n    }\n\n    if (test.dumpProtocol) {\n      test.dumpProtocol('frontend: ' + JSON.stringify(messageObject));\n    }\n\n    if (test.onMessageSent) {\n      const domain = method.split('.')[0];\n      const paramsObject = JSON.parse(JSON.stringify(params || {}));\n      test.onMessageSent({domain, method, params: (paramsObject as Object), id: messageId, sessionId});\n    }\n\n    ++this.#pendingResponsesCount;\n    if (LongPollingMethods.has(method)) {\n      this.#pendingLongPollingMessageIds.add(messageId);\n    }\n\n    return new Promise(resolve => {\n      this.#callbacks.set(messageId, {resolve, method, sessionId});\n      this.#transport.sendRawMessage(JSON.stringify(messageObject));\n    });\n  }\n\n  resolvePendingCalls(sessionId: string): void {\n    for (const {resolve, method, sessionId: callbackSessionId} of this.#callbacks.values()) {\n      if (sessionId !== callbackSessionId) {\n        continue;\n      }\n      resolve({\n        error: {\n          message: `Session is unregistering, can\\'t dispatch pending call to ${method}`,\n          code: CDPErrorStatus.SESSION_NOT_FOUND,\n        }\n      });\n    }\n  }\n\n  private sendRawMessageForTesting(method: QualifiedName, params: Object|null, callback: Callback|null, sessionId = ''):\n      void {\n    void this.send(method as Command, params as CommandParams<Command>, sessionId).then(response => {\n      if ('error' in response && response.error) {\n        callback?.(response.error, null);\n      } else if ('result' in response) {\n        callback?.(null, response.result as Object | null);\n      }\n    });\n  }\n\n  private onMessage(message: string|Object): void {\n    if (test.dumpProtocol) {\n      test.dumpProtocol('backend: ' + ((typeof message === 'string') ? message : JSON.stringify(message)));\n    }\n\n    if (test.onMessageReceived) {\n      const messageObjectCopy = JSON.parse((typeof message === 'string') ? message : JSON.stringify(message));\n      test.onMessageReceived(messageObjectCopy);\n    }\n\n    const messageObject = ((typeof message === 'string') ? JSON.parse(message) : message) as CDPReceivableMessage;\n\n    if ('id' in messageObject && messageObject.id !== undefined) {  // just a response for some request\n      const callback = this.#callbacks.get(messageObject.id);\n      this.#callbacks.delete(messageObject.id);\n      if (!callback) {\n        // Ignore messages with unknown IDs, we might see puppeteer proxied messages here.\n        return;\n      }\n\n      callback.resolve(messageObject);\n      --this.#pendingResponsesCount;\n      this.#pendingLongPollingMessageIds.delete(messageObject.id);\n\n      if (this.#pendingScripts.length && !this.hasOutstandingNonLongPollingRequests()) {\n        this.deprecatedRunAfterPendingDispatches();\n      }\n    } else if ('method' in messageObject) {\n      this.#observers.forEach(observer => observer.onEvent(messageObject));\n    } else {\n      InspectorBackend.reportProtocolError('Protocol Error: the message without method', messageObject);\n    }\n  }\n\n  private hasOutstandingNonLongPollingRequests(): boolean {\n    return this.#pendingResponsesCount - this.#pendingLongPollingMessageIds.size > 0;\n  }\n\n  private deprecatedRunAfterPendingDispatches(script?: (() => void)): void {\n    if (script) {\n      this.#pendingScripts.push(script);\n    }\n\n    // Execute all promises.\n    setTimeout(() => {\n      if (!this.hasOutstandingNonLongPollingRequests()) {\n        this.executeAfterPendingDispatches();\n      } else {\n        this.deprecatedRunAfterPendingDispatches();\n      }\n    }, 0);\n  }\n\n  private executeAfterPendingDispatches(): void {\n    if (!this.hasOutstandingNonLongPollingRequests()) {\n      const scripts = this.#pendingScripts;\n      this.#pendingScripts = [];\n      for (let id = 0; id < scripts.length; ++id) {\n        scripts[id]();\n      }\n    }\n  }\n}\n"]}