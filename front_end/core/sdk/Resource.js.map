{"version":3,"file":"Resource.js","sourceRoot":"","sources":["../../../../../../front_end/core/sdk/Resource.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AA+B7B,OAAO,KAAK,SAAS,MAAM,uCAAuC,CAAC;AACnE,OAAO,KAAK,MAAM,MAAM,qBAAqB,CAAC;AAC9C,OAAO,KAAK,QAAQ,MAAM,yBAAyB,CAAC;AAKpD,MAAM,OAAO,QAAQ;IACV,kBAAkB,CAAoB;IAC/C,QAAQ,CAAsB;IAC9B,IAAI,CAAmC;IAC9B,YAAY,CAAkC;IAC9C,QAAQ,CAA6B;IACrC,SAAS,CAAiC;IAC1C,KAAK,CAAmC;IACjD,SAAS,CAAS;IAClB,YAAY,CAAU;IACtB,aAAa,CAAY;IAChB,YAAY,CAAc;IACnC,UAAU,CAA8B;IACxC,YAAY,GAA2C,IAAI,CAAC;IAC5D;;;OAGG;IACH,mBAAmB,GAA2D,IAAI,CAAC;IAEnF,YACI,iBAAoC,EAAE,OAA4B,EAAE,GAAoC,EACxG,WAA4C,EAAE,OAAmC,EACjF,QAAwC,EAAE,IAAsC,EAAE,QAAgB,EAClG,YAAuB,EAAE,WAAwB;QACnD,IAAI,CAAC,kBAAkB,GAAG,iBAAiB,CAAC;QAC5C,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC;QAEf,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC;QAChC,IAAI,CAAC,QAAQ,GAAG,OAAO,CAAC;QACxB,IAAI,CAAC,SAAS,GAAG,QAAQ,CAAC;QAC1B,IAAI,CAAC,KAAK,GAAG,IAAI,IAAI,MAAM,CAAC,YAAY,CAAC,aAAa,CAAC,KAAK,CAAC;QAC7D,IAAI,CAAC,SAAS,GAAG,QAAQ,CAAC;QAC1B,IAAI,CAAC,YAAY,GAAG,KAAK,CAAC;QAE1B,IAAI,CAAC,aAAa,GAAG,YAAY,IAAI,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC,CAAC,CAAC,YAAY,CAAC,CAAC,CAAC,IAAI,CAAC;QACxG,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC;IAClC,CAAC;IAED,YAAY;QACV,IAAI,IAAI,CAAC,aAAa,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;YACzC,OAAO,IAAI,CAAC,aAAa,CAAC;QAC5B,CAAC;QACD,MAAM,kBAAkB,GAAG,IAAI,CAAC,QAAQ,CAAC,oBAAoB,EAAE,CAAC;QAChE,MAAM,IAAI,GAAG,kBAAkB,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,kBAAkB,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;QACtE,IAAI,CAAC,aAAa,GAAG,IAAI,IAAI,QAAQ,CAAC,aAAa,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC;QAChF,OAAO,IAAI,CAAC,aAAa,CAAC;IAC5B,CAAC;IAED,WAAW;QACT,IAAI,OAAO,IAAI,CAAC,YAAY,KAAK,QAAQ,IAAI,CAAC,IAAI,CAAC,QAAQ,EAAE,CAAC;YAC5D,OAAO,IAAI,CAAC,YAAY,CAAC;QAC3B,CAAC;QACD,OAAO,IAAI,CAAC,QAAQ,CAAC,YAAY,CAAC;IACpC,CAAC;IAED,IAAI,OAAO;QACT,OAAO,IAAI,CAAC,QAAQ,CAAC;IACvB,CAAC;IAED,IAAI,GAAG;QACL,OAAO,IAAI,CAAC,IAAI,CAAC;IACnB,CAAC;IAED,IAAI,GAAG,CAAC,CAAkC;QACxC,IAAI,CAAC,IAAI,GAAG,CAAC,CAAC;QACd,IAAI,CAAC,UAAU,GAAG,IAAI,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC;IACtD,CAAC;IAED,IAAI,SAAS;QACX,OAAO,IAAI,CAAC,UAAU,CAAC;IACzB,CAAC;IAED,IAAI,WAAW;QACb,OAAO,IAAI,CAAC,YAAY,CAAC;IAC3B,CAAC;IAED,IAAI,OAAO;QACT,OAAO,IAAI,CAAC,QAAQ,CAAC;IACvB,CAAC;IAED,IAAI,QAAQ;QACV,OAAO,IAAI,CAAC,SAAS,CAAC;IACxB,CAAC;IAED,IAAI,WAAW;QACb,OAAO,IAAI,CAAC,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,CAAC,CAAC,EAAE,CAAC;IAC5D,CAAC;IAED,YAAY;QACV,OAAO,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,YAAY,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC;IACnE,CAAC;IAED,IAAI,QAAQ;QACV,OAAO,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC;IACjE,CAAC;IAED,IAAI,OAAO;QACT,IAAI,IAAI,CAAC,YAAY,EAAE,aAAa,EAAE,CAAC;YACrC,OAAO,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC;QAChC,CAAC;QACD,OAAO,IAAI,CAAC,YAAY,EAAE,MAAM,IAAI,IAAI,CAAC;IAC3C,CAAC;IAED,IAAI,WAAW;QACb,OAAO,IAAI,CAAC,YAAY,CAAC;IAC3B,CAAC;IAED,IAAI,WAAW,CAAC,GAAY;QAC1B,IAAI,CAAC,YAAY,GAAG,GAAG,CAAC;IAC1B,CAAC;IAED,UAAU;QACR,OAAO,IAAI,CAAC,IAAI,CAAC;IACnB,CAAC;IAED,WAAW;QACT,IAAI,IAAI,CAAC,YAAY,EAAE,KAAK,MAAM,CAAC,YAAY,CAAC,aAAa,CAAC,QAAQ;YAClE,IAAI,CAAC,QAAQ,CAAC,OAAO,CAAC,YAAY,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC;YAC/C,OAAO,MAAM,CAAC,YAAY,CAAC,aAAa,CAAC,MAAM,CAAC;QAClD,CAAC;QACD,OAAO,IAAI,CAAC,YAAY,EAAE,CAAC;IAC7B,CAAC;IAED,KAAK,CAAC,kBAAkB;QACtB,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;YACtB,OAAO,IAAI,CAAC,YAAY,CAAC;QAC3B,CAAC;QACD,IAAI,IAAI,CAAC,mBAAmB,EAAE,CAAC;YAC7B,OAAO,MAAM,IAAI,CAAC,mBAAmB,CAAC;QACxC,CAAC;QACD,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,mBAAmB,EAAE,CAAC,IAAI,CAAC,WAAW,CAAC,EAAE;YACvE,6FAA6F;YAC7F,sDAAsD;YACtD,IAAI,CAAC,SAAS,CAAC,WAAW,CAAC,WAAW,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE,CAAC;gBAC5D,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC;YAClC,CAAC;YACD,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC;YAChC,OAAO,WAAW,CAAC;QACrB,CAAC,CAAC,CAAC;QACH,OAAO,MAAM,IAAI,CAAC,mBAAmB,CAAC;IACxC,CAAC;IAED,iBAAiB;QACf,OAAO,IAAI,CAAC,WAAW,EAAE,CAAC,iBAAiB,EAAE,IAAI,IAAI,CAAC,QAAQ,CAAC;IACjE,CAAC;IAED,KAAK,CAAC,eAAe,CAAC,KAAa,EAAE,aAAsB,EAAE,OAAgB;QAE3E,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;YAClB,OAAO,EAAE,CAAC;QACZ,CAAC;QACD,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,OAAO,MAAM,IAAI,CAAC,OAAO,CAAC,eAAe,CAAC,KAAK,EAAE,aAAa,EAAE,OAAO,CAAC,CAAC;QAC3E,CAAC;QACD,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,MAAM,EAAE,CAAC,SAAS,EAAE,CAAC,uBAAuB,CACrF,EAAC,OAAO,EAAE,IAAI,CAAC,OAAO,EAAE,GAAG,EAAE,IAAI,CAAC,GAAG,EAAE,KAAK,EAAE,aAAa,EAAE,OAAO,EAAC,CAAC,CAAC;QAC3E,OAAO,SAAS,CAAC,SAAS,CAAC,4BAA4B,CAAC,MAAM,CAAC,MAAM,IAAI,EAAE,EAAE,KAAK,EAAE,aAAa,EAAE,OAAO,CAAC,CAAC;IAC9G,CAAC;IAED,KAAK,CAAC,mBAAmB,CAAC,KAAuB;QAC/C,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,kBAAkB,EAAE,CAAC;QACpD,IAAI,SAAS,CAAC,WAAW,CAAC,WAAW,CAAC,OAAO,CAAC,WAAW,CAAC,EAAE,CAAC;YAC3D,OAAO;QACT,CAAC;QACD,KAAK,CAAC,GAAG,GAAG,WAAW,CAAC,SAAS,EAAE,IAAI,IAAI,CAAC,IAAI,CAAC;IACnD,CAAC;IAEO,KAAK,CAAC,mBAAmB;QAC/B,IAAI,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,oEAAoE;YACpE,OAAO,MAAM,IAAI,CAAC,OAAO,CAAC,kBAAkB,EAAE,CAAC;QACjD,CAAC;QAED,MAAM,QAAQ,GAAG,MAAM,IAAI,CAAC,kBAAkB,CAAC,MAAM,EAAE,CAAC,SAAS,EAAE,CAAC,yBAAyB,CACzF,EAAC,OAAO,EAAE,IAAI,CAAC,OAAgC,EAAE,GAAG,EAAE,IAAI,CAAC,GAAG,EAAC,CAAC,CAAC;QACrE,MAAM,KAAK,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;QAClC,IAAI,KAAK,EAAE,CAAC;YACV,OAAO,EAAC,KAAK,EAAC,CAAC;QACjB,CAAC;QACD,OAAO,IAAI,SAAS,CAAC,WAAW,CAAC,WAAW,CAAC,QAAQ,CAAC,OAAO,EAAE,QAAQ,CAAC,aAAa,EAAE,IAAI,CAAC,QAAQ,CAAC,CAAC;IACxG,CAAC;IAED,KAAK;QACH,OAAO,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,kBAAkB,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC;IAClF,CAAC;IAED,UAAU;QACR,OAAO,IAAI,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,CAAC;IACtD,CAAC;CACF","sourcesContent":["// Copyright 2021 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/*\n * Copyright (C) 2007, 2008 Apple Inc.  All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions\n * are met:\n *\n * 1.  Redistributions of source code must retain the above copyright\n *     notice, this list of conditions and the following disclaimer.\n * 2.  Redistributions in binary form must reproduce the above copyright\n *     notice, this list of conditions and the following disclaimer in the\n *     documentation and/or other materials provided with the distribution.\n * 3.  Neither the name of Apple Computer, Inc. (\"Apple\") nor the names of\n *     its contributors may be used to endorse or promote products derived\n *     from this software without specific prior written permission.\n *\n * THIS SOFTWARE IS PROVIDED BY APPLE AND ITS CONTRIBUTORS \"AS IS\" AND ANY\n * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n * DISCLAIMED. IN NO EVENT SHALL APPLE OR ITS CONTRIBUTORS BE LIABLE FOR ANY\n * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND\n * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF\n * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport type * as Protocol from '../../generated/protocol.js';\nimport * as TextUtils from '../../models/text_utils/text_utils.js';\nimport * as Common from '../common/common.js';\nimport * as Platform from '../platform/platform.js';\n\nimport type {NetworkRequest} from './NetworkRequest.js';\nimport type {ResourceTreeFrame, ResourceTreeModel} from './ResourceTreeModel.js';\n\nexport class Resource implements TextUtils.ContentProvider.ContentProvider {\n  readonly #resourceTreeModel: ResourceTreeModel;\n  #request: NetworkRequest|null;\n  #url!: Platform.DevToolsPath.UrlString;\n  readonly #documentURL: Platform.DevToolsPath.UrlString;\n  readonly #frameId: Protocol.Page.FrameId|null;\n  readonly #loaderId: Protocol.Network.LoaderId|null;\n  readonly #type: Common.ResourceType.ResourceType;\n  #mimeType: string;\n  #isGenerated: boolean;\n  #lastModified: Date|null;\n  readonly #contentSize: number|null;\n  #parsedURL?: Common.ParsedURL.ParsedURL;\n  #contentData: TextUtils.ContentData.ContentData|null = null;\n  /**\n   * There is always at most one CDP \"getResourceContent\" call in-flight. But once it's done\n   * we'll hit the backend again in case we failed.\n   */\n  #pendingContentData: Promise<TextUtils.ContentData.ContentDataOrError>|null = null;\n\n  constructor(\n      resourceTreeModel: ResourceTreeModel, request: NetworkRequest|null, url: Platform.DevToolsPath.UrlString,\n      documentURL: Platform.DevToolsPath.UrlString, frameId: Protocol.Page.FrameId|null,\n      loaderId: Protocol.Network.LoaderId|null, type: Common.ResourceType.ResourceType, mimeType: string,\n      lastModified: Date|null, contentSize: number|null) {\n    this.#resourceTreeModel = resourceTreeModel;\n    this.#request = request;\n    this.url = url;\n\n    this.#documentURL = documentURL;\n    this.#frameId = frameId;\n    this.#loaderId = loaderId;\n    this.#type = type || Common.ResourceType.resourceTypes.Other;\n    this.#mimeType = mimeType;\n    this.#isGenerated = false;\n\n    this.#lastModified = lastModified && Platform.DateUtilities.isValid(lastModified) ? lastModified : null;\n    this.#contentSize = contentSize;\n  }\n\n  lastModified(): Date|null {\n    if (this.#lastModified || !this.#request) {\n      return this.#lastModified;\n    }\n    const lastModifiedHeader = this.#request.responseLastModified();\n    const date = lastModifiedHeader ? new Date(lastModifiedHeader) : null;\n    this.#lastModified = date && Platform.DateUtilities.isValid(date) ? date : null;\n    return this.#lastModified;\n  }\n\n  contentSize(): number|null {\n    if (typeof this.#contentSize === 'number' || !this.#request) {\n      return this.#contentSize;\n    }\n    return this.#request.resourceSize;\n  }\n\n  get request(): NetworkRequest|null {\n    return this.#request;\n  }\n\n  get url(): Platform.DevToolsPath.UrlString {\n    return this.#url;\n  }\n\n  set url(x: Platform.DevToolsPath.UrlString) {\n    this.#url = x;\n    this.#parsedURL = new Common.ParsedURL.ParsedURL(x);\n  }\n\n  get parsedURL(): Common.ParsedURL.ParsedURL|undefined {\n    return this.#parsedURL;\n  }\n\n  get documentURL(): Platform.DevToolsPath.UrlString {\n    return this.#documentURL;\n  }\n\n  get frameId(): Protocol.Page.FrameId|null {\n    return this.#frameId;\n  }\n\n  get loaderId(): Protocol.Network.LoaderId|null {\n    return this.#loaderId;\n  }\n\n  get displayName(): string {\n    return this.#parsedURL ? this.#parsedURL.displayName : '';\n  }\n\n  resourceType(): Common.ResourceType.ResourceType {\n    return this.#request ? this.#request.resourceType() : this.#type;\n  }\n\n  get mimeType(): string {\n    return this.#request ? this.#request.mimeType : this.#mimeType;\n  }\n\n  get content(): string|null {\n    if (this.#contentData?.isTextContent) {\n      return this.#contentData.text;\n    }\n    return this.#contentData?.base64 ?? null;\n  }\n\n  get isGenerated(): boolean {\n    return this.#isGenerated;\n  }\n\n  set isGenerated(val: boolean) {\n    this.#isGenerated = val;\n  }\n\n  contentURL(): Platform.DevToolsPath.UrlString {\n    return this.#url;\n  }\n\n  contentType(): Common.ResourceType.ResourceType {\n    if (this.resourceType() === Common.ResourceType.resourceTypes.Document &&\n        this.mimeType.indexOf('javascript') !== -1) {\n      return Common.ResourceType.resourceTypes.Script;\n    }\n    return this.resourceType();\n  }\n\n  async requestContentData(): Promise<TextUtils.ContentData.ContentDataOrError> {\n    if (this.#contentData) {\n      return this.#contentData;\n    }\n    if (this.#pendingContentData) {\n      return await this.#pendingContentData;\n    }\n    this.#pendingContentData = this.innerRequestContent().then(contentData => {\n      // If an error happended we don't set `this.#contentData` so future `requestContentData` will\n      // attempt again to hit the backend for this Resource.\n      if (!TextUtils.ContentData.ContentData.isError(contentData)) {\n        this.#contentData = contentData;\n      }\n      this.#pendingContentData = null;\n      return contentData;\n    });\n    return await this.#pendingContentData;\n  }\n\n  canonicalMimeType(): string {\n    return this.contentType().canonicalMimeType() || this.mimeType;\n  }\n\n  async searchInContent(query: string, caseSensitive: boolean, isRegex: boolean):\n      Promise<TextUtils.ContentProvider.SearchMatch[]> {\n    if (!this.frameId) {\n      return [];\n    }\n    if (this.request) {\n      return await this.request.searchInContent(query, caseSensitive, isRegex);\n    }\n    const result = await this.#resourceTreeModel.target().pageAgent().invoke_searchInResource(\n        {frameId: this.frameId, url: this.url, query, caseSensitive, isRegex});\n    return TextUtils.TextUtils.performSearchInSearchMatches(result.result || [], query, caseSensitive, isRegex);\n  }\n\n  async populateImageSource(image: HTMLImageElement): Promise<void> {\n    const contentData = await this.requestContentData();\n    if (TextUtils.ContentData.ContentData.isError(contentData)) {\n      return;\n    }\n    image.src = contentData.asDataUrl() ?? this.#url;\n  }\n\n  private async innerRequestContent(): Promise<TextUtils.ContentData.ContentDataOrError> {\n    if (this.request) {\n      // The `contentData` promise only resolves once the request is done.\n      return await this.request.requestContentData();\n    }\n\n    const response = await this.#resourceTreeModel.target().pageAgent().invoke_getResourceContent(\n        {frameId: this.frameId as Protocol.Page.FrameId, url: this.url});\n    const error = response.getError();\n    if (error) {\n      return {error};\n    }\n    return new TextUtils.ContentData.ContentData(response.content, response.base64Encoded, this.mimeType);\n  }\n\n  frame(): ResourceTreeFrame|null {\n    return this.#frameId ? this.#resourceTreeModel.frameForId(this.#frameId) : null;\n  }\n\n  statusCode(): number {\n    return this.#request ? this.#request.statusCode : 0;\n  }\n}\n"]}