{"version":3,"file":"SourceMapScopeChainEntry.js","sourceRoot":"","sources":["../../../../../../front_end/core/sdk/SourceMapScopeChainEntry.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Protocol from '../../generated/protocol.js';\nimport type * as ScopesCodec from '../../third_party/source-map-scopes-codec/source-map-scopes-codec.js';\nimport * as i18n from '../i18n/i18n.js';\n\nimport type {CallFrame, LocationRange, ScopeChainEntry} from './DebuggerModel.js';\nimport {type GetPropertiesResult, type RemoteObject, RemoteObjectImpl, RemoteObjectProperty} from './RemoteObject.js';\nimport {contains} from './SourceMapScopesInfo.js';\n\nconst UIStrings = {\n  /**\n   * @description Title of a section in the debugger showing local JavaScript variables.\n   */\n  local: 'Local',\n  /**\n   * @description Text that refers to closure as a programming term\n   */\n  closure: 'Closure',\n  /**\n   * @description Noun that represents a section or block of code in the Debugger Model. Shown in the Sources tab, while paused on a breakpoint.\n   */\n  block: 'Block',\n  /**\n   * @description Title of a section in the debugger showing JavaScript variables from the global scope.\n   */\n  global: 'Global',\n  /**\n   * @description Text in Scope Chain Sidebar Pane of the Sources panel\n   */\n  returnValue: 'Return value',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('core/sdk/SourceMapScopeChainEntry.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport class SourceMapScopeChainEntry implements ScopeChainEntry {\n  readonly #callFrame: CallFrame;\n  readonly #scope: ScopesCodec.OriginalScope;\n  readonly #range?: ScopesCodec.GeneratedRange;\n  readonly #isInnerMostFunction: boolean;\n  readonly #returnValue?: RemoteObject;\n\n  /**\n   * @param isInnerMostFunction If `scope` is the innermost 'function' scope. Only used for labeling as we name the\n   * scope of the paused function 'Local', while other outer 'function' scopes are named 'Closure'.\n   */\n  constructor(\n      callFrame: CallFrame, scope: ScopesCodec.OriginalScope, range: ScopesCodec.GeneratedRange|undefined,\n      isInnerMostFunction: boolean, returnValue: RemoteObject|undefined) {\n    this.#callFrame = callFrame;\n    this.#scope = scope;\n    this.#range = range;\n    this.#isInnerMostFunction = isInnerMostFunction;\n    this.#returnValue = returnValue;\n  }\n\n  extraProperties(): RemoteObjectProperty[] {\n    if (this.#returnValue) {\n      return [new RemoteObjectProperty(\n          i18nString(UIStrings.returnValue), this.#returnValue, undefined, undefined, undefined, undefined, undefined,\n          /* synthetic */ true)];\n    }\n    return [];\n  }\n\n  callFrame(): CallFrame {\n    return this.#callFrame;\n  }\n\n  type(): string {\n    switch (this.#scope.kind) {\n      case 'global':\n        return Protocol.Debugger.ScopeType.Global;\n      case 'function':\n        return this.#isInnerMostFunction ? Protocol.Debugger.ScopeType.Local : Protocol.Debugger.ScopeType.Closure;\n      case 'block':\n        return Protocol.Debugger.ScopeType.Block;\n    }\n    return this.#scope.kind ?? '';\n  }\n\n  typeName(): string {\n    switch (this.#scope.kind) {\n      case 'global':\n        return i18nString(UIStrings.global);\n      case 'function':\n        return this.#isInnerMostFunction ? i18nString(UIStrings.local) : i18nString(UIStrings.closure);\n      case 'block':\n        return i18nString(UIStrings.block);\n    }\n    return this.#scope.kind ?? '';\n  }\n\n  name(): string|undefined {\n    return this.#scope.name;\n  }\n\n  range(): LocationRange|null {\n    return null;\n  }\n\n  object(): RemoteObject {\n    return new SourceMapScopeRemoteObject(this.#callFrame, this.#scope, this.#range);\n  }\n\n  description(): string {\n    return '';\n  }\n\n  icon(): string|undefined {\n    return undefined;\n  }\n}\n\nclass SourceMapScopeRemoteObject extends RemoteObjectImpl {\n  readonly #callFrame: CallFrame;\n  readonly #scope: ScopesCodec.OriginalScope;\n  readonly #range?: ScopesCodec.GeneratedRange;\n\n  constructor(callFrame: CallFrame, scope: ScopesCodec.OriginalScope, range: ScopesCodec.GeneratedRange|undefined) {\n    super(\n        callFrame.debuggerModel.runtimeModel(), /* objectId */ undefined, 'object', /* sub type */ undefined,\n        /* value */ null);\n    this.#callFrame = callFrame;\n    this.#scope = scope;\n    this.#range = range;\n  }\n\n  override async doGetProperties(_ownProperties: boolean, accessorPropertiesOnly: boolean, generatePreview: boolean):\n      Promise<GetPropertiesResult> {\n    if (accessorPropertiesOnly) {\n      return {properties: [], internalProperties: []};\n    }\n\n    const properties: RemoteObjectProperty[] = [];\n    for (const [index, variable] of this.#scope.variables.entries()) {\n      const expression = this.#findExpression(index);\n      if (expression === null) {\n        properties.push(SourceMapScopeRemoteObject.#unavailableProperty(variable));\n        continue;\n      }\n\n      // TODO(crbug.com/40277685): Once we can evaluate expressions in scopes other than the innermost one,\n      //         we need to find the find the CDP scope that matches `this.#range` and evaluate in that.\n      const result = await this.#callFrame.evaluate({expression, generatePreview});\n      if ('error' in result || result.exceptionDetails) {\n        // TODO(crbug.com/40277685): Make these errors user-visible to aid tooling developers.\n        //         E.g. show the error on hover or expose it in the developer resources panel.\n        properties.push(SourceMapScopeRemoteObject.#unavailableProperty(variable));\n      } else {\n        properties.push(new RemoteObjectProperty(\n            variable, result.object, /* enumerable */ false, /* writable */ false, /* isOwn */ true,\n            /* wasThrown */ false));\n      }\n    }\n\n    return {properties, internalProperties: []};\n  }\n\n  /** @returns null if the variable is unavailable at the current paused location */\n  #findExpression(index: number): string|null {\n    if (!this.#range) {\n      return null;\n    }\n\n    const expressionOrSubRanges = this.#range.values[index];\n    if (typeof expressionOrSubRanges === 'string') {\n      return expressionOrSubRanges;\n    }\n    if (expressionOrSubRanges === null) {\n      return null;\n    }\n\n    const pausedPosition = this.#callFrame.location();\n    for (const range of expressionOrSubRanges) {\n      if (contains({start: range.from, end: range.to}, pausedPosition.lineNumber, pausedPosition.columnNumber)) {\n        return range.value ?? null;\n      }\n    }\n    return null;\n  }\n\n  static #unavailableProperty(name: string): RemoteObjectProperty {\n    return new RemoteObjectProperty(\n        name, null, /* enumerable */ false, /* writeable */ false, /* isOwn */ true, /* wasThrown */ false);\n  }\n}\n"]}