{"version":3,"file":"StorageKeyManager.js","sourceRoot":"","sources":["../../../../../../front_end/core/sdk/StorageKeyManager.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,MAAM,MAAM,qBAAqB,CAAC;AAG9C,OAAO,EAAC,QAAQ,EAAC,MAAM,eAAe,CAAC;AAGvC,MAAM,OAAO,iBAAkB,SAAQ,QAAoB;IACzD,eAAe,CAAS;IACxB,YAAY,CAAc;IAC1B,YAAY,MAAc;QACxB,KAAK,CAAC,MAAM,CAAC,CAAC;QAEd,IAAI,CAAC,eAAe,GAAG,EAAE,CAAC;QAC1B,IAAI,CAAC,YAAY,GAAG,IAAI,GAAG,EAAE,CAAC;IAChC,CAAC;IAED,iBAAiB,CAAC,WAAwB;QACxC,MAAM,cAAc,GAAG,IAAI,CAAC,YAAY,CAAC;QACzC,IAAI,CAAC,YAAY,GAAG,WAAW,CAAC;QAEhC,KAAK,MAAM,UAAU,IAAI,cAAc,EAAE,CAAC;YACxC,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC;gBACvC,IAAI,CAAC,wBAAwB,uDAA6B,UAAU,CAAC,CAAC;YACxE,CAAC;QACH,CAAC;QAED,KAAK,MAAM,UAAU,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;YAC3C,IAAI,CAAC,cAAc,CAAC,GAAG,CAAC,UAAU,CAAC,EAAE,CAAC;gBACpC,IAAI,CAAC,wBAAwB,mDAA2B,UAAU,CAAC,CAAC;YACtE,CAAC;QACH,CAAC;IACH,CAAC;IAED,WAAW;QACT,OAAO,CAAC,GAAG,IAAI,CAAC,YAAY,CAAC,CAAC;IAChC,CAAC;IAED,cAAc;QACZ,OAAO,IAAI,CAAC,eAAe,CAAC;IAC9B,CAAC;IAED,iBAAiB,CAAC,UAAkB;QAClC,IAAI,CAAC,eAAe,GAAG,UAAU,CAAC;QAClC,IAAI,CAAC,wBAAwB,gEAAkC;YAC7D,cAAc,EAAE,IAAI,CAAC,eAAe;SACrC,CAAC,CAAC;IACL,CAAC;CACF;AAED,MAAM,UAAU,eAAe,CAAC,gBAAwB;IACtD,sEAAsE;IACtE,sDAAsD;IACtD,MAAM,UAAU,GAAG,gBAAgB,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC;IAC/C,MAAM,MAAM,GAAG,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC,CAAoC,CAAC,CAAC;IAC1G,MAAM,UAAU,GAAG,EAAC,MAAM,EAAE,UAAU,EAAE,IAAI,GAAG,EAA+B,EAAC,CAAC;IAChF,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,UAAU,CAAC,MAAM,EAAE,EAAE,CAAC,EAAE,CAAC;QAC3C,UAAU,CAAC,UAAU,CAAC,GAAG,CAAC,UAAU,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAwB,EAAE,UAAU,CAAC,CAAC,CAAC,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,CAAC;IACxG,CAAC;IACD,OAAO,UAAU,CAAC;AACpB,CAAC;AAiCD,6FAA6F;AAC7F,QAAQ,CAAC,QAAQ,CAAC,iBAAiB,EAAE,EAAC,YAAY,yBAAiB,EAAE,SAAS,EAAE,KAAK,EAAC,CAAC,CAAC","sourcesContent":["// Copyright 2022 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../common/common.js';\nimport type * as Platform from '../platform/platform.js';\n\nimport {SDKModel} from './SDKModel.js';\nimport {Capability, type Target} from './Target.js';\n\nexport class StorageKeyManager extends SDKModel<EventTypes> {\n  #mainStorageKey: string;\n  #storageKeys: Set<string>;\n  constructor(target: Target) {\n    super(target);\n\n    this.#mainStorageKey = '';\n    this.#storageKeys = new Set();\n  }\n\n  updateStorageKeys(storageKeys: Set<string>): void {\n    const oldStorageKeys = this.#storageKeys;\n    this.#storageKeys = storageKeys;\n\n    for (const storageKey of oldStorageKeys) {\n      if (!this.#storageKeys.has(storageKey)) {\n        this.dispatchEventToListeners(Events.STORAGE_KEY_REMOVED, storageKey);\n      }\n    }\n\n    for (const storageKey of this.#storageKeys) {\n      if (!oldStorageKeys.has(storageKey)) {\n        this.dispatchEventToListeners(Events.STORAGE_KEY_ADDED, storageKey);\n      }\n    }\n  }\n\n  storageKeys(): string[] {\n    return [...this.#storageKeys];\n  }\n\n  mainStorageKey(): string {\n    return this.#mainStorageKey;\n  }\n\n  setMainStorageKey(storageKey: string): void {\n    this.#mainStorageKey = storageKey;\n    this.dispatchEventToListeners(Events.MAIN_STORAGE_KEY_CHANGED, {\n      mainStorageKey: this.#mainStorageKey,\n    });\n  }\n}\n\nexport function parseStorageKey(storageKeyString: string): StorageKey {\n  // Based on the canonical implementation of StorageKey::Deserialize in\n  // third_party/blink/common/storage_key/storage_key.cc\n  const components = storageKeyString.split('^');\n  const origin = Common.ParsedURL.ParsedURL.extractOrigin(components[0] as Platform.DevToolsPath.UrlString);\n  const storageKey = {origin, components: new Map<StorageKeyComponent, string>()};\n  for (let i = 1; i < components.length; ++i) {\n    storageKey.components.set(components[i].charAt(0) as StorageKeyComponent, components[i].substring(1));\n  }\n  return storageKey;\n}\n\nexport const enum StorageKeyComponent {\n  TOP_LEVEL_SITE = '0',\n  NONCE_HIGH = '1',\n  NONCE_LOW = '2',\n  ANCESTOR_CHAIN_BIT = '3',\n  TOP_LEVEL_SITE_OPAQUE_NONCE_HIGH = '4',\n  TOP_LEVEL_SITE_OPAQUE_NONCE_LOW = '5',\n  TOP_LEVEL_SITE_OPAQUE_NONCE_PRECURSOR = '6',\n}\n\nexport interface StorageKey {\n  origin: Platform.DevToolsPath.UrlString;\n  components: Map<StorageKeyComponent, string>;\n}\n\nexport const enum Events {\n  STORAGE_KEY_ADDED = 'StorageKeyAdded',\n  STORAGE_KEY_REMOVED = 'StorageKeyRemoved',\n  MAIN_STORAGE_KEY_CHANGED = 'MainStorageKeyChanged',\n}\n\nexport interface MainStorageKeyChangedEvent {\n  mainStorageKey: string;\n}\n\nexport interface EventTypes {\n  [Events.STORAGE_KEY_ADDED]: string;\n  [Events.STORAGE_KEY_REMOVED]: string;\n  [Events.MAIN_STORAGE_KEY_CHANGED]: MainStorageKeyChangedEvent;\n}\n\n// TODO(jarhar): this is the one of the two usages of Capability.None. Do something about it!\nSDKModel.register(StorageKeyManager, {capabilities: Capability.NONE, autostart: false});\n"]}