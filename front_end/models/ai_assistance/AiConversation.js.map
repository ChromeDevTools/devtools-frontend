{"version":3,"file":"AiConversation.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_assistance/AiConversation.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../core/host/host.js';\nimport * as Root from '../../core/root/root.js';\n\nimport {\n  type AiAgent,\n  type ContextDetail,\n  type ConversationContext,\n  type MultimodalInput,\n  type ResponseData,\n  ResponseType\n} from './agents/AiAgent.js';\nimport {FileAgent} from './agents/FileAgent.js';\nimport {NetworkAgent} from './agents/NetworkAgent.js';\nimport {PerformanceAgent} from './agents/PerformanceAgent.js';\nimport {StylingAgent} from './agents/StylingAgent.js';\nimport {AiHistoryStorage, ConversationType, type SerializedConversation} from './AiHistoryStorage.js';\nimport type {ChangeManager} from './ChangeManager.js';\n\nexport const NOT_FOUND_IMAGE_DATA = '';\nconst MAX_TITLE_LENGTH = 80;\n\nexport function generateContextDetailsMarkdown(details: ContextDetail[]): string {\n  const detailsMarkdown: string[] = [];\n  for (const detail of details) {\n    const text = `\\`\\`\\`\\`${detail.codeLang || ''}\\n${detail.text.trim()}\\n\\`\\`\\`\\``;\n    detailsMarkdown.push(`**${detail.title}:**\\n${text}`);\n  }\n  return detailsMarkdown.join('\\n\\n');\n}\nexport class AiConversation {\n  static fromSerializedConversation(serializedConversation: SerializedConversation): AiConversation {\n    const history = serializedConversation.history.map(entry => {\n      if (entry.type === ResponseType.SIDE_EFFECT) {\n        return {...entry, confirm: () => {}};\n      }\n      return entry;\n    });\n    return new AiConversation(\n        serializedConversation.type,\n        history,\n        serializedConversation.id,\n        true,\n        undefined,\n        undefined,\n        serializedConversation.isExternal,\n    );\n  }\n\n  readonly id: string;\n  type: ConversationType;\n  #isReadOnly: boolean;\n  readonly history: ResponseData[];\n  #isExternal: boolean;\n\n  #aidaClient: Host.AidaClient.AidaClient;\n  #changeManager: ChangeManager|undefined;\n  #agent: AiAgent<unknown>;\n\n  constructor(\n      type: ConversationType,\n      data: ResponseData[] = [],\n      id: string = crypto.randomUUID(),\n      isReadOnly = true,\n      aidaClient: Host.AidaClient.AidaClient = new Host.AidaClient.AidaClient(),\n      changeManager?: ChangeManager,\n      isExternal = false,\n  ) {\n    this.#changeManager = changeManager;\n    this.#aidaClient = aidaClient;\n    this.#agent = this.#createAgent(type);\n\n    this.type = type;\n    this.id = id;\n    this.#isReadOnly = isReadOnly;\n    this.#isExternal = isExternal;\n    this.history = this.#reconstructHistory(data);\n  }\n\n  get isReadOnly(): boolean {\n    return this.#isReadOnly;\n  }\n\n  get title(): string|undefined {\n    const query = this.history.find(response => response.type === ResponseType.USER_QUERY)?.query;\n\n    if (!query) {\n      return;\n    }\n\n    if (this.#isExternal) {\n      return `[External] ${query.substring(0, MAX_TITLE_LENGTH - 11)}${\n          query.length > MAX_TITLE_LENGTH - 11 ? '…' : ''}`;\n    }\n    return `${query.substring(0, MAX_TITLE_LENGTH)}${query.length > MAX_TITLE_LENGTH ? '…' : ''}`;\n  }\n\n  get isEmpty(): boolean {\n    return this.history.length === 0;\n  }\n\n  #reconstructHistory(historyWithoutImages: ResponseData[]): ResponseData[] {\n    const imageHistory = AiHistoryStorage.instance().getImageHistory();\n    if (imageHistory && imageHistory.length > 0) {\n      const history: ResponseData[] = [];\n      for (const data of historyWithoutImages) {\n        if (data.type === ResponseType.USER_QUERY && data.imageId) {\n          const image = imageHistory.find(item => item.id === data.imageId);\n          const inlineData = image ? {data: image.data, mimeType: image.mimeType} :\n                                     {data: NOT_FOUND_IMAGE_DATA, mimeType: 'image/jpeg'};\n          history.push({...data, imageInput: {inlineData}});\n        } else {\n          history.push(data);\n        }\n      }\n      return history;\n    }\n    return historyWithoutImages;\n  }\n\n  getConversationMarkdown(): string {\n    const contentParts: string[] = [];\n    contentParts.push(\n        '# Exported Chat from Chrome DevTools AI Assistance\\n\\n' +\n            `**Export Timestamp (UTC):** ${new Date().toISOString()}\\n\\n` +\n            '---',\n    );\n    for (const item of this.history) {\n      switch (item.type) {\n        case ResponseType.USER_QUERY: {\n          contentParts.push(`## User\\n\\n${item.query}`);\n          if (item.imageInput) {\n            contentParts.push('User attached an image');\n          }\n          contentParts.push('## AI');\n          break;\n        }\n        case ResponseType.CONTEXT: {\n          contentParts.push(`### ${item.title}`);\n          if (item.details && item.details.length > 0) {\n            contentParts.push(generateContextDetailsMarkdown(item.details));\n          }\n          break;\n        }\n        case ResponseType.TITLE: {\n          contentParts.push(`### ${item.title}`);\n          break;\n        }\n        case ResponseType.THOUGHT: {\n          contentParts.push(`${item.thought}`);\n          break;\n        }\n        case ResponseType.ACTION: {\n          // We want to export only actions with output field\n          if (!item.output) {\n            break;\n          }\n          if (item.code) {\n            contentParts.push(`**Code executed:**\\n\\`\\`\\`\\n${item.code.trim()}\\n\\`\\`\\``);\n          }\n          contentParts.push(`**Data returned:**\\n\\`\\`\\`\\n${item.output}\\n\\`\\`\\``);\n          break;\n        }\n        case ResponseType.ANSWER: {\n          if (item.complete) {\n            contentParts.push(`### Answer\\n\\n${item.text.trim()}`);\n          }\n          break;\n        }\n      }\n    }\n    return contentParts.join('\\n\\n');\n  }\n\n  archiveConversation(): void {\n    this.#isReadOnly = true;\n  }\n\n  async addHistoryItem(item: ResponseData): Promise<void> {\n    this.history.push(item);\n    await AiHistoryStorage.instance().upsertHistoryEntry(this.serialize());\n    if (item.type === ResponseType.USER_QUERY) {\n      if (item.imageId && item.imageInput && 'inlineData' in item.imageInput) {\n        const inlineData = item.imageInput.inlineData;\n        await AiHistoryStorage.instance().upsertImage({\n          id: item.imageId,\n          data: inlineData.data,\n          mimeType: inlineData.mimeType,\n        });\n      }\n    }\n  }\n\n  serialize(): SerializedConversation {\n    return {\n      id: this.id,\n      history: this.history.map(item => {\n        if (item.type === ResponseType.USER_QUERY) {\n          return {...item, imageInput: undefined};\n        }\n        // Remove the `confirm()`-function because `structuredClone()` throws on functions\n        if (item.type === ResponseType.SIDE_EFFECT) {\n          return {...item, confirm: undefined};\n        }\n        return item;\n      }),\n      type: this.type,\n      isExternal: this.#isExternal,\n    };\n  }\n\n  #createAgent(conversationType: ConversationType): AiAgent<unknown> {\n    const options = {\n      aidaClient: this.#aidaClient,\n      serverSideLoggingEnabled: isAiAssistanceServerSideLoggingEnabled(),\n      changeManager: this.#changeManager,\n    };\n    let agent: AiAgent<unknown>;\n    switch (conversationType) {\n      case ConversationType.STYLING: {\n        agent = new StylingAgent(options);\n        break;\n      }\n      case ConversationType.NETWORK: {\n        agent = new NetworkAgent(options);\n        break;\n      }\n      case ConversationType.FILE: {\n        agent = new FileAgent(options);\n        break;\n      }\n      case ConversationType.PERFORMANCE: {\n        agent = new PerformanceAgent(options);\n        break;\n      }\n    }\n    return agent;\n  }\n\n  async *\n      run(\n          initialQuery: string,\n          options: {\n            selected: ConversationContext<unknown>|null,\n            signal?: AbortSignal,\n          },\n          multimodalInput?: MultimodalInput,\n          ): AsyncGenerator<ResponseData, void, void> {\n    for await (const data of this.#agent.run(initialQuery, options, multimodalInput)) {\n      // We don't want to save partial responses to the conversation history.\n      if (data.type !== ResponseType.ANSWER || data.complete) {\n        void this.addHistoryItem(data);\n      }\n      yield data;\n    }\n  }\n\n  get origin(): string|undefined {\n    return this.#agent.origin;\n  }\n}\n\nfunction isAiAssistanceServerSideLoggingEnabled(): boolean {\n  return !Root.Runtime.hostConfig.aidaAvailability?.disallowLogging;\n}\n"]}