{"version":3,"file":"BuiltInAi.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_assistance/BuiltInAi.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../core/host/host.js';\nimport * as Root from '../../core/root/root.js';\n\nlet builtInAiInstance: BuiltInAi|undefined;\nlet availability: LanguageModelAvailability|undefined;\nlet hasGpu: boolean|undefined;\nlet isFirstRun = true;\n\nexport interface LanguageModel {\n  promptStreaming: (arg0: string, opts?: {\n    signal?: AbortSignal,\n  }) => AsyncGenerator<string>;\n  clone: () => LanguageModel;\n  destroy: () => void;\n}\n\nexport const enum LanguageModelAvailability {\n  UNAVAILABLE = 'unavailable',\n  DOWNLOADABLE = 'downloadable',\n  DOWNLOADING = 'downloading',\n  AVAILABLE = 'available',\n  DISABLED = 'disabled',\n}\n\nexport class BuiltInAi {\n  #consoleInsightsSession: LanguageModel;\n\n  static async getLanguageModelAvailability(): Promise<LanguageModelAvailability> {\n    if (!Root.Runtime.hostConfig.devToolsAiPromptApi?.enabled) {\n      return LanguageModelAvailability.DISABLED;\n    }\n    try {\n      // @ts-expect-error\n      availability = await window.LanguageModel.availability({expectedOutputs: [{type: 'text', languages: ['en']}]}) as\n          LanguageModelAvailability;\n      return availability;\n    } catch {\n      return LanguageModelAvailability.UNAVAILABLE;\n    }\n  }\n\n  static cachedIsAvailable(): boolean {\n    return availability === LanguageModelAvailability.AVAILABLE &&\n        (hasGpu || Boolean(Root.Runtime.hostConfig.devToolsAiPromptApi?.allowWithoutGpu));\n  }\n\n  static isGpuAvailable(): boolean {\n    const hasGpuHelper = (): boolean => {\n      const canvas = document.createElement('canvas');\n      try {\n        const webgl = canvas.getContext('webgl');\n        if (!webgl) {\n          return false;\n        }\n        const debugInfo = webgl.getExtension('WEBGL_debug_renderer_info');\n        if (!debugInfo) {\n          return false;\n        }\n        const renderer = webgl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);\n        if (renderer.includes('SwiftShader')) {\n          return false;\n        }\n      } catch {\n        return false;\n      }\n      return true;\n    };\n\n    if (hasGpu !== undefined) {\n      return hasGpu;\n    }\n    hasGpu = hasGpuHelper();\n    return hasGpu;\n  }\n\n  private constructor(consoleInsightsSession: LanguageModel) {\n    this.#consoleInsightsSession = consoleInsightsSession;\n  }\n\n  static async instance(): Promise<BuiltInAi|undefined> {\n    if (builtInAiInstance === undefined) {\n      if (isFirstRun) {\n        const languageModelAvailability = await BuiltInAi.getLanguageModelAvailability();\n        const hasGpu = BuiltInAi.isGpuAvailable();\n        if (hasGpu) {\n          switch (languageModelAvailability) {\n            case LanguageModelAvailability.UNAVAILABLE:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.UNAVAILABLE_HAS_GPU);\n              break;\n            case LanguageModelAvailability.DOWNLOADABLE:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DOWNLOADABLE_HAS_GPU);\n              break;\n            case LanguageModelAvailability.DOWNLOADING:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DOWNLOADING_HAS_GPU);\n              break;\n            case LanguageModelAvailability.AVAILABLE:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.AVAILABLE_HAS_GPU);\n              break;\n            case LanguageModelAvailability.DISABLED:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DISABLED_HAS_GPU);\n              break;\n          }\n        } else {\n          switch (languageModelAvailability) {\n            case LanguageModelAvailability.UNAVAILABLE:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.UNAVAILABLE_NO_GPU);\n              break;\n            case LanguageModelAvailability.DOWNLOADABLE:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DOWNLOADABLE_NO_GPU);\n              break;\n            case LanguageModelAvailability.DOWNLOADING:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DOWNLOADING_NO_GPU);\n              break;\n            case LanguageModelAvailability.AVAILABLE:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.AVAILABLE_NO_GPU);\n              break;\n            case LanguageModelAvailability.DISABLED:\n              Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DISABLED_NO_GPU);\n              break;\n          }\n        }\n        isFirstRun = false;\n        if (!Root.Runtime.hostConfig.devToolsAiPromptApi?.allowWithoutGpu && !hasGpu) {\n          return undefined;\n        }\n        if (languageModelAvailability !== LanguageModelAvailability.AVAILABLE) {\n          return undefined;\n        }\n      } else {\n        if (!Root.Runtime.hostConfig.devToolsAiPromptApi?.allowWithoutGpu && !BuiltInAi.isGpuAvailable()) {\n          return undefined;\n        }\n        if ((await BuiltInAi.getLanguageModelAvailability()) !== LanguageModelAvailability.AVAILABLE) {\n          return undefined;\n        }\n      }\n\n      try {\n        // @ts-expect-error\n        const consoleInsightsSession = await window.LanguageModel.create({\n          initialPrompts: [{\n            role: 'system',\n            content: `\n  You are an expert web developer. Your goal is to help a human web developer who\n  is using Chrome DevTools to debug a web site or web app. The Chrome DevTools\n  console is showing a message which is either an error or a warning. Please help\n  the user understand the problematic console message.\n\n  Your instructions are as follows:\n    - Explain the reason why the error or warning is showing up.\n    - The explanation has a maximum length of 200 characters. Anything beyond this\n      length will be cut off. Make sure that your explanation is at most 200 characters long.\n    - Your explanation should not end in the middle of a sentence.\n    - Your explanation should consist of a single paragraph only. Do not include any\n      headings or code blocks. Only write a single paragraph of text.\n    - Your response should be concise and to the point. Avoid lengthy explanations\n      or unnecessary details.\n            `\n          }],\n          expectedInputs: [{\n            type: 'text',\n            languages: ['en'],\n          }],\n          expectedOutputs: [{\n            type: 'text',\n            languages: ['en'],\n          }],\n        }) as LanguageModel;\n        builtInAiInstance = new BuiltInAi(consoleInsightsSession);\n      } catch {\n        return undefined;\n      }\n    }\n    return builtInAiInstance;\n  }\n\n  static removeInstance(): void {\n    builtInAiInstance = undefined;\n  }\n\n  async * getConsoleInsight(prompt: string, abortController: AbortController): AsyncGenerator<string> {\n    // Clone the session to start a fresh conversation for each answer. Otherwise\n    // previous dialog would pollute the context resulting in worse answers.\n    let session: LanguageModel|null = null;\n    try {\n      session = await this.#consoleInsightsSession.clone();\n      const stream = session.promptStreaming(prompt, {\n        signal: abortController.signal,\n      });\n      for await (const chunk of stream) {\n        yield chunk;\n      }\n    } finally {\n      if (session) {\n        session.destroy();\n      }\n    }\n  }\n}\n"]}