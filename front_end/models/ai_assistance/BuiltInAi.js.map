{"version":3,"file":"BuiltInAi.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_assistance/BuiltInAi.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Host from '../../core/host/host.js';\nimport * as Root from '../../core/root/root.js';\n\nlet builtInAiInstance: BuiltInAi|undefined;\n\nexport interface LanguageModel {\n  promptStreaming: (arg0: string, opts?: {\n    signal?: AbortSignal,\n  }) => AsyncGenerator<string>;\n  clone: () => Promise<LanguageModel>;\n  destroy: () => void;\n}\n\nexport const enum LanguageModelAvailability {\n  UNAVAILABLE = 'unavailable',\n  DOWNLOADABLE = 'downloadable',\n  DOWNLOADING = 'downloading',\n  AVAILABLE = 'available',\n  DISABLED = 'disabled',\n}\n\nexport class BuiltInAi extends Common.ObjectWrapper.ObjectWrapper<EventTypes> {\n  #availability: LanguageModelAvailability|null = null;\n  #hasGpu: boolean;\n  #consoleInsightsSession?: LanguageModel;\n  initDoneForTesting: Promise<void>;\n  #downloadProgress: number|null = null;\n  #currentlyCreatingSession = false;\n\n  static instance(): BuiltInAi {\n    if (builtInAiInstance === undefined) {\n      builtInAiInstance = new BuiltInAi();\n    }\n    return builtInAiInstance;\n  }\n\n  constructor() {\n    super();\n    this.#hasGpu = this.#isGpuAvailable();\n    this.initDoneForTesting =\n        this.getLanguageModelAvailability().then(() => this.#sendAvailabilityMetrics()).then(() => this.initialize());\n  }\n\n  async getLanguageModelAvailability(): Promise<LanguageModelAvailability> {\n    if (!Root.Runtime.hostConfig.devToolsAiPromptApi?.enabled) {\n      this.#availability = LanguageModelAvailability.DISABLED;\n      return this.#availability;\n    }\n    try {\n      // @ts-expect-error\n      this.#availability = await window.LanguageModel.availability({\n        expectedInputs: [{\n          type: 'text',\n          languages: ['en'],\n        }],\n        expectedOutputs: [{\n          type: 'text',\n          languages: ['en'],\n        }],\n      }) as LanguageModelAvailability;\n    } catch {\n      this.#availability = LanguageModelAvailability.UNAVAILABLE;\n    }\n    return this.#availability;\n  }\n\n  isDownloading(): boolean {\n    return this.#availability === LanguageModelAvailability.DOWNLOADING;\n  }\n\n  isEventuallyAvailable(): boolean {\n    if (!this.#hasGpu && !Boolean(Root.Runtime.hostConfig.devToolsAiPromptApi?.allowWithoutGpu)) {\n      return false;\n    }\n    return this.#availability === LanguageModelAvailability.AVAILABLE ||\n        this.#availability === LanguageModelAvailability.DOWNLOADING ||\n        this.#availability === LanguageModelAvailability.DOWNLOADABLE;\n  }\n\n  #setDownloadProgress(newValue: number): void {\n    this.#downloadProgress = newValue;\n    this.dispatchEventToListeners(Events.DOWNLOAD_PROGRESS_CHANGED, this.#downloadProgress);\n  }\n\n  getDownloadProgress(): number|null {\n    return this.#downloadProgress;\n  }\n\n  startDownloadingModel(): void {\n    if (!Root.Runtime.hostConfig.devToolsAiPromptApi?.allowWithoutGpu && !this.#hasGpu) {\n      return;\n    }\n    if (this.#availability !== LanguageModelAvailability.DOWNLOADABLE) {\n      return;\n    }\n\n    void this.#createSession();\n    // Without the timeout, the returned availability would still be `downloadable`\n    setTimeout(() => {\n      void this.getLanguageModelAvailability();\n    }, 1000);\n  }\n\n  #isGpuAvailable(): boolean {\n    const canvas = document.createElement('canvas');\n    try {\n      const webgl = canvas.getContext('webgl');\n      if (!webgl) {\n        return false;\n      }\n      const debugInfo = webgl.getExtension('WEBGL_debug_renderer_info');\n      if (!debugInfo) {\n        return false;\n      }\n      const renderer = webgl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);\n      if (renderer.includes('SwiftShader')) {\n        return false;\n      }\n    } catch {\n      return false;\n    }\n    return true;\n  }\n\n  hasSession(): boolean {\n    return Boolean(this.#consoleInsightsSession);\n  }\n\n  async initialize(): Promise<void> {\n    if (!Root.Runtime.hostConfig.devToolsAiPromptApi?.allowWithoutGpu && !this.#hasGpu) {\n      return;\n    }\n    if (this.#availability !== LanguageModelAvailability.AVAILABLE &&\n        this.#availability !== LanguageModelAvailability.DOWNLOADING) {\n      return;\n    }\n    await this.#createSession();\n  }\n\n  async #createSession(): Promise<void> {\n    if (this.#currentlyCreatingSession) {\n      return;\n    }\n    this.#currentlyCreatingSession = true;\n\n    const monitor = (m: EventTarget): void => {\n      m.addEventListener('downloadprogress', ((e: {loaded: number}) => {\n                                               this.#setDownloadProgress(e.loaded);\n                                             }) as unknown as EventListener);\n    };\n\n    try {\n      // @ts-expect-error\n      this.#consoleInsightsSession = await window.LanguageModel.create({\n        monitor,\n        initialPrompts: [{\n          role: 'system',\n          content: `\nYou are an expert web developer. Your goal is to help a human web developer who\nis using Chrome DevTools to debug a web site or web app. The Chrome DevTools\nconsole is showing a message which is either an error or a warning. Please help\nthe user understand the problematic console message.\n\nYour instructions are as follows:\n  - Explain the reason why the error or warning is showing up.\n  - The explanation has a maximum length of 200 characters. Anything beyond this\n    length will be cut off. Make sure that your explanation is at most 200 characters long.\n  - Your explanation should not end in the middle of a sentence.\n  - Your explanation should consist of a single paragraph only. Do not include any\n    headings or code blocks. Only write a single paragraph of text.\n  - Your response should be concise and to the point. Avoid lengthy explanations\n    or unnecessary details.\n          `\n        }],\n        expectedInputs: [{\n          type: 'text',\n          languages: ['en'],\n        }],\n        expectedOutputs: [{\n          type: 'text',\n          languages: ['en'],\n        }],\n      });\n      if (this.#availability !== LanguageModelAvailability.AVAILABLE) {\n        this.dispatchEventToListeners(Events.DOWNLOADED_AND_SESSION_CREATED);\n        void this.getLanguageModelAvailability();\n      }\n    } catch (e) {\n      console.error('Error when creating LanguageModel session', e.message);\n    }\n    this.#currentlyCreatingSession = false;\n  }\n\n  static removeInstance(): void {\n    builtInAiInstance = undefined;\n  }\n\n  async * getConsoleInsight(prompt: string, abortController: AbortController): AsyncGenerator<string> {\n    if (!this.#consoleInsightsSession) {\n      return;\n    }\n    // Clone the session to start a fresh conversation for each answer. Otherwise\n    // previous dialog would pollute the context resulting in worse answers.\n    let session: LanguageModel|null = null;\n    try {\n      session = await this.#consoleInsightsSession.clone();\n      const stream = session.promptStreaming(prompt, {\n        signal: abortController.signal,\n      });\n      for await (const chunk of stream) {\n        yield chunk;\n      }\n    } finally {\n      if (session) {\n        session.destroy();\n      }\n    }\n  }\n\n  #sendAvailabilityMetrics(): void {\n    if (this.#hasGpu) {\n      switch (this.#availability) {\n        case LanguageModelAvailability.UNAVAILABLE:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.UNAVAILABLE_HAS_GPU);\n          break;\n        case LanguageModelAvailability.DOWNLOADABLE:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DOWNLOADABLE_HAS_GPU);\n          break;\n        case LanguageModelAvailability.DOWNLOADING:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DOWNLOADING_HAS_GPU);\n          break;\n        case LanguageModelAvailability.AVAILABLE:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.AVAILABLE_HAS_GPU);\n          break;\n        case LanguageModelAvailability.DISABLED:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DISABLED_HAS_GPU);\n          break;\n      }\n    } else {\n      switch (this.#availability) {\n        case LanguageModelAvailability.UNAVAILABLE:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.UNAVAILABLE_NO_GPU);\n          break;\n        case LanguageModelAvailability.DOWNLOADABLE:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DOWNLOADABLE_NO_GPU);\n          break;\n        case LanguageModelAvailability.DOWNLOADING:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DOWNLOADING_NO_GPU);\n          break;\n        case LanguageModelAvailability.AVAILABLE:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.AVAILABLE_NO_GPU);\n          break;\n        case LanguageModelAvailability.DISABLED:\n          Host.userMetrics.builtInAiAvailability(Host.UserMetrics.BuiltInAiAvailability.DISABLED_NO_GPU);\n          break;\n      }\n    }\n  }\n}\n\nexport const enum Events {\n  DOWNLOAD_PROGRESS_CHANGED = 'downloadProgressChanged',\n  DOWNLOADED_AND_SESSION_CREATED = 'downloadedAndSessionCreated',\n}\n\nexport interface EventTypes {\n  [Events.DOWNLOAD_PROGRESS_CHANGED]: number;\n  [Events.DOWNLOADED_AND_SESSION_CREATED]: void;\n}\n"]}