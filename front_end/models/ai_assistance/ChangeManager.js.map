{"version":3,"file":"ChangeManager.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_assistance/ChangeManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as Protocol from '../../generated/protocol.js';\n\nexport interface Change {\n  groupId: string;\n  // Optional about where in the source the selector was defined.\n  sourceLocation?: string;\n  // Selector used by the page or a simple selector as the fallback.\n  selector: string;\n  // Selector computed based on the element attributes.\n  simpleSelector?: string;\n  className: string;\n  styles: Record<string, string>;\n}\n\nfunction formatStyles(styles: Record<string, string>, indent = 2): string {\n  const lines = Object.entries(styles).map(([key, value]) => `${' '.repeat(indent)}${key}: ${value};`);\n  return lines.join('\\n');\n}\n\n/**\n * Keeps track of changes done by the Styling agent. Currently, it is\n * primarily for stylesheet generation based on all changes.\n */\nexport class ChangeManager {\n  readonly #stylesheetMutex = new Common.Mutex.Mutex();\n  readonly #cssModelToStylesheetId =\n      new Map<SDK.CSSModel.CSSModel, Map<Protocol.Page.FrameId, Protocol.DOM.StyleSheetId>>();\n  readonly #stylesheetChanges = new Map<Protocol.DOM.StyleSheetId, Change[]>();\n  readonly #backupStylesheetChanges = new Map<Protocol.DOM.StyleSheetId, Change[]>();\n\n  constructor() {\n    SDK.TargetManager.TargetManager.instance().addModelListener(\n        SDK.ResourceTreeModel.ResourceTreeModel,\n        SDK.ResourceTreeModel.Events.PrimaryPageChanged,\n        this.clear,\n        this,\n    );\n  }\n\n  async stashChanges(): Promise<void> {\n    for (const [cssModel, stylesheetMap] of this.#cssModelToStylesheetId.entries()) {\n      const stylesheetIds = Array.from(stylesheetMap.values());\n      await Promise.allSettled(stylesheetIds.map(async id => {\n        this.#backupStylesheetChanges.set(id, this.#stylesheetChanges.get(id) ?? []);\n        this.#stylesheetChanges.delete(id);\n        await cssModel.setStyleSheetText(id, '', true);\n      }));\n    }\n  }\n\n  dropStashedChanges(): void {\n    this.#backupStylesheetChanges.clear();\n  }\n\n  async popStashedChanges(): Promise<void> {\n    const cssModelAndStyleSheets = Array.from(this.#cssModelToStylesheetId.entries());\n\n    await Promise.allSettled(cssModelAndStyleSheets.map(async ([cssModel, stylesheetMap]) => {\n      const frameAndStylesheet = Array.from(stylesheetMap.entries());\n      return await Promise.allSettled(frameAndStylesheet.map(async ([frameId, stylesheetId]) => {\n        const changes = this.#backupStylesheetChanges.get(stylesheetId) ?? [];\n        return await Promise.allSettled(changes.map(async change => {\n          return await this.addChange(cssModel, frameId, change);\n        }));\n      }));\n    }));\n  }\n\n  async clear(): Promise<void> {\n    const models = Array.from(this.#cssModelToStylesheetId.keys());\n    const results = await Promise.allSettled(models.map(async model => {\n      await this.#onCssModelDisposed({data: model});\n    }));\n    this.#cssModelToStylesheetId.clear();\n    this.#stylesheetChanges.clear();\n    this.#backupStylesheetChanges.clear();\n    const firstFailed = results.find(result => result.status === 'rejected');\n    if (firstFailed) {\n      console.error(firstFailed.reason);\n    }\n  }\n\n  async addChange(cssModel: SDK.CSSModel.CSSModel, frameId: Protocol.Page.FrameId, change: Change): Promise<string> {\n    const stylesheetId = await this.#getStylesheet(cssModel, frameId);\n    const changes = this.#stylesheetChanges.get(stylesheetId) || [];\n    const existingChange = changes.find(c => c.className === change.className);\n    // Make sure teh styles are real CSS values.\n    const stylesKebab = Platform.StringUtilities.toKebabCaseKeys(change.styles);\n    if (existingChange) {\n      Object.assign(existingChange.styles, stylesKebab);\n      // This combines all style changes for a given element,\n      // regardless of the conversation they originated from, into a single rule.\n      // While separating these changes by conversation would be ideal,\n      // it currently causes crashes in the Styles tab when duplicate selectors exist (crbug.com/393515428).\n      // This workaround avoids that crash.\n      existingChange.groupId = change.groupId;\n    } else {\n      changes.push({\n        ...change,\n        styles: stylesKebab,\n      });\n    }\n    const content = this.#formatChangesForInspectorStylesheet(changes);\n    await cssModel.setStyleSheetText(stylesheetId, content, true);\n    this.#stylesheetChanges.set(stylesheetId, changes);\n    return content;\n  }\n\n  formatChangesForPatching(groupId: string, includeSourceLocation = false): string {\n    return Array.from(this.#stylesheetChanges.values())\n        .flatMap(\n            changesPerStylesheet => changesPerStylesheet.filter(change => change.groupId === groupId)\n                                        .map(change => this.#formatChange(change, includeSourceLocation)))\n        .filter(change => change !== '')\n        .join('\\n\\n');\n  }\n\n  #formatChangesForInspectorStylesheet(changes: Change[]): string {\n    return changes\n        .map(change => {\n          return `.${change.className} {\n  ${change.selector}& {\n${formatStyles(change.styles, 4)}\n  }\n}`;\n        })\n        .join('\\n');\n  }\n\n  #formatChange(change: Change, includeSourceLocation = false): string {\n    const sourceLocation =\n        includeSourceLocation && change.sourceLocation ? `/* related resource: ${change.sourceLocation} */\\n` : '';\n    // TODO: includeSourceLocation indicates whether we are using Patch\n    // agent. If needed we can have an separate knob.\n    const simpleSelector =\n        includeSourceLocation && change.simpleSelector ? ` /* the element was ${change.simpleSelector} */` : '';\n    return `${sourceLocation}${change.selector} {${simpleSelector}\n${formatStyles(change.styles)}\n}`;\n  }\n\n  async #getStylesheet(cssModel: SDK.CSSModel.CSSModel, frameId: Protocol.Page.FrameId):\n      Promise<Protocol.DOM.StyleSheetId> {\n    return await this.#stylesheetMutex.run(async () => {\n      let frameToStylesheet = this.#cssModelToStylesheetId.get(cssModel);\n      if (!frameToStylesheet) {\n        frameToStylesheet = new Map();\n        this.#cssModelToStylesheetId.set(cssModel, frameToStylesheet);\n        cssModel.addEventListener(SDK.CSSModel.Events.ModelDisposed, this.#onCssModelDisposed, this);\n      }\n      let stylesheetId = frameToStylesheet.get(frameId);\n      if (!stylesheetId) {\n        const styleSheetHeader = await cssModel.createInspectorStylesheet(frameId, /* force */ true);\n        if (!styleSheetHeader) {\n          throw new Error('inspector-stylesheet is not found');\n        }\n        stylesheetId = styleSheetHeader.id;\n        frameToStylesheet.set(frameId, stylesheetId);\n      }\n      return stylesheetId;\n    });\n  }\n\n  async #onCssModelDisposed(event: Common.EventTarget.EventTargetEvent<SDK.CSSModel.CSSModel>): Promise<void> {\n    return await this.#stylesheetMutex.run(async () => {\n      const cssModel = event.data;\n      cssModel.removeEventListener(SDK.CSSModel.Events.ModelDisposed, this.#onCssModelDisposed, this);\n      const stylesheetIds = Array.from(this.#cssModelToStylesheetId.get(cssModel)?.values() ?? []);\n      // Empty stylesheets.\n      const results = await Promise.allSettled(stylesheetIds.map(async id => {\n        this.#stylesheetChanges.delete(id);\n        this.#backupStylesheetChanges.delete(id);\n        await cssModel.setStyleSheetText(id, '', true);\n      }));\n      this.#cssModelToStylesheetId.delete(cssModel);\n      const firstFailed = results.find(result => result.status === 'rejected');\n      if (firstFailed) {\n        throw new Error(firstFailed.reason);\n      }\n    });\n  }\n}\n"]}