{"version":3,"file":"ContextSelectionAgent.js","sourceRoot":"","sources":["../../../../../../../front_end/models/ai_assistance/agents/ContextSelectionAgent.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,MAAM,MAAM,gCAAgC,CAAC;AACzD,OAAO,KAAK,IAAI,MAAM,4BAA4B,CAAC;AACnD,OAAO,KAAK,IAAI,MAAM,4BAA4B,CAAC;AACnD,OAAO,KAAK,QAAQ,MAAM,oCAAoC,CAAC;AAC/D,OAAO,KAAK,IAAI,MAAM,4BAA4B,CAAC;AACnD,OAAO,KAAK,GAAG,MAAM,0BAA0B,CAAC;AAChD,OAAO,KAAK,IAAI,MAAM,oBAAoB,CAAC;AAC3C,OAAO,KAAK,SAAS,MAAM,8BAA8B,CAAC;AAE1D,OAAO,EAEL,OAAO,GAGR,MAAM,cAAc,CAAC;AAEtB,MAAM,YAAY,GAAG,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC;AAC5C;;;;GAIG;AACH,MAAM,QAAQ,GAAG;;;;;;;;;;;;;;;;;;;;;;;;CAwBhB,CAAC;AAEF;;;GAGG;AACH,MAAM,OAAO,qBAAsB,SAAQ,OAAc;IAC9C,QAAQ,GAAG,QAAQ,CAAC;IACpB,aAAa,GAAG,IAAI,CAAC,UAAU,CAAC,aAAa,CAAC,iBAAiB,CAAC;IACzE,IAAI,QAAQ;QACV,sCAAsC;QACtC,OAAO,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,kBAAkB,EAAE,QAAQ,CAAC;IAC9D,CAAC;IACD,IAAI,OAAO;QACT,MAAM,WAAW,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,6BAA6B,EAAE,WAAW,CAAC;QACvF,MAAM,OAAO,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,6BAA6B,EAAE,OAAO,CAAC;QAE/E,OAAO;YACL,WAAW;YACX,OAAO;SACR,CAAC;IACJ,CAAC;IAED,YAAY,IAAkB;QAC5B,KAAK,CAAC,IAAI,CAAC,CAAC;QAEZ,IAAI,CAAC,eAAe,CAAwB,qBAAqB,EAAE;YACjE,WAAW,EAAE,iFAAiF;YAC9F,UAAU,EAAE;gBACV,IAAI,gDAAwC;gBAC5C,WAAW,EAAE,EAAE;gBACf,QAAQ,EAAE,IAAI;gBACd,QAAQ,EAAE,EAAE;gBACZ,UAAU,EAAE,EAAE;aACf;YACD,mBAAmB,EAAE,GAAG,EAAE;gBACxB,OAAO;oBACL,KAAK,EAAE,YAAY,CAAC,2BAA2B,CAAC;oBAChD,MAAM,EAAE,sBAAsB;iBAC/B,CAAC;YACJ,CAAC;YACD,OAAO,EAAE,KAAK,IAAI,EAAE;gBAClB,MAAM,QAAQ,GAAG,EAAE,CAAC;gBACpB,MAAM,MAAM,GAAG,GAAG,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC,iBAAiB,EAAE,CAAC;gBAC9E,MAAM,YAAY,GAAG,MAAM,EAAE,YAAY,EAAE,CAAC;gBAC5C,MAAM,kBAAkB,GAAG,YAAY,CAAC,CAAC,CAAC,IAAI,MAAM,CAAC,SAAS,CAAC,SAAS,CAAC,YAAY,CAAC,CAAC,cAAc,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC;gBAE/G,KAAK,MAAM,OAAO,IAAI,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC,QAAQ,EAAE,EAAE,CAAC;oBACvE,IAAI,kBAAkB,IAAI,OAAO,CAAC,cAAc,EAAE,KAAK,kBAAkB,EAAE,CAAC;wBAC1E,SAAS;oBACX,CAAC;oBACD,QAAQ,CAAC,IAAI,CAAC;wBACZ,GAAG,EAAE,OAAO,CAAC,GAAG,EAAE;wBAClB,UAAU,EAAE,OAAO,CAAC,UAAU;wBAC9B,QAAQ,EAAE,OAAO,CAAC,QAAQ;qBAC3B,CAAC,CAAC;gBACL,CAAC;gBAED,OAAO;oBACL,MAAM,EAAE,QAAQ;iBACjB,CAAC;YACJ,CAAC;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,eAAe,CAAgB,sBAAsB,EAAE;YAC1D,WAAW,EAAE,uDAAuD;YACpE,UAAU,EAAE;gBACV,IAAI,gDAAwC;gBAC5C,WAAW,EAAE,EAAE;gBACf,QAAQ,EAAE,IAAI;gBACd,QAAQ,EAAE,CAAC,KAAK,CAAC;gBACjB,UAAU,EAAE;oBACV,GAAG,EAAE;wBACH,IAAI,gDAAwC;wBAC5C,WAAW,EAAE,yBAAyB;wBACtC,QAAQ,EAAE,KAAK;qBAChB;iBACF;aACF;YACD,mBAAmB,EAAE,IAAI,CAAC,EAAE;gBAC1B,OAAO;oBACL,KAAK,EAAE,YAAY,CAAC,0BAA0B,CAAC;oBAC/C,MAAM,EAAE,wBAAwB,IAAI,CAAC,GAAG,GAAG;iBAC5C,CAAC;YACJ,CAAC;YACD,OAAO,EAAE,KAAK,EAAE,EAAC,GAAG,EAAC,EAAE,EAAE;gBACvB,kEAAkE;gBAClE,MAAM,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC,QAAQ,EAAE,CAAC,IAAI,CAAC,GAAG,CAAC,EAAE;oBAC1E,OAAO,GAAG,CAAC,GAAG,EAAE,KAAK,QAAQ,CAAC,YAAY,CAAC,SAAS,CAAA,GAAG,GAAG,EAAE;wBACxD,GAAG,CAAC,GAAG,EAAE,KAAK,QAAQ,CAAC,YAAY,CAAC,SAAS,CAAA,GAAG,GAAG,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,EAAE;wBAClE,GAAG,CAAC,GAAG,EAAE,KAAK,QAAQ,CAAC,YAAY,CAAC,SAAS,CAAA,GAAG,GAAG,GAAG,CAAC;gBAC7D,CAAC,CAAC,CAAC;gBAEH,IAAI,OAAO,EAAE,CAAC;oBACZ,OAAO;wBACL,OAAO,EAAE,OAAO;qBACjB,CAAC;gBACJ,CAAC;gBAED,OAAO;oBACL,KAAK,EAAE,kBAAkB;iBAC1B,CAAC;YACJ,CAAC;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,eAAe,CAAwB,iBAAiB,EAAE;YAC7D,WAAW,EAAE,6CAA6C;YAC1D,UAAU,EAAE;gBACV,IAAI,gDAAwC;gBAC5C,WAAW,EAAE,EAAE;gBACf,QAAQ,EAAE,IAAI;gBACd,QAAQ,EAAE,EAAE;gBACZ,UAAU,EAAE,EAAE;aACf;YACD,mBAAmB,EAAE,GAAG,EAAE;gBACxB,OAAO;oBACL,KAAK,EAAE,YAAY,CAAC,0BAA0B,CAAC;oBAC/C,MAAM,EAAE,kBAAkB;iBAC3B,CAAC;YACJ,CAAC;YACD,OAAO,EAAE,KAAK,IAAI,EAAE;gBAClB,MAAM,KAAK,GAAG,EAAE,CAAC;gBACjB,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,iBAAiB,EAAE,EAAE,CAAC;oBAC5C,KAAK,CAAC,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC,CAAC;gBACrC,CAAC;gBAED,OAAO;oBACL,MAAM,EAAE,KAAK;iBACd,CAAC;YACJ,CAAC;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,eAAe,CAAiB,kBAAkB,EAAE;YACvD,WAAW,EAAE,6CAA6C;YAC1D,UAAU,EAAE;gBACV,IAAI,gDAAwC;gBAC5C,WAAW,EAAE,EAAE;gBACf,QAAQ,EAAE,IAAI;gBACd,QAAQ,EAAE,CAAC,MAAM,CAAC;gBAClB,UAAU,EAAE;oBACV,IAAI,EAAE;wBACJ,IAAI,gDAAwC;wBAC5C,WAAW,EAAE,sBAAsB;wBACnC,QAAQ,EAAE,KAAK;qBAChB;iBACF;aACF;YACD,mBAAmB,EAAE,IAAI,CAAC,EAAE;gBAC1B,OAAO;oBACL,KAAK,EAAE,YAAY,CAAC,qBAAqB,CAAC;oBAC1C,MAAM,EAAE,oBAAoB,IAAI,CAAC,IAAI,GAAG;iBACzC,CAAC;YACJ,CAAC;YACD,OAAO,EAAE,KAAK,EAAC,MAAM,EAAC,EAAE;gBACtB,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,iBAAiB,EAAE,EAAE,CAAC;oBAC5C,IAAI,IAAI,CAAC,eAAe,EAAE,KAAK,MAAM,CAAC,IAAI,EAAE,CAAC;wBAC3C,OAAO;4BACL,OAAO,EAAE,IAAI;yBACd,CAAC;oBACJ,CAAC;gBACH,CAAC;gBAED,OAAO,EAAC,KAAK,EAAE,sBAAsB,EAAC,CAAC;YACzC,CAAC;SACF,CAAC,CAAC;IACL,CAAC;IAED,iBAAiB,GAAG,GAAkD,EAAE;QACtE,MAAM,SAAS,GAAG,SAAS,CAAC,SAAS,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC;QAC/D,MAAM,QAAQ,GAAG,SAAS,CAAC,QAAQ,EAAE,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE;YACrD,QAAQ,OAAO,CAAC,IAAI,EAAE,EAAE,CAAC;gBACvB,KAAK,SAAS,CAAC,SAAS,CAAC,YAAY,CAAC,OAAO,CAAC;gBAC9C,KAAK,SAAS,CAAC,SAAS,CAAC,YAAY,CAAC,UAAU,CAAC;gBACjD,KAAK,SAAS,CAAC,SAAS,CAAC,YAAY,CAAC,qBAAqB;oBACzD,OAAO,IAAI,CAAC;gBAEd;oBACE,OAAO,KAAK,CAAC;YACjB,CAAC;QACH,CAAC,CAAC,CAAC;QACH,MAAM,aAAa,GAAG,EAAE,CAAC;QACzB,KAAK,MAAM,OAAO,IAAI,QAAQ,EAAE,CAAC;YAC/B,KAAK,MAAM,YAAY,IAAI,OAAO,CAAC,aAAa,EAAE,EAAE,CAAC;gBACnD,aAAa,CAAC,IAAI,CAAC,YAAY,CAAC,CAAC;YACnC,CAAC;QACH,CAAC;QAED,OAAO,aAAa,CAAC;IACvB,CAAC,CAAC;IAEF,KAAK,CAAC,CAAE,oBAAoB;IAC5B,CAAC;IAEQ,KAAK,CAAC,YAAY,CAAC,KAAa;QACvC,OAAO,KAAK,CAAC;IACf,CAAC;CACF","sourcesContent":["// Copyright 2026 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as Host from '../../../core/host/host.js';\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport * as Platform from '../../../core/platform/platform.js';\nimport * as Root from '../../../core/root/root.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport * as Logs from '../../logs/logs.js';\nimport * as Workspace from '../../workspace/workspace.js';\n\nimport {\n  type AgentOptions,\n  AiAgent,\n  type ContextResponse,\n  type RequestOptions,\n} from './AiAgent.js';\n\nconst lockedString = i18n.i18n.lockedString;\n/**\n * WARNING: preamble defined in code is only used when userTier is\n * TESTERS. Otherwise, a server-side preamble is used (see\n * chrome_preambles.gcl). Sync local changes with the server-side.\n */\nconst preamble = `\nYou are a Web Development Assistant integrated into Chrome DevTools. Your tone is educational, supportive, and technically precise.\nYou aim to help developers of all levels, prioritizing teaching web concepts as the primary entry point for any solution.\n\n# Considerations\n* Determine what the question the domain of the question is - styling, network, sources, performance or other part of DevTools.\n* When possible proactively try to gather additional data and select context that they user may find relevant to the question they are asking utilizing the function calls available to you.\n* Avoid making assumptions without sufficient evidence, and always seek further clarification if needed.\n* Always explore multiple possible explanations for the observed behavior before settling on a conclusion.\n* When presenting solutions, clearly distinguish between the primary cause and contributing factors.\n* Please answer only if you are sure about the answer. Otherwise, explain why you're not able to answer.\n* When answering, always consider MULTIPLE possible solutions.\n* If you are unable to gather more information provide a comprehensive guide to how to fix the issue using Chrome DevTools and explain how and why.\n* You can suggest any panel or flow in Chrome DevTools that may help the user out\n\n# Formatting Guidelines\n* Use Markdown for all code snippets.\n* Always specify the language for code blocks (e.g., \\`\\`\\`css, \\`\\`\\`javascript).\n* Keep text responses concise and scannable.\n\n* ALWAYS OUTPUT a list of follow-up queries at the end of your text response. The format is SUGGESTIONS: [\"suggestion1\", \"suggestion2\", \"suggestion3\"]. Make sure that the array and the \\`SUGGESTIONS: \\` text is in the same line. You're also capable of executing the fix for the issue user mentioned. Reflect this in your suggestions.\n* **CRITICAL** NEVER write full Python programs - you should only write individual statements that invoke a single function from the provided library.\n* **CRITICAL** NEVER output text before a function call. Always do a function call first.\n* **CRITICAL** You are a debugging assistant in DevTools. NEVER provide answers to questions of unrelated topics such as legal advice, financial advice, personal opinions, medical advice, religion, race, politics, sexuality, gender, or any other non web-development topics. Answer \"Sorry, I can't answer that. I'm best at questions about debugging web pages.\" to such questions.\n`;\n\n/**\n * One agent instance handles one conversation. Create a new agent\n * instance for a new conversation.\n */\nexport class ContextSelectionAgent extends AiAgent<never> {\n  readonly preamble = preamble;\n  readonly clientFeature = Host.AidaClient.ClientFeature.CHROME_FILE_AGENT;\n  get userTier(): string|undefined {\n    // TODO: Make this depend on variable.\n    return Root.Runtime.hostConfig.devToolsFreestyler?.userTier;\n  }\n  get options(): RequestOptions {\n    const temperature = Root.Runtime.hostConfig.devToolsAiAssistanceFileAgent?.temperature;\n    const modelId = Root.Runtime.hostConfig.devToolsAiAssistanceFileAgent?.modelId;\n\n    return {\n      temperature,\n      modelId,\n    };\n  }\n\n  constructor(opts: AgentOptions) {\n    super(opts);\n\n    this.declareFunction<Record<string, never>>('listNetworkRequests', {\n      description: `Gives a list of network requests including URL, status code, and duration in ms`,\n      parameters: {\n        type: Host.AidaClient.ParametersTypes.OBJECT,\n        description: '',\n        nullable: true,\n        required: [],\n        properties: {},\n      },\n      displayInfoFromArgs: () => {\n        return {\n          title: lockedString('Listing network requests…'),\n          action: 'listNetworkRequest()',\n        };\n      },\n      handler: async () => {\n        const requests = [];\n        const target = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n        const inspectedURL = target?.inspectedURL();\n        const mainSecurityOrigin = inspectedURL ? new Common.ParsedURL.ParsedURL(inspectedURL).securityOrigin() : null;\n\n        for (const request of Logs.NetworkLog.NetworkLog.instance().requests()) {\n          if (mainSecurityOrigin && request.securityOrigin() !== mainSecurityOrigin) {\n            continue;\n          }\n          requests.push({\n            url: request.url(),\n            statusCode: request.statusCode,\n            duration: request.duration,\n          });\n        }\n\n        return {\n          result: requests,\n        };\n      },\n    });\n\n    this.declareFunction<{url: string}>('selectNetworkRequest', {\n      description: `From the list of selected request select one to debug`,\n      parameters: {\n        type: Host.AidaClient.ParametersTypes.OBJECT,\n        description: '',\n        nullable: true,\n        required: ['url'],\n        properties: {\n          url: {\n            type: Host.AidaClient.ParametersTypes.STRING,\n            description: 'The url of the requests',\n            nullable: false,\n          },\n        },\n      },\n      displayInfoFromArgs: args => {\n        return {\n          title: lockedString('Getting network request…'),\n          action: `selectNetworkRequest(${args.url})`,\n        };\n      },\n      handler: async ({url}) => {\n        // TODO: Switch to using IDs to make is easier to link to as well.\n        const request = Logs.NetworkLog.NetworkLog.instance().requests().find(req => {\n          return req.url() === Platform.DevToolsPath.urlString`${url}` ||\n              req.url() === Platform.DevToolsPath.urlString`${url.slice(0, -1)}` ||\n              req.url() === Platform.DevToolsPath.urlString`${url}/`;\n        });\n\n        if (request) {\n          return {\n            context: request,\n          };\n        }\n\n        return {\n          error: 'No request found',\n        };\n      },\n    });\n\n    this.declareFunction<Record<string, never>>('listSourceFiles', {\n      description: `Returns a list of all files in the project.`,\n      parameters: {\n        type: Host.AidaClient.ParametersTypes.OBJECT,\n        description: '',\n        nullable: true,\n        required: [],\n        properties: {},\n      },\n      displayInfoFromArgs: () => {\n        return {\n          title: lockedString('Listing source requests…'),\n          action: 'listSourceFile()',\n        };\n      },\n      handler: async () => {\n        const files = [];\n        for (const file of this.#getUISourceCodes()) {\n          files.push(file.fullDisplayName());\n        }\n\n        return {\n          result: files,\n        };\n      },\n    });\n\n    this.declareFunction<{name: string}>('selectSourceFile', {\n      description: `Returns a list of all files in the project.`,\n      parameters: {\n        type: Host.AidaClient.ParametersTypes.OBJECT,\n        description: '',\n        nullable: true,\n        required: ['name'],\n        properties: {\n          name: {\n            type: Host.AidaClient.ParametersTypes.STRING,\n            description: 'The name of the file',\n            nullable: false,\n          },\n        },\n      },\n      displayInfoFromArgs: args => {\n        return {\n          title: lockedString('Getting source file'),\n          action: `selectSourceFile(${args.name})`,\n        };\n      },\n      handler: async params => {\n        for (const file of this.#getUISourceCodes()) {\n          if (file.fullDisplayName() === params.name) {\n            return {\n              context: file,\n            };\n          }\n        }\n\n        return {error: 'Unable to find file.'};\n      },\n    });\n  }\n\n  #getUISourceCodes = (): Iterable<Workspace.UISourceCode.UISourceCode> => {\n    const workspace = Workspace.Workspace.WorkspaceImpl.instance();\n    const projects = workspace.projects().filter(project => {\n      switch (project.type()) {\n        case Workspace.Workspace.projectTypes.Network:\n        case Workspace.Workspace.projectTypes.FileSystem:\n        case Workspace.Workspace.projectTypes.ConnectableFileSystem:\n          return true;\n\n        default:\n          return false;\n      }\n    });\n    const uiSourceCodes = [];\n    for (const project of projects) {\n      for (const uiSourceCode of project.uiSourceCodes()) {\n        uiSourceCodes.push(uiSourceCode);\n      }\n    }\n\n    return uiSourceCodes;\n  };\n\n  async * handleContextDetails(): AsyncGenerator<ContextResponse, void, void> {\n  }\n\n  override async enhanceQuery(query: string): Promise<string> {\n    return query;\n  }\n}\n"]}