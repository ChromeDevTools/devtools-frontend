{"version":3,"file":"AIContext.js","sourceRoot":"","sources":["../../../../../../../front_end/models/ai_assistance/performance/AIContext.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Trace from '../../../models/trace/trace.js';\n\nimport {AICallTree} from './AICallTree.js';\n\ninterface AgentFocusData {\n  parsedTrace: Trace.TraceModel.ParsedTrace;\n  /** Note: at most one of event or callTree is non-null. */\n  event: Trace.Types.Events.Event|null;\n  /** Note: at most one of event or callTree is non-null. */\n  callTree: AICallTree|null;\n  insight: Trace.Insights.Types.InsightModel|null;\n}\n\n/**\n * Gets the first, most relevant InsightSet to use, following the logic of:\n * 1. If there is only one InsightSet, use that.\n * 2. If there are more, prefer the first we find that has a navigation associated with it.\n * 3. If none with a navigation are found, fallback to the first one.\n * 4. Otherwise, return null.\n */\nfunction getPrimaryInsightSet(insights: Trace.Insights.Types.TraceInsightSets): Trace.Insights.Types.InsightSet|null {\n  const insightSets = Array.from(insights.values());\n  if (insightSets.length === 0) {\n    return null;\n  }\n  if (insightSets.length === 1) {\n    return insightSets[0];\n  }\n\n  return insightSets.filter(set => set.navigation).at(0) ?? insightSets.at(0) ?? null;\n}\n\nexport class AgentFocus {\n  static fromParsedTrace(parsedTrace: Trace.TraceModel.ParsedTrace): AgentFocus {\n    if (!parsedTrace.insights) {\n      throw new Error('missing insights');\n    }\n\n    return new AgentFocus({\n      parsedTrace,\n      event: null,\n      callTree: null,\n      insight: null,\n    });\n  }\n\n  static fromInsight(parsedTrace: Trace.TraceModel.ParsedTrace, insight: Trace.Insights.Types.InsightModel):\n      AgentFocus {\n    if (!parsedTrace.insights) {\n      throw new Error('missing insights');\n    }\n\n    return new AgentFocus({\n      parsedTrace,\n      event: null,\n      callTree: null,\n      insight,\n    });\n  }\n\n  static fromEvent(parsedTrace: Trace.TraceModel.ParsedTrace, event: Trace.Types.Events.Event): AgentFocus {\n    if (!parsedTrace.insights) {\n      throw new Error('missing insights');\n    }\n\n    const result = AgentFocus.#getCallTreeOrEvent(parsedTrace, event);\n    return new AgentFocus({parsedTrace, event: result.event, callTree: result.callTree, insight: null});\n  }\n\n  static fromCallTree(callTree: AICallTree): AgentFocus {\n    return new AgentFocus({parsedTrace: callTree.parsedTrace, event: null, callTree, insight: null});\n  }\n\n  #data: AgentFocusData;\n  #primaryInsightSet: Trace.Insights.Types.InsightSet|null;\n  readonly eventsSerializer = new Trace.EventsSerializer.EventsSerializer();\n\n  constructor(data: AgentFocusData) {\n    if (!data.parsedTrace.insights) {\n      throw new Error('missing insights');\n    }\n\n    this.#data = data;\n    this.#primaryInsightSet = getPrimaryInsightSet(data.parsedTrace.insights);\n  }\n\n  get parsedTrace(): Trace.TraceModel.ParsedTrace {\n    return this.#data.parsedTrace;\n  }\n\n  get primaryInsightSet(): Trace.Insights.Types.InsightSet|null {\n    return this.#primaryInsightSet;\n  }\n\n  /** Note: at most one of event or callTree is non-null. */\n  get event(): Trace.Types.Events.Event|null {\n    return this.#data.event;\n  }\n\n  /** Note: at most one of event or callTree is non-null. */\n  get callTree(): AICallTree|null {\n    return this.#data.callTree;\n  }\n\n  get insight(): Trace.Insights.Types.InsightModel|null {\n    return this.#data.insight;\n  }\n\n  withInsight(insight: Trace.Insights.Types.InsightModel|null): AgentFocus {\n    const focus = new AgentFocus(this.#data);\n    focus.#data.insight = insight;\n    return focus;\n  }\n\n  withEvent(event: Trace.Types.Events.Event|null): AgentFocus {\n    const focus = new AgentFocus(this.#data);\n    const result = AgentFocus.#getCallTreeOrEvent(this.#data.parsedTrace, event);\n    focus.#data.callTree = result.callTree;\n    focus.#data.event = result.event;\n    return focus;\n  }\n\n  lookupEvent(key: Trace.Types.File.SerializableKey): Trace.Types.Events.Event|null {\n    try {\n      return this.eventsSerializer.eventForKey(key, this.#data.parsedTrace);\n    } catch (err) {\n      if (err.toString().includes('Unknown trace event') || err.toString().includes('Unknown profile call')) {\n        return null;\n      }\n\n      throw err;\n    }\n  }\n\n  /**\n   * If an event is a call tree, this returns that call tree and a null event.\n   * If not a call tree, this only returns a non-null event if the event is a network\n   * request.\n   * This is an arbitrary limitation â€“ it should be removed, but first we need to\n   * improve the agent's knowledge of events that are not main-thread or network\n   * events.\n   */\n  static #getCallTreeOrEvent(parsedTrace: Trace.TraceModel.ParsedTrace, event: Trace.Types.Events.Event|null):\n      {callTree: AICallTree|null, event: Trace.Types.Events.Event|null} {\n    const callTree = event && AICallTree.fromEvent(event, parsedTrace);\n    if (callTree) {\n      return {callTree, event: null};\n    }\n    if (event && Trace.Types.Events.isSyntheticNetworkRequest(event)) {\n      return {callTree: null, event};\n    }\n    return {callTree: null, event: null};\n  }\n}\n\nexport function getPerformanceAgentFocusFromModel(model: Trace.TraceModel.Model): AgentFocus|null {\n  const parsedTrace = model.parsedTrace();\n  if (!parsedTrace) {\n    return null;\n  }\n\n  return AgentFocus.fromParsedTrace(parsedTrace);\n}\n"]}