{"version":3,"file":"AIQueries.js","sourceRoot":"","sources":["../../../../../../../front_end/models/ai_assistance/performance/AIQueries.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,KAAK,MAAM,gCAAgC,CAAC;AAExD,OAAO,EAAC,UAAU,EAAC,MAAM,iBAAiB,CAAC;AAE3C,MAAM,OAAO,SAAS;IACpB,MAAM,CAAC,cAAc,CAAC,YAA8B,EAAE,WAAyC;QAE7F;;;;;;;;;;;;WAYG;QACH,IAAI,aAAa,GAAsC,IAAI,CAAC;QAC5D,IAAI,aAAa,GAAqC,IAAI,CAAC;QAE3D,IAAI,YAAY,EAAE,CAAC;YACjB,MAAM,UAAU,GAAG,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,yBAAyB,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;YACrF,IAAI,UAAU,EAAE,IAAI,CAAC,IAAI,EAAE,oBAAoB,EAAE,CAAC;gBAChD,aAAa,GAAG,UAAU,CAAC,GAAG,CAAC;gBAC/B,aAAa,GAAG,UAAU,CAAC,GAAG,CAAC;YACjC,CAAC;QACH,CAAC;QAED,MAAM,OAAO,GAAG,KAAK,CAAC,QAAQ,CAAC,OAAO,CAAC,cAAc,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QACxE,MAAM,MAAM,GAAG,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;YACnC,IAAI,aAAa,IAAI,aAAa,EAAE,CAAC;gBACnC,OAAO,MAAM,CAAC,GAAG,KAAK,aAAa,IAAI,MAAM,CAAC,GAAG,KAAK,aAAa,CAAC;YACtE,CAAC;YACD,OAAO,MAAM,CAAC,IAAI,sEAAkD,CAAC;QACvE,CAAC,CAAC,CAAC;QAEH,OAAO,MAAM,IAAI,IAAI,CAAC;IACxB,CAAC;IAED;;OAEG;IACH,MAAM,CAAC,0BAA0B,CAC7B,YAA8B,EAAE,MAA2C,EAC3E,WAAyC;QAC3C,MAAM,MAAM,GAAG,IAAI,CAAC,cAAc,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;QAC9D,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,MAAM,GAAG,UAAU,CAAC,mBAAmB,CAAC,EAAC,MAAM,EAAE,WAAW,EAAE,MAAM,EAAC,CAAC,CAAC;QAC7E,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,IAAI,CAAC;QACd,CAAC;QAED,2EAA2E;QAC3E,MAAM,aAAa,GAAG,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,yBAAyB,CAAC,MAAM,EAAE,CAAC,OAAO,EAAE,CAAC;QACvF,MAAM,MAAM,GAAG,IAAI,KAAK,CAAC,MAAM,CAAC,WAAW,CAAC,mBAAmB,CAC3D,aAAa,CAAC,MAAM,CAAC,mFAAmD,CAAC,CAAC,CAAC;QAE/E,2FAA2F;QAC3F,MAAM,SAAS,GAAG,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAChE,MAAM,OAAO,GAAG,KAAK,CAAC,OAAO,CAAC,MAAM,CAAC,YAAY,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC;QAC9D,OAAO,IAAI,KAAK,CAAC,MAAM,CAAC,SAAS,CAAC,gBAAgB,CAAC,MAAM,EAAE;YACzD,UAAU,EAAE,IAAI,KAAK,CAAC,MAAM,CAAC,WAAW,CAAC,mBAAmB,CAAC,EAAE,CAAC;YAChE,OAAO,EAAE,CAAC,MAAM,CAAC;YACjB,SAAS;YACT,OAAO;SACR,CAAC,CAAC;IACL,CAAC;IAED;;;OAGG;IACH,MAAM,CAAC,yBAAyB,CAC5B,YAA8B,EAAE,MAA2C,EAC3E,WAAyC;QAC3C,MAAM,MAAM,GAAG,IAAI,CAAC,cAAc,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;QAC9D,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,IAAI,CAAC;QACd,CAAC;QAED,OAAO,UAAU,CAAC,gBAAgB,CAAC;YACjC,MAAM,EAAE;gBACN,GAAG,EAAE,MAAM,CAAC,GAAG;gBACf,GAAG,EAAE,MAAM,CAAC,GAAG;aAChB;YACD,WAAW;YACX,MAAM;SACP,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,MAAM,CAAC,YAAY,CACf,YAA8B,EAAE,MAA2C,EAC3E,WAAyC,EAAE,KAAK,GAAG,CAAC;QACtD,MAAM,MAAM,GAAG,IAAI,CAAC,cAAc,CAAC,YAAY,EAAE,WAAW,CAAC,CAAC;QAC9D,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,KAAK,GAAG,UAAU,CAAC,mBAAmB,CAAC,EAAC,MAAM,EAAE,WAAW,EAAE,MAAM,EAAC,CAAC,CAAC;QAC5E,IAAI,CAAC,KAAK,EAAE,CAAC;YACX,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,QAAQ,GAAG,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,KAAK,SAAS,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,GAAG,GAAG,CAAC,CAAC,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,KAAK,CAAC,CAAC;QACvG,OAAO,QAAQ;aACV,GAAG,CAAC,IAAI,CAAC,EAAE;YACV,MAAM,IAAI,GAAG,UAAU,CAAC,SAAS,CAAC,IAAI,EAAE,WAAW,CAAC,CAAC;YACrD,IAAI,IAAI,EAAE,CAAC;gBACT,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;YAC3B,CAAC;YACD,OAAO,IAAI,CAAC;QACd,CAAC,CAAC;aACD,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC;IAC9B,CAAC;CACF","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Trace from '../../../models/trace/trace.js';\n\nimport {AICallTree} from './AICallTree.js';\n\nexport class AIQueries {\n  static findMainThread(navigationId: string|undefined, parsedTrace: Trace.TraceModel.ParsedTrace):\n      Trace.Handlers.Threads.ThreadData|null {\n    /**\n     * We cannot assume that there is one main thread as there are scenarios\n     * where there can be multiple (see crbug.com/402658800) as an example.\n     * Therefore we calculate the main thread by using the thread that the\n     * Insight has been associated to. Most Insights relate to a navigation, so\n     * in this case we can use the navigation's PID/TID as we know that will\n     * have run on the main thread that we are interested in.\n     * If we do not have a navigation, we fall back to looking for the first\n     * thread we find that is of type MAIN_THREAD.\n     * Longer term we should solve this at the Trace Engine level to avoid\n     * look-ups like this; this is the work that is tracked in\n     * crbug.com/402658800.\n     */\n    let mainThreadPID: Trace.Types.Events.ProcessID|null = null;\n    let mainThreadTID: Trace.Types.Events.ThreadID|null = null;\n\n    if (navigationId) {\n      const navigation = parsedTrace.data.Meta.navigationsByNavigationId.get(navigationId);\n      if (navigation?.args.data?.isOutermostMainFrame) {\n        mainThreadPID = navigation.pid;\n        mainThreadTID = navigation.tid;\n      }\n    }\n\n    const threads = Trace.Handlers.Threads.threadsInTrace(parsedTrace.data);\n    const thread = threads.find(thread => {\n      if (mainThreadPID && mainThreadTID) {\n        return thread.pid === mainThreadPID && thread.tid === mainThreadTID;\n      }\n      return thread.type === Trace.Handlers.Threads.ThreadType.MAIN_THREAD;\n    });\n\n    return thread ?? null;\n  }\n\n  /**\n   * Returns bottom up activity for the given range.\n   */\n  static mainThreadActivityBottomUp(\n      navigationId: string|undefined, bounds: Trace.Types.Timing.TraceWindowMicro,\n      parsedTrace: Trace.TraceModel.ParsedTrace): Trace.Extras.TraceTree.BottomUpRootNode|null {\n    const thread = this.findMainThread(navigationId, parsedTrace);\n    if (!thread) {\n      return null;\n    }\n\n    const events = AICallTree.findEventsForThread({thread, parsedTrace, bounds});\n    if (!events) {\n      return null;\n    }\n\n    // Use the same filtering as front_end/panels/timeline/TimelineTreeView.ts.\n    const visibleEvents = Trace.Helpers.Trace.VISIBLE_TRACE_EVENT_TYPES.values().toArray();\n    const filter = new Trace.Extras.TraceFilter.VisibleEventsFilter(\n        visibleEvents.concat([Trace.Types.Events.Name.SYNTHETIC_NETWORK_REQUEST]));\n\n    // The bottom up root node handles all the \"in Tracebounds\" checks we need for the insight.\n    const startTime = Trace.Helpers.Timing.microToMilli(bounds.min);\n    const endTime = Trace.Helpers.Timing.microToMilli(bounds.max);\n    return new Trace.Extras.TraceTree.BottomUpRootNode(events, {\n      textFilter: new Trace.Extras.TraceFilter.ExclusiveNameFilter([]),\n      filters: [filter],\n      startTime,\n      endTime,\n    });\n  }\n\n  /**\n   * Returns an AI Call Tree representing the activity on the main thread for\n   * the relevant time range of the given insight.\n   */\n  static mainThreadActivityTopDown(\n      navigationId: string|undefined, bounds: Trace.Types.Timing.TraceWindowMicro,\n      parsedTrace: Trace.TraceModel.ParsedTrace): AICallTree|null {\n    const thread = this.findMainThread(navigationId, parsedTrace);\n    if (!thread) {\n      return null;\n    }\n\n    return AICallTree.fromTimeOnThread({\n      thread: {\n        pid: thread.pid,\n        tid: thread.tid,\n      },\n      parsedTrace,\n      bounds,\n    });\n  }\n\n  /**\n   * Returns the top longest tasks as AI Call Trees.\n   */\n  static longestTasks(\n      navigationId: string|undefined, bounds: Trace.Types.Timing.TraceWindowMicro,\n      parsedTrace: Trace.TraceModel.ParsedTrace, limit = 3): AICallTree[]|null {\n    const thread = this.findMainThread(navigationId, parsedTrace);\n    if (!thread) {\n      return null;\n    }\n\n    const tasks = AICallTree.findMainThreadTasks({thread, parsedTrace, bounds});\n    if (!tasks) {\n      return null;\n    }\n\n    const topTasks = tasks.filter(e => e.name === 'RunTask').sort((a, b) => b.dur - a.dur).slice(0, limit);\n    return topTasks\n        .map(task => {\n          const tree = AICallTree.fromEvent(task, parsedTrace);\n          if (tree) {\n            tree.selectedNode = null;\n          }\n          return tree;\n        })\n        .filter(tree => !!tree);\n  }\n}\n"]}