{"version":3,"file":"AiCodeCompletion.js","sourceRoot":"","sources":["../../../../../../front_end/models/ai_code_completion/AiCodeCompletion.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../core/host/host.js';\nimport * as Root from '../../core/root/root.js';\n\nimport {debugLog} from './debug.js';\n\n/**\n * TODO(b/404796739): Remove these definitions of AgentOptions and RequestOptions and\n * use the existing ones which are used for AI assistance panel agents.\n **/\ninterface AgentOptions {\n  aidaClient: Host.AidaClient.AidaClient;\n  serverSideLoggingEnabled?: boolean;\n  confirmSideEffectForTest?: typeof Promise.withResolvers;\n}\n\ninterface RequestOptions {\n  temperature?: number;\n  modelId?: string;\n}\n\ninterface CachedRequest {\n  request: Host.AidaClient.CompletionRequest;\n  response: Host.AidaClient.CompletionResponse;\n}\n\nexport interface Callbacks {\n  getSelectionHead: () => number;\n  getCompletionHint: () => string | undefined | null;\n  setAiAutoCompletion: (args: {\n    text: string,\n    from: number,\n    startTime: number,\n    onImpression: (rpcGlobalId: Host.AidaClient.RpcGlobalId, latency: number, sampleId?: number) => void,\n    clearCachedRequest: () => void,\n    rpcGlobalId?: Host.AidaClient.RpcGlobalId,\n    sampleId?: number,\n  }|null) => void;\n}\n\n/* clang-format off */\nexport const consoleAdditionalContextFileContent = `/**\n * This file describes the execution environment of the Chrome DevTools Console.\n * The code is JavaScript, but with special global functions and variables.\n * Top-level await is available.\n * The console has direct access to the inspected page's \\`window\\` and \\`document\\`.\n */\n\n/**\n * @description Returns the value of the most recently evaluated expression.\n */\nlet $_;\n\n/**\n * @description A reference to the most recently selected DOM element.\n * $0, $1, $2, $3, $4 can be used to reference the last five selected DOM elements.\n */\nlet $0;\n\n/**\n * @description A query selector alias. $$('.my-class') is equivalent to document.querySelectorAll('.my-class').\n */\nfunction $$(selector, startNode) {}\n\n/**\n * @description An XPath selector. $x('//p') returns an array of all <p> elements.\n */\nfunction $x(path, startNode) {}\n\nfunction clear() {}\n\nfunction copy(object) {}\n\n/**\n * @description Selects and reveals the specified element in the Elements panel.\n */\nfunction inspect(object) {}\n\nfunction keys(object) {}\n\nfunction values(object) {}\n\n/**\n * @description When the specified function is called, the debugger is invoked.\n */\nfunction debug(func) {}\n\n/**\n * @description Stops the debugging of the specified function.\n */\nfunction undebug(func) {}\n\n/**\n * @description Logs a message to the console whenever the specified function is called,\n * along with the arguments passed to it.\n */\nfunction monitor(func) {}\n\n/**\n * @description Stops monitoring the specified function.\n */\nfunction unmonitor(func) {}\n\n/**\n * @description Logs all events dispatched to the specified object to the console.\n */\nfunction monitorEvents(object, events) {}\n\n/**\n * @description Returns an object containing all event listeners registered on the specified object.\n */\nfunction getEventListeners(object) {}\n\n/**\n * The global \\`console\\` object has several helpful methods\n */\nconst console = {\n  log: (...args) => {},\n  warn: (...args) => {},\n  error: (...args) => {},\n  info: (...args) => {},\n  debug: (...args) => {},\n  assert: (assertion, ...args) => {},\n  dir: (object) => {}, // Displays an interactive property listing of an object.\n  dirxml: (object) => {}, // Displays an XML/HTML representation of an object.\n  table: (data, columns) => {}, // Displays tabular data as a table.\n  group: (label) => {}, // Creates a new inline collapsible group.\n  groupEnd: () => {},\n  time: (label) => {}, // Starts a timer.\n  timeEnd: (label) => {} // Stops a timer and logs the elapsed time.\n};`;\n/* clang-format on */\n\n/**\n * The AiCodeCompletion class is responsible for fetching code completion suggestions\n * from the AIDA backend.\n */\nexport class AiCodeCompletion {\n  #stopSequences: string[];\n  #renderingTimeout?: number;\n  #aidaRequestCache?: CachedRequest;\n  // TODO(b/445394511): Remove panel from the class\n  #panel: ContextFlavor;\n  #callbacks?: Callbacks;\n\n  readonly #sessionId: string = crypto.randomUUID();\n  readonly #aidaClient: Host.AidaClient.AidaClient;\n  readonly #serverSideLoggingEnabled: boolean;\n\n  constructor(opts: AgentOptions, panel: ContextFlavor, callbacks?: Callbacks, stopSequences?: string[]) {\n    this.#aidaClient = opts.aidaClient;\n    this.#serverSideLoggingEnabled = opts.serverSideLoggingEnabled ?? false;\n    this.#panel = panel;\n    this.#stopSequences = stopSequences ?? [];\n    this.#callbacks = callbacks;\n  }\n\n  #buildRequest(\n      prefix: string, suffix: string,\n      inferenceLanguage: Host.AidaClient.AidaInferenceLanguage = Host.AidaClient.AidaInferenceLanguage.JAVASCRIPT,\n      additionalFiles?: Host.AidaClient.AdditionalFile[]): Host.AidaClient.CompletionRequest {\n    const userTier = Host.AidaClient.convertToUserTierEnum(this.#userTier);\n    function validTemperature(temperature: number|undefined): number|undefined {\n      return typeof temperature === 'number' && temperature >= 0 ? temperature : undefined;\n    }\n    // As a temporary fix for b/441221870 we are prepending a newline for each prefix.\n    prefix = '\\n' + prefix;\n\n    let additionalContextFiles = additionalFiles ?? undefined;\n    if (!additionalContextFiles) {\n      additionalContextFiles = this.#panel === ContextFlavor.CONSOLE ? [{\n        path: 'devtools-console-context.js',\n        content: consoleAdditionalContextFileContent,\n        included_reason: Host.AidaClient.Reason.RELATED_FILE,\n      }] :\n                                                                       undefined;\n    }\n    return {\n      client: Host.AidaClient.CLIENT_NAME,\n      prefix,\n      suffix,\n      options: {\n        inference_language: inferenceLanguage,\n        temperature: validTemperature(this.#options.temperature),\n        model_id: this.#options.modelId || undefined,\n        stop_sequences: this.#stopSequences,\n      },\n      metadata: {\n        disable_user_content_logging: !(this.#serverSideLoggingEnabled ?? false),\n        string_session_id: this.#sessionId,\n        user_tier: userTier,\n        client_version: Root.Runtime.getChromeVersion(),\n      },\n      additional_files: additionalContextFiles,\n    };\n  }\n\n  async #completeCodeCached(request: Host.AidaClient.CompletionRequest): Promise<{\n    response: Host.AidaClient.CompletionResponse | null,\n    fromCache: boolean,\n  }> {\n    const cachedResponse = this.#checkCachedRequestForResponse(request);\n    if (cachedResponse) {\n      return {response: cachedResponse, fromCache: true};\n    }\n\n    const response = await this.#aidaClient.completeCode(request);\n    if (!response) {\n      return {\n        response: null,\n        fromCache: false,\n      };\n    }\n\n    this.#updateCachedRequest(request, response);\n    return {\n      response,\n      fromCache: false,\n    };\n  }\n\n  get #userTier(): string|undefined {\n    return Root.Runtime.hostConfig.devToolsAiCodeCompletion?.userTier;\n  }\n\n  get #options(): RequestOptions {\n    const temperature = Root.Runtime.hostConfig.devToolsAiCodeCompletion?.temperature;\n    const modelId = Root.Runtime.hostConfig.devToolsAiCodeCompletion?.modelId;\n\n    return {\n      temperature,\n      modelId,\n    };\n  }\n\n  #checkCachedRequestForResponse(request: Host.AidaClient.CompletionRequest): Host.AidaClient.CompletionResponse|null {\n    if (!this.#aidaRequestCache || this.#aidaRequestCache.request.suffix !== request.suffix ||\n        JSON.stringify(this.#aidaRequestCache.request.options) !== JSON.stringify(request.options)) {\n      return null;\n    }\n    const possibleGeneratedSamples: Host.AidaClient.GenerationSample[] = [];\n    for (const sample of this.#aidaRequestCache.response.generatedSamples) {\n      const prefixWithSample = this.#aidaRequestCache.request.prefix + sample.generationString;\n      if (prefixWithSample.startsWith(request.prefix)) {\n        possibleGeneratedSamples.push({\n          generationString: prefixWithSample.substring(request.prefix.length),\n          sampleId: sample.sampleId,\n          score: sample.score,\n          attributionMetadata: sample.attributionMetadata,\n        });\n      }\n    }\n    if (possibleGeneratedSamples.length === 0) {\n      return null;\n    }\n    return {generatedSamples: possibleGeneratedSamples, metadata: this.#aidaRequestCache.response.metadata};\n  }\n\n  #updateCachedRequest(request: Host.AidaClient.CompletionRequest, response: Host.AidaClient.CompletionResponse): void {\n    this.#aidaRequestCache = {request, response};\n  }\n\n  registerUserImpression(rpcGlobalId: Host.AidaClient.RpcGlobalId, latency: number, sampleId?: number): void {\n    const seconds = Math.floor(latency / 1_000);\n    const remainingMs = latency % 1_000;\n    const nanos = Math.floor(remainingMs * 1_000_000);\n\n    void this.#aidaClient.registerClientEvent({\n      corresponding_aida_rpc_global_id: rpcGlobalId,\n      disable_user_content_logging: true,\n      complete_code_client_event: {\n        user_impression: {\n          sample: {\n            sample_id: sampleId,\n          },\n          latency: {\n            duration: {\n              seconds,\n              nanos,\n            },\n          }\n        },\n      },\n    });\n    debugLog('Registered user impression with latency {seconds:', seconds, ', nanos:', nanos, '}');\n    Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiCodeCompletionSuggestionDisplayed);\n  }\n\n  registerUserAcceptance(rpcGlobalId: Host.AidaClient.RpcGlobalId, sampleId?: number): void {\n    void this.#aidaClient.registerClientEvent({\n      corresponding_aida_rpc_global_id: rpcGlobalId,\n      disable_user_content_logging: true,\n      complete_code_client_event: {\n        user_acceptance: {\n          sample: {\n            sample_id: sampleId,\n          }\n        },\n      },\n    });\n    debugLog('Registered user acceptance');\n    Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiCodeCompletionSuggestionAccepted);\n  }\n\n  clearCachedRequest(): void {\n    this.#aidaRequestCache = undefined;\n  }\n\n  async completeCode(\n      prefix: string, suffix: string, cursorPositionAtRequest: number,\n      inferenceLanguage?: Host.AidaClient.AidaInferenceLanguage,\n      additionalFiles?: Host.AidaClient.AdditionalFile[]): Promise<{\n    response: Host.AidaClient.CompletionResponse | null,\n    fromCache: boolean,\n  }> {\n    const request = this.#buildRequest(prefix, suffix, inferenceLanguage, additionalFiles);\n    const {response, fromCache} = await this.#completeCodeCached(request);\n\n    debugLog('At cursor position', cursorPositionAtRequest, {request, response, fromCache});\n    if (!response) {\n      return {response: null, fromCache: false};\n    }\n\n    return {response, fromCache};\n  }\n\n  remove(): void {\n    if (this.#renderingTimeout) {\n      clearTimeout(this.#renderingTimeout);\n      this.#renderingTimeout = undefined;\n    }\n    this.#callbacks?.setAiAutoCompletion(null);\n  }\n\n  static isAiCodeCompletionEnabled(locale: string): boolean {\n    if (!locale.startsWith('en-')) {\n      return false;\n    }\n    const aidaAvailability = Root.Runtime.hostConfig.aidaAvailability;\n    if (!aidaAvailability || aidaAvailability.blockedByGeo || aidaAvailability.blockedByAge ||\n        aidaAvailability.blockedByEnterprisePolicy) {\n      return false;\n    }\n    return Boolean(aidaAvailability.enabled && Root.Runtime.hostConfig.devToolsAiCodeCompletion?.enabled);\n  }\n}\n\nexport const enum ContextFlavor {\n  CONSOLE = 'console',  // generated code can contain console specific APIs like `$0`.\n  SOURCES = 'sources',\n}\n"]}