{
  "version": 3,
  "sources": ["../../../../../../front_end/models/ai_code_completion/debug.ts", "../../../../../../front_end/models/ai_code_completion/AiCodeCompletion.ts"],
  "sourcesContent": ["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/**\n * @file Local debugging utilities.\n */\n\nexport function isDebugMode(): boolean {\n  return Boolean(localStorage.getItem('debugAiCodeCompletionEnabled'));\n}\n\nexport function debugLog(...log: unknown[]): void {\n  if (!isDebugMode()) {\n    return;\n  }\n\n  // eslint-disable-next-line no-console\n  console.log(...log);\n}\n\nfunction setDebugAiCodeCompletionEnabled(enabled: boolean): void {\n  if (enabled) {\n    localStorage.setItem('debugAiCodeCompletionEnabled', 'true');\n  } else {\n    localStorage.removeItem('debugAiCodeCompletionEnabled');\n  }\n}\n// @ts-expect-error\nglobalThis.setDebugAiCodeCompletionEnabled = setDebugAiCodeCompletionEnabled;\n", "// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../core/host/host.js';\nimport * as Root from '../../core/root/root.js';\n\nimport {debugLog} from './debug.js';\n\n/**\n * TODO(b/404796739): Remove these definitions of AgentOptions and RequestOptions and\n * use the existing ones which are used for AI assistance panel agents.\n **/\ninterface AgentOptions {\n  aidaClient: Host.AidaClient.AidaClient;\n  serverSideLoggingEnabled?: boolean;\n  confirmSideEffectForTest?: typeof Promise.withResolvers;\n}\n\ninterface RequestOptions {\n  temperature?: number;\n  modelId?: string;\n}\n\ninterface CachedRequest {\n  request: Host.AidaClient.CompletionRequest;\n  response: Host.AidaClient.CompletionResponse;\n}\n\nexport interface Callbacks {\n  getSelectionHead: () => number;\n  getCompletionHint: () => string | undefined | null;\n  setAiAutoCompletion: (args: {\n    text: string,\n    from: number,\n    startTime: number,\n    onImpression: (rpcGlobalId: Host.AidaClient.RpcGlobalId, latency: number, sampleId?: number) => void,\n    clearCachedRequest: () => void,\n    rpcGlobalId?: Host.AidaClient.RpcGlobalId,\n    sampleId?: number,\n  }|null) => void;\n}\n\n/* clang-format off */\nexport const consoleAdditionalContextFileContent = `/**\n * This file describes the execution environment of the Chrome DevTools Console.\n * The code is JavaScript, but with special global functions and variables.\n * Top-level await is available.\n * The console has direct access to the inspected page's \\`window\\` and \\`document\\`.\n */\n\n/**\n * @description Returns the value of the most recently evaluated expression.\n */\nlet $_;\n\n/**\n * @description A reference to the most recently selected DOM element.\n * $0, $1, $2, $3, $4 can be used to reference the last five selected DOM elements.\n */\nlet $0;\n\n/**\n * @description A query selector alias. $$('.my-class') is equivalent to document.querySelectorAll('.my-class').\n */\nfunction $$(selector, startNode) {}\n\n/**\n * @description An XPath selector. $x('//p') returns an array of all <p> elements.\n */\nfunction $x(path, startNode) {}\n\nfunction clear() {}\n\nfunction copy(object) {}\n\n/**\n * @description Selects and reveals the specified element in the Elements panel.\n */\nfunction inspect(object) {}\n\nfunction keys(object) {}\n\nfunction values(object) {}\n\n/**\n * @description When the specified function is called, the debugger is invoked.\n */\nfunction debug(func) {}\n\n/**\n * @description Stops the debugging of the specified function.\n */\nfunction undebug(func) {}\n\n/**\n * @description Logs a message to the console whenever the specified function is called,\n * along with the arguments passed to it.\n */\nfunction monitor(func) {}\n\n/**\n * @description Stops monitoring the specified function.\n */\nfunction unmonitor(func) {}\n\n/**\n * @description Logs all events dispatched to the specified object to the console.\n */\nfunction monitorEvents(object, events) {}\n\n/**\n * @description Returns an object containing all event listeners registered on the specified object.\n */\nfunction getEventListeners(object) {}\n\n/**\n * The global \\`console\\` object has several helpful methods\n */\nconst console = {\n  log: (...args) => {},\n  warn: (...args) => {},\n  error: (...args) => {},\n  info: (...args) => {},\n  debug: (...args) => {},\n  assert: (assertion, ...args) => {},\n  dir: (object) => {}, // Displays an interactive property listing of an object.\n  dirxml: (object) => {}, // Displays an XML/HTML representation of an object.\n  table: (data, columns) => {}, // Displays tabular data as a table.\n  group: (label) => {}, // Creates a new inline collapsible group.\n  groupEnd: () => {},\n  time: (label) => {}, // Starts a timer.\n  timeEnd: (label) => {} // Stops a timer and logs the elapsed time.\n};`;\n/* clang-format on */\n\n/**\n * The AiCodeCompletion class is responsible for fetching code completion suggestions\n * from the AIDA backend.\n */\nexport class AiCodeCompletion {\n  #stopSequences: string[];\n  #renderingTimeout?: number;\n  #aidaRequestCache?: CachedRequest;\n  // TODO(b/445394511): Remove panel from the class\n  #panel: ContextFlavor;\n  #callbacks?: Callbacks;\n\n  readonly #sessionId: string = crypto.randomUUID();\n  readonly #aidaClient: Host.AidaClient.AidaClient;\n  readonly #serverSideLoggingEnabled: boolean;\n\n  constructor(opts: AgentOptions, panel: ContextFlavor, callbacks?: Callbacks, stopSequences?: string[]) {\n    this.#aidaClient = opts.aidaClient;\n    this.#serverSideLoggingEnabled = opts.serverSideLoggingEnabled ?? false;\n    this.#panel = panel;\n    this.#stopSequences = stopSequences ?? [];\n    this.#callbacks = callbacks;\n  }\n\n  #buildRequest(\n      prefix: string, suffix: string,\n      inferenceLanguage: Host.AidaClient.AidaInferenceLanguage = Host.AidaClient.AidaInferenceLanguage.JAVASCRIPT,\n      additionalFiles?: Host.AidaClient.AdditionalFile[]): Host.AidaClient.CompletionRequest {\n    const userTier = Host.AidaClient.convertToUserTierEnum(this.#userTier);\n    function validTemperature(temperature: number|undefined): number|undefined {\n      return typeof temperature === 'number' && temperature >= 0 ? temperature : undefined;\n    }\n    // As a temporary fix for b/441221870 we are prepending a newline for each prefix.\n    prefix = '\\n' + prefix;\n\n    let additionalContextFiles = additionalFiles ?? undefined;\n    if (!additionalContextFiles) {\n      additionalContextFiles = this.#panel === ContextFlavor.CONSOLE ? [{\n        path: 'devtools-console-context.js',\n        content: consoleAdditionalContextFileContent,\n        included_reason: Host.AidaClient.Reason.RELATED_FILE,\n      }] :\n                                                                       undefined;\n    }\n    return {\n      client: Host.AidaClient.CLIENT_NAME,\n      prefix,\n      suffix,\n      options: {\n        inference_language: inferenceLanguage,\n        temperature: validTemperature(this.#options.temperature),\n        model_id: this.#options.modelId || undefined,\n        stop_sequences: this.#stopSequences,\n      },\n      metadata: {\n        disable_user_content_logging: !(this.#serverSideLoggingEnabled ?? false),\n        string_session_id: this.#sessionId,\n        user_tier: userTier,\n        client_version: Root.Runtime.getChromeVersion(),\n      },\n      additional_files: additionalContextFiles,\n    };\n  }\n\n  async #completeCodeCached(request: Host.AidaClient.CompletionRequest): Promise<{\n    response: Host.AidaClient.CompletionResponse | null,\n    fromCache: boolean,\n  }> {\n    const cachedResponse = this.#checkCachedRequestForResponse(request);\n    if (cachedResponse) {\n      return {response: cachedResponse, fromCache: true};\n    }\n\n    const response = await this.#aidaClient.completeCode(request);\n    if (!response) {\n      return {\n        response: null,\n        fromCache: false,\n      };\n    }\n\n    this.#updateCachedRequest(request, response);\n    return {\n      response,\n      fromCache: false,\n    };\n  }\n\n  get #userTier(): string|undefined {\n    return Root.Runtime.hostConfig.devToolsAiCodeCompletion?.userTier;\n  }\n\n  get #options(): RequestOptions {\n    const temperature = Root.Runtime.hostConfig.devToolsAiCodeCompletion?.temperature;\n    const modelId = Root.Runtime.hostConfig.devToolsAiCodeCompletion?.modelId;\n\n    return {\n      temperature,\n      modelId,\n    };\n  }\n\n  #checkCachedRequestForResponse(request: Host.AidaClient.CompletionRequest): Host.AidaClient.CompletionResponse|null {\n    if (!this.#aidaRequestCache || this.#aidaRequestCache.request.suffix !== request.suffix ||\n        JSON.stringify(this.#aidaRequestCache.request.options) !== JSON.stringify(request.options)) {\n      return null;\n    }\n    const possibleGeneratedSamples: Host.AidaClient.GenerationSample[] = [];\n    for (const sample of this.#aidaRequestCache.response.generatedSamples) {\n      const prefixWithSample = this.#aidaRequestCache.request.prefix + sample.generationString;\n      if (prefixWithSample.startsWith(request.prefix)) {\n        possibleGeneratedSamples.push({\n          generationString: prefixWithSample.substring(request.prefix.length),\n          sampleId: sample.sampleId,\n          score: sample.score,\n          attributionMetadata: sample.attributionMetadata,\n        });\n      }\n    }\n    if (possibleGeneratedSamples.length === 0) {\n      return null;\n    }\n    return {generatedSamples: possibleGeneratedSamples, metadata: this.#aidaRequestCache.response.metadata};\n  }\n\n  #updateCachedRequest(request: Host.AidaClient.CompletionRequest, response: Host.AidaClient.CompletionResponse): void {\n    this.#aidaRequestCache = {request, response};\n  }\n\n  registerUserImpression(rpcGlobalId: Host.AidaClient.RpcGlobalId, latency: number, sampleId?: number): void {\n    const seconds = Math.floor(latency / 1_000);\n    const remainingMs = latency % 1_000;\n    const nanos = Math.floor(remainingMs * 1_000_000);\n\n    void this.#aidaClient.registerClientEvent({\n      corresponding_aida_rpc_global_id: rpcGlobalId,\n      disable_user_content_logging: true,\n      complete_code_client_event: {\n        user_impression: {\n          sample: {\n            sample_id: sampleId,\n          },\n          latency: {\n            duration: {\n              seconds,\n              nanos,\n            },\n          }\n        },\n      },\n    });\n    debugLog('Registered user impression with latency {seconds:', seconds, ', nanos:', nanos, '}');\n    Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiCodeCompletionSuggestionDisplayed);\n  }\n\n  registerUserAcceptance(rpcGlobalId: Host.AidaClient.RpcGlobalId, sampleId?: number): void {\n    void this.#aidaClient.registerClientEvent({\n      corresponding_aida_rpc_global_id: rpcGlobalId,\n      disable_user_content_logging: true,\n      complete_code_client_event: {\n        user_acceptance: {\n          sample: {\n            sample_id: sampleId,\n          }\n        },\n      },\n    });\n    debugLog('Registered user acceptance');\n    Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiCodeCompletionSuggestionAccepted);\n  }\n\n  clearCachedRequest(): void {\n    this.#aidaRequestCache = undefined;\n  }\n\n  async completeCode(\n      prefix: string, suffix: string, cursorPositionAtRequest: number,\n      inferenceLanguage?: Host.AidaClient.AidaInferenceLanguage,\n      additionalFiles?: Host.AidaClient.AdditionalFile[]): Promise<{\n    response: Host.AidaClient.CompletionResponse | null,\n    fromCache: boolean,\n  }> {\n    const request = this.#buildRequest(prefix, suffix, inferenceLanguage, additionalFiles);\n    const {response, fromCache} = await this.#completeCodeCached(request);\n\n    debugLog('At cursor position', cursorPositionAtRequest, {request, response, fromCache});\n    if (!response) {\n      return {response: null, fromCache: false};\n    }\n\n    return {response, fromCache};\n  }\n\n  remove(): void {\n    if (this.#renderingTimeout) {\n      clearTimeout(this.#renderingTimeout);\n      this.#renderingTimeout = undefined;\n    }\n    this.#callbacks?.setAiAutoCompletion(null);\n  }\n\n  static isAiCodeCompletionEnabled(locale: string): boolean {\n    if (!locale.startsWith('en-')) {\n      return false;\n    }\n    const aidaAvailability = Root.Runtime.hostConfig.aidaAvailability;\n    if (!aidaAvailability || aidaAvailability.blockedByGeo || aidaAvailability.blockedByAge ||\n        aidaAvailability.blockedByEnterprisePolicy) {\n      return false;\n    }\n    return Boolean(aidaAvailability.enabled && Root.Runtime.hostConfig.devToolsAiCodeCompletion?.enabled);\n  }\n}\n\nexport const enum ContextFlavor {\n  CONSOLE = 'console',  // generated code can contain console specific APIs like `$0`.\n  SOURCES = 'sources',\n}\n"],
  "mappings": "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",
  "names": []
}
