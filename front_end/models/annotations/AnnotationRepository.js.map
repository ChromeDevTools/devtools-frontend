{"version":3,"file":"AnnotationRepository.js","sourceRoot":"","sources":["../../../../../../front_end/models/annotations/AnnotationRepository.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Root from '../../core/root/root.js';\nimport type * as SDK from '../../core/sdk/sdk.js';\n\nimport {AnnotationType} from './AnnotationType.js';\n\nexport interface BaseAnnotationData {\n  id: number;\n  type: AnnotationType;\n  message: string;\n  // Sometimes the anchor for an annotation is not known, but is provided using a\n  // string id instead (which can be converted to a proper `anchor`).\n  lookupId: string;\n  // Sometimes we want annotations to anchor to a particular string on the page.\n  anchorToString?: string;\n}\n\nexport interface ElementsAnnotationData extends BaseAnnotationData {\n  type: AnnotationType.ELEMENT_NODE;\n  anchor?: SDK.DOMModel.DOMNode;\n}\n\nexport interface NetworkRequestAnnotationData extends BaseAnnotationData {\n  type: AnnotationType.NETWORK_REQUEST;\n  anchor?: SDK.NetworkRequest.NetworkRequest;\n}\n\nexport interface NetworkRequestDetailsAnnotationData extends BaseAnnotationData {\n  type: AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS;\n  anchor?: SDK.NetworkRequest.NetworkRequest;\n}\n\nexport const enum Events {\n  ANNOTATION_ADDED = 'AnnotationAdded',\n  ANNOTATION_DELETED = 'AnnotationDeleted',\n  ALL_ANNOTATIONS_DELETED = 'AllAnnotationsDeleted',\n}\n\nexport interface EventTypes {\n  [Events.ANNOTATION_ADDED]: BaseAnnotationData;\n  [Events.ANNOTATION_DELETED]: {id: number};\n  [Events.ALL_ANNOTATIONS_DELETED]: void;\n}\n\nexport class AnnotationRepository {\n  static #instance: AnnotationRepository|null = null;\n  static #hasRepliedGreenDevDisabled = false;\n  static #hasShownFlagWarning = false;\n\n  #events = new Common.ObjectWrapper.ObjectWrapper<EventTypes>();\n  #annotationData: BaseAnnotationData[] = [];\n  #nextId = 0;\n\n  static instance(): AnnotationRepository {\n    if (!AnnotationRepository.#instance) {\n      AnnotationRepository.#instance = new AnnotationRepository();\n    }\n    return AnnotationRepository.#instance;\n  }\n\n  static annotationsEnabled(): boolean {\n    const enabled = Boolean(Root.Runtime.hostConfig.devToolsGreenDevUi?.enabled);\n    // TODO(finnur): Fix race when Repository is created before feature flags have been set properly.\n    if (!enabled) {\n      this.#hasRepliedGreenDevDisabled = true;\n    } else if (this.#hasRepliedGreenDevDisabled && !this.#hasShownFlagWarning) {\n      console.warn(\n          'Flag controlling GreenDev has flipped from false to true. ' +\n          'Only some callers will expect GreenDev to be enabled, which can lead to unexpected results.');\n      this.#hasShownFlagWarning = true;\n    }\n    return Boolean(enabled);\n  }\n\n  addEventListener<T extends keyof EventTypes>(\n      eventType: T, listener: (arg0: Common.EventTarget.EventTargetEvent<EventTypes[T]>) => void,\n      thisObject?: Object): Common.EventTarget.EventDescriptor<EventTypes, T> {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received request to add event listener with annotations disabled');\n    }\n    return this.#events.addEventListener(eventType, listener, thisObject);\n  }\n\n  getAnnotationDataByType(type: AnnotationType): BaseAnnotationData[] {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received query for annotation types with annotations disabled');\n      return [];\n    }\n\n    const annotations = this.#annotationData.filter(annotation => annotation.type === type);\n    return annotations;\n  }\n\n  getAnnotationDataById(id: number): BaseAnnotationData|undefined {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received query for annotation type with annotations disabled');\n      return undefined;\n    }\n\n    return this.#annotationData.find(annotation => annotation.id === id);\n  }\n\n  #getExistingAnnotation(type: AnnotationType, anchor?: SDK.DOMModel.DOMNode|SDK.NetworkRequest.NetworkRequest|string):\n      BaseAnnotationData|undefined {\n    const annotations = this.getAnnotationDataByType(type);\n    const annotation = annotations.find(annotation => {\n      if (typeof anchor === 'string') {\n        return annotation.lookupId === anchor;\n      }\n      switch (type) {\n        case AnnotationType.ELEMENT_NODE: {\n          const elementAnnotation = annotation as ElementsAnnotationData;\n          return elementAnnotation.anchor === anchor;\n        }\n        case AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS: {\n          const networkRequestDetailsAnnotation = annotation as NetworkRequestDetailsAnnotationData;\n          return networkRequestDetailsAnnotation.anchor === anchor;\n        }\n        default:\n          console.warn('[AnnotationRepository] Unknown AnnotationType', type);\n          return false;\n      }\n    });\n    return annotation;\n  }\n\n  #updateExistingAnnotationLabel(\n      label: string, type: AnnotationType,\n      anchor?: SDK.DOMModel.DOMNode|SDK.NetworkRequest.NetworkRequest|string): boolean {\n    const annotation = this.#getExistingAnnotation(type, anchor);\n    if (annotation) {\n      // TODO(finnur): This should work for annotations that have not been displayed yet,\n      // but we need to also notify the AnnotationManager for those that have been shown.\n      annotation.message = label;\n      return true;\n    }\n    return false;\n  }\n\n  addElementsAnnotation(\n      label: string,\n      anchor?: SDK.DOMModel.DOMNode|string,\n      anchorToString?: string,\n      ): void {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received annotation registration with annotations disabled');\n      return;\n    }\n\n    if (this.#updateExistingAnnotationLabel(label, AnnotationType.ELEMENT_NODE, anchor)) {\n      return;\n    }\n\n    const annotationData: ElementsAnnotationData = {\n      id: this.#nextId++,\n      type: AnnotationType.ELEMENT_NODE,\n      message: label,\n      lookupId: typeof anchor === 'string' ? anchor : '',\n      anchor: typeof anchor !== 'string' ? anchor : undefined,\n      anchorToString,\n    };\n    this.#annotationData.push(annotationData);\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationRepository] Added element annotation:', label, {\n      annotationData,\n      annotations: this.#annotationData.length,\n    });\n    this.#events.dispatchEventToListeners(Events.ANNOTATION_ADDED, annotationData);\n  }\n\n  addNetworkRequestAnnotation(\n      label: string,\n      anchor?: SDK.NetworkRequest.NetworkRequest|string,\n      anchorToString?: string,\n      ): void {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received annotation registration with annotations disabled');\n      return;\n    }\n\n    // We only need to update the NETWORK_REQUEST_SUBPANEL_HEADERS because the\n    // NETWORK_REQUEST Annotation has no meaningful label.\n    if (this.#updateExistingAnnotationLabel(label, AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS, anchor)) {\n      return;\n    }\n\n    const annotationData: NetworkRequestAnnotationData = {\n      id: this.#nextId++,\n      type: AnnotationType.NETWORK_REQUEST,\n      message: '',\n      lookupId: typeof anchor === 'string' ? anchor : '',\n      anchor: typeof anchor !== 'string' ? anchor : undefined,\n      anchorToString,\n    };\n    this.#annotationData.push(annotationData);\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationRepository] Added annotation:', label, {\n      annotationData,\n      annotations: this.#annotationData.length,\n    });\n    this.#events.dispatchEventToListeners(Events.ANNOTATION_ADDED, annotationData);\n\n    const annotationDetailsData: NetworkRequestDetailsAnnotationData = {\n      id: this.#nextId++,\n      type: AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS,\n      message: label,\n      lookupId: typeof anchor === 'string' ? anchor : '',\n      anchor: typeof anchor !== 'string' ? anchor : undefined,\n      anchorToString,\n    };\n\n    this.#annotationData.push(annotationDetailsData);\n    this.#events.dispatchEventToListeners(Events.ANNOTATION_ADDED, annotationDetailsData);\n  }\n\n  deleteAllAnnotations(): void {\n    this.#annotationData = [];\n    this.#events.dispatchEventToListeners(Events.ALL_ANNOTATIONS_DELETED);\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationRepository] Deleting all annotations');\n  }\n\n  deleteAnnotation(id: number): void {\n    const index = this.#annotationData.findIndex(annotation => annotation.id === id);\n    if (index === -1) {\n      console.warn(`[AnnotationRepository] Could not find annotation with id ${id}`);\n      return;\n    }\n    this.#annotationData.splice(index, 1);\n    this.#events.dispatchEventToListeners(Events.ANNOTATION_DELETED, {id});\n    // eslint-disable-next-line no-console\n    console.log(`[AnnotationRepository] Deleted annotation with id ${id}`);\n  }\n}\n"]}