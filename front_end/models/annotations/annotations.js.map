{
  "version": 3,
  "sources": ["../../../../../../front_end/models/annotations/AnnotationRepository.ts", "../../../../../../front_end/models/annotations/AnnotationType.ts"],
  "sourcesContent": ["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Root from '../../core/root/root.js';\nimport type * as SDK from '../../core/sdk/sdk.js';\n\nimport {AnnotationType} from './AnnotationType.js';\n\nexport interface BaseAnnotationData {\n  id: number;\n  type: AnnotationType;\n  message: string;\n  // Sometimes the anchor for an annotation is not known, but is provided using a\n  // string id instead (which can be converted to a proper `anchor`).\n  lookupId: string;\n  // Sometimes we want annotations to anchor to a particular string on the page.\n  anchorToString?: string;\n}\n\nexport interface ElementsAnnotationData extends BaseAnnotationData {\n  type: AnnotationType.ELEMENT_NODE;\n  anchor?: SDK.DOMModel.DOMNode;\n}\n\nexport interface NetworkRequestAnnotationData extends BaseAnnotationData {\n  type: AnnotationType.NETWORK_REQUEST;\n  anchor?: SDK.NetworkRequest.NetworkRequest;\n}\n\nexport interface NetworkRequestDetailsAnnotationData extends BaseAnnotationData {\n  type: AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS;\n  anchor?: SDK.NetworkRequest.NetworkRequest;\n}\n\nexport const enum Events {\n  ANNOTATION_ADDED = 'AnnotationAdded',\n  ANNOTATION_DELETED = 'AnnotationDeleted',\n  ALL_ANNOTATIONS_DELETED = 'AllAnnotationsDeleted',\n}\n\nexport interface EventTypes {\n  [Events.ANNOTATION_ADDED]: BaseAnnotationData;\n  [Events.ANNOTATION_DELETED]: {id: number};\n  [Events.ALL_ANNOTATIONS_DELETED]: void;\n}\n\nexport class AnnotationRepository {\n  static #instance: AnnotationRepository|null = null;\n  static #hasRepliedGreenDevDisabled = false;\n  static #hasShownFlagWarning = false;\n\n  #events = new Common.ObjectWrapper.ObjectWrapper<EventTypes>();\n  #annotationData: BaseAnnotationData[] = [];\n  #nextId = 0;\n\n  static instance(): AnnotationRepository {\n    if (!AnnotationRepository.#instance) {\n      AnnotationRepository.#instance = new AnnotationRepository();\n    }\n    return AnnotationRepository.#instance;\n  }\n\n  static annotationsEnabled(): boolean {\n    const enabled = Boolean(Root.Runtime.hostConfig.devToolsGreenDevUi?.enabled);\n    // TODO(finnur): Fix race when Repository is created before feature flags have been set properly.\n    if (!enabled) {\n      this.#hasRepliedGreenDevDisabled = true;\n    } else if (this.#hasRepliedGreenDevDisabled && !this.#hasShownFlagWarning) {\n      console.warn(\n          'Flag controlling GreenDev has flipped from false to true. ' +\n          'Only some callers will expect GreenDev to be enabled, which can lead to unexpected results.');\n      this.#hasShownFlagWarning = true;\n    }\n    return Boolean(enabled);\n  }\n\n  addEventListener<T extends keyof EventTypes>(\n      eventType: T, listener: (arg0: Common.EventTarget.EventTargetEvent<EventTypes[T]>) => void,\n      thisObject?: Object): Common.EventTarget.EventDescriptor<EventTypes, T> {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received request to add event listener with annotations disabled');\n    }\n    return this.#events.addEventListener(eventType, listener, thisObject);\n  }\n\n  getAnnotationDataByType(type: AnnotationType): BaseAnnotationData[] {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received query for annotation types with annotations disabled');\n      return [];\n    }\n\n    const annotations = this.#annotationData.filter(annotation => annotation.type === type);\n    return annotations;\n  }\n\n  getAnnotationDataById(id: number): BaseAnnotationData|undefined {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received query for annotation type with annotations disabled');\n      return undefined;\n    }\n\n    return this.#annotationData.find(annotation => annotation.id === id);\n  }\n\n  #getExistingAnnotation(type: AnnotationType, anchor?: SDK.DOMModel.DOMNode|SDK.NetworkRequest.NetworkRequest|string):\n      BaseAnnotationData|undefined {\n    const annotations = this.getAnnotationDataByType(type);\n    const annotation = annotations.find(annotation => {\n      if (typeof anchor === 'string') {\n        return annotation.lookupId === anchor;\n      }\n      switch (type) {\n        case AnnotationType.ELEMENT_NODE: {\n          const elementAnnotation = annotation as ElementsAnnotationData;\n          return elementAnnotation.anchor === anchor;\n        }\n        case AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS: {\n          const networkRequestDetailsAnnotation = annotation as NetworkRequestDetailsAnnotationData;\n          return networkRequestDetailsAnnotation.anchor === anchor;\n        }\n        default:\n          console.warn('[AnnotationRepository] Unknown AnnotationType', type);\n          return false;\n      }\n    });\n    return annotation;\n  }\n\n  #updateExistingAnnotationLabel(\n      label: string, type: AnnotationType,\n      anchor?: SDK.DOMModel.DOMNode|SDK.NetworkRequest.NetworkRequest|string): boolean {\n    const annotation = this.#getExistingAnnotation(type, anchor);\n    if (annotation) {\n      // TODO(finnur): This should work for annotations that have not been displayed yet,\n      // but we need to also notify the AnnotationManager for those that have been shown.\n      annotation.message = label;\n      return true;\n    }\n    return false;\n  }\n\n  addElementsAnnotation(\n      label: string,\n      anchor?: SDK.DOMModel.DOMNode|string,\n      anchorToString?: string,\n      ): void {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received annotation registration with annotations disabled');\n      return;\n    }\n\n    if (this.#updateExistingAnnotationLabel(label, AnnotationType.ELEMENT_NODE, anchor)) {\n      return;\n    }\n\n    const annotationData: ElementsAnnotationData = {\n      id: this.#nextId++,\n      type: AnnotationType.ELEMENT_NODE,\n      message: label,\n      lookupId: typeof anchor === 'string' ? anchor : '',\n      anchor: typeof anchor !== 'string' ? anchor : undefined,\n      anchorToString,\n    };\n    this.#annotationData.push(annotationData);\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationRepository] Added element annotation:', label, {\n      annotationData,\n      annotations: this.#annotationData.length,\n    });\n    this.#events.dispatchEventToListeners(Events.ANNOTATION_ADDED, annotationData);\n  }\n\n  addNetworkRequestAnnotation(\n      label: string,\n      anchor?: SDK.NetworkRequest.NetworkRequest|string,\n      anchorToString?: string,\n      ): void {\n    if (!AnnotationRepository.annotationsEnabled()) {\n      console.warn('Received annotation registration with annotations disabled');\n      return;\n    }\n\n    // We only need to update the NETWORK_REQUEST_SUBPANEL_HEADERS because the\n    // NETWORK_REQUEST Annotation has no meaningful label.\n    if (this.#updateExistingAnnotationLabel(label, AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS, anchor)) {\n      return;\n    }\n\n    const annotationData: NetworkRequestAnnotationData = {\n      id: this.#nextId++,\n      type: AnnotationType.NETWORK_REQUEST,\n      message: '',\n      lookupId: typeof anchor === 'string' ? anchor : '',\n      anchor: typeof anchor !== 'string' ? anchor : undefined,\n      anchorToString,\n    };\n    this.#annotationData.push(annotationData);\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationRepository] Added annotation:', label, {\n      annotationData,\n      annotations: this.#annotationData.length,\n    });\n    this.#events.dispatchEventToListeners(Events.ANNOTATION_ADDED, annotationData);\n\n    const annotationDetailsData: NetworkRequestDetailsAnnotationData = {\n      id: this.#nextId++,\n      type: AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS,\n      message: label,\n      lookupId: typeof anchor === 'string' ? anchor : '',\n      anchor: typeof anchor !== 'string' ? anchor : undefined,\n      anchorToString,\n    };\n\n    this.#annotationData.push(annotationDetailsData);\n    this.#events.dispatchEventToListeners(Events.ANNOTATION_ADDED, annotationDetailsData);\n  }\n\n  deleteAllAnnotations(): void {\n    this.#annotationData = [];\n    this.#events.dispatchEventToListeners(Events.ALL_ANNOTATIONS_DELETED);\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationRepository] Deleting all annotations');\n  }\n\n  deleteAnnotation(id: number): void {\n    const index = this.#annotationData.findIndex(annotation => annotation.id === id);\n    if (index === -1) {\n      console.warn(`[AnnotationRepository] Could not find annotation with id ${id}`);\n      return;\n    }\n    this.#annotationData.splice(index, 1);\n    this.#events.dispatchEventToListeners(Events.ANNOTATION_DELETED, {id});\n    // eslint-disable-next-line no-console\n    console.log(`[AnnotationRepository] Deleted annotation with id ${id}`);\n  }\n}\n", "// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nexport enum AnnotationType {\n  ELEMENT_NODE = 0,\n  STYLE_RULE = 1,\n  NETWORK_REQUEST = 2,\n  NETWORK_REQUEST_SUBPANEL_HEADERS = 3,\n}\n"],
  "mappings": "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",
  "names": ["AnnotationType", "annotation"]
}
