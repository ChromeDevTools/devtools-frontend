{"version":3,"file":"AutofillManager.js","sourceRoot":"","sources":["../../../../../../front_end/models/autofill_manager/AutofillManager.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,MAAM,MAAM,6BAA6B,CAAC;AACtD,OAAO,KAAK,QAAQ,MAAM,iCAAiC,CAAC;AAC5D,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAG7C,IAAI,uBAAwC,CAAC;AAE7C,MAAM,OAAO,eAAgB,SAAQ,MAAM,CAAC,aAAa,CAAC,aAAyB;IACjF,QAAQ,GAAG,EAAE,CAAC;IACd,aAAa,GAAoC,EAAE,CAAC;IACpD,QAAQ,GAAY,EAAE,CAAC;IACvB,cAAc,GAAyC,IAAI,CAAC;IAE5D;QACE,KAAK,EAAE,CAAC;QACR,GAAG,CAAC,aAAa,CAAC,aAAa,CAAC,QAAQ,EAAE,CAAC,gBAAgB,CACvD,GAAG,CAAC,aAAa,CAAC,aAAa,0EAAgD,IAAI,CAAC,kBAAkB,EAAE,IAAI,EAC5G,EAAC,MAAM,EAAE,IAAI,EAAC,CAAC,CAAC;IACtB,CAAC;IAED,MAAM,CAAC,QAAQ,CAAC,OAAiC,EAAC,QAAQ,EAAE,IAAI,EAAC;QAC/D,MAAM,EAAC,QAAQ,EAAC,GAAG,IAAI,CAAC;QACxB,IAAI,CAAC,uBAAuB,IAAI,QAAQ,EAAE,CAAC;YACzC,uBAAuB,GAAG,IAAI,eAAe,EAAE,CAAC;QAClD,CAAC;QACD,OAAO,uBAAuB,CAAC;IACjC,CAAC;IAED,KAAK,CAAC,kBAAkB,CAAC,EAAC,IAAI,EACsE;QAClG,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,aAAa,CAAC;QACzC,IAAI,CAAC,6BAA6B,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAC/C,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;YAClB,IAAI,CAAC,wBAAwB,uDAA6B;gBACxD,OAAO,EAAE,IAAI,CAAC,QAAQ;gBACtB,YAAY,EAAE,IAAI,CAAC,aAAa;gBAChC,OAAO,EAAE,IAAI,CAAC,QAAQ;aACvB,CAAC,CAAC;QACL,CAAC;IACH,CAAC;IAED,wBAAwB;QACtB,IAAI,CAAC,IAAI,CAAC,QAAQ,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC;YAC3C,OAAO,IAAI,CAAC;QACd,CAAC;QACD,OAAO;YACL,OAAO,EAAE,IAAI,CAAC,QAAQ;YACtB,YAAY,EAAE,IAAI,CAAC,aAAa;YAChC,OAAO,EAAE,IAAI,CAAC,QAAQ;SACvB,CAAC;IACJ,CAAC;IAED,oBAAoB,CAAC,WAA0C;QAC7D,MAAM,aAAa,GAAG,WAAW,CAAC,OAAO,CAAC;QAC1C,MAAM,MAAM,GAAG,GAAG,CAAC,YAAY,CAAC,YAAY,CAAC,QAAQ,EAAE,CAAC,QAAQ,CAAC,WAAW,CAAC,OAAO,CAAC,EAAE,iBAAiB,EAAE,CAAC,MAAM,EAAE,CAAC;QACpH,IAAI,MAAM,EAAE,CAAC;YACX,MAAM,YAAY,GAAG,IAAI,GAAG,CAAC,QAAQ,CAAC,eAAe,CAAC,MAAM,EAAE,aAAa,CAAC,CAAC;YAC7E,MAAM,QAAQ,GAAG,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;YACrD,IAAI,YAAY,IAAI,QAAQ,EAAE,CAAC;gBAC7B,QAAQ,CAAC,YAAY,EAAE,CAAC,kBAAkB,CAAC,EAAC,YAAY,EAAC,EAAE,KAAK,CAAC,CAAC;YACpE,CAAC;QACH,CAAC;IACH,CAAC;IAED,4BAA4B;QAC1B,GAAG,CAAC,YAAY,CAAC,YAAY,CAAC,oBAAoB,EAAE,CAAC;IACvD,CAAC;IAED,6BAA6B,CAAC,EAAC,SAAS,EAAE,YAAY,EAA2C;QAC/F,yDAAyD;QACzD,MAAM,mBAAmB,GAAG,CAAC,aAA8C,EAAU,EAAE,CACnF,aAAa,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,GAAG,CAAC,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;QACjG,IAAI,CAAC,QAAQ,GAAG,SAAS,CAAC,aAAa,CAAC,GAAG,CAAC,aAAa,CAAC,EAAE,CAAC,mBAAmB,CAAC,aAAa,CAAC,CAAC;aAC3E,MAAM,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,MAAM,CAAC;aACzB,IAAI,CAAC,IAAI,CAAC,CAAC;QAEhC,IAAI,CAAC,aAAa,GAAG,YAAY,CAAC;QAClC,IAAI,CAAC,QAAQ,GAAG,EAAE,CAAC;QAEnB,oEAAoE;QACpE,qCAAqC;QACrC,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,IAAI,CAAC,aAAa,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACnD,IAAI,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC,KAAK,KAAK,EAAE,EAAE,CAAC;gBACvC,SAAS;YACX,CAAC;YACD,uDAAuD;YACvD,gCAAgC;YAChC,kEAAkE;YAClE,MAAM,MAAM,GAAG,QAAQ,CAAC,eAAe,CAAC,eAAe,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC,UAAU,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC;iBACvF,UAAU,CAAC,YAAY,EAAE,MAAM,CAAC,CAAC;YACrD,MAAM,OAAO,GAAG,IAAI,CAAC,QAAQ,CAAC,UAAU,CAAC,KAAK,EAAE,GAAG,CAAC,CAAC,QAAQ,CAAC,IAAI,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC;YACvF,KAAK,MAAM,KAAK,IAAI,OAAO,EAAE,CAAC;gBAC5B,IAAI,OAAO,KAAK,CAAC,KAAK,KAAK,WAAW,EAAE,CAAC;oBACvC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,EAAC,UAAU,EAAE,KAAK,CAAC,KAAK,EAAE,QAAQ,EAAE,KAAK,CAAC,KAAK,GAAG,KAAK,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,gBAAgB,EAAE,CAAC,EAAC,CAAC,CAAC;gBAC9G,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;CACF","sourcesContent":["// Copyright 2023 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as Protocol from '../../generated/protocol.js';\n\nlet autofillManagerInstance: AutofillManager;\n\nexport class AutofillManager extends Common.ObjectWrapper.ObjectWrapper<EventTypes> {\n  #address = '';\n  #filledFields: Protocol.Autofill.FilledField[] = [];\n  #matches: Match[] = [];\n  #autofillModel: SDK.AutofillModel.AutofillModel|null = null;\n\n  private constructor() {\n    super();\n    SDK.TargetManager.TargetManager.instance().addModelListener(\n        SDK.AutofillModel.AutofillModel, SDK.AutofillModel.Events.ADDRESS_FORM_FILLED, this.#addressFormFilled, this,\n        {scoped: true});\n  }\n\n  static instance(opts: {forceNew: boolean|null} = {forceNew: null}): AutofillManager {\n    const {forceNew} = opts;\n    if (!autofillManagerInstance || forceNew) {\n      autofillManagerInstance = new AutofillManager();\n    }\n    return autofillManagerInstance;\n  }\n\n  async #addressFormFilled({data}: Common.EventTarget.EventTargetEvent<\n                           SDK.AutofillModel.EventTypes[SDK.AutofillModel.Events.ADDRESS_FORM_FILLED]>): Promise<void> {\n    this.#autofillModel = data.autofillModel;\n    this.#processAddressFormFilledData(data.event);\n    if (this.#address) {\n      this.dispatchEventToListeners(Events.ADDRESS_FORM_FILLED, {\n        address: this.#address,\n        filledFields: this.#filledFields,\n        matches: this.#matches,\n      });\n    }\n  }\n\n  getLastFilledAddressForm(): AddressFormFilledEvent|null {\n    if (!this.#address || !this.#autofillModel) {\n      return null;\n    }\n    return {\n      address: this.#address,\n      filledFields: this.#filledFields,\n      matches: this.#matches,\n    };\n  }\n\n  highlightFilledField(filledField: Protocol.Autofill.FilledField): void {\n    const backendNodeId = filledField.fieldId;\n    const target = SDK.FrameManager.FrameManager.instance().getFrame(filledField.frameId)?.resourceTreeModel().target();\n    if (target) {\n      const deferredNode = new SDK.DOMModel.DeferredDOMNode(target, backendNodeId);\n      const domModel = target.model(SDK.DOMModel.DOMModel);\n      if (deferredNode && domModel) {\n        domModel.overlayModel().highlightInOverlay({deferredNode}, 'all');\n      }\n    }\n  }\n\n  clearHighlightedFilledFields(): void {\n    SDK.OverlayModel.OverlayModel.hideDOMNodeHighlight();\n  }\n\n  #processAddressFormFilledData({addressUi, filledFields}: Protocol.Autofill.AddressFormFilledEvent): void {\n    // Transform addressUi into a single (multi-line) string.\n    const concatAddressFields = (addressFields: Protocol.Autofill.AddressFields): string =>\n        addressFields.fields.filter(field => field.value.length).map(field => field.value).join(' ');\n    this.#address = addressUi.addressFields.map(addressFields => concatAddressFields(addressFields))\n                        .filter(str => str.length)\n                        .join('\\n');\n\n    this.#filledFields = filledFields;\n    this.#matches = [];\n\n    // Populate a list of matches by searching in the address string for\n    // occurences of filled field values.\n    for (let i = 0; i < this.#filledFields.length; i++) {\n      if (this.#filledFields[i].value === '') {\n        continue;\n      }\n      // 1) Replace multiple whitespaces with a single space.\n      // 2) Escape special characters.\n      // 3) For ',' or '.' before whitespace, insert the '?' quantifier.\n      const needle = Platform.StringUtilities.escapeForRegExp(this.#filledFields[i].value.replaceAll(/\\s/g, ' '))\n                         .replaceAll(/([.,]+)\\s/g, '$1? ');\n      const matches = this.#address.replaceAll(/\\s/g, ' ').matchAll(new RegExp(needle, 'g'));\n      for (const match of matches) {\n        if (typeof match.index !== 'undefined') {\n          this.#matches.push({startIndex: match.index, endIndex: match.index + match[0].length, filledFieldIndex: i});\n        }\n      }\n    }\n  }\n}\n\n/**\n * A Match describes how the value of a filled field corresponds to a substring\n * of address from startIndex to endIndex.\n **/\nexport interface Match {\n  startIndex: number;\n  endIndex: number;\n  filledFieldIndex: number;\n}\n\nexport const enum Events {\n  ADDRESS_FORM_FILLED = 'AddressFormFilled',\n}\n\nexport interface AddressFormFilledEvent {\n  address: string;\n  filledFields: Protocol.Autofill.FilledField[];\n  matches: Match[];\n}\n\nexport interface EventTypes {\n  [Events.ADDRESS_FORM_FILLED]: AddressFormFilledEvent;\n}\n"]}