{"version":3,"file":"ContentProviderBasedProject.js","sourceRoot":"","sources":["../../../../../../front_end/models/bindings/ContentProviderBasedProject.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2013 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Common from '../../core/common/common.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport * as TextUtils from '../text_utils/text_utils.js';\nimport * as Workspace from '../workspace/workspace.js';\n\nconst UIStrings = {\n  /**\n   * @description Error message that is displayed in the Sources panel when can't be loaded.\n   */\n  unknownErrorLoadingFile: 'Unknown error loading file',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('models/bindings/ContentProviderBasedProject.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\ninterface UISourceCodeData {\n  mimeType: string;\n  metadata: Workspace.UISourceCode.UISourceCodeMetadata|null;\n  contentProvider: TextUtils.ContentProvider.ContentProvider;\n}\n\nexport class ContentProviderBasedProject extends Workspace.Workspace.ProjectStore {\n  readonly #isServiceProject: boolean;\n  readonly #uiSourceCodeToData = new WeakMap<Workspace.UISourceCode.UISourceCode, UISourceCodeData>();\n  constructor(\n      workspace: Workspace.Workspace.WorkspaceImpl, id: string, type: Workspace.Workspace.projectTypes,\n      displayName: string, isServiceProject: boolean) {\n    super(workspace, id, type, displayName);\n    this.#isServiceProject = isServiceProject;\n    workspace.addProject(this);\n  }\n\n  async requestFileContent(uiSourceCode: Workspace.UISourceCode.UISourceCode):\n      Promise<TextUtils.ContentData.ContentDataOrError> {\n    const {contentProvider} = this.#uiSourceCodeToData.get(uiSourceCode) as UISourceCodeData;\n    try {\n      return await contentProvider.requestContentData();\n    } catch (err) {\n      // TODO(rob.paveza): CRBug 1013683 - Consider propagating exceptions full-stack\n      return {\n        error: err ? String(err) : i18nString(UIStrings.unknownErrorLoadingFile),\n      };\n    }\n  }\n\n  isServiceProject(): boolean {\n    return this.#isServiceProject;\n  }\n\n  async requestMetadata(uiSourceCode: Workspace.UISourceCode.UISourceCode):\n      Promise<Workspace.UISourceCode.UISourceCodeMetadata|null> {\n    const {metadata} = this.#uiSourceCodeToData.get(uiSourceCode) as UISourceCodeData;\n    return metadata;\n  }\n\n  canSetFileContent(): boolean {\n    return false;\n  }\n\n  async setFileContent(_uiSourceCode: Workspace.UISourceCode.UISourceCode, _newContent: string, _isBase64: boolean):\n      Promise<void> {\n  }\n\n  fullDisplayName(uiSourceCode: Workspace.UISourceCode.UISourceCode): string {\n    let parentPath = uiSourceCode.parentURL().replace(/^(?:https?|file)\\:\\/\\//, '');\n    try {\n      parentPath = decodeURI(parentPath);\n    } catch {\n    }\n    return parentPath + '/' + uiSourceCode.displayName(true);\n  }\n\n  mimeType(uiSourceCode: Workspace.UISourceCode.UISourceCode): string {\n    const {mimeType} = (this.#uiSourceCodeToData.get(uiSourceCode) as UISourceCodeData);\n    return mimeType;\n  }\n\n  canRename(): boolean {\n    return false;\n  }\n\n  override rename(\n      _uiSourceCode: Workspace.UISourceCode.UISourceCode, _newName: Platform.DevToolsPath.RawPathString,\n      callback:\n          (arg0: boolean, arg1?: string|undefined, arg2?: Platform.DevToolsPath.UrlString|undefined,\n           arg3?: Common.ResourceType.ResourceType|undefined) => void): void {\n    callback(false);\n  }\n\n  override excludeFolder(_path: Platform.DevToolsPath.UrlString): void {\n  }\n\n  canExcludeFolder(_path: Platform.DevToolsPath.EncodedPathString): boolean {\n    return false;\n  }\n\n  async createFile(\n      _path: Platform.DevToolsPath.EncodedPathString, _name: string|null, _content: string,\n      _isBase64?: boolean): Promise<Workspace.UISourceCode.UISourceCode|null> {\n    return null;\n  }\n\n  canCreateFile(): boolean {\n    return false;\n  }\n\n  override deleteFile(_uiSourceCode: Workspace.UISourceCode.UISourceCode): void {\n  }\n\n  override remove(): void {\n  }\n\n  searchInFileContent(\n      uiSourceCode: Workspace.UISourceCode.UISourceCode, query: string, caseSensitive: boolean,\n      isRegex: boolean): Promise<TextUtils.ContentProvider.SearchMatch[]> {\n    const {contentProvider} = this.#uiSourceCodeToData.get(uiSourceCode) as UISourceCodeData;\n    return contentProvider.searchInContent(query, caseSensitive, isRegex);\n  }\n\n  async findFilesMatchingSearchRequest(\n      searchConfig: Workspace.SearchConfig.SearchConfig, filesMatchingFileQuery: Workspace.UISourceCode.UISourceCode[],\n      progress: Common.Progress.Progress):\n      Promise<Map<Workspace.UISourceCode.UISourceCode, TextUtils.ContentProvider.SearchMatch[]|null>> {\n    const result = new Map();\n    progress.totalWork = filesMatchingFileQuery.length;\n    await Promise.all(filesMatchingFileQuery.map(searchInContent.bind(this)));\n    progress.done = true;\n    return result;\n\n    async function searchInContent(\n        this: ContentProviderBasedProject, uiSourceCode: Workspace.UISourceCode.UISourceCode): Promise<void> {\n      let allMatchesFound = true;\n      let matches: TextUtils.ContentProvider.SearchMatch[] = [];\n      for (const query of searchConfig.queries().slice()) {\n        const searchMatches =\n            await this.searchInFileContent(uiSourceCode, query, !searchConfig.ignoreCase(), searchConfig.isRegex());\n        if (!searchMatches.length) {\n          allMatchesFound = false;\n          break;\n        }\n        matches = Platform.ArrayUtilities.mergeOrdered(\n            matches, searchMatches, TextUtils.ContentProvider.SearchMatch.comparator);\n      }\n      if (allMatchesFound) {\n        result.set(uiSourceCode, matches);\n      }\n      ++progress.worked;\n    }\n  }\n\n  override indexContent(progress: Common.Progress.Progress): void {\n    queueMicrotask(() => {\n      progress.done = true;\n    });\n  }\n\n  addUISourceCodeWithProvider(\n      uiSourceCode: Workspace.UISourceCode.UISourceCode,\n      contentProvider: TextUtils.ContentProvider.ContentProvider,\n      metadata: Workspace.UISourceCode.UISourceCodeMetadata|null,\n      mimeType: string,\n      ): void {\n    this.#uiSourceCodeToData.set(uiSourceCode, {mimeType, metadata, contentProvider});\n    this.addUISourceCode(uiSourceCode);\n  }\n\n  addContentProvider(\n      url: Platform.DevToolsPath.UrlString, contentProvider: TextUtils.ContentProvider.ContentProvider,\n      mimeType: string): Workspace.UISourceCode.UISourceCode {\n    const uiSourceCode = this.createUISourceCode(url, contentProvider.contentType());\n    this.addUISourceCodeWithProvider(uiSourceCode, contentProvider, null, mimeType);\n    return uiSourceCode;\n  }\n\n  reset(): void {\n    this.removeProject();\n    this.workspace().addProject(this);\n  }\n\n  dispose(): void {\n    this.removeProject();\n  }\n}\n"]}