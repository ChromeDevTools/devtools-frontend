{"version":3,"file":"NetworkProject.js","sourceRoot":"","sources":["../../../../../../front_end/models/bindings/NetworkProject.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2012 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport type * as Protocol from '../../generated/protocol.js';\nimport type * as Workspace from '../workspace/workspace.js';\n\nconst uiSourceCodeToAttributionMap = new WeakMap<Workspace.UISourceCode.UISourceCode, Map<Protocol.Page.FrameId, {\n                                                   frame: SDK.ResourceTreeModel.ResourceTreeFrame,\n                                                   count: number,\n                                                 }>>();\nconst projectToTargetMap = new WeakMap<Workspace.Workspace.Project, SDK.Target.Target>();\n\nlet networkProjectManagerInstance: NetworkProjectManager;\n\nexport class NetworkProjectManager extends Common.ObjectWrapper.ObjectWrapper<EventTypes> {\n  private constructor() {\n    super();\n  }\n\n  static instance({forceNew}: {\n    forceNew: boolean,\n  } = {forceNew: false}): NetworkProjectManager {\n    if (!networkProjectManagerInstance || forceNew) {\n      networkProjectManagerInstance = new NetworkProjectManager();\n    }\n\n    return networkProjectManagerInstance;\n  }\n}\n\nexport const enum Events {\n  FRAME_ATTRIBUTION_ADDED = 'FrameAttributionAdded',\n  FRAME_ATTRIBUTION_REMOVED = 'FrameAttributionRemoved',\n}\n\nexport interface FrameAttributionEvent {\n  uiSourceCode: Workspace.UISourceCode.UISourceCode;\n  frame: SDK.ResourceTreeModel.ResourceTreeFrame;\n}\n\nexport interface EventTypes {\n  [Events.FRAME_ATTRIBUTION_ADDED]: FrameAttributionEvent;\n  [Events.FRAME_ATTRIBUTION_REMOVED]: FrameAttributionEvent;\n}\n\nexport class NetworkProject {\n  static resolveFrame(uiSourceCode: Workspace.UISourceCode.UISourceCode, frameId: Protocol.Page.FrameId):\n      SDK.ResourceTreeModel.ResourceTreeFrame|null {\n    const target = NetworkProject.targetForUISourceCode(uiSourceCode);\n    const resourceTreeModel = target?.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    return resourceTreeModel ? resourceTreeModel.frameForId(frameId) : null;\n  }\n\n  static setInitialFrameAttribution(uiSourceCode: Workspace.UISourceCode.UISourceCode, frameId: Protocol.Page.FrameId):\n      void {\n    if (!frameId) {\n      return;\n    }\n    const frame = NetworkProject.resolveFrame(uiSourceCode, frameId);\n    if (!frame) {\n      return;\n    }\n    const attribution = new Map<Protocol.Page.FrameId, {\n      frame: SDK.ResourceTreeModel.ResourceTreeFrame,\n      count: number,\n    }>();\n    attribution.set(frameId, {frame, count: 1});\n    uiSourceCodeToAttributionMap.set(uiSourceCode, attribution);\n  }\n\n  static cloneInitialFrameAttribution(\n      fromUISourceCode: Workspace.UISourceCode.UISourceCode,\n      toUISourceCode: Workspace.UISourceCode.UISourceCode): void {\n    const fromAttribution = uiSourceCodeToAttributionMap.get(fromUISourceCode);\n    if (!fromAttribution) {\n      return;\n    }\n    const toAttribution = new Map<Protocol.Page.FrameId, {\n      frame: SDK.ResourceTreeModel.ResourceTreeFrame,\n      count: number,\n    }>();\n    for (const frameId of fromAttribution.keys()) {\n      const value = fromAttribution.get(frameId);\n      if (typeof value !== 'undefined') {\n        toAttribution.set(frameId, {frame: value.frame, count: value.count});\n      }\n    }\n    uiSourceCodeToAttributionMap.set(toUISourceCode, toAttribution);\n  }\n\n  static addFrameAttribution(uiSourceCode: Workspace.UISourceCode.UISourceCode, frameId: Protocol.Page.FrameId): void {\n    const frame = NetworkProject.resolveFrame(uiSourceCode, frameId);\n    if (!frame) {\n      return;\n    }\n    const frameAttribution = uiSourceCodeToAttributionMap.get(uiSourceCode);\n    if (!frameAttribution) {\n      return;\n    }\n    const attributionInfo = frameAttribution.get(frameId) || {frame, count: 0};\n    attributionInfo.count += 1;\n    frameAttribution.set(frameId, attributionInfo);\n    if (attributionInfo.count !== 1) {\n      return;\n    }\n\n    const data = {uiSourceCode, frame};\n    NetworkProjectManager.instance().dispatchEventToListeners(Events.FRAME_ATTRIBUTION_ADDED, data);\n  }\n\n  static removeFrameAttribution(uiSourceCode: Workspace.UISourceCode.UISourceCode, frameId: Protocol.Page.FrameId):\n      void {\n    const frameAttribution = uiSourceCodeToAttributionMap.get(uiSourceCode);\n    if (!frameAttribution) {\n      return;\n    }\n    const attributionInfo = frameAttribution.get(frameId);\n    console.assert(Boolean(attributionInfo), 'Failed to remove frame attribution for url: ' + uiSourceCode.url());\n    if (!attributionInfo) {\n      return;\n    }\n    attributionInfo.count -= 1;\n    if (attributionInfo.count > 0) {\n      return;\n    }\n    frameAttribution.delete(frameId);\n    const data = {uiSourceCode, frame: attributionInfo.frame};\n    NetworkProjectManager.instance().dispatchEventToListeners(Events.FRAME_ATTRIBUTION_REMOVED, data);\n  }\n\n  static targetForUISourceCode(uiSourceCode: Workspace.UISourceCode.UISourceCode): SDK.Target.Target|null {\n    return projectToTargetMap.get(uiSourceCode.project()) || null;\n  }\n\n  static setTargetForProject(project: Workspace.Workspace.Project, target: SDK.Target.Target): void {\n    projectToTargetMap.set(project, target);\n  }\n\n  static getTargetForProject(project: Workspace.Workspace.Project): SDK.Target.Target|null {\n    return projectToTargetMap.get(project) || null;\n  }\n\n  static framesForUISourceCode(uiSourceCode: Workspace.UISourceCode.UISourceCode):\n      SDK.ResourceTreeModel.ResourceTreeFrame[] {\n    const target = NetworkProject.targetForUISourceCode(uiSourceCode);\n    const resourceTreeModel = target?.model(SDK.ResourceTreeModel.ResourceTreeModel);\n    const attribution = uiSourceCodeToAttributionMap.get(uiSourceCode);\n    if (!resourceTreeModel || !attribution) {\n      return [];\n    }\n    const frames = Array.from(attribution.keys()).map(frameId => resourceTreeModel.frameForId(frameId));\n    return frames.filter(frame => !!frame);\n  }\n}\n"]}