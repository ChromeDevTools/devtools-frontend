{
  "version": 3,
  "sources": ["../../../../../../front_end/models/computed_style/ComputedStyleModel.ts"],
  "sourcesContent": ["// Copyright 2015 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as SDK from '../../core/sdk/sdk.js';\n\n/**\n * A thin wrapper around the CSS Model to gather up changes in CSS files that\n * could impact a node's computed styles.\n * Callers are expected to initiate tracking of the Node themselves via the CSS\n * Model trackComputedStyleUpdatesForNode method.\n */\nexport class ComputedStyleModel extends Common.ObjectWrapper.ObjectWrapper<EventTypes> {\n  #node: SDK.DOMModel.DOMNode|null;\n  #cssModel: SDK.CSSModel.CSSModel|null;\n  private eventListeners: Common.EventTarget.EventDescriptor[];\n  private frameResizedTimer?: number;\n  private computedStylePromise?: Promise<ComputedStyle|null>;\n\n  constructor(node?: SDK.DOMModel.DOMNode|null) {\n    super();\n    this.#cssModel = null;\n    this.eventListeners = [];\n    this.#node = node ?? null;\n  }\n\n  get node(): SDK.DOMModel.DOMNode|null {\n    return this.#node;\n  }\n\n  set node(node: SDK.DOMModel.DOMNode|null) {\n    this.#node = node;\n    this.updateModel(this.#node ? this.#node.domModel().cssModel() : null);\n    this.onCSSModelChanged(null);\n  }\n\n  cssModel(): SDK.CSSModel.CSSModel|null {\n    return this.#cssModel?.isEnabled() ? this.#cssModel : null;\n  }\n\n  private updateModel(cssModel: SDK.CSSModel.CSSModel|null): void {\n    if (this.#cssModel === cssModel) {\n      return;\n    }\n    Common.EventTarget.removeEventListeners(this.eventListeners);\n    this.#cssModel = cssModel;\n    const domModel = cssModel ? cssModel.domModel() : null;\n    const resourceTreeModel = cssModel ? cssModel.target().model(SDK.ResourceTreeModel.ResourceTreeModel) : null;\n\n    if (cssModel && domModel && resourceTreeModel) {\n      this.eventListeners = [\n        cssModel.addEventListener(SDK.CSSModel.Events.StyleSheetAdded, this.onCSSModelChanged, this),\n        cssModel.addEventListener(SDK.CSSModel.Events.StyleSheetRemoved, this.onCSSModelChanged, this),\n        cssModel.addEventListener(SDK.CSSModel.Events.StyleSheetChanged, this.onCSSModelChanged, this),\n        cssModel.addEventListener(SDK.CSSModel.Events.FontsUpdated, this.onCSSModelChanged, this),\n        cssModel.addEventListener(SDK.CSSModel.Events.MediaQueryResultChanged, this.onCSSModelChanged, this),\n        cssModel.addEventListener(SDK.CSSModel.Events.PseudoStateForced, this.onCSSModelChanged, this),\n        cssModel.addEventListener(SDK.CSSModel.Events.StartingStylesStateForced, this.onCSSModelChanged, this),\n        cssModel.addEventListener(SDK.CSSModel.Events.ModelWasEnabled, this.onCSSModelChanged, this),\n        cssModel.addEventListener(SDK.CSSModel.Events.ComputedStyleUpdated, this.onComputedStyleChanged, this),\n        domModel.addEventListener(SDK.DOMModel.Events.DOMMutated, this.onDOMModelChanged, this),\n        resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.FrameResized, this.onFrameResized, this),\n      ];\n    }\n  }\n\n  private onCSSModelChanged(event: Common.EventTarget.EventTargetEvent<CSSModelChangedEvent>|null): void {\n    delete this.computedStylePromise;\n    this.dispatchEventToListeners(Events.CSS_MODEL_CHANGED, event?.data ?? null);\n  }\n\n  private onComputedStyleChanged(\n      event: Common.EventTarget.EventTargetEvent<SDK.CSSModel.ComputedStyleUpdatedEvent>|null): void {\n    delete this.computedStylePromise;\n    // If the event contains `nodeId` and that's not the same as this node's id\n    // we don't emit the COMPUTED_STYLE_CHANGED event.\n    if (event?.data && 'nodeId' in event.data && event.data.nodeId !== this.#node?.id) {\n      return;\n    }\n\n    this.dispatchEventToListeners(Events.COMPUTED_STYLE_CHANGED);\n  }\n\n  private onDOMModelChanged(event: Common.EventTarget.EventTargetEvent<SDK.DOMModel.DOMNode>): void {\n    // Any attribute removal or modification can affect the styles of \"related\" nodes.\n    const node = event.data;\n    if (!this.#node ||\n        this.#node !== node && node.parentNode !== this.#node.parentNode && !node.isAncestor(this.#node)) {\n      return;\n    }\n    this.onCSSModelChanged(null);\n  }\n\n  private onFrameResized(): void {\n    function refreshContents(this: ComputedStyleModel): void {\n      this.onCSSModelChanged(null);\n      delete this.frameResizedTimer;\n    }\n\n    if (this.frameResizedTimer) {\n      clearTimeout(this.frameResizedTimer);\n    }\n\n    this.frameResizedTimer = window.setTimeout(refreshContents.bind(this), 100);\n  }\n\n  private elementNode(): SDK.DOMModel.DOMNode|null {\n    const node = this.node;\n    if (!node) {\n      return null;\n    }\n    return node.enclosingElementOrSelf();\n  }\n\n  async fetchComputedStyle(): Promise<ComputedStyle|null> {\n    const elementNode = this.elementNode();\n    const cssModel = this.cssModel();\n    if (!elementNode || !cssModel) {\n      return null;\n    }\n    const nodeId = elementNode.id;\n    if (!nodeId) {\n      return null;\n    }\n\n    if (!this.computedStylePromise) {\n      this.computedStylePromise = cssModel.getComputedStyle(nodeId).then(verifyOutdated.bind(this, elementNode));\n    }\n\n    return await this.computedStylePromise;\n\n    function verifyOutdated(\n        this: ComputedStyleModel, elementNode: SDK.DOMModel.DOMNode, style: Map<string, string>|null): ComputedStyle|\n        null {\n      return elementNode === this.elementNode() && style ? new ComputedStyle(elementNode, style) :\n                                                           null as ComputedStyle | null;\n    }\n  }\n}\n\nexport const enum Events {\n  CSS_MODEL_CHANGED = 'CSSModelChanged',\n  COMPUTED_STYLE_CHANGED = 'ComputedStyleChanged',\n}\n\nexport type CSSModelChangedEvent = SDK.CSSStyleSheetHeader.CSSStyleSheetHeader|SDK.CSSModel.StyleSheetChangedEvent|\n                                   SDK.CSSModel.PseudoStateForcedEvent|SDK.DOMModel.DOMNode|null|void;\n\nexport interface EventTypes {\n  [Events.CSS_MODEL_CHANGED]: CSSModelChangedEvent;\n  [Events.COMPUTED_STYLE_CHANGED]: void;\n}\n\nexport class ComputedStyle {\n  node: SDK.DOMModel.DOMNode;\n  computedStyle: Map<string, string>;\n  constructor(node: SDK.DOMModel.DOMNode, computedStyle: Map<string, string>) {\n    this.node = node;\n    this.computedStyle = computedStyle;\n  }\n}\n"],
  "mappings": "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",
  "names": ["elementNode"]
}
