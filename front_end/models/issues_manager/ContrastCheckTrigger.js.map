{"version":3,"file":"ContrastCheckTrigger.js","sourceRoot":"","sources":["../../../../../../front_end/models/issues_manager/ContrastCheckTrigger.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../core/common/common.js';\nimport * as Root from '../../core/root/root.js';\nimport * as SDK from '../../core/sdk/sdk.js';\n\nlet contrastCheckTriggerInstance: ContrastCheckTrigger|null = null;\n\nexport class ContrastCheckTrigger {\n  #pageLoadListeners = new WeakMap<SDK.ResourceTreeModel.ResourceTreeModel, Common.EventTarget.EventDescriptor>();\n  #frameAddedListeners = new WeakMap<SDK.ResourceTreeModel.ResourceTreeModel, Common.EventTarget.EventDescriptor>();\n\n  constructor() {\n    SDK.TargetManager.TargetManager.instance().observeModels(SDK.ResourceTreeModel.ResourceTreeModel, this);\n  }\n\n  static instance({forceNew}: {forceNew: boolean} = {forceNew: false}): ContrastCheckTrigger {\n    if (!contrastCheckTriggerInstance || forceNew) {\n      contrastCheckTriggerInstance = new ContrastCheckTrigger();\n    }\n\n    return contrastCheckTriggerInstance;\n  }\n\n  async modelAdded(resourceTreeModel: SDK.ResourceTreeModel.ResourceTreeModel): Promise<void> {\n    this.#pageLoadListeners.set(\n        resourceTreeModel,\n        resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.Load, this.#pageLoaded, this));\n    this.#frameAddedListeners.set(\n        resourceTreeModel,\n        resourceTreeModel.addEventListener(SDK.ResourceTreeModel.Events.FrameAdded, this.#frameAdded, this));\n  }\n\n  modelRemoved(resourceTreeModel: SDK.ResourceTreeModel.ResourceTreeModel): void {\n    const pageLoadListener = this.#pageLoadListeners.get(resourceTreeModel);\n    if (pageLoadListener) {\n      Common.EventTarget.removeEventListeners([pageLoadListener]);\n    }\n    const frameAddedListeners = this.#frameAddedListeners.get(resourceTreeModel);\n    if (frameAddedListeners) {\n      Common.EventTarget.removeEventListeners([frameAddedListeners]);\n    }\n  }\n\n  #checkContrast(resourceTreeModel: SDK.ResourceTreeModel.ResourceTreeModel): void {\n    if (!Root.Runtime.experiments.isEnabled('contrast-issues')) {\n      return;\n    }\n    void resourceTreeModel.target().auditsAgent().invoke_checkContrast({});\n  }\n\n  #pageLoaded(event: Common.EventTarget\n                  .EventTargetEvent<{resourceTreeModel: SDK.ResourceTreeModel.ResourceTreeModel, loadTime: number}>):\n      void {\n    const {resourceTreeModel} = event.data;\n    this.#checkContrast(resourceTreeModel);\n  }\n\n  async #frameAdded(event: Common.EventTarget.EventTargetEvent<SDK.ResourceTreeModel.ResourceTreeFrame>):\n      Promise<void> {\n    if (!Root.Runtime.experiments.isEnabled('contrast-issues')) {\n      return;\n    }\n    const frame = event.data;\n    if (!frame.isMainFrame()) {\n      return;\n    }\n    // If the target document finished loading, check the contrast immediately.\n    // Otherwise, it should be triggered when the page load event fires.\n    const response = await frame.resourceTreeModel().target().runtimeAgent().invoke_evaluate(\n        {expression: 'document.readyState', returnByValue: true});\n    if (response.result && response.result.value === 'complete') {\n      this.#checkContrast(frame.resourceTreeModel());\n    }\n  }\n}\n"]}