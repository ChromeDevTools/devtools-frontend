{"version":3,"file":"ChatView.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/ai_assistance/components/ChatView.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,4DAA4D;AAE5D,OAAO,6CAA6C,CAAC;AAErD,OAAO,KAAK,IAAI,MAAM,4BAA4B,CAAC;AACnD,OAAO,KAAK,IAAI,MAAM,4BAA4B,CAAC;AAGnD,OAAO,KAAK,OAAO,MAAM,2CAA2C,CAAC;AAErE,OAAO,KAAK,EAAE,MAAM,8BAA8B,CAAC;AACnD,OAAO,KAAK,GAAG,MAAM,wBAAwB,CAAC;AAC9C,OAAO,EAAC,WAAW,EAAC,MAAM,mBAAmB,CAAC;AAE9C,OAAO,EAAC,SAAS,EAAC,MAAM,gBAAgB,CAAC;AACzC,OAAO,cAAc,MAAM,mBAAmB,CAAC;AAC/C,OAAO,EAA0C,aAAa,EAAC,MAAM,oBAAoB,CAAC;AAE1F,OAAO,EAAC,SAAS,EAAsB,MAAM,gBAAgB,CAAC;AAE9D,MAAM,EAAC,IAAI,EAAE,UAAU,EAAE,EAAC,GAAG,EAAE,MAAM,EAAE,SAAS,EAAC,EAAC,GAAG,GAAG,CAAC;AAEzD;;EAEE;AACF,MAAM,qBAAqB,GAAG;IAC5B;;OAEG;IACH,cAAc,EAAE,qBAAqB;CAC7B,CAAC;AAEX,MAAM,YAAY,GAAG,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC;AAE5C,MAAM,sBAAsB,GAAG,CAAC,CAAC;AAkCjC,MAAM,OAAO,QAAS,SAAQ,WAAW;IAC9B,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,EAAC,IAAI,EAAE,MAAM,EAAC,CAAC,CAAC;IACrD,UAAU,CAAU;IACpB,MAAM,CAAQ;IACd,yBAAyB,CAAW;IACpC,eAAe,GAAG,SAAS,EAAe,CAAC;IAC3C,gCAAgC,GAAG,IAAI,cAAc,CAAC,GAAG,EAAE,CAAC,IAAI,CAAC,8BAA8B,EAAE,CAAC,CAAC;IACnG;;;;;;;;OAQG;IACH,kBAAkB,GAAG,IAAI,CAAC;IAC1B;;;;;OAKG;IACH,qBAAqB,GAAG,KAAK,CAAC;IAC9B,SAAS,GAAG,SAAS,EAAsC,CAAC;IAE5D,YAAY,KAAY;QACtB,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;IACtB,CAAC;IAED,IAAI,KAAK,CAAC,KAAY;QACpB,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC;QACpB,IAAI,CAAC,OAAO,EAAE,CAAC;IACjB,CAAC;IAED,iBAAiB;QACf,IAAI,CAAC,OAAO,EAAE,CAAC;QAEf,IAAI,IAAI,CAAC,yBAAyB,EAAE,CAAC;YACnC,IAAI,CAAC,gCAAgC,CAAC,OAAO,CAAC,IAAI,CAAC,yBAAyB,CAAC,CAAC;QAChF,CAAC;IACH,CAAC;IAED,oBAAoB;QAClB,IAAI,CAAC,gCAAgC,CAAC,UAAU,EAAE,CAAC;IACrD,CAAC;IAED,cAAc;QACZ,MAAM,QAAQ,GAAG,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,aAAa,CAAwB,CAAC;QAClF,IAAI,CAAC,QAAQ,EAAE,CAAC;YACd,OAAO;QACT,CAAC;QAED,QAAQ,CAAC,KAAK,EAAE,CAAC;IACnB,CAAC;IAED,qBAAqB;QACnB,IAAI,IAAI,CAAC,UAAU,KAAK,SAAS,EAAE,CAAC;YAClC,OAAO;QACT,CAAC;QAED,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,KAAK,EAAE,CAAC;YACjC,OAAO;QACT,CAAC;QAED,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;IACjD,CAAC;IAED,cAAc;QACZ,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,KAAK,EAAE,CAAC;YACjC,OAAO;QACT,CAAC;QAED,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;IACzE,CAAC;IAED,8BAA8B;QAC5B,IAAI,CAAC,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC7B,OAAO;QACT,CAAC;QAED,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,KAAK,EAAE,CAAC;YACjC,OAAO;QACT,CAAC;QAED,IAAI,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC5B,IAAI,CAAC,wBAAwB,CAAC,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,YAAY,CAAC,CAAC;QACzE,CAAC;IACH,CAAC;IAED,wBAAwB,CAAC,SAAiB;QACxC,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,KAAK,EAAE,CAAC;YACjC,OAAO;QACT,CAAC;QAED,IAAI,CAAC,UAAU,GAAG,SAAS,CAAC;QAC5B,IAAI,CAAC,qBAAqB,GAAG,IAAI,CAAC;QAClC,IAAI,CAAC,eAAe,CAAC,KAAK,CAAC,SAAS,GAAG,SAAS,CAAC;IACnD,CAAC;IAED,0BAA0B,CAAC,EAAqB;QAC9C,IAAI,CAAC,yBAAyB,GAAG,EAAE,CAAC;QAEpC,IAAI,EAAE,EAAE,CAAC;YACP,IAAI,CAAC,gCAAgC,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QACpD,CAAC;aAAM,CAAC;YACN,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;YAC/B,IAAI,CAAC,gCAAgC,CAAC,UAAU,EAAE,CAAC;QACrD,CAAC;IACH,CAAC;IAED,aAAa,GAAG,CAAC,EAAS,EAAQ,EAAE;QAClC,IAAI,CAAC,EAAE,CAAC,MAAM,IAAI,CAAC,CAAC,EAAE,CAAC,MAAM,YAAY,WAAW,CAAC,EAAE,CAAC;YACtD,OAAO;QACT,CAAC;QAED,yDAAyD;QACzD,6DAA6D;QAC7D,oDAAoD;QACpD,IAAI,IAAI,CAAC,qBAAqB,EAAE,CAAC;YAC/B,IAAI,CAAC,qBAAqB,GAAG,KAAK,CAAC;YACnC,OAAO;QACT,CAAC;QAED,IAAI,CAAC,UAAU,GAAG,EAAE,CAAC,MAAM,CAAC,SAAS,CAAC;QACtC,IAAI,CAAC,kBAAkB;YACnB,EAAE,CAAC,MAAM,CAAC,SAAS,GAAG,EAAE,CAAC,MAAM,CAAC,YAAY,GAAG,sBAAsB,GAAG,EAAE,CAAC,MAAM,CAAC,YAAY,CAAC;IACrG,CAAC,CAAC;IAEF,sBAAsB,GAAG,CAAC,UAAkB,EAAQ,EAAE;QACpD,IAAI,CAAC,SAAS,CAAC,KAAK,EAAE,SAAS,EAAE,EAAE,aAAa,CAAC,UAAU,CAAC,CAAC;QAC7D,IAAI,CAAC,OAAO,EAAE,CAAC;QACf,IAAI,CAAC,cAAc,EAAE,CAAC;QACtB,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,oCAAoC,CAAC,CAAC;IAC7F,CAAC,CAAC;IAEF,OAAO;QAEL,MAAM,kBAAkB,GAAG,GAAG,CAAC,UAAU,CAAC,QAAQ,CAAC;YACjD,mBAAmB,EAAE,IAAI;YACzB,MAAM,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,UAAU;SAChC,CAAC,CAAC;QAEH,mBAAmB;QACnB,GAAG,CAAC,MAAM,CAAC,IAAI,CAAA;eACJ,cAAc;;wBAEL,IAAI,CAAC,aAAa,IAAI,GAAG,CAAC,IAAI,CAAC,eAAe,CAAC;YAC3D,kBAAkB,CAAC;YACnB,QAAQ,EAAE,IAAI,CAAC,MAAM,CAAC,QAAQ;YAC9B,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,SAAS;YAChC,UAAU,EAAE,IAAI,CAAC,MAAM,CAAC,UAAU;YAClC,mBAAmB,EAAE,IAAI,CAAC,MAAM,CAAC,mBAAmB;YACpD,mBAAmB,EAAE,IAAI,CAAC,MAAM,CAAC,mBAAmB;YACpD,WAAW,EAAE,IAAI,CAAC,MAAM,CAAC,qBAAqB;YAC9C,QAAQ,EAAE,IAAI,CAAC,MAAM,CAAC,QAAQ;YAC9B,gBAAgB,EAAE,IAAI,CAAC,MAAM,CAAC,gBAAgB;YAC9C,aAAa,EAAE,IAAI,CAAC,MAAM,CAAC,aAAa;YACxC,aAAa,EAAE,IAAI,CAAC,MAAM,CAAC,aAAa;YACxC,iBAAiB,EAAE,IAAI,CAAC,sBAAsB;YAC9C,gBAAgB,EAAE,IAAI,CAAC,MAAM,CAAC,gBAAgB;YAC9C,qBAAqB,EAAE,IAAI,CAAC,0BAA0B;YACtD,mBAAmB,EAAE,IAAI,CAAC,MAAM,CAAC,mBAAmB;SACrD,CAAC;mCACuB,kBAAkB,kBAAkB,EAAE,CAAC,MAAM,CAAC,YAAY,CAAC,SAAS,EAAE;YAC7F,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,SAAS;YAChC,oBAAoB,EAAE,IAAI,CAAC,MAAM,CAAC,oBAAoB;YACtD,mBAAmB,EAAE,IAAI,CAAC,MAAM,CAAC,mBAAmB;YACpD,gBAAgB,EAAE,IAAI,CAAC,MAAM,CAAC,gBAAgB;YAC9C,cAAc,EAAE,IAAI,CAAC,MAAM,CAAC,cAAc;YAC1C,eAAe,EAAE,IAAI,CAAC,MAAM,CAAC,eAAe;YAC5C,qBAAqB,EAAE,IAAI,CAAC,MAAM,CAAC,qBAAqB;YACxD,sBAAsB,EAAE,IAAI,CAAC,MAAM,CAAC,sBAAsB,IAAI,KAAK;YACnE,gBAAgB,EAAE,IAAI,CAAC,MAAM,CAAC,gBAAgB;YAC9C,uBAAuB,EAAE,IAAI,CAAC,MAAM,CAAC,uBAAuB,IAAI,KAAK;YACrE,UAAU,EAAE,IAAI,CAAC,MAAM,CAAC,UAAU;YAClC,uBAAuB,EAAE,IAAI,CAAC,MAAM,CAAC,uBAAuB;YAC5D,cAAc,EAAE,IAAI,CAAC,MAAM,CAAC,cAAc;YAC1C,qBAAqB,EAAE,IAAI,CAAC,MAAM,CAAC,qBAAqB;YACxD,YAAY,EAAE,CACV,IAAY,EAAE,UAAiC,EAC/C,mBAAmE,EAAE,EAAE;gBACzE,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,IAAI,EAAE,UAAU,EAAE,mBAAmB,CAAC,CAAC;gBAChE,IAAI,CAAC,OAAO,EAAE,CAAC;YACjB,CAAC;YACD,aAAa,EAAE,IAAI,CAAC,MAAM,CAAC,aAAa;YACxC,iBAAiB,EAAE,IAAI,CAAC,MAAM,CAAC,iBAAiB;SACjD,CAAC,IAAI,GAAG,CAAC,IAAI,CAAC,SAAS,CAAC;;;KAG9B,EAAE,IAAI,CAAC,OAAO,EAAE,EAAC,IAAI,EAAE,IAAI,EAAC,CAAC,CAAC;QAC/B,kBAAkB;IACpB,CAAC;CACF;AAED,SAAS,kBAAkB,CAAC,EAC1B,QAAQ,EACR,SAAS,EACT,UAAU,EACV,mBAAmB,EACnB,mBAAmB,EACnB,WAAW,EACX,QAAQ,EACR,gBAAgB,EAChB,aAAa,EACb,aAAa,EACb,iBAAiB,EACjB,gBAAgB,EAChB,mBAAmB,EACnB,qBAAqB,GAgBtB;IACC,IAAI,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;QACxB,OAAO,cAAc,CAAC;YACpB,QAAQ;YACR,SAAS;YACT,UAAU;YACV,mBAAmB;YACnB,QAAQ;YACR,gBAAgB;YAChB,aAAa;YACb,aAAa;YACb,iBAAiB;YACjB,gBAAgB;YAChB,qBAAqB;YACrB,mBAAmB;SACpB,CAAC,CAAC;IACL,CAAC;IAED,OAAO,gBAAgB,CAAC,EAAC,mBAAmB,EAAE,WAAW,EAAE,iBAAiB,EAAC,CAAC,CAAC;AACjF,CAAC;AAED,SAAS,cAAc,CAAC,EACtB,QAAQ,EACR,SAAS,EACT,UAAU,EACV,mBAAmB,EACnB,QAAQ,EACR,gBAAgB,EAChB,aAAa,EACb,aAAa,EACb,iBAAiB,EACjB,gBAAgB,EAChB,mBAAmB,EACnB,qBAAqB,GActB;IACC,SAAS,iBAAiB;QACxB,IAAI,SAAS,EAAE,CAAC;YACd,OAAO,GAAG,CAAC,OAAO,CAAC;QACrB,CAAC;QAED,mBAAmB;QACnB,OAAO,IAAI,CAAA;sBACO,EAAE,CAAC,MAAM,CAAC,YAAY,CAAC,WAAW,EAAE;YAClD,aAAa,EAAE,aAAa,IAAI,EAAE;YAClC,aAAa;SACd,CAAC;wBACgB,CAAC;QACrB,kBAAkB;IACpB,CAAC;IAED,mBAAmB;IACnB,OAAO,IAAI,CAAA;sCACyB,GAAG,CAAC,qBAAqB,CAAC;QACxD,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,EAAE,CAC3B,IAAI,CAAA,kCAAkC,EAAE,CAAC,MAAM,CAAC,YAAY,CAAC,aAAa,EAAE;QAC1E,OAAO;QACP,SAAS;QACT,UAAU;QACV,mBAAmB;QACnB,QAAQ;QACR,gBAAgB;QAChB,aAAa,EAAE,QAAQ,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC,KAAK,OAAO;QAC1C,iBAAiB;QACjB,gBAAgB;QAChB,mBAAmB;KACpB,CAAC,qBAAqB,CACxB;QACC,iBAAiB,EAAE;;GAExB,CAAC;IACF,kBAAkB;AACpB,CAAC;AAED,SAAS,gBAAgB,CAAC,EAAC,mBAAmB,EAAE,WAAW,EAAE,iBAAiB,EAI7E;IACC,mBAAmB;IACnB,OAAO,IAAI,CAAA;;;;;;;YAOD,YAAY,CAAC,qBAAqB,CAAC,cAAc,CAAC;;;QAGtD,WAAW,CAAC,GAAG,CAAC,CAAC,EAAC,KAAK,EAAE,YAAY,EAAC,EAAE,EAAE;QAC1C,OAAO,IAAI,CAAA;;mBAEA,GAAG,EAAE,CAAC,iBAAiB,CAAC,KAAK,CAAC;kBAErC;YACE,OAAO,kDAAiC;YACxC,IAAI,6CAA6B;YACjC,KAAK;YACL,YAAY,EAAE,YAAY,IAAI,YAAY;YAC1C,QAAQ,EAAE,mBAAmB;SAEjC;WACC,KAAK,oBAAoB,CAAC;IAC/B,CAAC,CAAC;;SAEC,CAAC;IACR,kBAAkB;AACpB,CAAC;AAQD,cAAc,CAAC,MAAM,CAAC,uBAAuB,EAAE,QAAQ,CAAC,CAAC","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/* eslint-disable @devtools/no-lit-render-outside-of-view */\n\nimport '../../../ui/components/spinners/spinners.js';\n\nimport * as Host from '../../../core/host/host.js';\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport type * as Platform from '../../../core/platform/platform.js';\nimport type * as AiAssistanceModel from '../../../models/ai_assistance/ai_assistance.js';\nimport * as Buttons from '../../../ui/components/buttons/buttons.js';\nimport type {MarkdownLitRenderer} from '../../../ui/components/markdown_view/MarkdownView.js';\nimport * as UI from '../../../ui/legacy/legacy.js';\nimport * as Lit from '../../../ui/lit/lit.js';\nimport {PatchWidget} from '../PatchWidget.js';\n\nimport {ChatInput} from './ChatInput.js';\nimport chatViewStyles from './chatView.css.js';\nimport {type ChatMessage, type ModelChatMessage, UserActionRow} from './UserActionRow.js';\n\nexport {ChatInput, type ImageInputData} from './ChatInput.js';\n\nconst {html, Directives: {ref, repeat, createRef}} = Lit;\n\n/*\n* Strings that don't need to be translated at this time.\n*/\nconst UIStringsNotTranslate = {\n  /**\n   * @description Text for the empty state of the AI assistance panel.\n   */\n  emptyStateText: 'How can I help you?',\n} as const;\n\nconst lockedString = i18n.i18n.lockedString;\n\nconst SCROLL_ROUNDING_OFFSET = 1;\n\nexport interface Props {\n  onTextSubmit:\n      (text: string, imageInput?: Host.AidaClient.Part,\n       multimodalInputType?: AiAssistanceModel.AiAgent.MultimodalInputType) => void;\n  onInspectElementClick: () => void;\n  onFeedbackSubmit: (rpcId: Host.AidaClient.RpcGlobalId, rate: Host.AidaClient.Rating, feedback?: string) => void;\n  onCancelClick: () => void;\n  onContextClick: () => void;\n  onNewConversation: () => void;\n  onCopyResponseClick: (message: ModelChatMessage) => void;\n  changeManager: AiAssistanceModel.ChangeManager.ChangeManager;\n  inspectElementToggled: boolean;\n  messages: ChatMessage[];\n  selectedContext: AiAssistanceModel.AiAgent.ConversationContext<unknown>|null;\n  isLoading: boolean;\n  canShowFeedbackForm: boolean;\n  userInfo: Pick<Host.InspectorFrontendHostAPI.SyncInformation, 'accountImage'|'accountFullName'>;\n  conversationType: AiAssistanceModel.AiHistoryStorage.ConversationType;\n  isReadOnly: boolean;\n  blockedByCrossOrigin: boolean;\n  changeSummary?: string;\n  multimodalInputEnabled?: boolean;\n  isTextInputDisabled: boolean;\n  emptyStateSuggestions: AiAssistanceModel.AiAgent.ConversationSuggestion[];\n  inputPlaceholder: Platform.UIString.LocalizedString;\n  disclaimerText: Platform.UIString.LocalizedString;\n  isArtifactsSidebarOpen: boolean;\n  uploadImageInputEnabled?: boolean;\n  markdownRenderer: MarkdownLitRenderer;\n  additionalFloatyContext: UI.Floaty.FloatyContextSelection[];\n}\n\nexport class ChatView extends HTMLElement {\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  #scrollTop?: number;\n  #props: Props;\n  #messagesContainerElement?: Element;\n  #mainElementRef = createRef<HTMLElement>();\n  #messagesContainerResizeObserver = new ResizeObserver(() => this.#handleMessagesContainerResize());\n  /**\n   * Indicates whether the chat scroll position should be pinned to the bottom.\n   *\n   * This is true when:\n   *   - The scroll is at the very bottom, allowing new messages to push the scroll down automatically.\n   *   - The panel is initially rendered and the user hasn't scrolled yet.\n   *\n   * It is set to false when the user scrolls up to view previous messages.\n   */\n  #pinScrollToBottom = true;\n  /**\n   * Indicates whether the scroll event originated from code\n   * or a user action. When set to `true`, `handleScroll` will ignore the event,\n   * allowing it to only handle user-driven scrolls and correctly decide\n   * whether to pin the content to the bottom.\n   */\n  #isProgrammaticScroll = false;\n  #inputRef = createRef<UI.Widget.WidgetElement<ChatInput>>();\n\n  constructor(props: Props) {\n    super();\n    this.#props = props;\n  }\n\n  set props(props: Props) {\n    this.#props = props;\n    this.#render();\n  }\n\n  connectedCallback(): void {\n    this.#render();\n\n    if (this.#messagesContainerElement) {\n      this.#messagesContainerResizeObserver.observe(this.#messagesContainerElement);\n    }\n  }\n\n  disconnectedCallback(): void {\n    this.#messagesContainerResizeObserver.disconnect();\n  }\n\n  focusTextInput(): void {\n    const textArea = this.#shadow.querySelector('.chat-input') as HTMLTextAreaElement;\n    if (!textArea) {\n      return;\n    }\n\n    textArea.focus();\n  }\n\n  restoreScrollPosition(): void {\n    if (this.#scrollTop === undefined) {\n      return;\n    }\n\n    if (!this.#mainElementRef?.value) {\n      return;\n    }\n\n    this.#setMainElementScrollTop(this.#scrollTop);\n  }\n\n  scrollToBottom(): void {\n    if (!this.#mainElementRef?.value) {\n      return;\n    }\n\n    this.#setMainElementScrollTop(this.#mainElementRef.value.scrollHeight);\n  }\n\n  #handleMessagesContainerResize(): void {\n    if (!this.#pinScrollToBottom) {\n      return;\n    }\n\n    if (!this.#mainElementRef?.value) {\n      return;\n    }\n\n    if (this.#pinScrollToBottom) {\n      this.#setMainElementScrollTop(this.#mainElementRef.value.scrollHeight);\n    }\n  }\n\n  #setMainElementScrollTop(scrollTop: number): void {\n    if (!this.#mainElementRef?.value) {\n      return;\n    }\n\n    this.#scrollTop = scrollTop;\n    this.#isProgrammaticScroll = true;\n    this.#mainElementRef.value.scrollTop = scrollTop;\n  }\n\n  #handleMessageContainerRef(el: Element|undefined): void {\n    this.#messagesContainerElement = el;\n\n    if (el) {\n      this.#messagesContainerResizeObserver.observe(el);\n    } else {\n      this.#pinScrollToBottom = true;\n      this.#messagesContainerResizeObserver.disconnect();\n    }\n  }\n\n  #handleScroll = (ev: Event): void => {\n    if (!ev.target || !(ev.target instanceof HTMLElement)) {\n      return;\n    }\n\n    // Do not handle scroll events caused by programmatically\n    // updating the scroll position. We want to know whether user\n    // did scroll the container from the user interface.\n    if (this.#isProgrammaticScroll) {\n      this.#isProgrammaticScroll = false;\n      return;\n    }\n\n    this.#scrollTop = ev.target.scrollTop;\n    this.#pinScrollToBottom =\n        ev.target.scrollTop + ev.target.clientHeight + SCROLL_ROUNDING_OFFSET > ev.target.scrollHeight;\n  };\n\n  #handleSuggestionClick = (suggestion: string): void => {\n    this.#inputRef.value?.getWidget()?.setInputValue(suggestion);\n    this.#render();\n    this.focusTextInput();\n    Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiAssistanceDynamicSuggestionClicked);\n  };\n\n  #render(): void {\n\n    const inputWidgetClasses = Lit.Directives.classMap({\n      'chat-input-widget': true,\n      sticky: !this.#props.isReadOnly,\n    });\n\n    // clang-format off\n    Lit.render(html`\n      <style>${chatViewStyles}</style>\n      <div class=\"chat-ui\">\n        <main @scroll=${this.#handleScroll} ${ref(this.#mainElementRef)}>\n          ${renderMainContents({\n            messages: this.#props.messages,\n            isLoading: this.#props.isLoading,\n            isReadOnly: this.#props.isReadOnly,\n            canShowFeedbackForm: this.#props.canShowFeedbackForm,\n            isTextInputDisabled: this.#props.isTextInputDisabled,\n            suggestions: this.#props.emptyStateSuggestions,\n            userInfo: this.#props.userInfo,\n            markdownRenderer: this.#props.markdownRenderer,\n            changeSummary: this.#props.changeSummary,\n            changeManager: this.#props.changeManager,\n            onSuggestionClick: this.#handleSuggestionClick,\n            onFeedbackSubmit: this.#props.onFeedbackSubmit,\n            onMessageContainerRef: this.#handleMessageContainerRef,\n            onCopyResponseClick: this.#props.onCopyResponseClick,\n          })}\n          <devtools-widget class=${inputWidgetClasses} .widgetConfig=${UI.Widget.widgetConfig(ChatInput, {\n            isLoading: this.#props.isLoading,\n            blockedByCrossOrigin: this.#props.blockedByCrossOrigin,\n            isTextInputDisabled: this.#props.isTextInputDisabled,\n            inputPlaceholder: this.#props.inputPlaceholder,\n            disclaimerText: this.#props.disclaimerText,\n            selectedContext: this.#props.selectedContext,\n            inspectElementToggled: this.#props.inspectElementToggled,\n            multimodalInputEnabled: this.#props.multimodalInputEnabled ?? false,\n            conversationType: this.#props.conversationType,\n            uploadImageInputEnabled: this.#props.uploadImageInputEnabled ?? false,\n            isReadOnly: this.#props.isReadOnly,\n            additionalFloatyContext: this.#props.additionalFloatyContext,\n            onContextClick: this.#props.onContextClick,\n            onInspectElementClick: this.#props.onInspectElementClick,\n            onTextSubmit: (\n                text: string, imageInput?: Host.AidaClient.Part,\n                multimodalInputType?: AiAssistanceModel.AiAgent.MultimodalInputType) => {\n              this.#props.onTextSubmit(text, imageInput, multimodalInputType);\n              this.#render();\n            },\n            onCancelClick: this.#props.onCancelClick,\n            onNewConversation: this.#props.onNewConversation,\n          })} ${ref(this.#inputRef)}></devtools-widget>\n        </main>\n      </div>\n    `, this.#shadow, {host: this});\n    // clang-format on\n  }\n}\n\nfunction renderMainContents({\n  messages,\n  isLoading,\n  isReadOnly,\n  canShowFeedbackForm,\n  isTextInputDisabled,\n  suggestions,\n  userInfo,\n  markdownRenderer,\n  changeSummary,\n  changeManager,\n  onSuggestionClick,\n  onFeedbackSubmit,\n  onCopyResponseClick,\n  onMessageContainerRef,\n}: {\n  messages: ChatMessage[],\n  isLoading: boolean,\n  isReadOnly: boolean,\n  canShowFeedbackForm: boolean,\n  isTextInputDisabled: boolean,\n  suggestions: AiAssistanceModel.AiAgent.ConversationSuggestion[],\n  userInfo: Pick<Host.InspectorFrontendHostAPI.SyncInformation, 'accountImage'|'accountFullName'>,\n  markdownRenderer: MarkdownLitRenderer,\n  changeManager: AiAssistanceModel.ChangeManager.ChangeManager,\n  onSuggestionClick: (suggestion: string) => void,\n  onFeedbackSubmit: (rpcId: Host.AidaClient.RpcGlobalId, rate: Host.AidaClient.Rating, feedback?: string) => void,\n  onCopyResponseClick: (message: ModelChatMessage) => void,\n  onMessageContainerRef: (el: Element|undefined) => void,\n  changeSummary?: string,\n}): Lit.LitTemplate {\n  if (messages.length > 0) {\n    return renderMessages({\n      messages,\n      isLoading,\n      isReadOnly,\n      canShowFeedbackForm,\n      userInfo,\n      markdownRenderer,\n      changeSummary,\n      changeManager,\n      onSuggestionClick,\n      onFeedbackSubmit,\n      onMessageContainerRef,\n      onCopyResponseClick\n    });\n  }\n\n  return renderEmptyState({isTextInputDisabled, suggestions, onSuggestionClick});\n}\n\nfunction renderMessages({\n  messages,\n  isLoading,\n  isReadOnly,\n  canShowFeedbackForm,\n  userInfo,\n  markdownRenderer,\n  changeSummary,\n  changeManager,\n  onSuggestionClick,\n  onFeedbackSubmit,\n  onCopyResponseClick,\n  onMessageContainerRef,\n}: {\n  messages: ChatMessage[],\n  isLoading: boolean,\n  isReadOnly: boolean,\n  canShowFeedbackForm: boolean,\n  userInfo: Pick<Host.InspectorFrontendHostAPI.SyncInformation, 'accountImage'|'accountFullName'>,\n  markdownRenderer: MarkdownLitRenderer,\n  onSuggestionClick: (suggestion: string) => void,\n  onFeedbackSubmit: (rpcId: Host.AidaClient.RpcGlobalId, rate: Host.AidaClient.Rating, feedback?: string) => void,\n  onCopyResponseClick: (message: ModelChatMessage) => void,\n  onMessageContainerRef: (el: Element|undefined) => void,\n  changeSummary?: string,\n  changeManager?: AiAssistanceModel.ChangeManager.ChangeManager,\n}): Lit.TemplateResult {\n  function renderPatchWidget(): Lit.LitTemplate {\n    if (isLoading) {\n      return Lit.nothing;\n    }\n\n    // clang-format off\n    return html`<devtools-widget\n      .widgetConfig=${UI.Widget.widgetConfig(PatchWidget, {\n        changeSummary: changeSummary ?? '',\n        changeManager,\n      })}\n    ></devtools-widget>`;\n    // clang-format on\n  }\n\n  // clang-format off\n  return html`\n    <div class=\"messages-container\" ${ref(onMessageContainerRef)}>\n      ${repeat(messages, message =>\n        html`<devtools-widget .widgetConfig=${UI.Widget.widgetConfig(UserActionRow, {\n          message,\n          isLoading,\n          isReadOnly,\n          canShowFeedbackForm,\n          userInfo,\n          markdownRenderer,\n          isLastMessage: messages.at(-1) === message,\n          onSuggestionClick,\n          onFeedbackSubmit,\n          onCopyResponseClick,\n        })}></devtools-widget>`\n      )}\n      ${renderPatchWidget()}\n    </div>\n  `;\n  // clang-format on\n}\n\nfunction renderEmptyState({isTextInputDisabled, suggestions, onSuggestionClick}: {\n  isTextInputDisabled: boolean,\n  suggestions: AiAssistanceModel.AiAgent.ConversationSuggestion[],\n  onSuggestionClick: (suggestion: string) => void,\n}): Lit.TemplateResult {\n  // clang-format off\n  return html`<div class=\"empty-state-container\">\n    <div class=\"header\">\n      <div class=\"icon\">\n        <devtools-icon\n          name=\"smart-assistant\"\n        ></devtools-icon>\n      </div>\n      <h1>${lockedString(UIStringsNotTranslate.emptyStateText)}</h1>\n    </div>\n    <div class=\"empty-state-content\">\n      ${suggestions.map(({title, jslogContext}) => {\n        return html`<devtools-button\n          class=\"suggestion\"\n          @click=${() => onSuggestionClick(title)}\n          .data=${\n            {\n              variant: Buttons.Button.Variant.OUTLINED,\n              size: Buttons.Button.Size.REGULAR,\n              title,\n              jslogContext: jslogContext ?? 'suggestion',\n              disabled: isTextInputDisabled,\n            } as Buttons.Button.ButtonData\n          }\n        >${title}</devtools-button>`;\n      })}\n    </div>\n  </div>`;\n  // clang-format on\n}\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-ai-chat-view': ChatView;\n  }\n}\n\ncustomElements.define('devtools-ai-chat-view', ChatView);\n"]}