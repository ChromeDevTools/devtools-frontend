{"version":3,"file":"DeviceBoundSessionsTreeElement.js","sourceRoot":"","sources":["../../../../../../front_end/panels/application/DeviceBoundSessionsTreeElement.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2026 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Common from '../../core/common/common.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport type * as Platform from '../../core/platform/platform.js';\nimport {createIcon} from '../../ui/kit/kit.js';\n\nimport {ApplicationPanelTreeElement, ExpandableApplicationPanelTreeElement} from './ApplicationPanelTreeElement.js';\nimport {\n  DeviceBoundSessionModelEvents,\n  type DeviceBoundSessionModelEventTypes,\n  type DeviceBoundSessionsModel\n} from './DeviceBoundSessionsModel.js';\nimport type {ResourcesPanel} from './ResourcesPanel.js';\n\nconst UIStrings = {\n  /**\n   *@description Text for section title Application panel sidebar. A website\n   * may decide to create a session for a user, for example when the user logs\n   * in. They can use a protocol to make it a \"device bound session\". That\n   * means that when the session expires, it is only possible for it to be\n   * extended on the device it was created on. Thus the session is considered\n   * to be bound to that device. For more details on the protocol, see\n   * https://github.com/w3c/webappsec-dbsc/blob/main/README.md and\n   * https://w3c.github.io/webappsec-dbsc/.\n   */\n  deviceBoundSessions: 'Device bound sessions',\n  /**\n   *@description Empty state description for root tree element and site tree\n   * elements. A website may decide to create a session for a user, for example\n   * when the user logs in. They can use a protocol to make it a \"device bound\n   * session\". That means that when the session expires, it is only possible\n   * for it to be extended on the device it was created on. Thus the session\n   * is considered to be bound to that device. A session can have various events,\n   * such as when it's first created, when it's extended, or when it's\n   * terminated. For more details on the protocol, see\n   * https://github.com/w3c/webappsec-dbsc/blob/main/README.md and\n   * https://w3c.github.io/webappsec-dbsc/.\n   */\n  deviceBoundSessionsCategoryDescription: 'On this page you can view device bound sessions and associated events',\n  /**\n   *@description Events are sometimes linked to sessions. These are grouped\n   * visually either by session name or by 'No session' if any events are not\n   * linked to a session.\n   */\n  noSession: 'No session',\n} as const;\n\nconst str_ = i18n.i18n.registerUIStrings('panels/application/DeviceBoundSessionsTreeElement.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport class RootTreeElement extends ExpandableApplicationPanelTreeElement {\n  #model: DeviceBoundSessionsModel;\n  #sites = new Map<string, {siteTreeElement: ExpandableApplicationPanelTreeElement, sessions: Set<string|undefined>}>();\n\n  constructor(storagePanel: ResourcesPanel, model: DeviceBoundSessionsModel) {\n    super(\n        storagePanel, i18nString(UIStrings.deviceBoundSessions), i18nString(UIStrings.deviceBoundSessions),\n        i18nString(UIStrings.deviceBoundSessionsCategoryDescription), 'device-bound-sessions-root');\n    this.setLeadingIcons([createIcon('lock-person')]);\n    this.#model = model;\n  }\n\n  override get itemURL(): Platform.DevToolsPath.UrlString {\n    return 'device-bound-sessions://' as Platform.DevToolsPath.UrlString;\n  }\n\n  override onbind(): void {\n    super.onbind();\n    this.#model.addEventListener(DeviceBoundSessionModelEvents.INITIALIZE_SESSIONS, this.#onNewSessions, this);\n    this.#model.addEventListener(DeviceBoundSessionModelEvents.ADD_VISIBLE_SITE, this.#onVisibleSiteAdded, this);\n    this.#model.addEventListener(DeviceBoundSessionModelEvents.CLEAR_VISIBLE_SITES, this.#onVisibleSitesCleared, this);\n    this.#model.addEventListener(DeviceBoundSessionModelEvents.EVENT_OCCURRED, this.#onEventOccurred, this);\n  }\n\n  override onunbind(): void {\n    super.onunbind();\n    this.#model.removeEventListener(DeviceBoundSessionModelEvents.INITIALIZE_SESSIONS, this.#onNewSessions, this);\n    this.#model.removeEventListener(DeviceBoundSessionModelEvents.ADD_VISIBLE_SITE, this.#onVisibleSiteAdded, this);\n    this.#model.removeEventListener(\n        DeviceBoundSessionModelEvents.CLEAR_VISIBLE_SITES, this.#onVisibleSitesCleared, this);\n    this.#model.removeEventListener(DeviceBoundSessionModelEvents.EVENT_OCCURRED, this.#onEventOccurred, this);\n  }\n\n  #updateSiteTreeElementVisibility(site: string): void {\n    const siteMapEntry = this.#sites.get(site);\n    if (!siteMapEntry) {\n      return;\n    }\n\n    const siteTreeElement = siteMapEntry.siteTreeElement;\n    const isElementPresent = this.indexOfChild(siteTreeElement) >= 0;\n    const isSiteAllowed = this.#model.isSiteVisible(site);\n\n    if (isSiteAllowed && !isElementPresent) {\n      // Appending a child element that already has children requires a workaround of\n      // detaching and repopulating them so that the selection background color UI works.\n      // TODO(crbug.com/471021582): Can this fix safely be moved to Treeoutline.ts?\n      this.appendChild(siteTreeElement);\n      const children = [...siteTreeElement.children()];\n      siteTreeElement.removeChildren();\n      for (const child of children) {\n        siteTreeElement.appendChild(child);\n      }\n    } else if (!isSiteAllowed && isElementPresent) {\n      this.removeChild(siteTreeElement);\n    }\n  }\n\n  #addSiteSessionIfMissing(site: string, sessionId: string|undefined): void {\n    let siteMapEntry = this.#sites.get(site);\n    if (!siteMapEntry) {\n      const siteElement = new ExpandableApplicationPanelTreeElement(\n          this.resourcesPanel, site, i18nString(UIStrings.deviceBoundSessions),\n          i18nString(UIStrings.deviceBoundSessionsCategoryDescription), 'device-bound-sessions-site');\n      siteElement.setLeadingIcons([createIcon('cloud')]);\n      siteElement.itemURL = `device-bound-sessions://${site}` as Platform.DevToolsPath.UrlString;\n      siteMapEntry = {siteTreeElement: siteElement, sessions: new Set()};\n      this.#sites.set(site, siteMapEntry);\n    }\n\n    if (!siteMapEntry.sessions.has(sessionId)) {\n      const sessionElement = new ApplicationPanelTreeElement(\n          this.resourcesPanel, sessionId ?? i18nString(UIStrings.noSession), false, 'device-bound-sessions-session');\n      sessionElement.setLeadingIcons([createIcon('database')]);\n      sessionElement.itemURL = `device-bound-sessions://${site}/${sessionId || ''}` as Platform.DevToolsPath.UrlString;\n      const defaultOnSelect = sessionElement.onselect.bind(sessionElement);\n      sessionElement.onselect = (selectedByUser?: boolean): boolean => {\n        defaultOnSelect(selectedByUser);\n        this.resourcesPanel.showDeviceBoundSession(this.#model, site, sessionId);\n        return false;\n      };\n\n      if (sessionId === undefined) {\n        // The \"No session\" session is always listed at the top.\n        siteMapEntry.siteTreeElement.insertChild(sessionElement, 0);\n      } else {\n        siteMapEntry.siteTreeElement.appendChild(sessionElement);\n      }\n      siteMapEntry.sessions.add(sessionId);\n    }\n\n    this.#updateSiteTreeElementVisibility(site);\n  }\n\n  #onNewSessions({data: {sessions}}: Common.EventTarget.EventTargetEvent<\n                 DeviceBoundSessionModelEventTypes[DeviceBoundSessionModelEvents.INITIALIZE_SESSIONS]>): void {\n    for (const session of sessions) {\n      this.#addSiteSessionIfMissing(session.key.site, session.key.id);\n    }\n  }\n\n  #onVisibleSiteAdded(\n      {data: {site}}: Common.EventTarget\n          .EventTargetEvent<DeviceBoundSessionModelEventTypes[DeviceBoundSessionModelEvents.ADD_VISIBLE_SITE]>): void {\n    this.#updateSiteTreeElementVisibility(site);\n  }\n\n  #onVisibleSitesCleared(): void {\n    this.removeChildren();\n  }\n\n  #onEventOccurred(\n      {data: {site, sessionId}}: Common.EventTarget\n          .EventTargetEvent<DeviceBoundSessionModelEventTypes[DeviceBoundSessionModelEvents.EVENT_OCCURRED]>): void {\n    this.#addSiteSessionIfMissing(site, sessionId);\n  }\n}\n"]}