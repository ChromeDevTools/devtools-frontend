{"version":3,"file":"ExtensionStorageItemsView.js","sourceRoot":"","sources":["../../../../../../front_end/panels/application/ExtensionStorageItemsView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/*\n * Copyright (C) 2008 Nokia Inc.  All rights reserved.\n * Copyright (C) 2013 Samsung Electronics. All rights reserved.\n *\n * Redistribution and use in source and binary forms, with or without\n * modification, are permitted provided that the following conditions\n * are met:\n * 1. Redistributions of source code must retain the above copyright\n *    notice, this list of conditions and the following disclaimer.\n * 2. Redistributions in binary form must reproduce the above copyright\n *    notice, this list of conditions and the following disclaimer in the\n *    documentation and/or other materials provided with the distribution.\n *\n * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY\n * EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR\n * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL APPLE INC. OR\n * CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n * PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n * PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY\n * OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n */\n\nimport * as Common from '../../core/common/common.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport type * as Platform from '../../core/platform/platform.js';\nimport * as Protocol from '../../generated/protocol.js';\nimport * as TextUtils from '../../models/text_utils/text_utils.js';\nimport * as JSON5 from '../../third_party/json5/json5.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport * as VisualLogging from '../../ui/visual_logging/visual_logging.js';\n\nimport type {ExtensionStorage} from './ExtensionStorageModel.js';\nimport {KeyValueStorageItemsView, type View as KeyValueStorageItemsViewFunction} from './KeyValueStorageItemsView.js';\n\nconst UIStrings = {\n  /**\n   * @description Name for the \"Extension Storage Items\" table that shows the content of the extension Storage.\n   */\n  extensionStorageItems: 'Extension Storage Items',\n  /**\n   * @description Text for announcing that the \"Extension Storage Items\" table was cleared, that is, all\n   * entries were deleted.\n   */\n  extensionStorageItemsCleared: 'Extension Storage Items cleared',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/application/ExtensionStorageItemsView.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport namespace ExtensionStorageItemsDispatcher {\n  export const enum Events {\n    ITEM_EDITED = 'ItemEdited',\n    ITEMS_REFRESHED = 'ItemsRefreshed',\n  }\n\n  export interface EventTypes {\n    [Events.ITEM_EDITED]: void;\n    [Events.ITEMS_REFRESHED]: void;\n  }\n}\n\nexport class ExtensionStorageItemsView extends KeyValueStorageItemsView {\n  #extensionStorage!: ExtensionStorage;\n  readonly extensionStorageItemsDispatcher:\n      Common.ObjectWrapper.ObjectWrapper<ExtensionStorageItemsDispatcher.EventTypes>;\n\n  constructor(extensionStorage: ExtensionStorage, view?: KeyValueStorageItemsViewFunction) {\n    super(\n        i18nString(UIStrings.extensionStorageItems), 'extension-storage', true, view, undefined,\n        {jslog: `${VisualLogging.pane().context('extension-storage-data')}`, classes: ['storage-view', 'table']});\n\n    this.extensionStorageItemsDispatcher =\n        new Common.ObjectWrapper.ObjectWrapper<ExtensionStorageItemsDispatcher.EventTypes>();\n\n    this.setStorage(extensionStorage);\n  }\n\n  get #isEditable(): boolean {\n    // The managed storage area is always read only, since it exposes values\n    // set by enterprise policy.\n    return this.#extensionStorage.storageArea !== Protocol.Extensions.StorageArea.Managed;\n  }\n\n  /**\n   * When parsing a value provided by the user, attempt to treat it as JSON,\n   * falling back to a string otherwise.\n   */\n  parseValue(input: string): unknown {\n    try {\n      return JSON5.parse(input);\n    } catch {\n      return input;\n    }\n  }\n\n  protected removeItem(key: string): void {\n    void this.#extensionStorage.removeItem(key).then(() => {\n      this.refreshItems();\n    });\n  }\n\n  protected setItem(key: string, value: string): void {\n    void this.#extensionStorage.setItem(key, this.parseValue(value)).then(() => {\n      this.refreshItems();\n      this.extensionStorageItemsDispatcher.dispatchEventToListeners(ExtensionStorageItemsDispatcher.Events.ITEM_EDITED);\n    });\n  }\n\n  protected createPreview(key: string, value: string): Promise<UI.Widget.Widget|null> {\n    const url = 'extension-storage://' + this.#extensionStorage.extensionId + '/' + this.#extensionStorage.storageArea +\n            '/preview/' + key as Platform.DevToolsPath.UrlString;\n    const provider = TextUtils.StaticContentProvider.StaticContentProvider.fromString(\n        url,\n        Common.ResourceType.resourceTypes.XHR,\n        value,\n    );\n    return SourceFrame.PreviewFactory.PreviewFactory.createPreview(\n        provider,\n        'text/plain',\n    );\n  }\n\n  setStorage(extensionStorage: ExtensionStorage): void {\n    this.#extensionStorage = extensionStorage;\n\n    this.editable = this.#isEditable;\n\n    this.refreshItems();\n  }\n\n  #extensionStorageItemsCleared(): void {\n    if (!this.isShowing()) {\n      return;\n    }\n\n    this.itemsCleared();\n    UI.ARIAUtils.LiveAnnouncer.alert(i18nString(UIStrings.extensionStorageItemsCleared));\n  }\n\n  override deleteSelectedItem(): void {\n    if (!this.#isEditable) {\n      return;\n    }\n    this.deleteSelectedItem();\n  }\n\n  override refreshItems(): void {\n    void this.#refreshItems();\n  }\n\n  async #refreshItems(): Promise<void> {\n    const items = await this.#extensionStorage.getItems();\n    if (!items || !this.toolbar) {\n      return;\n    }\n    const filteredItems =\n        Object.entries(items)\n            .map(([key, value]) => ({key, value: typeof value === 'string' ? value : JSON.stringify(value)}))\n            .filter(item => this.toolbar?.filterRegex?.test(`${item.key} ${item.value}`) ?? true);\n    this.showItems(filteredItems);\n    this.extensionStorageItemsDispatcher.dispatchEventToListeners(\n        ExtensionStorageItemsDispatcher.Events.ITEMS_REFRESHED);\n  }\n\n  override deleteAllItems(): void {\n    if (!this.#isEditable) {\n      return;\n    }\n    this.#extensionStorage.clear().then(\n        () => {\n          this.#extensionStorageItemsCleared();\n        },\n        () => {\n          throw new Error('Unable to clear storage.');\n        });\n  }\n}\n"]}