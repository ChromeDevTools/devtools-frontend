{"version":3,"file":"BounceTrackingMitigationsView.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/application/components/BounceTrackingMitigationsView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2023 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport '../../../ui/components/report_view/report_view.js';\nimport '../../../ui/legacy/components/data_grid/data_grid.js';\n\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport * as SDK from '../../../core/sdk/sdk.js';\nimport * as Buttons from '../../../ui/components/buttons/buttons.js';\nimport * as UI from '../../../ui/legacy/legacy.js';\nimport * as Lit from '../../../ui/lit/lit.js';\nimport * as VisualLogging from '../../../ui/visual_logging/visual_logging.js';\n\nimport bounceTrackingMitigationsViewStyles from './bounceTrackingMitigationsView.css.js';\n\nconst {html} = Lit;\n\nconst UIStrings = {\n  /**\n   * @description Title text in bounce tracking mitigations view of the Application panel.\n   */\n  bounceTrackingMitigationsTitle: 'Bounce tracking mitigations',\n  /**\n   * @description Label for the button to force bounce tracking mitigations to run.\n   */\n  forceRun: 'Force run',\n  /**\n   * @description Label for the disabled button while bounce tracking mitigations are running\n   */\n  runningMitigations: 'Running',\n  /**\n   * @description Heading of table which displays sites whose state was deleted by bounce tracking mitigations.\n   */\n  stateDeletedFor: 'State was deleted for the following sites:',\n  /**\n   * @description Text shown once the deletion command has been sent to the browser process.\n   */\n  checkingPotentialTrackers: 'Checking for potential bounce tracking sites.',\n  /**\n   * @description Link text about explanation of Bounce Tracking Mitigations.\n   */\n  learnMore: 'Learn more: Bounce Tracking Mitigations',\n  /**\n   * @description Text shown when bounce tracking mitigations have been forced to run and\n   * identified no potential bounce tracking sites to delete state for. This may also\n   * indicate that bounce tracking mitigations are disabled or third-party cookies aren't being blocked.\n   */\n  noPotentialBounceTrackersIdentified:\n      'State was not cleared for any potential bounce tracking sites. Either none were identified or third-party cookies are not blocked.',\n  /**\n   * @description Text shown when bounce tracking mitigations are disabled.\n   */\n  featureDisabled: 'Bounce tracking mitigations are disabled.',\n} as const;\n\nconst str_ = i18n.i18n.registerUIStrings('panels/application/components/BounceTrackingMitigationsView.ts', UIStrings);\nexport const i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport const enum ScreenStatusType {\n  INITIALIZING = 'Initializing',\n  RUNNING = 'Running',\n  RESULT = 'Result',\n  DISABLED = 'Disabled',\n}\n\nexport interface BounceTrackingMitigationsViewData {\n  trackingSites: string[];\n}\n\nexport interface ViewInput {\n  screenStatus: ScreenStatusType;\n  trackingSites: string[];\n  seenButtonClick: boolean;\n  runMitigations: () => Promise<void>;\n}\n\nconst renderForceRunButton = (input: ViewInput): Lit.TemplateResult => {\n  const isMitigationRunning = (input.screenStatus === ScreenStatusType.RUNNING);\n\n  // clang-format off\n  return html`\n    <devtools-button\n      aria-label=${i18nString(UIStrings.forceRun)}\n      .disabled=${isMitigationRunning}\n      .spinner=${isMitigationRunning}\n      .variant=${Buttons.Button.Variant.PRIMARY}\n      @click=${input.runMitigations}\n      jslog=${VisualLogging.action('force-run').track({click: true})}>\n      ${isMitigationRunning ? html`\n        ${i18nString(UIStrings.runningMitigations)}`:`\n        ${i18nString(UIStrings.forceRun)}\n      `}\n    </devtools-button>\n  `;\n  // clang-format on\n};\n\nconst renderDeletedSitesOrNoSitesMessage = (input: ViewInput): Lit.LitTemplate => {\n  if (!input.seenButtonClick) {\n    return Lit.nothing;\n  }\n\n  if (input.trackingSites.length === 0) {\n    // clang-format off\n    return html`\n      <devtools-report-section>\n      ${(input.screenStatus === ScreenStatusType.RUNNING) ? html`\n        ${i18nString(UIStrings.checkingPotentialTrackers)}`:`\n        ${i18nString(UIStrings.noPotentialBounceTrackersIdentified)}\n      `}\n      </devtools-report-section>\n    `;\n    // clang-format on\n  }\n\n  // clang-format off\n  return html`\n    <devtools-report-section>\n      <devtools-data-grid striped inline>\n        <table>\n          <tr>\n            <th id=\"sites\" weight=\"10\" sortable>\n              ${i18nString(UIStrings.stateDeletedFor)}\n            </th>\n          </tr>\n          ${input.trackingSites.map(site => html`\n            <tr><td>${site}</td></tr>`)}\n        </table>\n      </devtools-data-grid>\n    </devtools-report-section>\n  `;\n  // clang-format on\n};\n\nconst renderMainFrameInformation = (input: ViewInput): Lit.LitTemplate => {\n  if (input.screenStatus === ScreenStatusType.INITIALIZING) {\n    return Lit.nothing;\n  }\n\n  if (input.screenStatus === ScreenStatusType.DISABLED) {\n    // clang-format off\n    return html`\n      <devtools-report-section>\n        ${i18nString(UIStrings.featureDisabled)}\n      </devtools-report-section>\n    `;\n    // clang-format on\n  }\n\n  // clang-format off\n  return html`\n    <devtools-report-section>\n      ${renderForceRunButton(input)}\n    </devtools-report-section>\n    ${renderDeletedSitesOrNoSitesMessage(input)}\n    <devtools-report-divider>\n    </devtools-report-divider>\n    <devtools-report-section>\n      <x-link href=\"https://privacycg.github.io/nav-tracking-mitigations/#bounce-tracking-mitigations\" class=\"link\"\n      jslog=${VisualLogging.link('learn-more').track({click: true})}>\n        ${i18nString(UIStrings.learnMore)}\n      </x-link>\n    </devtools-report-section>\n  `;\n  // clang-format on\n};\n\nexport const DEFAULT_VIEW = (input: ViewInput, _output: undefined, target: HTMLElement): void => {\n  // clang-format off\n  Lit.render(html`\n    <style>${bounceTrackingMitigationsViewStyles}</style>\n    <style>${UI.inspectorCommonStyles}</style>\n    <devtools-report .data=${{reportTitle: i18nString(UIStrings.bounceTrackingMitigationsTitle)}}\n                      jslog=${VisualLogging.pane('bounce-tracking-mitigations')}>\n      ${renderMainFrameInformation(input)}\n    </devtools-report>\n  `, target);\n  // clang-format on\n};\n\ntype ViewFunction = typeof DEFAULT_VIEW;\n\nexport class BounceTrackingMitigationsView extends UI.Widget.Widget {\n  #trackingSites: string[] = [];\n  #screenStatus = ScreenStatusType.INITIALIZING;\n  #seenButtonClick = false;\n  #view: ViewFunction;\n\n  constructor(element?: HTMLElement, view: ViewFunction = DEFAULT_VIEW) {\n    super(element, {useShadowDom: true, classes: ['overflow-auto']});\n\n    this.#view = view;\n\n    const mainTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    if (!mainTarget) {\n      this.#screenStatus = ScreenStatusType.RESULT;\n    } else {\n      void mainTarget.systemInfo().invoke_getFeatureState({featureState: 'DIPS'}).then(state => {\n        this.#screenStatus = state.featureEnabled ? ScreenStatusType.RESULT : ScreenStatusType.DISABLED;\n        this.requestUpdate();\n      });\n    }\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n    this.requestUpdate();\n  }\n\n  override performUpdate(): void {\n    this.#view(\n        {\n          screenStatus: this.#screenStatus,\n          trackingSites: this.#trackingSites,\n          seenButtonClick: this.#seenButtonClick,\n          runMitigations: this.#runMitigations.bind(this),\n        },\n        undefined, this.contentElement);\n  }\n\n  async #runMitigations(): Promise<void> {\n    const mainTarget = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    if (!mainTarget) {\n      return;\n    }\n\n    this.#seenButtonClick = true;\n    this.#screenStatus = ScreenStatusType.RUNNING;\n\n    this.requestUpdate();\n\n    const response = await mainTarget.storageAgent().invoke_runBounceTrackingMitigations();\n    this.#trackingSites = [];\n    response.deletedSites.forEach(element => {\n      this.#trackingSites.push(element);\n    });\n\n    this.#renderMitigationsResult();\n  }\n\n  #renderMitigationsResult(): void {\n    this.#screenStatus = ScreenStatusType.RESULT;\n    this.requestUpdate();\n  }\n}\n"]}