{"version":3,"file":"StackTrace.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/application/components/StackTrace.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-lit-render-outside-of-view */\n\nimport '../../../ui/components/expandable_list/expandable_list.js';\n\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport type * as SDK from '../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../generated/protocol.js';\nimport * as Components from '../../../ui/legacy/components/utils/utils.js';\nimport * as UI from '../../../ui/legacy/legacy.js';\nimport {html, nothing, render, type TemplateResult} from '../../../ui/lit/lit.js';\nimport * as VisualLogging from '../../../ui/visual_logging/visual_logging.js';\n\nimport stackTraceLinkButtonStyles from './stackTraceLinkButton.css.js';\nimport stackTraceRowStyles from './stackTraceRow.css.js';\n\nconst {widgetConfig} = UI.Widget;\n\nconst UIStrings = {\n  /**\n   * @description Error message stating that something went wrong when trying to render stack trace\n   */\n  cannotRenderStackTrace: 'Cannot render stack trace',\n  /**\n   * @description A link to show more frames in the stack trace if more are available. Never 0.\n   */\n  showSMoreFrames: '{n, plural, =1 {Show # more frame} other {Show # more frames}}',\n  /**\n   * @description A link to rehide frames that are by default hidden.\n   */\n  showLess: 'Show less',\n  /**\n   * @description Label for a stack trace. If a frame is created programmatically (i.e. via JavaScript), there is a\n   * stack trace for the line of code which caused the creation of the iframe. This is the stack trace we are showing here.\n   */\n  creationStackTrace: 'Frame Creation `Stack Trace`',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/application/components/StackTrace.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nexport interface StackTraceData {\n  creationStackTraceData: {\n    creationStackTrace: Protocol.Runtime.StackTrace|null,\n    creationStackTraceTarget: SDK.Target.Target|null,\n  };\n  buildStackTraceRows: (\n      stackTrace: Protocol.Runtime.StackTrace,\n      target: SDK.Target.Target|null,\n      linkifier: Components.Linkifier.Linkifier,\n      tabStops: boolean|undefined,\n      updateCallback?: (arg0: Array<Components.JSPresentationUtils.StackTraceRegularRow|\n                                    Components.JSPresentationUtils.StackTraceAsyncRow>) => void,\n      ) => Array<Components.JSPresentationUtils.StackTraceRegularRow|Components.JSPresentationUtils.StackTraceAsyncRow>;\n}\n\ninterface StackTraceRowViewInput {\n  stackTraceRowItem: Components.JSPresentationUtils.StackTraceRegularRow|null;\n}\n\ntype StackTraceRowView = (input: StackTraceRowViewInput, output: undefined, target: HTMLElement) => void;\nconst ROW_DEFAULT_VIEW: StackTraceRowView = (input, output, target) => {\n  if (!input.stackTraceRowItem) {\n    return;\n  }\n  // clang-format off\n  render(html`\n    <style>${stackTraceRowStyles}</style>\n    <div class=\"stack-trace-row\">\n      <div class=\"stack-trace-function-name text-ellipsis\" title=${input.stackTraceRowItem.functionName}>\n        ${input.stackTraceRowItem.functionName}\n      </div>\n      <div class=\"stack-trace-source-location\">\n        ${input.stackTraceRowItem.link ? html`\n          <div class=\"text-ellipsis\">\\xA0@\\xA0${input.stackTraceRowItem.link}</div>` :\n          nothing}\n        </div>\n      </div>`, target);\n  // clang-format on\n};\n\nexport class StackTraceRow extends UI.Widget.Widget {\n  constructor(element?: HTMLElement, view = ROW_DEFAULT_VIEW) {\n    super(element, {useShadowDom: true});\n    this.#view = view;\n  }\n\n  stackTraceRowItem: Components.JSPresentationUtils.StackTraceRegularRow|null = null;\n  #view: StackTraceRowView;\n\n  override performUpdate(): void {\n    this.#view(this, undefined, this.contentElement);\n  }\n}\n\ninterface StackTraceLinkViewInput {\n  onShowAllClick: () => void;\n  hiddenCallFramesCount: number|null;\n  expandedView: boolean;\n}\n\ntype StackTraceLinkView = (input: StackTraceLinkViewInput, output: undefined, target: HTMLElement) => void;\nconst LINK_DEFAULT_VIEW: StackTraceLinkView = (input, output, target) => {\n  if (!input.hiddenCallFramesCount) {\n    return;\n  }\n  const linkText = input.expandedView ? i18nString(UIStrings.showLess) :\n                                        i18nString(UIStrings.showSMoreFrames, {n: input.hiddenCallFramesCount});\n  // clang-format off\n  render(html`\n    <style>${stackTraceLinkButtonStyles}</style>\n    <div class=\"stack-trace-row\">\n      <button class=\"link\" @click=${() => input.onShowAllClick()}>\n        ${linkText}\n      </button>\n    </div>`, target);\n  // clang-format on\n};\n\nexport class StackTraceLinkButton extends UI.Widget.Widget {\n  onShowAllClick: () => void = () => {};\n  hiddenCallFramesCount: number|null = null;\n  expandedView = false;\n  #view: StackTraceLinkView;\n\n  constructor(element?: HTMLElement, view = LINK_DEFAULT_VIEW) {\n    super(element, {useShadowDom: true});\n    this.#view = view;\n  }\n\n  override performUpdate(): void {\n    this.#view(this, undefined, this.contentElement);\n  }\n}\n\nexport class StackTrace extends UI.Widget.Widget {\n  readonly #linkifier = new Components.Linkifier.Linkifier();\n  #stackTraceRows:\n      Array<Components.JSPresentationUtils.StackTraceRegularRow|Components.JSPresentationUtils.StackTraceAsyncRow> = [];\n  #showHidden = false;\n\n  constructor(element?: HTMLElement) {\n    super(element, {useShadowDom: true});\n  }\n\n  set data(data: StackTraceData) {\n    const {creationStackTrace, creationStackTraceTarget} = data.creationStackTraceData;\n    if (creationStackTrace) {\n      this.#stackTraceRows = data.buildStackTraceRows(\n          creationStackTrace, creationStackTraceTarget, this.#linkifier, true,\n          this.#onStackTraceRowsUpdated.bind(this));\n    }\n    this.#render();\n  }\n\n  #onStackTraceRowsUpdated(\n      stackTraceRows:\n          Array<Components.JSPresentationUtils.StackTraceRegularRow|Components.JSPresentationUtils.StackTraceAsyncRow>):\n      void {\n    this.#stackTraceRows = stackTraceRows;\n    this.#render();\n  }\n\n  #onToggleShowAllClick(): void {\n    this.#showHidden = !this.#showHidden;\n    this.#render();\n  }\n\n  createRowTemplates(): TemplateResult[] {\n    const expandableRows = [];\n    let hiddenCallFramesCount = 0;\n    for (const item of this.#stackTraceRows) {\n      let ignoreListHide = false;\n      // TODO(crbug.com/1183325): fix race condition with uiLocation still being null here\n      // Note: This has always checked whether the call frame location *in the generated\n      // code* is ignore-listed or not. This can change after the live location updates,\n      // and is handled again in the linkifier live location update callback.\n      if ('link' in item && item.link) {\n        const uiLocation = Components.Linkifier.Linkifier.uiLocation(item.link);\n        ignoreListHide = Boolean(uiLocation?.isIgnoreListed());\n      }\n      if (this.#showHidden || !ignoreListHide) {\n        if ('functionName' in item) {\n          expandableRows.push(html`\n          <devtools-widget data-stack-trace-row .widgetConfig=${widgetConfig(StackTraceRow, {\n            stackTraceRowItem: item\n          })}></devtools-widget>`);\n        }\n        if ('asyncDescription' in item) {\n          expandableRows.push(html`\n            <div>${item.asyncDescription}</div>\n          `);\n        }\n      }\n      if ('functionName' in item && ignoreListHide) {\n        hiddenCallFramesCount++;\n      }\n    }\n    if (hiddenCallFramesCount) {\n      // Disabled until https://crbug.com/1079231 is fixed.\n      // clang-format off\n      expandableRows.push(html`\n        <devtools-widget data-stack-trace-row .widgetConfig=${widgetConfig(StackTraceLinkButton, {\n          onShowAllClick: this.#onToggleShowAllClick.bind(this),\n          hiddenCallFramesCount,\n          expandedView: this.#showHidden})}>\n        </devtools-widget>\n      `);\n      // clang-format on\n    }\n\n    return expandableRows;\n  }\n\n  #render(): void {\n    if (!this.#stackTraceRows.length) {\n      // Disabled until https://crbug.com/1079231 is fixed.\n      // clang-format off\n      render(\n        html`\n          <span>${i18nString(UIStrings.cannotRenderStackTrace)}</span>\n        `,\n        this.contentElement, {host: this});\n      return;\n    }\n\n    const expandableRows = this.createRowTemplates();\n    render(\n      html`\n        <devtools-expandable-list .data=${{rows: expandableRows, title: i18nString(UIStrings.creationStackTrace)}}\n                                  jslog=${VisualLogging.tree()}>\n        </devtools-expandable-list>\n      `,\n      this.contentElement, {host: this});\n    // clang-format on\n  }\n}\n"]}