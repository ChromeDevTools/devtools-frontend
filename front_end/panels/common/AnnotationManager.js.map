{"version":3,"file":"AnnotationManager.js","sourceRoot":"","sources":["../../../../../../front_end/panels/common/AnnotationManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Common from '../../core/common/common.js';\nimport type * as SDK from '../../core/sdk/sdk.js';\nimport * as Annotations from '../../models/annotations/annotations.js';\n\nimport {Annotation} from './Annotation.js';\n\ninterface AnnotationData {\n  id: number;\n  type: Annotations.AnnotationType;\n  annotation: Annotation;\n}\n\ninterface AnnotationPlacement {\n  parentElement: Element;\n  insertBefore?: Node|null;\n  resolveInitialState:\n      (parentElement: Element, reveal: boolean, lookupId: string,\n       anchor?: SDK.DOMModel.DOMNode|SDK.NetworkRequest.NetworkRequest) => Promise<{x: number, y: number}|null>;\n}\n\n// This class handles general management of Annotations, the data needed to display them and any panel-specific things\n// that the AnnotationRepository must be free from. It is created on-demand the first time a panel, that wants to show\n// an Annotation, appears.\n//\n// NOTE: For now this class is not for general use and is inactive (unless a specific flag is supplied).\nexport class AnnotationManager {\n  static #instance: AnnotationManager|null = null;\n\n  #annotationPlacements: Map<Annotations.AnnotationType, AnnotationPlacement>|null = null;\n  #annotations = new Map<number, AnnotationData>();\n  #synced = false;\n\n  constructor() {\n    if (!Annotations.AnnotationRepository.annotationsEnabled()) {\n      console.warn('AnnotationManager created with annotations disabled');\n      return;\n    }\n\n    Annotations.AnnotationRepository.instance().addEventListener(\n        Annotations.Events.ANNOTATION_ADDED, this.#onAnnotationAdded, this);\n    Annotations.AnnotationRepository.instance().addEventListener(\n        Annotations.Events.ANNOTATION_DELETED, this.#onAnnotationDeleted, this);\n    Annotations.AnnotationRepository.instance().addEventListener(\n        Annotations.Events.ALL_ANNOTATIONS_DELETED, this.#onAllAnnotationsDeleted, this);\n  }\n\n  static instance(): AnnotationManager {\n    if (!AnnotationManager.#instance) {\n      AnnotationManager.#instance = new AnnotationManager();\n    }\n    return AnnotationManager.#instance;\n  }\n\n  initializePlacementForAnnotationType(\n      type: Annotations.AnnotationType,\n      resolveInitialState:\n          (parentElement: Element, reveal: boolean, lookupId: string,\n           anchor?: SDK.DOMModel.DOMNode|SDK.NetworkRequest.NetworkRequest) => Promise<{x: number, y: number}|null>,\n      parentElement: Element, insertBefore: Node|null = null): void {\n    if (!Annotations.AnnotationRepository.annotationsEnabled()) {\n      return;\n    }\n\n    if (!this.#annotationPlacements) {\n      this.#annotationPlacements = new Map();\n    }\n    this.#annotationPlacements.set(type, {parentElement, insertBefore, resolveInitialState});\n\n    // eslint-disable-next-line no-console\n    console.log(\n        `[AnnotationManager] initializing placement for ${Annotations.AnnotationType[type]}`, {parentElement},\n        'placement count:', this.#annotationPlacements);\n\n    this.#syncAnnotations();\n  }\n\n  #syncAnnotations(): void {\n    if (this.#synced) {\n      return;\n    }\n\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationManager] **** SYNC STARTED ***');\n    const repository = Annotations.AnnotationRepository.instance();\n    for (const type of Object.values(Annotations.AnnotationType)) {\n      for (const annotation of repository.getAnnotationDataByType(type as Annotations.AnnotationType)) {\n        // eslint-disable-next-line no-console\n        console.log(\n            '[AnnotationManager] Available annotation:', annotation,\n            'need sync:', !this.#annotations.has(annotation.id));\n        if (!this.#annotations.has(annotation.id)) {\n          this.#addAnnotation(annotation);\n        }\n      }\n    }\n    this.#synced = true;\n  }\n\n  #onAllAnnotationsDeleted(): void {\n    for (const annotation of this.#annotations.values()) {\n      annotation.annotation.hide();\n    }\n    this.#annotations = new Map();\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationManager] deleted all annotations');\n  }\n\n  #onAnnotationDeleted(\n      event: Common.EventTarget.EventTargetEvent<Annotations.EventTypes[Annotations.Events.ANNOTATION_DELETED]>): void {\n    const {id} = event.data;\n    const annotation = this.#annotations.get(id);\n    if (annotation) {\n      annotation.annotation.hide();\n      this.#annotations.delete(id);\n    }\n    // eslint-disable-next-line no-console\n    console.log(`[AnnotationManager] Deleted annotation with id ${id}`);\n  }\n\n  #onAnnotationAdded(\n      event: Common.EventTarget.EventTargetEvent<Annotations.EventTypes[Annotations.Events.ANNOTATION_ADDED]>): void {\n    const annotationData = event.data;\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationManager] handleAddAnnotation', annotationData);\n    this.#addAnnotation(annotationData);\n  }\n\n  #addAnnotation(annotationData: Annotations.BaseAnnotationData): void {\n    const expandable = annotationData.type !== Annotations.AnnotationType.NETWORK_REQUEST;\n    const showExpanded = annotationData.type !== Annotations.AnnotationType.NETWORK_REQUEST;\n    const showAnchored = annotationData.type !== Annotations.AnnotationType.NETWORK_REQUEST;\n    const showCloseButton = annotationData.type !== Annotations.AnnotationType.NETWORK_REQUEST;\n    const annotation = new Annotation(\n        annotationData.id, annotationData.message, showExpanded, showAnchored, expandable, showCloseButton);\n    this.#annotations.set(annotationData.id, {id: annotationData.id, type: annotationData.type, annotation});\n    // eslint-disable-next-line no-console\n    console.log('[AnnotationManager] addAnnotation called. Annotations now', this.#annotations);\n    requestAnimationFrame(async () => {\n      await this.#resolveAnnotationWithId(annotationData.id);\n    });\n  }\n\n  async resolveAnnotationsOfType(type: Annotations.AnnotationType): Promise<void> {\n    for (const annotationData of this.#annotations.values()) {\n      if (annotationData.type === type) {\n        await this.#resolveAnnotationWithId(annotationData.id);\n      }\n    }\n  }\n\n  async #resolveAnnotationWithId(id: number): Promise<void> {\n    const annotation = this.#annotations.get(id);\n    if (!annotation) {\n      console.warn('Unable to find annotation with id', id, ' in annotations map', this.#annotations);\n      return;\n    }\n\n    const placement = this.#annotationPlacements?.get(annotation.type);\n    if (!placement) {\n      console.warn(\n          'Unable to find placement for annotation with id', id,\n          '(note: this is expected if its panel hasn\\'t been shown yet).');\n      return;\n    }\n\n    let position = undefined;\n    const annotationRegistration = Annotations.AnnotationRepository.instance().getAnnotationDataById(id);\n    const reveal = !annotation.annotation.hasShown();\n    switch (annotationRegistration?.type) {\n      case Annotations.AnnotationType.ELEMENT_NODE: {\n        const elementData = annotationRegistration as Annotations.ElementsAnnotationData;\n        position = await placement.resolveInitialState(\n            placement.parentElement, reveal, elementData.lookupId, elementData.anchor);\n        break;\n      }\n      case Annotations.AnnotationType.NETWORK_REQUEST: {\n        const networkRequestData = annotationRegistration as Annotations.NetworkRequestAnnotationData;\n        position = await placement.resolveInitialState(\n            placement.parentElement, reveal, networkRequestData.lookupId, networkRequestData.anchor);\n        break;\n      }\n      case Annotations.AnnotationType.NETWORK_REQUEST_SUBPANEL_HEADERS: {\n        const networkRequestDetailsData = annotationRegistration as Annotations.NetworkRequestDetailsAnnotationData;\n        position = await placement.resolveInitialState(\n            placement.parentElement, reveal, networkRequestDetailsData.lookupId, networkRequestDetailsData.anchor);\n        break;\n      }\n      default:\n        console.warn('[AnnotationManager] Unknown AnnotationType', annotationRegistration?.type);\n    }\n\n    if (!position) {\n      // eslint-disable-next-line no-console\n      console.log(`Unable to calculate position for annotation with id ${annotationRegistration?.id}`);\n      return;\n    }\n\n    annotation.annotation.setCoordinates(position.x, position.y);\n\n    if (!annotation.annotation.isShowing()) {\n      annotation.annotation.show(placement.parentElement, placement.insertBefore);\n    }\n  }\n}\n"]}