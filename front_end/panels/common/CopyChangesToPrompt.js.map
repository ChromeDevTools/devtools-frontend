{"version":3,"file":"CopyChangesToPrompt.js","sourceRoot":"","sources":["../../../../../../front_end/panels/common/CopyChangesToPrompt.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Host from '../../core/host/host.js';\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as GreenDev from '../../models/greendev/greendev.js';\nimport type * as Workspace from '../../models/workspace/workspace.js';\nimport * as WorkspaceDiff from '../../models/workspace_diff/workspace_diff.js';\nimport * as Diff from '../../third_party/diff/diff.js';\nimport * as Buttons from '../../ui/components/buttons/buttons.js';\nimport * as Snackbars from '../../ui/components/snackbars/snackbars.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport * as Lit from '../../ui/lit/lit.js';\n\nconst {render, html} = Lit;\n\nconst UIStrings = {\n  /**\n   * @description The message shown in a toast when the response is copied to the clipboard.\n   */\n  responseCopiedToClipboard: 'Response copied to clipboard',\n} as const;\n\nconst str_ = i18n.i18n.registerUIStrings('panels/common/CopyChangesToPrompt.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\ninterface CopyChangesDiff {\n  diff: Diff.Diff.DiffArray|undefined;\n  uiSourceCode: Workspace.UISourceCode.UISourceCode;\n}\n\ninterface GeminiChangesViewInput {\n  /**\n   * These are the set of diffs tracked by the Changes Panel.\n   */\n  diffs: CopyChangesDiff[];\n  /**\n   * Supplied by the Patch Agent if it has made any changes on behalf of the\n   * user.\n   */\n  patchAgentCSSChange: string|null;\n  onCopyToClipboard: (text: string) => void;\n}\n\ntype GeminiChangesView = (input: GeminiChangesViewInput, output: object, target: HTMLElement) => void;\n\nexport class CopyChangesToPrompt extends UI.Widget.Widget {\n  #workspaceDiff: WorkspaceDiff.WorkspaceDiff.WorkspaceDiffImpl;\n  readonly #view: GeminiChangesView;\n  #patchAgentCSSChange: string|null = null;\n\n  constructor(target?: HTMLElement, view = GEMINI_CHANGES_VIEW) {\n    super(target);\n    this.#view = view;\n    this.#workspaceDiff = WorkspaceDiff.WorkspaceDiff.workspaceDiff();\n  }\n\n  get patchAgentCSSChange(): string|null {\n    return this.#patchAgentCSSChange;\n  }\n  set patchAgentCSSChange(code: string) {\n    this.#patchAgentCSSChange = code;\n    this.requestUpdate();\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n    this.#workspaceDiff.addEventListener(\n        WorkspaceDiff.WorkspaceDiff.Events.MODIFIED_STATUS_CHANGED, this.#onDiffChange, this);\n  }\n\n  override willHide(): void {\n    super.willHide();\n    this.#workspaceDiff.removeEventListener(\n        WorkspaceDiff.WorkspaceDiff.Events.MODIFIED_STATUS_CHANGED, this.#onDiffChange, this);\n  }\n\n  #getModifiledFiles(): Workspace.UISourceCode.UISourceCode[] {\n    return this.#workspaceDiff.modifiedUISourceCodes().filter(modified => {\n      return !modified.url().startsWith('inspector://');\n    });\n  }\n\n  #onDiffChange(): void {\n    // TODO: track this and unsubscribe to files?\n    for (const file of this.#getModifiledFiles()) {\n      this.#workspaceDiff.subscribeToDiffChange(file, this.requestUpdate, this);\n    }\n    this.requestUpdate();\n  }\n\n  set workspaceDiff(diff: WorkspaceDiff.WorkspaceDiff.WorkspaceDiffImpl) {\n    this.#workspaceDiff = diff;\n    this.requestUpdate();\n  }\n\n  override async performUpdate(): Promise<void> {\n    if (!GreenDev.Prototypes.instance().isEnabled('copyToGemini')) {\n      // We expect code that renders this component to only do so based on this flag, but this is a double-check.\n      return;\n    }\n\n    const diffs = await Promise.all(this.#getModifiledFiles().map(async modifiedUISourceCode => {\n      const diffResponse = await this.#workspaceDiff?.requestDiff(modifiedUISourceCode);\n      return {diff: diffResponse?.diff ?? [], uiSourceCode: modifiedUISourceCode};\n    }));\n    this.#view(\n        {\n          diffs,\n          patchAgentCSSChange: this.#patchAgentCSSChange,\n          onCopyToClipboard: (text: string) => {\n            Host.InspectorFrontendHost.InspectorFrontendHostInstance.copyText(text);\n            Snackbars.Snackbar.Snackbar.show({\n              message: i18nString(UIStrings.responseCopiedToClipboard),\n            });\n          }\n        },\n        {}, this.contentElement);\n  }\n}\nconst GEMINI_CHANGES_VIEW: GeminiChangesView = (input, _output, target) => {\n  const hasDiffs = input.diffs.some(d => {\n    return d.diff !== undefined && d.diff.length > 0;\n  });\n\n  if (!hasDiffs && !input.patchAgentCSSChange) {\n    render(Lit.nothing, target);\n    return;\n  }\n\n  const promptForChangesPanel = hasDiffs ? buildGeminiCommand(input.diffs) : '';\n  const promptForPatchAgentCSS = input.patchAgentCSSChange ? buildPatchAgentCSSPrompt(input.patchAgentCSSChange) : '';\n\n  const finalPrompt = [PREAMBLE, promptForChangesPanel, promptForPatchAgentCSS].filter(x => x.length > 0).join(`\\n`);\n\n  function copyClick(): void {\n    input.onCopyToClipboard(finalPrompt);\n  }\n  // clang-format off\n  render(html`<devtools-button\n      .iconName=${'copy'}\n      .variant=${Buttons.Button.Variant.OUTLINED}\n      @click=${copyClick}>Copy prompt to clipboard</devtools-button>\n    `, target);\n  // clang-format on\n};\n\nfunction buildPatchAgentCSSPrompt(code: string): string {\n  // clang-format off\n  return `The DevTools CSS Patching Agent has also made some CSS changes on behalf of the user. These changes are listed below. Think carefully about how best to apply these changes.\n\n**DevTools Patch Agent changes**\n\\`\\`\\`\n${code}\n\\`\\`\\``;\n  // clang-format on\n}\n\nfunction buildGeminiCommand(diffs: readonly CopyChangesDiff[]): string {\n  // clang-format off\n  const output = `Below this line are a list of files and the diff for each of them. Consider this diff and apply it to the codebase but remembering that the changes in DevTools may not be the most accurate fixes and you should not necessarily apply them directly as DevTools works with the deployed code and not the source code.\n\nWithin the diffs you will often see lines of code commented out. If the diff contains a new line that was some code being wrapped in comments, treat that as if the intent is to delete the code.\n\nHow to read a diff:\n* If a line starts with \\`-\\` , DevTools removed it.\n* If a line starts with \\`+\\` , DevTools added it.\n* If a line starts with neither a \\`+\\` or \\`-\\` , DevTools did not change the line and you can safely ignore it.\n\n${diffs.map(diff => {\n    if (!diff.diff || diff.diff.length === 0) {\n      return '';\n    }\n    return `Filename: ${diff.uiSourceCode.fullDisplayName()}\n\nDiff:\n${formatDiffForLLM(diff.diff)}`;\n  }).filter(x => x.length).join('\\n')}`;\n  // clang-format on\n  return output;\n}\n\nfunction formatDiffForLLM(diffArray: Diff.Diff.DiffArray): string {\n  let formattedDiff = '';\n  for (const diffItem of diffArray) {\n    const operation = diffItem[0];\n    const lines = diffItem[1];\n\n    for (const line of lines) {\n      if (operation === Diff.Diff.Operation.Equal) {\n        formattedDiff += '  ' + line + '\\n';\n      } else if (operation === Diff.Diff.Operation.Insert) {\n        formattedDiff += '+ ' + line + '\\n';\n      } else if (operation === Diff.Diff.Operation.Delete) {\n        formattedDiff += '- ' + line + '\\n';\n      }\n    }\n  }\n  return formattedDiff;\n}\n\nconst PREAMBLE =\n    `You are receiving a set of runtime changes (CSS, HTML, and JS) captured via Browser DevTools. Your goal is to persist these changes into the local source code by identifying the original source-of-truth.\n\nBecause DevTools reflects the \"Flattened Result\" of complex build logic, you must follow this \"Source-Aware\" strategy:\n\n1. **Structural Mapping (HTML/DOM):**\n    - If a DOM element was added/removed, identify the source template (JSX, Vue, Svelte, HTML) responsible.\n    - **Logic Check:** Determine if the change should be a static element or if it requires a new conditional (\\`if/else\\`) or loop (\\`map\\`) based on existing component patterns.\n\n2. **Style Mapping (CSS/Attributes):**\n    - Map raw styles to the project's specific styling architecture (Tailwind, SCSS, Styled-Components).\n    - Replace hard-coded values with existing Design Tokens or Theme Variables (\\`var(--color-primary)\\`, etc.) found in the codebase.\n    - CSS changes may not be applied to CSS files directly. Consider that CSS could be applied via JavaScript, especially if the codebase is using a component based frontend framework or web components.\n\n\n3. **Behavioral Mapping (JS/Event Listeners):**\n    - If logic or event handlers were modified, locate the corresponding functions or hooks in the source.\n    - Ensure new logic follows the project's state management patterns (e.g., React \\`useState\\`, Redux, or standard ES6+ modules).\n\n4. **Safety & Ambiguity Protocol:**\n    - **Third-Party Code:** If a change targets a DOM element or style generated by an external library (e.g., a UI kit's internal wrapper), do not modify the library's source. Instead, find the appropriate override mechanism in the codebase.\n    - **Uncertainty:** If a DevTools change cannot be mapped to the source with 100% confidence (e.g., minified selectors or ambiguous origin), stop and report the conflict rather than guessing.\n\n5. **Agentic Execution Workflow:**\n    - **Discovery:** Use your tools (\\`grep\\`, \\`find\\`, etc.) to locate unique strings or class names from the DevTools log.\n    - **Analysis:** Determine if the target is a reusable component or a specific page instance.\n    - **Implementation:** Execute file edits using the project's idiomatic syntax and formatting standards.\n\n**INSTRUCTION:**\nBegin by searching for the relevant source files. Explain your mapping logic before performing the edits.\n`;\n"]}