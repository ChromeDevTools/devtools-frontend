{"version":3,"file":"StyleEditorWidget.js","sourceRoot":"","sources":["../../../../../../front_end/panels/elements/StyleEditorWidget.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-imperative-dom-api */\n\nimport * as IconButton from '../../ui/components/icon_button/icon_button.js';\nimport * as UI from '../../ui/legacy/legacy.js';\n\nimport type * as ElementsComponents from './components/components.js';\nimport type {StylePropertiesSection} from './StylePropertiesSection.js';\nimport {StylePropertyTreeElement} from './StylePropertyTreeElement.js';\nimport type {StylesSidebarPane} from './StylesSidebarPane.js';\n\ntype PropertySelectedEvent = ElementsComponents.StylePropertyEditor.PropertySelectedEvent;\ntype PropertyDeselectedEvent = ElementsComponents.StylePropertyEditor.PropertyDeselectedEvent;\n\nlet instance: StyleEditorWidget|null = null;\ninterface Editor extends HTMLElement {\n  data: {\n    authoredProperties: Map<String, String>,\n    computedProperties: Map<String, String>,\n  };\n  getEditableProperties(): Array<{propertyName: string}>;\n  jslogContext: string;\n}\n\n/**\n * Thin UI.Widget wrapper around style editors to allow using it as a popover.\n */\nexport class StyleEditorWidget extends UI.Widget.VBox {\n  private editor?: Editor;\n  private pane?: StylesSidebarPane;\n  private section?: StylePropertiesSection;\n  private editorContainer: HTMLElement;\n\n  #triggerKey: string|undefined;\n\n  constructor() {\n    super({useShadowDom: true});\n    this.contentElement.tabIndex = 0;\n    this.setDefaultFocusedElement(this.contentElement);\n    this.editorContainer = document.createElement('div');\n    this.contentElement.appendChild(this.editorContainer);\n    this.onPropertySelected = this.onPropertySelected.bind(this);\n    this.onPropertyDeselected = this.onPropertyDeselected.bind(this);\n  }\n\n  getSection(): StylePropertiesSection|undefined {\n    return this.section;\n  }\n\n  async onPropertySelected(event: PropertySelectedEvent): Promise<void> {\n    if (!this.section) {\n      return;\n    }\n    const target = ensureTreeElementForProperty(this.section, event.data.name);\n    target.property.value = event.data.value;\n    target.updateTitle();\n    await target.applyStyleText(target.renderedPropertyText(), false);\n    await this.render();\n  }\n\n  async onPropertyDeselected(event: PropertyDeselectedEvent): Promise<void> {\n    if (!this.section) {\n      return;\n    }\n    const target = ensureTreeElementForProperty(this.section, event.data.name);\n    await target.applyStyleText('', false);\n    await this.render();\n  }\n\n  bindContext(pane: StylesSidebarPane, section: StylePropertiesSection): void {\n    this.pane = pane;\n    this.section = section;\n    this.editor?.addEventListener('propertyselected', this.onPropertySelected);\n    this.editor?.addEventListener('propertydeselected', this.onPropertyDeselected);\n  }\n\n  setTriggerKey(value: string): void {\n    this.#triggerKey = value;\n  }\n\n  getTriggerKey(): string|undefined {\n    return this.#triggerKey;\n  }\n\n  unbindContext(): void {\n    this.pane = undefined;\n    this.section = undefined;\n    this.editor?.removeEventListener('propertyselected', this.onPropertySelected);\n    this.editor?.removeEventListener('propertydeselected', this.onPropertyDeselected);\n  }\n\n  async render(): Promise<void> {\n    if (!this.editor) {\n      return;\n    }\n    this.editor.data = {\n      authoredProperties: this.section ? getAuthoredStyles(this.section, this.editor.getEditableProperties()) :\n                                         new Map(),\n      computedProperties: this.pane ? await fetchComputedStyles(this.pane) : new Map(),\n    };\n  }\n\n  static instance(): StyleEditorWidget {\n    if (!instance) {\n      instance = new StyleEditorWidget();\n    }\n    return instance;\n  }\n\n  setEditor(editorClass: {new(): Editor}): void {\n    if (!(this.editor instanceof editorClass)) {\n      this.contentElement.removeChildren();\n      this.editor = new editorClass();\n      this.contentElement.appendChild(this.editor);\n    }\n  }\n\n  static createTriggerButton(\n      pane: StylesSidebarPane, section: StylePropertiesSection, editorClass: {new(): Editor}, buttonTitle: string,\n      triggerKey: string): HTMLElement {\n    const triggerButton = IconButton.Icon.create('flex-wrap', 'styles-pane-button');\n    triggerButton.title = buttonTitle;\n    triggerButton.role = 'button';\n\n    triggerButton.onclick = async event => {\n      event.stopPropagation();\n      const popoverHelper = pane.swatchPopoverHelper();\n      const widget = StyleEditorWidget.instance();\n      widget.element.classList.toggle('with-padding', true);\n      widget.setEditor(editorClass);\n      widget.bindContext(pane, section);\n      widget.setTriggerKey(triggerKey);\n      await widget.render();\n      widget.focus();\n      const scrollerElement = triggerButton.enclosingNodeOrSelfWithClass('style-panes-wrapper');\n      const onScroll = (): void => {\n        popoverHelper.hide(true);\n      };\n      popoverHelper.show(widget, triggerButton, () => {\n        widget.unbindContext();\n        if (scrollerElement) {\n          scrollerElement.removeEventListener('scroll', onScroll);\n        }\n      });\n      if (scrollerElement) {\n        scrollerElement.addEventListener('scroll', onScroll);\n      }\n    };\n    triggerButton.onmouseup = event => {\n      // Stop propagation to prevent the property editor from being activated.\n      event.stopPropagation();\n    };\n\n    return triggerButton;\n  }\n}\n\nfunction ensureTreeElementForProperty(section: StylePropertiesSection, propertyName: string): StylePropertyTreeElement {\n  const target = section.propertiesTreeOutline.rootElement().children().find(\n      child => child instanceof StylePropertyTreeElement && child.property.name === propertyName);\n  if (target) {\n    return target as StylePropertyTreeElement;\n  }\n  const newTarget = section.addNewBlankProperty();\n  newTarget.property.name = propertyName;\n  return newTarget;\n}\n\nasync function fetchComputedStyles(pane: StylesSidebarPane): Promise<Map<string, string>> {\n  const computedStyleModel = pane.computedStyleModel();\n  const style = await computedStyleModel.fetchComputedStyle();\n  return style ? style.computedStyle : new Map();\n}\n\nfunction getAuthoredStyles(\n    section: StylePropertiesSection, editableProperties: Array<{propertyName: string}>): Map<string, string> {\n  const authoredProperties = new Map();\n  const editablePropertiesSet = new Set(editableProperties.map(prop => prop.propertyName));\n  for (const prop of section.style().leadingProperties()) {\n    if (editablePropertiesSet.has(prop.name)) {\n      authoredProperties.set(prop.name, prop.value);\n    }\n  }\n  return authoredProperties;\n}\n"]}