{"version":3,"file":"EventDisplayTable.js","sourceRoot":"","sources":["../../../../../../front_end/panels/media/EventDisplayTable.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-imperative-dom-api */\n\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as DataGrid from '../../ui/legacy/components/data_grid/data_grid.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport * as VisualLogging from '../../ui/visual_logging/visual_logging.js';\n\nimport eventDisplayTableStyles from './eventDisplayTable.css.js';\nimport type {PlayerEvent} from './MediaModel.js';\n\nconst UIStrings = {\n  /**\n   * @description Text for timestamps of items\n   */\n  timestamp: 'Timestamp',\n  /**\n   * @description The column header for event names.\n   */\n  eventName: 'Event name',\n  /**\n   * @description Text for the value of something\n   */\n  value: 'Value',\n  /**\n   * @description The accessible name of a table that displays information about events that occurred\n   * while a video/media player was present on the page.\n   */\n  eventDisplay: 'Event display',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/media/EventDisplayTable.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\nexport interface EventDisplayColumnConfig {\n  id: string;\n  title: string;\n  sortable: boolean;\n  weight?: number;\n}\n\nexport const enum MediaEventColumnKeys {\n  TIMESTAMP = 'display-timestamp',\n  EVENT = 'event',\n  VALUE = 'value',\n}\n\nexport class EventNode extends DataGrid.DataGrid.DataGridNode<EventNode> {\n  private expandableElement: SourceFrame.JSONView.JSONView|null;\n\n  constructor(event: PlayerEvent) {\n    super(event, false);\n    this.expandableElement = null;\n  }\n\n  override createCell(columnId: string): HTMLElement {\n    const cell = this.createTD(columnId);\n    const cellData = this.data[columnId] as string;\n    if (columnId === MediaEventColumnKeys.VALUE) {\n      const enclosed = cell.createChild('div', 'event-display-table-contents-json-wrapper');\n      this.expandableElement =\n          new SourceFrame.JSONView.JSONView(new SourceFrame.JSONView.ParsedJSON(cellData, '', ''), true);\n      this.expandableElement.markAsRoot();\n      this.expandableElement.show(enclosed);\n    } else {\n      cell.classList.add('event-display-table-basic-text-table-entry');\n      UI.UIUtils.createTextChild(cell, cellData);\n    }\n    return cell;\n  }\n}\n\nexport class PlayerEventsView extends UI.Widget.VBox {\n  private readonly dataGrid: DataGrid.DataGrid.DataGridImpl<EventNode>;\n  private firstEventTime: number;\n\n  constructor() {\n    super({jslog: `${VisualLogging.pane('events')}`});\n    this.registerRequiredCSS(eventDisplayTableStyles);\n\n    // Set up element styles.\n\n    this.contentElement.classList.add('event-display-table-contents-table-container');\n\n    this.dataGrid = this.createDataGrid([\n      {\n        id: MediaEventColumnKeys.TIMESTAMP,\n        title: i18nString(UIStrings.timestamp),\n        weight: 1,\n        sortable: false,\n      },\n      {id: MediaEventColumnKeys.EVENT, title: i18nString(UIStrings.eventName), weight: 2, sortable: false},\n      {\n        id: MediaEventColumnKeys.VALUE,\n        title: i18nString(UIStrings.value),\n        weight: 7,\n        sortable: false,\n      },\n    ]);\n\n    this.firstEventTime = 0;\n    this.dataGrid.setStriped(true);\n    this.dataGrid.asWidget().show(this.contentElement);\n  }\n\n  private createDataGrid(headers: EventDisplayColumnConfig[]): DataGrid.DataGrid.DataGridImpl<EventNode> {\n    const gridColumnDescs = [];\n    for (const headerDesc of headers) {\n      gridColumnDescs.push(PlayerEventsView.convertToGridDescriptor(headerDesc));\n    }\n\n    // TODO(tmathmeyer) SortableDataGrid doesn't play nice with nested JSON\n    // renderers, since they can change size, and this breaks the visible\n    // element computation in ViewportDataGrid.\n    const datagrid = new DataGrid.DataGrid.DataGridImpl({\n      displayName: i18nString(UIStrings.eventDisplay),\n      columns: gridColumnDescs,\n      deleteCallback: undefined,\n      refreshCallback: undefined,\n    });\n    datagrid.asWidget().contentElement.classList.add('no-border-top-datagrid');\n    return datagrid;\n  }\n\n  onEvent(event: PlayerEvent): void {\n    if (this.firstEventTime === 0 && typeof event.timestamp === 'number') {\n      this.firstEventTime = event.timestamp;\n    }\n\n    event = this.subtractFirstEventTime(event);\n    const stringified = event.value;\n    try {\n      const json = JSON.parse(stringified);\n      event.event = json.event;\n      delete json['event'];\n      event.value = json;\n      const node = new EventNode(event);\n      const scroll = this.dataGrid.scrollContainer;\n      const isAtBottom = scroll.scrollTop === (scroll.scrollHeight - scroll.offsetHeight);\n      this.dataGrid.rootNode().appendChild(node as DataGrid.DataGrid.DataGridNode<EventNode>);\n      if (isAtBottom) {\n        scroll.scrollTop = scroll.scrollHeight;\n      }\n    } catch {\n      // If this is a legacy message event, ignore it for now until they\n      // are handled.\n    }\n  }\n\n  private subtractFirstEventTime(event: PlayerEvent): PlayerEvent {\n    if (typeof event.timestamp === 'number') {\n      event.displayTimestamp = (event.timestamp - this.firstEventTime).toFixed(3);\n    }\n    return event;\n  }\n\n  private static convertToGridDescriptor(columnConfig: EventDisplayColumnConfig): DataGrid.DataGrid.ColumnDescriptor {\n    return {\n      id: columnConfig.id,\n      title: columnConfig.title,\n      sortable: columnConfig.sortable,\n      weight: columnConfig.weight || 0,\n      sort: DataGrid.DataGrid.Order.Ascending,\n    } as DataGrid.DataGrid.ColumnDescriptor;\n  }\n}\n"]}