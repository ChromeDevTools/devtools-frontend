{"version":3,"file":"EventTimelineView.js","sourceRoot":"","sources":["../../../../../../front_end/panels/media/EventTimelineView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-imperative-dom-api */\n\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as VisualLogging from '../../ui/visual_logging/visual_logging.js';\n\nimport type {PlayerEvent} from './MediaModel.js';\nimport {\n  ColdColorScheme,\n  type Event,\n  type EventProperties,\n  HotColorScheme,\n  TickingFlameChart,\n} from './TickingFlameChart.js';\n\n// Has to be a double, see https://v8.dev/blog/react-cliff\nconst NO_NORMALIZED_TIMESTAMP = -1.5;\n\nconst UIStrings = {\n  /**\n   * @description Title of the 'Playback Status' button\n   */\n  playbackStatus: 'Playback Status',\n  /**\n   * @description Title of the 'Buffering Status' button\n   */\n  bufferingStatus: 'Buffering Status',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/media/EventTimelineView.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\ntype State = Record<string, string>;\n\nexport class PlayerEventsTimeline extends TickingFlameChart {\n  private normalizedTimestamp: number;\n  private playbackStatusLastEvent: Event|null;\n  private audioBufferingStateEvent: Event|null;\n  private videoBufferingStateEvent: Event|null;\n\n  constructor() {\n    super();\n\n    this.element.setAttribute('jslog', `${VisualLogging.pane('timeline')}`);\n\n    this.normalizedTimestamp = NO_NORMALIZED_TIMESTAMP;\n\n    this.addGroup(i18nString(UIStrings.playbackStatus), 2);\n    this.addGroup(i18nString(UIStrings.bufferingStatus), 2);  // video on top, audio on bottom\n\n    this.playbackStatusLastEvent = null;\n    this.audioBufferingStateEvent = null;\n    this.videoBufferingStateEvent = null;\n  }\n\n  private ensureNoPreviousPlaybackEvent(normalizedTime: number): void {\n    if (this.playbackStatusLastEvent !== null) {\n      this.playbackStatusLastEvent.endTime = normalizedTime;\n      this.playbackStatusLastEvent = null;\n    }\n  }\n\n  /**\n   * Playback events are {kPlay, kPause, kSuspended, kEnded, and kWebMediaPlayerDestroyed}\n   * once destroyed, a player cannot receive more events of any kind.\n   */\n  private onPlaybackEvent(event: PlayerEvent, normalizedTime: number): void {\n    switch (event.event) {\n      case 'kPlay':\n        this.canTick = true;\n        this.ensureNoPreviousPlaybackEvent(normalizedTime);\n\n        // Disabled until Closure is gone.\n        // clang-format off\n        this.playbackStatusLastEvent = this.startEvent({\n          level: 0,\n          startTime: normalizedTime,\n          name: 'Play',\n        } as EventProperties);\n        // clang-format on\n        break;\n\n      case 'kPause':\n        // Don't change ticking state - the player is still active even during\n        // video pause. It may receive buffering events, seeks, etc.\n        this.ensureNoPreviousPlaybackEvent(normalizedTime);\n\n        // Disabled until Closure is gone.\n        // clang-format off\n        this.playbackStatusLastEvent = this.startEvent({\n          level: 0,\n          startTime: normalizedTime,\n          name: 'Pause',\n          color: HotColorScheme[1],\n        } as EventProperties);\n        // clang-format on\n        break;\n\n      case 'kWebMediaPlayerDestroyed':\n        this.canTick = false;\n        this.ensureNoPreviousPlaybackEvent(normalizedTime);\n        this.addMarker({\n          level: 1,\n          startTime: normalizedTime,\n          name: 'Destroyed',\n          color: HotColorScheme[4],\n        } as EventProperties);\n        // clang-format on\n        break;\n\n      case 'kSuspended':\n        // Other event's can't happen during suspension or while the player is\n        // destroyed, so stop the ticking.\n        this.canTick = false;\n        this.ensureNoPreviousPlaybackEvent(normalizedTime);\n\n        // Disabled until Closure is gone.\n        // clang-format off\n        this.playbackStatusLastEvent = this.startEvent({\n          level: 1,\n          startTime: normalizedTime,\n          name: 'Suspended',\n          color: HotColorScheme[3],\n        } as EventProperties);\n        // clang-format on\n        break;\n\n      case 'kEnded':\n        // Player ending can still have seeks & other events.\n        this.ensureNoPreviousPlaybackEvent(normalizedTime);\n\n        // Disabled until Closure is gone.\n        // clang-format off\n        this.playbackStatusLastEvent = this.startEvent({\n          level: 1,\n          startTime: normalizedTime,\n          name: 'Ended',\n          color: HotColorScheme[2],\n        } as EventProperties);\n        // clang-format on\n        break;\n\n      default:\n        throw new Error(`_onPlaybackEvent cant handle ${event.event}`);\n    }\n  }\n\n  private bufferedEnough(state: State): boolean {\n    return state['state'] === 'BUFFERING_HAVE_ENOUGH';\n  }\n\n  private onBufferingStatus(event: PlayerEvent, normalizedTime: number): void {\n    // No declarations inside the case labels.\n    let audioState: State|null = null;\n    let videoState: State|null = null;\n\n    switch (event.event) {\n      case 'kBufferingStateChanged':\n        // There are three allowed entries, audio, video, and pipeline.\n        // We only want the buffering for audio and video to be displayed.\n        // One event may have changes for a single type, or for both audio/video\n        // simultaneously.\n        // @ts-expect-error\n        audioState = event.value['audio_buffering_state'];\n        // @ts-expect-error\n        videoState = event.value['video_buffering_state'];\n\n        if (audioState) {\n          if (this.audioBufferingStateEvent !== null) {\n            this.audioBufferingStateEvent.endTime = normalizedTime;\n            this.audioBufferingStateEvent = null;\n          }\n          if (!this.bufferedEnough(audioState)) {\n            this.audioBufferingStateEvent = this.startEvent({\n              level: 3,\n              startTime: normalizedTime,\n              name: 'Audio Buffering',\n              color: ColdColorScheme[1],\n            } as EventProperties);\n          }\n        }\n\n        if (videoState) {\n          if (this.videoBufferingStateEvent !== null) {\n            this.videoBufferingStateEvent.endTime = normalizedTime;\n            this.videoBufferingStateEvent = null;\n          }\n          if (!this.bufferedEnough(videoState)) {\n            this.videoBufferingStateEvent = this.startEvent({\n              level: 2,\n              startTime: normalizedTime,\n              name: 'Video Buffering',\n              color: ColdColorScheme[0],\n            } as EventProperties);\n          }\n        }\n        break;\n\n      default:\n        throw new Error(`_onPlaybackEvent cant handle ${event.event}`);\n    }\n  }\n\n  onEvent(event: PlayerEvent): void {\n    if (this.normalizedTimestamp === NO_NORMALIZED_TIMESTAMP) {\n      this.normalizedTimestamp = Number(event.timestamp);\n    }\n    const inMilliseconds = (Number(event.timestamp) - this.normalizedTimestamp) * 1000;\n\n    switch (event.event) {\n      case 'kPlay':\n      case 'kPause':\n      case 'kWebMediaPlayerDestroyed':\n      case 'kSuspended':\n      case 'kEnded':\n        return this.onPlaybackEvent(event, inMilliseconds);\n\n      case 'kBufferingStateChanged':\n        return this.onBufferingStatus(event, inMilliseconds);\n\n      default:\n    }\n  }\n}\n"]}