{"version":3,"file":"RequestInitiatorView.js","sourceRoot":"","sources":["../../../../../../front_end/panels/network/RequestInitiatorView.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAC7B,oDAAoD;AAEpD,OAAO,KAAK,IAAI,MAAM,yBAAyB,CAAC;AAChD,OAAO,KAAK,GAAG,MAAM,uBAAuB,CAAC;AAC7C,OAAO,KAAK,IAAI,MAAM,2BAA2B,CAAC;AAClD,OAAO,KAAK,UAAU,MAAM,2CAA2C,CAAC;AACxE,OAAO,KAAK,EAAE,MAAM,2BAA2B,CAAC;AAChD,OAAO,KAAK,aAAa,MAAM,2CAA2C,CAAC;AAE3E,OAAO,0BAA0B,MAAM,+BAA+B,CAAC;AACvE,OAAO,8BAA8B,MAAM,mCAAmC,CAAC;AAE/E,MAAM,SAAS,GAAG;IAChB;;OAEG;IACH,WAAW,EAAE,mBAAmB;IAChC;;OAEG;IACH,gBAAgB,EAAE,oBAAoB;IACtC;;OAEG;IACH,qBAAqB,EAAE,yBAAyB;CACxC,CAAC;AACX,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC,wCAAwC,EAAE,SAAS,CAAC,CAAC;AAC9F,MAAM,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,kBAAkB,CAAC,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;AACtE,MAAM,OAAO,oBAAqB,SAAQ,EAAE,CAAC,MAAM,CAAC,IAAI;IACrC,SAAS,CAAiC;IAC1C,OAAO,CAAoC;IAC3C,WAAW,CAA6B;IACjD,QAAQ,CAAU;IAE1B,YAAY,OAA0C;QACpD,KAAK,CAAC,EAAC,KAAK,EAAE,GAAG,aAAa,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,KAAK,CAAC,EAAC,MAAM,EAAE,IAAI,EAAC,CAAC,EAAE,EAAC,CAAC,CAAC;QAE3E,IAAI,CAAC,OAAO,CAAC,SAAS,CAAC,GAAG,CAAC,wBAAwB,CAAC,CAAC;QACrD,IAAI,CAAC,SAAS,GAAG,IAAI,UAAU,CAAC,SAAS,CAAC,SAAS,EAAE,CAAC;QACtD,IAAI,CAAC,OAAO,GAAG,OAAO,CAAC;QACvB,IAAI,CAAC,WAAW,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,UAAU,CAAC,SAAS,CAAC,WAAW,CAAC,EAAE,EAAE,CAAC,CAAC;QACzF,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QACpC,IAAI,CAAC,QAAQ,GAAG,KAAK,CAAC;IACxB,CAAC;IAED,MAAM,CAAC,uBAAuB,CAC1B,OAA0C,EAAE,SAAyC,EACrF,aAAuB;QACzB,MAAM,SAAS,GAAG,OAAO,CAAC,SAAS,EAAE,CAAC;QACtC,IAAI,CAAC,SAAS,EAAE,KAAK,EAAE,CAAC;YACtB,OAAO,IAAI,CAAC;QACd,CAAC;QACD,MAAM,cAAc,GAAG,GAAG,CAAC,cAAc,CAAC,cAAc,CAAC,UAAU,CAAC,OAAO,CAAC,CAAC;QAC7E,MAAM,MAAM,GAAG,cAAc,CAAC,CAAC,CAAC,cAAc,CAAC,MAAM,EAAE,CAAC,CAAC,CAAC,SAAS,CAAC;QACpE,OAAO,IAAI,UAAU,CAAC,mBAAmB,CAAC,wBAAwB,CAC9D,SAAS,EAAE,MAAM,EAAE,SAAS,EAAE,EAAC,iBAAiB,EAAE,SAAS,CAAC,KAAK,EAAE,QAAQ,EAAE,aAAa,EAAC,CAAC,CAAC;IACnG,CAAC;IAEO,UAAU;QAChB,MAAM,WAAW,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,mBAAmB,EAAE,CAAC;QAC7D,WAAW,CAAC,mBAAmB,CAAC,8BAA8B,CAAC,CAAC;QAChE,WAAW,CAAC,cAAc,CAAC,SAAS,CAAC,GAAG,CAAC,6BAA6B,CAAC,CAAC;QACxE,WAAW,CAAC,cAAc,CAAC,YAAY,CAAC,OAAO,EAAE,GAAG,aAAa,CAAC,IAAI,CAAC,gBAAgB,CAAC,EAAE,CAAC,CAAC;QAE5F,OAAO,WAAW,CAAC;IACrB,CAAC;IAEO,qBAAqB,CACzB,cAA8C,EAAE,KAAa,EAC7D,IAAwC;QAC1C,MAAM,IAAI,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QAEnD,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAEvB,IAAI,IAAI,CAAC,YAAY,YAAY,WAAW,EAAE,CAAC;YAC7C,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,GAAG,CAAC,sCAAsC,CAAC,CAAC;QAC1E,CAAC;QAED,MAAM,UAAU,GAAG,cAAc,CAAC,UAAU,CAAC;QAC7C,IAAI,MAAM,GAA+B,IAAI,CAAC;QAC9C,KAAK,MAAM,OAAO,IAAI,KAAK,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC,OAAO,EAAE,EAAE,CAAC;YACvD,MAAM,WAAW,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC;YAClE,MAAM,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;YAChC,MAAM,CAAC,MAAM,EAAE,CAAC;YAChB,MAAM,GAAG,WAAW,CAAC;QACvB,CAAC;QAED,IAAI,CAAC,MAAM,EAAE,CAAC;QACd,MAAM,CAAC,MAAM,EAAE,CAAC;QAChB,MAAM,YAAY,GAAG,MAAM,CAAC,YAAY,CAAC;QACzC,IAAI,YAAY,YAAY,WAAW,EAAE,CAAC;YACxC,YAAY,CAAC,KAAK,CAAC,UAAU,GAAG,MAAM,CAAC;QACzC,CAAC;QAED,MAAM,SAAS,GAAG,cAAc,CAAC,SAAS,CAAC;QAC3C,IAAI,CAAC,2BAA2B,CAAC,SAAS,EAAE,MAAM,EAAE,IAAI,CAAC,OAAO,CAAC,CAAC;QAClE,OAAO,IAAI,CAAC;IACd,CAAC;IAEO,2BAA2B,CAC/B,SAAoF,EACpF,aAAyC,EAAE,aAAgD;QAC7F,MAAM,OAAO,GAAG,IAAI,GAAG,EAAqC,CAAC;QAC7D,uEAAuE;QACvE,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAC1B,KAAK,MAAM,OAAO,IAAI,SAAS,CAAC,IAAI,EAAE,EAAE,CAAC;YACvC,IAAI,SAAS,CAAC,GAAG,CAAC,OAAO,CAAC,KAAK,aAAa,EAAE,CAAC;gBAC7C,MAAM,WAAW,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,OAAO,CAAC,GAAG,EAAE,CAAC,CAAC;gBAClE,aAAa,CAAC,WAAW,CAAC,WAAW,CAAC,CAAC;gBACvC,aAAa,CAAC,MAAM,EAAE,CAAC;gBACvB,uCAAuC;gBACvC,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,EAAE,CAAC;oBAC1B,OAAO,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC;oBACrB,IAAI,CAAC,2BAA2B,CAAC,SAAS,EAAE,WAAW,EAAE,OAAO,CAAC,CAAC;gBACpE,CAAC;YACH,CAAC;QACH,CAAC;IACH,CAAC;IAEO,sBAAsB,CAC1B,iBAA0E,EAAE,KAAa,EACzF,IAAwC;QAC1C,MAAM,IAAI,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;QACnD,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,CAAC;QAEvB,IAAI,IAAI,CAAC,YAAY,YAAY,WAAW,EAAE,CAAC;YAC7C,IAAI,CAAC,YAAY,CAAC,SAAS,CAAC,GAAG,CAAC,sCAAsC,CAAC,CAAC;QAC1E,CAAC;QAED,MAAM,cAAc,GAAG,IAAI,EAAE,CAAC,WAAW,CAAC,WAAW,CAAC,SAAS,EAAE,KAAK,CAAC,CAAC;QACxE,cAAc,CAAC,UAAU,GAAG,KAAK,CAAC;QAClC,iBAAiB,CAAC,UAAU,EAAE,CAAC;QAC/B,iBAAiB,CAAC,IAAI,CAAC,cAAc,CAAC,eAAe,CAAC,CAAC;QAEvD,IAAI,CAAC,WAAW,CAAC,cAAc,CAAC,CAAC;QACjC,IAAI,CAAC,MAAM,EAAE,CAAC;IAChB,CAAC;IAEQ,QAAQ;QACf,KAAK,CAAC,QAAQ,EAAE,CAAC;QACjB,IAAI,IAAI,CAAC,QAAQ,EAAE,CAAC;YAClB,OAAO;QACT,CAAC;QACD,IAAI,CAAC,mBAAmB,CAAC,0BAA0B,CAAC,CAAC;QACrD,IAAI,oBAAoB,GAAG,KAAK,CAAC;QACjC,MAAM,aAAa,GAAG,IAAI,CAAC,UAAU,EAAE,CAAC;QAExC,MAAM,iBAAiB,GAAG,oBAAoB,CAAC,uBAAuB,CAAC,IAAI,CAAC,OAAO,EAAE,IAAI,CAAC,SAAS,EAAE,IAAI,CAAC,CAAC;QAE3G,IAAI,iBAAiB,EAAE,CAAC;YACtB,oBAAoB,GAAG,IAAI,CAAC;YAC5B,IAAI,CAAC,sBAAsB,CAAC,iBAAiB,EAAE,UAAU,CAAC,SAAS,CAAC,gBAAgB,CAAC,EAAE,aAAa,CAAC,CAAC;QACxG,CAAC;QAED,MAAM,cAAc,GAAG,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC,wBAAwB,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAEpG,IAAI,cAAc,CAAC,UAAU,CAAC,IAAI,GAAG,CAAC,IAAI,cAAc,CAAC,SAAS,CAAC,IAAI,GAAG,CAAC,EAAE,CAAC;YAC5E,oBAAoB,GAAG,IAAI,CAAC;YAC5B,IAAI,CAAC,qBAAqB,CAAC,cAAc,EAAE,UAAU,CAAC,SAAS,CAAC,qBAAqB,CAAC,EAAE,aAAa,CAAC,CAAC;QACzG,CAAC;QAED,MAAM,UAAU,GAAG,aAAa,CAAC,UAAU,EAAE,CAAC;QAE9C,IAAI,UAAU,EAAE,CAAC;YACf,UAAU,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAC1B,CAAC;QAED,IAAI,oBAAoB,EAAE,CAAC;YACzB,IAAI,CAAC,OAAO,CAAC,WAAW,CAAC,aAAa,CAAC,OAAO,CAAC,CAAC;YAChD,IAAI,CAAC,WAAW,CAAC,UAAU,EAAE,CAAC;QAChC,CAAC;QACD,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC;IACvB,CAAC;CACF","sourcesContent":["// Copyright 2019 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-imperative-dom-api */\n\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Logs from '../../models/logs/logs.js';\nimport * as Components from '../../ui/legacy/components/utils/utils.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport * as VisualLogging from '../../ui/visual_logging/visual_logging.js';\n\nimport requestInitiatorViewStyles from './requestInitiatorView.css.js';\nimport requestInitiatorViewTreeStyles from './requestInitiatorViewTree.css.js';\n\nconst UIStrings = {\n  /**\n   * @description Text in Request Initiator View of the Network panel if the request has no initiator data\n   */\n  noInitiator: 'No initiator data',\n  /**\n   * @description Title of a section in Request Initiator view of the Network Panel\n   */\n  requestCallStack: 'Request call stack',\n  /**\n   * @description Title of a section in Request Initiator view of the Network Panel\n   */\n  requestInitiatorChain: 'Request initiator chain',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/network/RequestInitiatorView.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\nexport class RequestInitiatorView extends UI.Widget.VBox {\n  private readonly linkifier: Components.Linkifier.Linkifier;\n  private readonly request: SDK.NetworkRequest.NetworkRequest;\n  private readonly emptyWidget: UI.EmptyWidget.EmptyWidget;\n  private hasShown: boolean;\n\n  constructor(request: SDK.NetworkRequest.NetworkRequest) {\n    super({jslog: `${VisualLogging.pane('initiator').track({resize: true})}`});\n\n    this.element.classList.add('request-initiator-view');\n    this.linkifier = new Components.Linkifier.Linkifier();\n    this.request = request;\n    this.emptyWidget = new UI.EmptyWidget.EmptyWidget(i18nString(UIStrings.noInitiator), '');\n    this.emptyWidget.show(this.element);\n    this.hasShown = false;\n  }\n\n  static createStackTracePreview(\n      request: SDK.NetworkRequest.NetworkRequest, linkifier: Components.Linkifier.Linkifier,\n      focusableLink?: boolean): Components.JSPresentationUtils.StackTracePreviewContent|null {\n    const initiator = request.initiator();\n    if (!initiator?.stack) {\n      return null;\n    }\n    const networkManager = SDK.NetworkManager.NetworkManager.forRequest(request);\n    const target = networkManager ? networkManager.target() : undefined;\n    return new Components.JSPresentationUtils.StackTracePreviewContent(\n        undefined, target, linkifier, {runtimeStackTrace: initiator.stack, tabStops: focusableLink});\n  }\n\n  private createTree(): UI.TreeOutline.TreeOutlineInShadow {\n    const treeOutline = new UI.TreeOutline.TreeOutlineInShadow();\n    treeOutline.registerRequiredCSS(requestInitiatorViewTreeStyles);\n    treeOutline.contentElement.classList.add('request-initiator-view-tree');\n    treeOutline.contentElement.setAttribute('jslog', `${VisualLogging.tree('initiator-tree')}`);\n\n    return treeOutline;\n  }\n\n  private buildRequestChainTree(\n      initiatorGraph: Logs.NetworkLog.InitiatorGraph, title: string,\n      tree: UI.TreeOutline.TreeOutlineInShadow): UI.TreeOutline.TreeElement {\n    const root = new UI.TreeOutline.TreeElement(title);\n\n    tree.appendChild(root);\n\n    if (root.titleElement instanceof HTMLElement) {\n      root.titleElement.classList.add('request-initiator-view-section-title');\n    }\n\n    const initiators = initiatorGraph.initiators;\n    let parent: UI.TreeOutline.TreeElement = root;\n    for (const request of Array.from(initiators).reverse()) {\n      const treeElement = new UI.TreeOutline.TreeElement(request.url());\n      parent.appendChild(treeElement);\n      parent.expand();\n      parent = treeElement;\n    }\n\n    root.expand();\n    parent.select();\n    const titleElement = parent.titleElement;\n    if (titleElement instanceof HTMLElement) {\n      titleElement.style.fontWeight = 'bold';\n    }\n\n    const initiated = initiatorGraph.initiated;\n    this.depthFirstSearchTreeBuilder(initiated, parent, this.request);\n    return root;\n  }\n\n  private depthFirstSearchTreeBuilder(\n      initiated: Map<SDK.NetworkRequest.NetworkRequest, SDK.NetworkRequest.NetworkRequest>,\n      parentElement: UI.TreeOutline.TreeElement, parentRequest: SDK.NetworkRequest.NetworkRequest): void {\n    const visited = new Set<SDK.NetworkRequest.NetworkRequest>();\n    // this.request should be already in the tree when build initiator part\n    visited.add(this.request);\n    for (const request of initiated.keys()) {\n      if (initiated.get(request) === parentRequest) {\n        const treeElement = new UI.TreeOutline.TreeElement(request.url());\n        parentElement.appendChild(treeElement);\n        parentElement.expand();\n        // only do dfs when we haven't done one\n        if (!visited.has(request)) {\n          visited.add(request);\n          this.depthFirstSearchTreeBuilder(initiated, treeElement, request);\n        }\n      }\n    }\n  }\n\n  private buildStackTraceSection(\n      stackTracePreview: Components.JSPresentationUtils.StackTracePreviewContent, title: string,\n      tree: UI.TreeOutline.TreeOutlineInShadow): void {\n    const root = new UI.TreeOutline.TreeElement(title);\n    tree.appendChild(root);\n\n    if (root.titleElement instanceof HTMLElement) {\n      root.titleElement.classList.add('request-initiator-view-section-title');\n    }\n\n    const contentElement = new UI.TreeOutline.TreeElement(undefined, false);\n    contentElement.selectable = false;\n    stackTracePreview.markAsRoot();\n    stackTracePreview.show(contentElement.listItemElement);\n\n    root.appendChild(contentElement);\n    root.expand();\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n    if (this.hasShown) {\n      return;\n    }\n    this.registerRequiredCSS(requestInitiatorViewStyles);\n    let initiatorDataPresent = false;\n    const containerTree = this.createTree();\n\n    const stackTracePreview = RequestInitiatorView.createStackTracePreview(this.request, this.linkifier, true);\n\n    if (stackTracePreview) {\n      initiatorDataPresent = true;\n      this.buildStackTraceSection(stackTracePreview, i18nString(UIStrings.requestCallStack), containerTree);\n    }\n\n    const initiatorGraph = Logs.NetworkLog.NetworkLog.instance().initiatorGraphForRequest(this.request);\n\n    if (initiatorGraph.initiators.size > 1 || initiatorGraph.initiated.size > 1) {\n      initiatorDataPresent = true;\n      this.buildRequestChainTree(initiatorGraph, i18nString(UIStrings.requestInitiatorChain), containerTree);\n    }\n\n    const firstChild = containerTree.firstChild();\n\n    if (firstChild) {\n      firstChild.select(true);\n    }\n\n    if (initiatorDataPresent) {\n      this.element.appendChild(containerTree.element);\n      this.emptyWidget.hideWidget();\n    }\n    this.hasShown = true;\n  }\n}\n"]}