{"version":3,"file":"RequestInitiatorView.js","sourceRoot":"","sources":["../../../../../../front_end/panels/network/RequestInitiatorView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-imperative-dom-api */\n\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as SDK from '../../core/sdk/sdk.js';\nimport * as Logs from '../../models/logs/logs.js';\nimport * as Components from '../../ui/legacy/components/utils/utils.js';\nimport * as UI from '../../ui/legacy/legacy.js';\nimport * as Lit from '../../ui/lit/lit.js';\nimport * as VisualLogging from '../../ui/visual_logging/visual_logging.js';\n\nimport requestInitiatorViewStyles from './requestInitiatorView.css.js';\nimport requestInitiatorViewTreeStyles from './requestInitiatorViewTree.css.js';\n\nconst {html, render, nothing} = Lit;\nconst {widgetConfig} = UI.Widget;\n\nconst UIStrings = {\n  /**\n   * @description Text in Request Initiator View of the Network panel if the request has no initiator data\n   */\n  noInitiator: 'No initiator data',\n  /**\n   * @description Title of a section in Request Initiator view of the Network Panel\n   */\n  requestCallStack: 'Request call stack',\n  /**\n   * @description Title of a section in Request Initiator view of the Network Panel\n   */\n  requestInitiatorChain: 'Request initiator chain',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/network/RequestInitiatorView.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\nexport interface ViewInput {\n  initiatorGraph: Logs.NetworkLog.InitiatorGraph;\n  hasStackTrace: boolean;\n  request: SDK.NetworkRequest.NetworkRequest;\n  linkifier: Components.Linkifier.Linkifier;\n  target?: SDK.Target.Target;\n}\n\nexport const DEFAULT_VIEW = (input: ViewInput, _output: undefined, target: HTMLElement): void => {\n  const hasInitiatorData =\n      input.initiatorGraph.initiators.size > 1 || input.initiatorGraph.initiated.size > 1 || input.hasStackTrace;\n\n  if (!hasInitiatorData) {\n    render(\n        html`\n      <div class=\"empty-view\" style=\"display: flex; justify-content: center; align-items: center; height: 100%; color: var(--sys-color-token-subtle);\">\n        ${i18nString(UIStrings.noInitiator)}\n      </div>\n    `,\n        target);\n    return;\n  }\n\n  const renderStackTraceSection = (): Lit.TemplateResult => {\n    return html`\n      <li role=\"treeitem\" class=\"request-initiator-view-section-title\" aria-expanded=\"true\">\n        ${i18nString(UIStrings.requestCallStack)}\n        <ul role=\"group\">\n          <li role=\"treeitem\">\n            <devtools-widget .widgetConfig=${widgetConfig(Components.JSPresentationUtils.StackTracePreviewContent, {\n      target: input.target,\n      linkifier: input.linkifier,\n      options: {runtimeStackTrace: input.request.initiator()?.stack, tabStops: true}\n    })}></devtools-widget>\n          </li>\n        </ul>\n      </li>\n    `;\n  };\n\n  const renderInitiatorNodes = (initiators: SDK.NetworkRequest.NetworkRequest[], index: number,\n                                initiated: Map<SDK.NetworkRequest.NetworkRequest, SDK.NetworkRequest.NetworkRequest>,\n                                visited: Set<SDK.NetworkRequest.NetworkRequest>): Lit.TemplateResult => {\n    if (index >= initiators.length) {\n      return html`${nothing}`;\n    }\n    const request = initiators[index];\n    const isCurrentRequest = (index === initiators.length - 1);\n\n    return html`\n      <li role=\"treeitem\" ?selected=${isCurrentRequest} aria-expanded=\"true\">\n        <span style=${isCurrentRequest ? 'font-weight: bold' : ''}>${request.url()}</span>\n        <ul role=\"group\">\n          ${renderInitiatorNodes(initiators, index + 1, initiated, visited)}\n          ${isCurrentRequest ? renderInitiatedNodes(initiated, request, visited) : nothing}\n        </ul>\n      </li>\n    `;\n  };\n\n  const renderInitiatedNodes = (initiated: Map<SDK.NetworkRequest.NetworkRequest, SDK.NetworkRequest.NetworkRequest>,\n                                parentRequest: SDK.NetworkRequest.NetworkRequest,\n                                visited: Set<SDK.NetworkRequest.NetworkRequest>): Lit.TemplateResult => {\n    const children = [];\n    for (const [request, initiator] of initiated) {\n      if (initiator === parentRequest) {\n        children.push(request);\n      }\n    }\n    if (children.length === 0) {\n      return html`${nothing}`;\n    }\n    return html`\n      ${children.map(child => {\n      const shouldRecurse = !visited.has(child);\n      if (shouldRecurse) {\n        visited.add(child);\n      }\n      return html`\n        <li role=\"treeitem\" aria-expanded=\"true\">\n          <span>${child.url()}</span>\n          ${shouldRecurse ? html`<ul>${renderInitiatedNodes(initiated, child, visited)}</ul>` : nothing}\n        </li>\n      `;\n    })}\n    `;\n  };\n\n  const renderInitiatorChain = (initiatorGraph: Logs.NetworkLog.InitiatorGraph): Lit.TemplateResult => {\n    const initiators = Array.from(initiatorGraph.initiators).reverse();\n    const visited = new Set<SDK.NetworkRequest.NetworkRequest>();\n    visited.add(input.request);\n    return html`\n      <li role=\"treeitem\" class=\"request-initiator-view-section-title\" aria-expanded=\"true\">\n        ${i18nString(UIStrings.requestInitiatorChain)}\n        <ul role=\"group\">\n          ${renderInitiatorNodes(initiators, 0, initiatorGraph.initiated, visited)}\n        </ul>\n      </li>\n    `;\n  };\n\n  render(\n      html`\n    <div class=\"request-initiator-view-tree\" jslog=${VisualLogging.tree('initiator-tree')}>\n      <devtools-tree .template=${\n          html`\n        <style>\n          ${requestInitiatorViewTreeStyles}\n        </style>\n        <ul role=\"tree\">\n           ${input.hasStackTrace ? renderStackTraceSection() : Lit.nothing}\n           ${\n              (input.initiatorGraph.initiators.size > 1 || input.initiatorGraph.initiated.size > 1) ?\n                  renderInitiatorChain(input.initiatorGraph) :\n                  Lit.nothing}\n        </ul>\n      `}></devtools-tree>\n    </div>\n  `,\n      target);\n};\n\ntype View = typeof DEFAULT_VIEW;\n\nexport class RequestInitiatorView extends UI.Widget.VBox {\n  private readonly linkifier: Components.Linkifier.Linkifier;\n  private readonly request: SDK.NetworkRequest.NetworkRequest;\n  #view: View;\n\n  constructor(request: SDK.NetworkRequest.NetworkRequest, view: View = DEFAULT_VIEW) {\n    super({jslog: `${VisualLogging.pane('initiator').track({resize: true})}`});\n\n    this.element.classList.add('request-initiator-view');\n    this.linkifier = new Components.Linkifier.Linkifier();\n    this.request = request;\n    this.#view = view;\n  }\n\n  static createStackTracePreview(\n      request: SDK.NetworkRequest.NetworkRequest, linkifier: Components.Linkifier.Linkifier,\n      focusableLink?: boolean): Components.JSPresentationUtils.StackTracePreviewContent|null {\n    const initiator = request.initiator();\n    if (!initiator?.stack) {\n      return null;\n    }\n    const networkManager = SDK.NetworkManager.NetworkManager.forRequest(request);\n    const target = networkManager ? networkManager.target() : undefined;\n    return new Components.JSPresentationUtils.StackTracePreviewContent(\n        undefined, target, linkifier, {runtimeStackTrace: initiator.stack, tabStops: focusableLink});\n  }\n\n  override performUpdate(): void {\n    const initiatorGraph = Logs.NetworkLog.NetworkLog.instance().initiatorGraphForRequest(this.request);\n    const hasStackTrace = !!this.request.initiator()?.stack;\n    const networkManager = SDK.NetworkManager.NetworkManager.forRequest(this.request);\n    const target = networkManager ? networkManager.target() : undefined;\n\n    const viewInput: ViewInput = {\n      initiatorGraph,\n      hasStackTrace,\n      request: this.request,\n      linkifier: this.linkifier,\n      target: target || undefined,\n    };\n\n    this.#view(viewInput, undefined, this.contentElement);\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n    this.registerRequiredCSS(requestInitiatorViewStyles);\n    this.requestUpdate();\n  }\n}\n"]}