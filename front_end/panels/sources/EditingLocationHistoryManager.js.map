{"version":3,"file":"EditingLocationHistoryManager.js","sourceRoot":"","sources":["../../../../../../front_end/panels/sources/EditingLocationHistoryManager.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2014 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Platform from '../../core/platform/platform.js';\nimport * as Workspace from '../../models/workspace/workspace.js';\nimport type * as CodeMirror from '../../third_party/codemirror.next/codemirror.next.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\n\nimport type {SourcesView} from './SourcesView.js';\nimport type {UISourceCodeFrame} from './UISourceCodeFrame.js';\n\nexport const HistoryDepth = 20;\n\nexport class EditingLocationHistoryManager {\n  private readonly entries: EditingLocationHistoryEntry[] = [];\n  private current = -1;\n  private revealing = false;\n\n  constructor(private readonly sourcesView: SourcesView) {\n  }\n\n  trackSourceFrameCursorJumps(sourceFrame: UISourceCodeFrame): void {\n    sourceFrame.addEventListener(\n        SourceFrame.SourceFrame.Events.EDITOR_UPDATE, event => this.onEditorUpdate(event.data, sourceFrame));\n  }\n\n  private onEditorUpdate(update: CodeMirror.ViewUpdate, sourceFrame: UISourceCodeFrame): void {\n    if (update.docChanged) {\n      this.mapEntriesFor(sourceFrame.uiSourceCode(), update.changes);\n    }\n    const prevPos = update.startState.selection.main;\n    const newPos = update.state.selection.main;\n    const isJump = !this.revealing && prevPos.anchor !== newPos.anchor && update.transactions.some(tr => {\n      return Boolean(\n          tr.isUserEvent('select.pointer') || tr.isUserEvent('select.reveal') || tr.isUserEvent('select.search'));\n    });\n    if (isJump) {\n      this.updateCurrentState(sourceFrame.uiSourceCode(), prevPos.head);\n      if (this.entries.length > this.current + 1) {\n        this.entries.length = this.current + 1;\n      }\n      this.entries.push(new EditingLocationHistoryEntry(sourceFrame.uiSourceCode(), newPos.head));\n      this.current++;\n      if (this.entries.length > HistoryDepth) {\n        this.entries.shift();\n        this.current--;\n      }\n    }\n  }\n\n  updateCurrentState(uiSourceCode: Workspace.UISourceCode.UISourceCode, position: number): void {\n    if (!this.revealing) {\n      const top = this.current >= 0 ? this.entries[this.current] : null;\n      if (top?.matches(uiSourceCode)) {\n        top.position = position;\n      }\n    }\n  }\n\n  private mapEntriesFor(uiSourceCode: Workspace.UISourceCode.UISourceCode, change: CodeMirror.ChangeDesc): void {\n    for (const entry of this.entries) {\n      if (entry.matches(uiSourceCode)) {\n        entry.position = change.mapPos(entry.position);\n      }\n    }\n  }\n\n  private reveal(entry: EditingLocationHistoryEntry): void {\n    const uiSourceCode = Workspace.Workspace.WorkspaceImpl.instance().uiSourceCode(entry.projectId, entry.url);\n    if (uiSourceCode) {\n      this.revealing = true;\n      this.sourcesView.showSourceLocation(uiSourceCode, entry.position, false, true);\n      this.revealing = false;\n    }\n  }\n\n  rollback(): void {\n    if (this.current > 0) {\n      this.current--;\n      this.reveal(this.entries[this.current]);\n    }\n  }\n\n  rollover(): void {\n    if (this.current < this.entries.length - 1) {\n      this.current++;\n      this.reveal(this.entries[this.current]);\n    }\n  }\n\n  removeHistoryForSourceCode(uiSourceCode: Workspace.UISourceCode.UISourceCode): void {\n    for (let i = this.entries.length - 1; i >= 0; i--) {\n      if (this.entries[i].matches(uiSourceCode)) {\n        this.entries.splice(i, 1);\n        if (this.current >= i) {\n          this.current--;\n        }\n      }\n    }\n  }\n}\n\nclass EditingLocationHistoryEntry {\n  readonly projectId: string;\n  readonly url: Platform.DevToolsPath.UrlString;\n  position: number;\n\n  constructor(uiSourceCode: Workspace.UISourceCode.UISourceCode, position: number) {\n    this.projectId = uiSourceCode.project().id();\n    this.url = uiSourceCode.url();\n    this.position = position;\n  }\n\n  matches(uiSourceCode: Workspace.UISourceCode.UISourceCode): boolean {\n    return this.url === uiSourceCode.url() && this.projectId === uiSourceCode.project().id();\n  }\n}\n"]}