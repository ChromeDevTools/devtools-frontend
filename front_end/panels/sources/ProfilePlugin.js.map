{"version":3,"file":"ProfilePlugin.js","sourceRoot":"","sources":["../../../../../../front_end/panels/sources/ProfilePlugin.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2021 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-imperative-dom-api */\n\nimport * as i18n from '../../core/i18n/i18n.js';\nimport * as Platform from '../../core/platform/platform.js';\nimport type * as Workspace from '../../models/workspace/workspace.js';\nimport * as CodeMirror from '../../third_party/codemirror.next/codemirror.next.js';\nimport type * as TextEditor from '../../ui/components/text_editor/text_editor.js';\nimport * as SourceFrame from '../../ui/legacy/components/source_frame/source_frame.js';\n\nimport {Plugin} from './Plugin.js';\n\n// Defines plugins that show profiling information in the editor\n// gutter when available.\n\nconst UIStrings = {\n  /**\n   * @description The milisecond unit\n   */\n  ms: 'ms',\n  /**\n   * @description Unit for data size in DevTools\n   */\n  mb: 'MB',\n  /**\n   * @description A unit\n   */\n  kb: 'kB',\n} as const;\nconst str_ = i18n.i18n.registerUIStrings('panels/sources/ProfilePlugin.ts', UIStrings);\nconst i18nString = i18n.i18n.getLocalizedString.bind(undefined, str_);\n\nclass MemoryMarker extends CodeMirror.GutterMarker {\n  constructor(readonly value: number) {\n    super();\n  }\n\n  override eq(other: MemoryMarker): boolean {\n    return this.value === other.value;\n  }\n\n  override toDOM(): HTMLElement {\n    const element = document.createElement('div');\n    element.className = 'cm-profileMarker';\n    let value = this.value;\n    const intensity = Platform.NumberUtilities.clamp(Math.log10(1 + 2e-3 * value) / 5, 0.02, 1);\n    element.style.backgroundColor = `hsla(217, 100%, 70%, ${intensity.toFixed(3)})`;\n    value /= 1e3;\n    let units;\n    let fractionDigits;\n    if (value >= 1e3) {\n      units = i18nString(UIStrings.mb);\n      value /= 1e3;\n      fractionDigits = value >= 20 ? 0 : 1;\n    } else {\n      units = i18nString(UIStrings.kb);\n      fractionDigits = 0;\n    }\n    element.textContent = value.toFixed(fractionDigits);\n    const unitElement = element.appendChild(document.createElement('span'));\n    unitElement.className = 'cm-units';\n    unitElement.textContent = units;\n    return element;\n  }\n}\n\nclass PerformanceMarker extends CodeMirror.GutterMarker {\n  constructor(readonly value: number) {\n    super();\n  }\n\n  override eq(other: MemoryMarker): boolean {\n    return this.value === other.value;\n  }\n\n  override toDOM(): HTMLElement {\n    const element = document.createElement('div');\n    element.className = 'cm-profileMarker';\n    const intensity = Platform.NumberUtilities.clamp(Math.log10(1 + 10 * this.value) / 5, 0.02, 1);\n    element.textContent = this.value.toFixed(1);\n    element.style.backgroundColor = `hsla(44, 100%, 50%, ${intensity.toFixed(3)})`;\n    const span = document.createElement('span');\n    span.className = 'cm-units';\n    span.textContent = i18nString(UIStrings.ms);\n    element.appendChild(span);\n    return element;\n  }\n}\n\nfunction markersFromProfileData(\n    map: Map<number, number>, state: CodeMirror.EditorState,\n    type: SourceFrame.SourceFrame.DecoratorType): CodeMirror.RangeSet<CodeMirror.GutterMarker> {\n  const markerType = type === SourceFrame.SourceFrame.DecoratorType.PERFORMANCE ? PerformanceMarker : MemoryMarker;\n  const markers: Array<CodeMirror.Range<CodeMirror.GutterMarker>> = [];\n  for (const [line, value] of map) {\n    if (line <= state.doc.lines) {\n      const {from} = state.doc.line(line);\n      markers.push(new markerType(value).range(from));\n    }\n  }\n  return CodeMirror.RangeSet.of(markers, true);\n}\n\nconst makeLineLevelProfilePlugin = (type: SourceFrame.SourceFrame.DecoratorType): typeof Plugin =>\n    class extends Plugin {\n  updateEffect = CodeMirror.StateEffect.define<Map<number, number>>();\n  field: CodeMirror.StateField<CodeMirror.RangeSet<CodeMirror.GutterMarker>>;\n  gutter: CodeMirror.Extension;\n  compartment: CodeMirror.Compartment = new CodeMirror.Compartment();\n\n  constructor(uiSourceCode: Workspace.UISourceCode.UISourceCode) {\n    super(uiSourceCode);\n\n    this.field = CodeMirror.StateField.define<CodeMirror.RangeSet<CodeMirror.GutterMarker>>({\n      create(): CodeMirror.RangeSet<CodeMirror.GutterMarker> {\n        return CodeMirror.RangeSet.empty;\n      },\n      update: (markers, tr) => {\n        return tr.effects.reduce((markers, effect) => {\n          return effect.is(this.updateEffect) ? markersFromProfileData(effect.value, tr.state, type) : markers;\n        }, markers.map(tr.changes));\n      },\n    });\n\n    this.gutter = CodeMirror.gutter({\n      markers: view => view.state.field(this.field),\n      class: `cm-${type}Gutter`,\n    });\n  }\n\n  static override accepts(uiSourceCode: Workspace.UISourceCode.UISourceCode): boolean {\n    return uiSourceCode.contentType().hasScripts();\n  }\n\n  private getLineMap(): Map<number, number>|undefined {\n    return this.uiSourceCode.getDecorationData(type);\n  }\n\n  override editorExtension(): CodeMirror.Extension {\n    const map = this.getLineMap();\n    return this.compartment.of(\n        !map ? [] : [this.field.init(state => markersFromProfileData(map, state, type)), this.gutter, theme]);\n  }\n\n  override decorationChanged(type: SourceFrame.SourceFrame.DecoratorType, editor: TextEditor.TextEditor.TextEditor):\n      void {\n    const installed = Boolean(editor.state.field(this.field, false));\n    const map = this.getLineMap();\n    if (!map) {\n      if (installed) {\n        editor.dispatch({effects: this.compartment.reconfigure([])});\n      }\n    } else if (!installed) {\n      editor.dispatch({\n        effects: this.compartment.reconfigure(\n            [this.field.init(state => markersFromProfileData(map, state, type)), this.gutter, theme]),\n      });\n    } else {\n      editor.dispatch({effects: this.updateEffect.of(map)});\n    }\n  }\n};\n\nconst theme = CodeMirror.EditorView.baseTheme({\n  '.cm-line::selection': {\n    backgroundColor: 'transparent',\n    color: 'currentColor',\n  },\n  '.cm-performanceGutter': {\n    width: '60px',\n    backgroundColor: 'var(--sys-color-cdt-base-container)',\n    marginLeft: '3px',\n  },\n  '.cm-memoryGutter': {\n    width: '48px',\n    backgroundColor: 'var(--sys-color-cdt-base-container)',\n    marginLeft: '3px',\n  },\n  '.cm-profileMarker': {\n    textAlign: 'right',\n    paddingRight: '3px',\n  },\n  '.cm-profileMarker .cm-units': {\n    color: 'var(--sys-color-token-subtle)',\n    fontSize: '75%',\n    marginLeft: '3px',\n  },\n});\n\nexport const MemoryProfilePlugin = makeLineLevelProfilePlugin(SourceFrame.SourceFrame.DecoratorType.MEMORY);\n\nexport const PerformanceProfilePlugin = makeLineLevelProfilePlugin(SourceFrame.SourceFrame.DecoratorType.PERFORMANCE);\n"]}