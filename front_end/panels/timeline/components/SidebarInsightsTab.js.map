{"version":3,"file":"SidebarInsightsTab.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/components/SidebarInsightsTab.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,KAAK,MAAM,gCAAgC,CAAC;AACxD,OAAO,KAAK,OAAO,MAAM,2CAA2C,CAAC;AACrE,OAAO,KAAK,EAAE,MAAM,8BAA8B,CAAC;AACnD,OAAO,KAAK,GAAG,MAAM,wBAAwB,CAAC;AAC9C,OAAO,KAAK,KAAK,MAAM,mBAAmB,CAAC;AAE3C,OAAO,KAAK,QAAQ,MAAM,wBAAwB,CAAC;AAEnD,OAAO,wBAAwB,MAAM,6BAA6B,CAAC;AACnE,OAAO,EAAC,uBAAuB,EAAmC,MAAM,8BAA8B,CAAC;AAEvG,MAAM,EAAC,IAAI,EAAC,GAAG,GAAG,CAAC;AACnB,MAAM,EAAC,YAAY,EAAC,GAAG,EAAE,CAAC,MAAM,CAAC;AAgBjC,MAAM,CAAC,MAAM,YAAY,GAAS,CAAC,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,EAAE;IAC1D,MAAM,EACJ,WAAW,EACX,MAAM,EACN,gBAAgB,EAChB,aAAa,EACb,gBAAgB,EAChB,mBAAmB,EACnB,mBAAmB,EACnB,qBAAqB,EACrB,WAAW,GACZ,GAAG,KAAK,CAAC;IAEV,MAAM,QAAQ,GAAG,WAAW,CAAC,QAAQ,CAAC;IACtC,IAAI,CAAC,QAAQ,EAAE,CAAC;QACd,OAAO;IACT,CAAC;IAED,MAAM,sBAAsB,GAAG,QAAQ,CAAC,IAAI,GAAG,CAAC,CAAC;IAEjD,mBAAmB;IACnB,GAAG,CAAC,MAAM,CAAC,IAAI,CAAA;aACJ,wBAAwB;;QAE7B,CAAC,GAAG,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC,UAAU,EAAE,KAAK,EAAE,EAAE;QACjD,MAAM,EAAC,EAAE,EAAE,GAAG,EAAC,GAAG,UAAU,CAAC;QAC7B,MAAM,IAAI,GAAgC;YACxC,aAAa,EAAE,EAAE;YACjB,cAAc,EAAE,gBAAgB;YAChC,aAAa;YACb,WAAW;SACZ,CAAC;QACF,MAAM,QAAQ,GAAG,UAAU,KAAK,gBAAgB,CAAC;QAEjD,MAAM,QAAQ,GAAG,IAAI,CAAA;;mCAEM,EAAE;4BACT,YAAY,CAAC,uBAAuB,EAAE,EAAC,IAAI,EAAC,CAAC;;SAEhE,CAAC;QAEF,IAAI,sBAAsB,EAAE,CAAC;YAC3B,OAAO,IAAI,CAAA,kBAAkB,QAAQ;;uBAExB,GAAG,EAAE,CAAC,mBAAmB,CAAC,UAAU,CAAC;4BAChC,GAAG,EAAE,CAAC,mBAAmB,CAAC,UAAU,CAAC;4BACrC,GAAG,EAAE,CAAC,qBAAqB,EAAE;sBACnC,GAAG,CAAC,IAAI;gBACd,kBAAkB,CAAC,QAAQ,CAAC;sBACtB,MAAM,CAAC,KAAK,CAAC;;yBAEV,CAAC,KAAY,EAAE,EAAE;gBACxB,KAAK,CAAC,eAAe,EAAE,CAAC;gBACxB,WAAW,CAAC,UAAU,CAAC,CAAC;YAC1B,CAAC;;kBAEC,gBAAgB,CAAC,QAAQ,CAAC;;;cAG9B,QAAQ;qBACD,CAAC;QACd,CAAC;QAED,OAAO,QAAQ,CAAC;IAClB,CAAC,CAAC;;GAEL,EAAE,MAAM,CAAC,CAAC;IACX,kBAAkB;AACpB,CAAC,CAAC;AAEF,SAAS,gBAAgB,CAAC,iBAA0B;IAClD,MAAM,OAAO,GAAG,GAAG,CAAC,UAAU,CAAC,QAAQ,CAAC;QACtC,WAAW,EAAE,IAAI;QACjB,MAAM,EAAE,iBAAiB;KAC1B,CAAC,CAAC;IAEH,mBAAmB;IACnB,OAAO,IAAI,CAAA;eACE,OAAO;+BACS;QACvB,OAAO,0CAA6B;QACpC,QAAQ,EAAE,mBAAmB;QAC7B,IAAI,yCAA2B;KACH;8BACN,CAAC;IAC7B,kBAAkB;AACpB,CAAC;AAED,SAAS,kBAAkB,CAAC,iBAA0B;IACpD,MAAM,gBAAgB,GAAG,GAAG,CAAC,UAAU,CAAC,QAAQ,CAAC;QAC/C,eAAe,EAAE,IAAI;QACrB,MAAM,EAAE,iBAAiB;KAC1B,CAAC,CAAC;IAEH,mBAAmB;IACnB,OAAO,IAAI,CAAA;iBACI,gBAAgB;+BACF;QACvB,OAAO,0CAA6B;QACpC,QAAQ,EAAE,eAAe;QACzB,IAAI,yCAA2B;KACH;;GAEjC,CAAC;IACF,kBAAkB;AACpB,CAAC;AAED,MAAM,OAAO,kBAAmB,SAAQ,EAAE,CAAC,MAAM,CAAC,MAAM;IACtD,MAAM,CAAC,mBAAmB;QACxB,MAAM,aAAa,GAAG,QAAQ,CAAC,aAAa,CAAC,iBAAiB,CAAgD,CAAC;QAC/G,OAAO,aAAa,CAAC;IACvB,CAAC;IAED,KAAK,CAAO;IACZ,YAAY,GAAsC,IAAI,CAAC;IACvD,cAAc,GAAuB,IAAI,CAAC;IAC1C,iBAAiB,GAAG,KAAK,CAAC,QAAQ,CAAC,KAAK,CAAC,eAAe,CAAC,GAAG,CAAC;IAC7D;;;;;OAKG;IACH,mBAAmB,GAAyC,IAAI,CAAC;IAEjE,YAAY,OAAqB,EAAE,OAAa,YAAY;QAC1D,KAAK,CAAC,OAAO,EAAE,EAAC,YAAY,EAAE,IAAI,EAAC,CAAC,CAAC;QACrC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC;IACpB,CAAC;IAED,0GAA0G;IAE1G,IAAI,WAAW,CAAC,IAAuC;QACrD,IAAI,IAAI,KAAK,IAAI,CAAC,YAAY,EAAE,CAAC;YAC/B,OAAO;QACT,CAAC;QAED,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC;QACzB,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC;QAEhC,IAAI,IAAI,CAAC,YAAY,EAAE,QAAQ,EAAE,CAAC;YAChC,sIAAsI;YACtI,IAAI,CAAC,mBAAmB,GAAG,CAAC,GAAG,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC;QACpF,CAAC;QAED,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;IAED,IAAI,aAAa;QACf,OAAO,IAAI,CAAC,cAAc,CAAC;IAC7B,CAAC;IAED,IAAI,aAAa,CAAC,MAA0B;QAC1C,IAAI,MAAM,KAAK,IAAI,CAAC,cAAc,EAAE,CAAC;YACnC,OAAO;QACT,CAAC;QAED,IAAI,CAAC,cAAc,GAAG,MAAM,CAAC;QAE7B,8FAA8F;QAC9F,6FAA6F;QAC7F,4FAA4F;QAC5F,6FAA6F;QAC7F,2BAA2B;QAC3B,IAAI,IAAI,CAAC,cAAc,EAAE,CAAC;YACxB,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,YAAY,EAAE,QAAQ,EAAE,GAAG,CAAC,IAAI,CAAC,cAAc,CAAC,aAAa,CAAC,IAAI,IAAI,CAAC;QACzG,CAAC;QACD,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;IAED,oBAAoB,CAAC,UAA2C;QAC9D,IAAI,CAAC,mBAAmB,GAAG,IAAI,CAAC,mBAAmB,KAAK,UAAU,CAAC,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,UAAU,CAAC;QACvF,iCAAiC;QACjC,IAAI,IAAI,CAAC,mBAAmB,EAAE,EAAE,KAAK,IAAI,CAAC,cAAc,EAAE,aAAa,EAAE,CAAC;YACxE,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,IAAI,QAAQ,CAAC,cAAc,CAAC,kBAAkB,EAAE,CAAC,CAAC;QAC/E,CAAC;QACD,IAAI,CAAC,aAAa,EAAE,CAAC;IACvB,CAAC;IAED,oBAAoB,CAAC,UAA2C;QAC9D,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,IAAI,QAAQ,CAAC,cAAc,CAAC,iBAAiB,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC;IAC/F,CAAC;IAED,sBAAsB;QACpB,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,IAAI,QAAQ,CAAC,cAAc,CAAC,iBAAiB,EAAE,CAAC,CAAC;IAC9E,CAAC;IAED,YAAY,CAAC,UAA2C;QACtD,IAAI,CAAC,OAAO,CAAC,aAAa,CAAC,IAAI,QAAQ,CAAC,cAAc,CAAC,cAAc,CAAC,UAAU,CAAC,MAAM,CAAC,CAAC,CAAC;IAC5F,CAAC;IAED,sBAAsB;QACpB,IAAI,CAAC,IAAI,CAAC,cAAc,EAAE,CAAC;YACzB,OAAO;QACT,CAAC;QAED,uDAAuD;QACvD,MAAM,GAAG,GAAG,IAAI,CAAC,OAAO,CAAC,UAAU,EAAE,aAAa,CAC9C,0BAA0B,IAAI,CAAC,cAAc,CAAC,aAAa,IAAI,CAAC,CAAC;QACrE,GAAG,EAAE,SAAS,EAAE,EAAE,sBAAsB,EAAE,CAAC;IAC7C,CAAC;IAEQ,aAAa;QACpB,IAAI,CAAC,IAAI,CAAC,YAAY,EAAE,QAAQ,EAAE,CAAC;YACjC,OAAO;QACT,CAAC;QAED,MAAM,WAAW,GAAG,CAAC,GAAG,IAAI,CAAC,YAAY,CAAC,QAAQ,CAAC,MAAM,EAAE,CAAC,CAAC;QAC7D,MAAM,KAAK,GAAc;YACvB,WAAW,EAAE,IAAI,CAAC,YAAY;YAC9B,MAAM,EAAE,KAAK,CAAC,OAAO,CAAC,eAAe,CAAC,WAAW,CAAC,GAAG,CAAC,CAAC,EAAC,GAAG,EAAC,EAAE,EAAE,CAAC,GAAG,CAAC,CAAC;YACtE,gBAAgB,EAAE,IAAI,CAAC,mBAAmB;YAC1C,aAAa,EAAE,IAAI,CAAC,cAAc;YAClC,gBAAgB,EAAE,IAAI,CAAC,iBAAiB;YACxC,mBAAmB,EAAE,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,IAAI,CAAC;YACzD,mBAAmB,EAAE,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,IAAI,CAAC;YACzD,qBAAqB,EAAE,IAAI,CAAC,sBAAsB,CAAC,IAAI,CAAC,IAAI,CAAC;YAC7D,WAAW,EAAE,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,CAAC;SAC1C,CAAC;QACF,IAAI,CAAC,KAAK,CAAC,KAAK,EAAE,SAAS,EAAE,IAAI,CAAC,cAAc,CAAC,CAAC;IACpD,CAAC;CACF","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Trace from '../../../models/trace/trace.js';\nimport * as Buttons from '../../../ui/components/buttons/buttons.js';\nimport * as UI from '../../../ui/legacy/legacy.js';\nimport * as Lit from '../../../ui/lit/lit.js';\nimport * as Utils from '../utils/utils.js';\n\nimport * as Insights from './insights/insights.js';\nimport type {ActiveInsight} from './Sidebar.js';\nimport sidebarInsightsTabStyles from './sidebarInsightsTab.css.js';\nimport {SidebarSingleInsightSet, type SidebarSingleInsightSetData} from './SidebarSingleInsightSet.js';\n\nconst {html} = Lit;\nconst {widgetConfig} = UI.Widget;\n\ninterface ViewInput {\n  parsedTrace: Trace.TraceModel.ParsedTrace;\n  labels: string[];\n  activeInsightSet: Trace.Insights.Types.InsightSet|null;\n  activeInsight: ActiveInsight|null;\n  selectedCategory: Trace.Insights.Types.InsightCategory;\n  onInsightSetToggled: (insightSet: Trace.Insights.Types.InsightSet) => void;\n  onInsightSetHovered: (insightSet: Trace.Insights.Types.InsightSet) => void;\n  onInsightSetUnhovered: () => void;\n  onZoomClick: (insightSet: Trace.Insights.Types.InsightSet) => void;\n}\n\ntype View = (input: ViewInput, output: undefined, target: HTMLElement) => void;\n\nexport const DEFAULT_VIEW: View = (input, output, target) => {\n  const {\n    parsedTrace,\n    labels,\n    activeInsightSet,\n    activeInsight,\n    selectedCategory,\n    onInsightSetToggled,\n    onInsightSetHovered,\n    onInsightSetUnhovered,\n    onZoomClick,\n  } = input;\n\n  const insights = parsedTrace.insights;\n  if (!insights) {\n    return;\n  }\n\n  const hasMultipleInsightSets = insights.size > 1;\n\n  // clang-format off\n  Lit.render(html`\n    <style>${sidebarInsightsTabStyles}</style>\n    <div class=\"insight-sets-wrapper\">\n      ${[...insights.values()].map((insightSet, index) => {\n        const {id, url} = insightSet;\n        const data: SidebarSingleInsightSetData = {\n          insightSetKey: id,\n          activeCategory: selectedCategory,\n          activeInsight,\n          parsedTrace,\n        };\n        const selected = insightSet === activeInsightSet;\n\n        const contents = html`\n          <devtools-widget\n            data-insight-set-key=${id}\n            .widgetConfig=${widgetConfig(SidebarSingleInsightSet, {data})}\n          ></devtools-widget>\n        `;\n\n        if (hasMultipleInsightSets) {\n          return html`<details ?open=${selected}>\n            <summary\n              @click=${() => onInsightSetToggled(insightSet)}\n              @mouseenter=${() => onInsightSetHovered(insightSet)}\n              @mouseleave=${() => onInsightSetUnhovered()}\n              title=${url.href}>\n              ${renderDropdownIcon(selected)}\n              <span>${labels[index]}</span>\n              <span class='zoom-button'\n                @click=${(event: Event) => {\n                  event.stopPropagation();\n                  onZoomClick(insightSet);\n                }}\n              >\n                ${renderZoomButton(selected)}\n              </span>\n            </summary>\n            ${contents}\n          </details>`;\n        }\n\n        return contents;\n      })}\n    </div>\n  `, target);\n  // clang-format on\n};\n\nfunction renderZoomButton(insightSetToggled: boolean): Lit.TemplateResult {\n  const classes = Lit.Directives.classMap({\n    'zoom-icon': true,\n    active: insightSetToggled,\n  });\n\n  // clang-format off\n  return html`\n  <div class=${classes}>\n      <devtools-button .data=${{\n        variant: Buttons.Button.Variant.ICON,\n        iconName: 'center-focus-weak',\n        size: Buttons.Button.Size.SMALL,\n      } as Buttons.Button.ButtonData}\n    ></devtools-button></div>`;\n  // clang-format on\n}\n\nfunction renderDropdownIcon(insightSetToggled: boolean): Lit.TemplateResult {\n  const containerClasses = Lit.Directives.classMap({\n    'dropdown-icon': true,\n    active: insightSetToggled,\n  });\n\n  // clang-format off\n  return html`\n    <div class=${containerClasses}>\n      <devtools-button .data=${{\n        variant: Buttons.Button.Variant.ICON,\n        iconName: 'chevron-right',\n        size: Buttons.Button.Size.SMALL,\n      } as Buttons.Button.ButtonData}\n    ></devtools-button></div>\n  `;\n  // clang-format on\n}\n\nexport class SidebarInsightsTab extends UI.Widget.Widget {\n  static createWidgetElement(): UI.Widget.WidgetElement<SidebarInsightsTab> {\n    const widgetElement = document.createElement('devtools-widget') as UI.Widget.WidgetElement<SidebarInsightsTab>;\n    return widgetElement;\n  }\n\n  #view: View;\n  #parsedTrace: Trace.TraceModel.ParsedTrace|null = null;\n  #activeInsight: ActiveInsight|null = null;\n  #selectedCategory = Trace.Insights.Types.InsightCategory.ALL;\n  /**\n   * When a trace has sets of insights, we show an accordion with each\n   * set within. A set can be specific to a single navigation, or include the\n   * beginning of the trace up to the first navigation.\n   * You can only have one of these open at any time.\n   */\n  #selectedInsightSet: Trace.Insights.Types.InsightSet|null = null;\n\n  constructor(element?: HTMLElement, view: View = DEFAULT_VIEW) {\n    super(element, {useShadowDom: true});\n    this.#view = view;\n  }\n\n  // TODO(paulirish): add back a disconnectedCallback() to avoid memory leaks that doesn't cause b/372943062\n\n  set parsedTrace(data: Trace.TraceModel.ParsedTrace|null) {\n    if (data === this.#parsedTrace) {\n      return;\n    }\n\n    this.#parsedTrace = data;\n    this.#selectedInsightSet = null;\n\n    if (this.#parsedTrace?.insights) {\n      /** Select the first set. Filtering out trivial sets was done back in {@link Trace.Processor.#computeInsightsForInitialTracePeriod} */\n      this.#selectedInsightSet = [...this.#parsedTrace.insights.values()].at(0) ?? null;\n    }\n\n    this.requestUpdate();\n  }\n\n  get activeInsight(): ActiveInsight|null {\n    return this.#activeInsight;\n  }\n\n  set activeInsight(active: ActiveInsight|null) {\n    if (active === this.#activeInsight) {\n      return;\n    }\n\n    this.#activeInsight = active;\n\n    // Only update selectedInsightSet if there is an active insight. Otherwise, closing an insight\n    // would also collapse the insight set. Usually the proper insight set is already set because\n    // the user has it open already in order for this setter to be called, but insights can also\n    // be activated by clicking on a insight chip in the Summary panel, which may require opening\n    // a different insight set.\n    if (this.#activeInsight) {\n      this.#selectedInsightSet = this.#parsedTrace?.insights?.get(this.#activeInsight.insightSetKey) ?? null;\n    }\n    this.requestUpdate();\n  }\n\n  #onInsightSetToggled(insightSet: Trace.Insights.Types.InsightSet): void {\n    this.#selectedInsightSet = this.#selectedInsightSet === insightSet ? null : insightSet;\n    // Update the active insight set.\n    if (this.#selectedInsightSet?.id !== this.#activeInsight?.insightSetKey) {\n      this.element.dispatchEvent(new Insights.SidebarInsight.InsightDeactivated());\n    }\n    this.requestUpdate();\n  }\n\n  #onInsightSetHovered(insightSet: Trace.Insights.Types.InsightSet): void {\n    this.element.dispatchEvent(new Insights.SidebarInsight.InsightSetHovered(insightSet.bounds));\n  }\n\n  #onInsightSetUnhovered(): void {\n    this.element.dispatchEvent(new Insights.SidebarInsight.InsightSetHovered());\n  }\n\n  #onZoomClick(insightSet: Trace.Insights.Types.InsightSet): void {\n    this.element.dispatchEvent(new Insights.SidebarInsight.InsightSetZoom(insightSet.bounds));\n  }\n\n  highlightActiveInsight(): void {\n    if (!this.#activeInsight) {\n      return;\n    }\n\n    // Find the right set for this insight via the set key.\n    const set = this.element.shadowRoot?.querySelector<UI.Widget.WidgetElement<SidebarSingleInsightSet>>(\n        `[data-insight-set-key=\"${this.#activeInsight.insightSetKey}\"]`);\n    set?.getWidget()?.highlightActiveInsight();\n  }\n\n  override performUpdate(): void {\n    if (!this.#parsedTrace?.insights) {\n      return;\n    }\n\n    const insightSets = [...this.#parsedTrace.insights.values()];\n    const input: ViewInput = {\n      parsedTrace: this.#parsedTrace,\n      labels: Utils.Helpers.createUrlLabels(insightSets.map(({url}) => url)),\n      activeInsightSet: this.#selectedInsightSet,\n      activeInsight: this.#activeInsight,\n      selectedCategory: this.#selectedCategory,\n      onInsightSetToggled: this.#onInsightSetToggled.bind(this),\n      onInsightSetHovered: this.#onInsightSetHovered.bind(this),\n      onInsightSetUnhovered: this.#onInsightSetUnhovered.bind(this),\n      onZoomClick: this.#onZoomClick.bind(this),\n    };\n    this.#view(input, undefined, this.contentElement);\n  }\n}\n"]}