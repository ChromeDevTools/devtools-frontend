{"version":3,"file":"SidebarInsightsTab.js","sourceRoot":"","sources":["../../../../../../../front_end/panels/timeline/components/SidebarInsightsTab.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-lit-render-outside-of-view */\n\nimport './SidebarSingleInsightSet.js';\n\nimport * as Trace from '../../../models/trace/trace.js';\nimport * as Buttons from '../../../ui/components/buttons/buttons.js';\nimport * as ComponentHelpers from '../../../ui/components/helpers/helpers.js';\nimport * as Lit from '../../../ui/lit/lit.js';\nimport * as Utils from '../utils/utils.js';\n\nimport * as Insights from './insights/insights.js';\nimport type {ActiveInsight} from './Sidebar.js';\nimport sidebarInsightsTabStyles from './sidebarInsightsTab.css.js';\nimport type {SidebarSingleInsightSet, SidebarSingleInsightSetData} from './SidebarSingleInsightSet.js';\n\nconst {html} = Lit;\n\nexport class SidebarInsightsTab extends HTMLElement {\n  readonly #shadow = this.attachShadow({mode: 'open'});\n  #parsedTrace: Trace.TraceModel.ParsedTrace|null = null;\n  #activeInsight: ActiveInsight|null = null;\n  #selectedCategory = Trace.Insights.Types.InsightCategory.ALL;\n  /**\n   * When a trace has sets of insights, we show an accordion with each\n   * set within. A set can be specific to a single navigation, or include the\n   * beginning of the trace up to the first navigation.\n   * You can only have one of these open at any time, and we track it via this ID.\n   */\n  #selectedInsightSetKey: string|null = null;\n\n  // TODO(paulirish): add back a disconnectedCallback() to avoid memory leaks that doesn't cause b/372943062\n\n  set parsedTrace(data: Trace.TraceModel.ParsedTrace|null) {\n    if (data === this.#parsedTrace) {\n      return;\n    }\n\n    this.#parsedTrace = data;\n    this.#selectedInsightSetKey = null;\n\n    if (this.#parsedTrace?.insights) {\n      /** Select the first set. Filtering out trivial sets was done back in {@link Trace.Processor.#computeInsightsForInitialTracePeriod} */\n      this.#selectedInsightSetKey = [...this.#parsedTrace.insights.keys()].at(0) ?? null;\n    }\n\n    void ComponentHelpers.ScheduledRender.scheduleRender(this, this.#render);\n  }\n\n  get activeInsight(): ActiveInsight|null {\n    return this.#activeInsight;\n  }\n\n  set activeInsight(active: ActiveInsight|null) {\n    if (active === this.#activeInsight) {\n      return;\n    }\n    this.#activeInsight = active;\n\n    // Only update the insightSetKey if there is an active insight. Otherwise, closing an insight\n    // would also collapse the insight set. Usually the proper insight set is already set because\n    // the user has it open already in order for this setter to be called, but insights can also\n    // be activated by clicking on a insight chip in the Summary panel, which may require opening\n    // a different insight set.\n    if (this.#activeInsight) {\n      this.#selectedInsightSetKey = this.#activeInsight.insightSetKey;\n    }\n    void ComponentHelpers.ScheduledRender.scheduleRender(this, this.#render);\n  }\n\n  #insightSetToggled(id: string): void {\n    this.#selectedInsightSetKey = this.#selectedInsightSetKey === id ? null : id;\n    // Update the active insight set.\n    if (this.#selectedInsightSetKey !== this.#activeInsight?.insightSetKey) {\n      this.dispatchEvent(new Insights.SidebarInsight.InsightDeactivated());\n    }\n    void ComponentHelpers.ScheduledRender.scheduleRender(this, this.#render);\n  }\n\n  #insightSetHovered(id: string): void {\n    const data = this.#parsedTrace?.insights?.get(id);\n    data && this.dispatchEvent(new Insights.SidebarInsight.InsightSetHovered(data.bounds));\n  }\n\n  #insightSetUnhovered(): void {\n    this.dispatchEvent(new Insights.SidebarInsight.InsightSetHovered());\n  }\n\n  #onZoomClick(event: Event, id: string): void {\n    event.stopPropagation();\n    const data = this.#parsedTrace?.insights?.get(id);\n    if (!data) {\n      return;\n    }\n    this.dispatchEvent(new Insights.SidebarInsight.InsightSetZoom(data.bounds));\n  }\n\n  #renderZoomButton(insightSetToggled: boolean): Lit.TemplateResult {\n    const classes = Lit.Directives.classMap({\n      'zoom-icon': true,\n      active: insightSetToggled,\n    });\n\n    // clang-format off\n    return html`\n    <div class=${classes}>\n        <devtools-button .data=${{\n          variant: Buttons.Button.Variant.ICON,\n          iconName: 'center-focus-weak',\n          size: Buttons.Button.Size.SMALL,\n        } as Buttons.Button.ButtonData}\n      ></devtools-button></div>`;\n    // clang-format on\n  }\n\n  #renderDropdownIcon(insightSetToggled: boolean): Lit.TemplateResult {\n    const containerClasses = Lit.Directives.classMap({\n      'dropdown-icon': true,\n      active: insightSetToggled,\n    });\n\n    // clang-format off\n    return html`\n      <div class=${containerClasses}>\n        <devtools-button .data=${{\n          variant: Buttons.Button.Variant.ICON,\n          iconName: 'chevron-right',\n          size: Buttons.Button.Size.SMALL,\n        } as Buttons.Button.ButtonData}\n      ></devtools-button></div>\n    `;\n    // clang-format on\n  }\n\n  highlightActiveInsight(): void {\n    if (!this.#activeInsight) {\n      return;\n    }\n    // Find the right set for this insight via the set key.\n    const set = this.#shadow?.querySelector<SidebarSingleInsightSet>(\n        `devtools-performance-sidebar-single-navigation[data-insight-set-key=\"${this.#activeInsight.insightSetKey}\"]`);\n    if (!set) {\n      return;\n    }\n    set.highlightActiveInsight();\n  }\n\n  #render(): void {\n    if (!this.#parsedTrace?.insights) {\n      Lit.render(Lit.nothing, this.#shadow, {host: this});\n      return;\n    }\n\n    const insights = this.#parsedTrace.insights;\n    const hasMultipleInsightSets = insights.size > 1;\n    const labels = Utils.Helpers.createUrlLabels([...insights.values()].map(({url}) => url));\n\n    const contents =\n        // clang-format off\n     html`\n      <style>${sidebarInsightsTabStyles}</style>\n      <div class=\"insight-sets-wrapper\">\n        ${[...insights.values()].map(({id, url}, index) => {\n          const data: SidebarSingleInsightSetData = {\n            insightSetKey: id,\n            activeCategory: this.#selectedCategory,\n            activeInsight: this.#activeInsight,\n            parsedTrace: this.#parsedTrace,\n          };\n\n          const contents = html`\n            <devtools-performance-sidebar-single-navigation\n              data-insight-set-key=${id}\n              .data=${data}>\n            </devtools-performance-sidebar-single-navigation>\n          `;\n\n          if (hasMultipleInsightSets) {\n            return html`<details\n              ?open=${id === this.#selectedInsightSetKey}\n            >\n              <summary\n                @click=${() => this.#insightSetToggled(id)}\n                @mouseenter=${() => this.#insightSetHovered(id)}\n                @mouseleave=${() => this.#insightSetUnhovered()}\n                title=${url.href}>\n                ${this.#renderDropdownIcon(id === this.#selectedInsightSetKey)}\n                <span>${labels[index]}</span>\n                <span class='zoom-button' @click=${(event: Event) => this.#onZoomClick(event, id)}>${this.#renderZoomButton(id === this.#selectedInsightSetKey)}</span>\n              </summary>\n              ${contents}\n            </details>`;\n          }\n\n          return contents;\n        })}\n      </div>\n    `;\n    // clang-format on\n\n    // Insight components contain state, so to prevent insights from previous trace loads breaking things we use the parsedTrace\n    // as a render key.\n    // Note: newer Lit has `keyed`, but we don't have that, so we do it manually. https://lit.dev/docs/templates/directives/#keyed\n    const result = Lit.Directives.repeat([contents], () => this.#parsedTrace, template => template);\n    Lit.render(result, this.#shadow, {host: this});\n  }\n}\n\ncustomElements.define('devtools-performance-sidebar-insights', SidebarInsightsTab);\n\ndeclare global {\n  interface HTMLElementTagNameMap {\n    'devtools-performance-sidebar-insights': SidebarInsightsTab;\n  }\n}\n"]}