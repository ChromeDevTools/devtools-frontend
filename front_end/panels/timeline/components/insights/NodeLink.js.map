{"version":3,"file":"NodeLink.js","sourceRoot":"","sources":["../../../../../../../../front_end/panels/timeline/components/insights/NodeLink.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type * as Platform from '../../../../core/platform/platform.js';\nimport * as SDK from '../../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../../generated/protocol.js';\nimport * as Buttons from '../../../../ui/components/buttons/buttons.js';\nimport * as LegacyComponents from '../../../../ui/legacy/components/utils/utils.js';\nimport * as UI from '../../../../ui/legacy/legacy.js';\nimport * as Lit from '../../../../ui/lit/lit.js';\nimport * as PanelsCommon from '../../../common/common.js';\n\nconst {html} = Lit;\nconst {widgetConfig} = UI.Widget;\n\ninterface ViewInput {\n  relatedNodeEl: Node|undefined;\n  fallbackUrl?: Platform.DevToolsPath.UrlString;\n  fallbackHtmlSnippet?: string;\n  fallbackText?: string;\n}\n\ntype View = (input: ViewInput, output: undefined, target: HTMLElement) => void;\n\nexport const DEFAULT_VIEW: View = (input, output, target) => {\n  const {\n    relatedNodeEl,\n    fallbackUrl,\n    fallbackHtmlSnippet,\n    fallbackText,\n  } = input;\n\n  let template;\n  if (relatedNodeEl) {\n    template = html`<div class='node-link'>${relatedNodeEl}</div>`;\n  } else if (fallbackUrl) {\n    const MAX_URL_LENGTH = 20;\n    const options = {\n      tabStop: true,\n      showColumnNumber: false,\n      inlineFrameIndex: 0,\n      maxLength: MAX_URL_LENGTH,\n    };\n    const linkEl = LegacyComponents.Linkifier.Linkifier.linkifyURL(fallbackUrl, options);\n    template = html`<div class='node-link'>\n      <style>${Buttons.textButtonStyles}</style>\n      ${linkEl}\n    </div>`;\n  } else if (fallbackHtmlSnippet) {\n    // TODO: Use CodeHighlighter.\n    template = html`<pre style='text-wrap: auto'>${fallbackHtmlSnippet}</pre>`;\n  } else if (fallbackText) {\n    template = html`<span>${fallbackText}</span>`;\n  } else {\n    template = Lit.nothing;\n  }\n\n  Lit.render(template, target);\n};\n\nexport interface NodeLinkData {\n  backendNodeId: Protocol.DOM.BackendNodeId;\n  frame?: string;\n  options?: PanelsCommon.DOMLinkifier.Options;\n  /**\n   * URL to display if backendNodeId cannot be resolved (ie for traces loaded from disk).\n   * Will be given to linkifyURL. Use this or one of the other fallback fields.\n   */\n  fallbackUrl?: Platform.DevToolsPath.UrlString;\n  /**\n   * Text to display if backendNodeId cannot be resolved (ie for traces loaded from disk).\n   * Displayed as monospace code.\n   */\n  fallbackHtmlSnippet?: string;\n  /**\n   * Text to display if backendNodeId cannot be resolved (ie for traces loaded from disk).\n   * Displayed as plain text.\n   */\n  fallbackText?: string;\n}\n\nexport class NodeLink extends UI.Widget.Widget {\n  #view: View;\n  #backendNodeId?: Protocol.DOM.BackendNodeId;\n  #frame?: string;\n  #options?: PanelsCommon.DOMLinkifier.Options;\n  #fallbackUrl?: Platform.DevToolsPath.UrlString;\n  #fallbackHtmlSnippet?: string;\n  #fallbackText?: string;\n  /**\n   * Track the linkified Node for a given backend NodeID to avoid repeated lookups on re-render.\n   * Also tracks if we fail to resolve a node, to ensure we don't try on each subsequent re-render.\n   */\n  #linkifiedNodeForBackendId = new Map<Protocol.DOM.BackendNodeId, Node|'NO_NODE_FOUND'>();\n\n  constructor(element?: HTMLElement, view: View = DEFAULT_VIEW) {\n    super(element, {useShadowDom: true});\n    this.#view = view;\n  }\n\n  set data(data: NodeLinkData) {\n    this.#backendNodeId = data.backendNodeId;\n    this.#frame = data.frame;\n    this.#options = data.options;\n    this.#fallbackUrl = data.fallbackUrl;\n    this.#fallbackHtmlSnippet = data.fallbackHtmlSnippet;\n    this.#fallbackText = data.fallbackText;\n    this.requestUpdate();\n  }\n\n  async #linkify(): Promise<Node|undefined> {\n    if (this.#backendNodeId === undefined) {\n      return;\n    }\n    const fromCache = this.#linkifiedNodeForBackendId.get(this.#backendNodeId);\n    if (fromCache) {\n      if (fromCache === 'NO_NODE_FOUND') {\n        return undefined;\n      }\n      return fromCache;\n    }\n\n    const target = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    const domModel = target?.model(SDK.DOMModel.DOMModel);\n    if (!domModel) {\n      return undefined;\n    }\n    const domNodesMap = await domModel.pushNodesByBackendIdsToFrontend(new Set([this.#backendNodeId]));\n    const node = domNodesMap?.get(this.#backendNodeId);\n    if (!node) {\n      this.#linkifiedNodeForBackendId.set(this.#backendNodeId, 'NO_NODE_FOUND');\n      return;\n    }\n\n    if (node.frameId() !== this.#frame) {\n      this.#linkifiedNodeForBackendId.set(this.#backendNodeId, 'NO_NODE_FOUND');\n      return;\n    }\n\n    // TODO: it'd be nice if we could specify what attributes to render,\n    // ex for the Viewport insight: <meta content=\"...\"> (instead of just <meta>)\n    const linkedNode = PanelsCommon.DOMLinkifier.Linkifier.instance().linkify(node, this.#options);\n    this.#linkifiedNodeForBackendId.set(this.#backendNodeId, linkedNode);\n    return linkedNode;\n  }\n\n  override async performUpdate(): Promise<void> {\n    const input: ViewInput = {\n      relatedNodeEl: await this.#linkify(),\n      fallbackUrl: this.#fallbackUrl,\n      fallbackHtmlSnippet: this.#fallbackHtmlSnippet,\n      fallbackText: this.#fallbackText,\n    };\n    this.#view(input, undefined, this.contentElement);\n  }\n}\n\nexport function nodeLink(data: NodeLinkData): Lit.TemplateResult {\n  return html`<devtools-widget .widgetConfig=${widgetConfig(NodeLink, {\n    data,\n  })}></devtools-widget>`;\n}\n"]}