{"version":3,"file":"SlowCSSSelector.js","sourceRoot":"","sources":["../../../../../../../../front_end/panels/timeline/components/insights/SlowCSSSelector.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport '../../../../ui/components/linkifier/linkifier.js';\n\nimport * as i18n from '../../../../core/i18n/i18n.js';\nimport * as Platform from '../../../../core/platform/platform.js';\nimport * as SDK from '../../../../core/sdk/sdk.js';\nimport type * as Protocol from '../../../../generated/protocol.js';\nimport type {SlowCSSSelectorInsightModel} from '../../../../models/trace/insights/SlowCSSSelector.js';\nimport * as Trace from '../../../../models/trace/trace.js';\nimport type * as Linkifier from '../../../../ui/components/linkifier/linkifier.js';\nimport * as UI from '../../../../ui/legacy/legacy.js';\nimport * as Lit from '../../../../ui/lit/lit.js';\n\nimport {BaseInsightComponent} from './BaseInsightComponent.js';\nimport {Table} from './Table.js';\n\nconst {UIStrings, i18nString} = Trace.Insights.Models.SlowCSSSelector;\n\nconst {html} = Lit;\nconst {widgetConfig} = UI.Widget;\n\nexport class SlowCSSSelector extends BaseInsightComponent<SlowCSSSelectorInsightModel> {\n  override internalName = 'slow-css-selector';\n  #selectorLocations = new Map<string, Protocol.CSS.SourceRange[]>();\n\n  protected override hasAskAiSupport(): boolean {\n    return true;\n  }\n\n  private async toSourceFileLocation(cssModel: SDK.CSSModel.CSSModel, selector: Trace.Types.Events.SelectorTiming):\n      Promise<Linkifier.Linkifier.LinkifierData[]|undefined> {\n    if (!cssModel) {\n      return undefined;\n    }\n    const styleSheetHeader = cssModel.styleSheetHeaderForId(selector.style_sheet_id as Protocol.DOM.StyleSheetId);\n    if (!styleSheetHeader?.resourceURL()) {\n      return undefined;\n    }\n\n    // get the locations from cache if available\n    const key: string = JSON.stringify({selectorText: selector.selector, styleSheetId: selector.style_sheet_id});\n    let ranges = this.#selectorLocations.get(key);\n    if (!ranges) {\n      const result = await cssModel.agent.invoke_getLocationForSelector(\n          {selectorText: selector.selector, styleSheetId: selector.style_sheet_id as Protocol.DOM.StyleSheetId});\n      if (result.getError() || !result.ranges) {\n        return undefined;\n      }\n      ranges = result.ranges;\n      this.#selectorLocations.set(key, ranges);\n    }\n\n    const locations = ranges.map((range, itemIndex) => {\n      return {\n        url: styleSheetHeader.resourceURL(),\n        lineNumber: range.startLine,\n        columnNumber: range.startColumn,\n        linkText: `[${itemIndex + 1}]`,\n        title: `${styleSheetHeader.id} line ${range.startLine + 1}:${range.startColumn + 1}`,\n      } as Linkifier.Linkifier.LinkifierData;\n    });\n    return locations;\n  }\n\n  private async getSelectorLinks(\n      cssModel: SDK.CSSModel.CSSModel|null|undefined,\n      selector: Trace.Types.Events.SelectorTiming): Promise<Lit.LitTemplate> {\n    if (!cssModel) {\n      return Lit.nothing;\n    }\n\n    if (!selector.style_sheet_id) {\n      return Lit.nothing;\n    }\n\n    const locations = await this.toSourceFileLocation(cssModel, selector);\n    if (!locations) {\n      return Lit.nothing;\n    }\n\n    const links = html`\n    ${locations.map((location, itemIndex) => {\n      const divider = itemIndex !== locations.length - 1 ? ', ' : '';\n      return html`<devtools-linkifier .data=${location}></devtools-linkifier>${divider}`;\n    })}`;\n\n    return links;\n  }\n\n  override renderContent(): Lit.LitTemplate {\n    if (!this.model) {\n      return Lit.nothing;\n    }\n\n    const target = SDK.TargetManager.TargetManager.instance().primaryPageTarget();\n    const cssModel = target?.model(SDK.CSSModel.CSSModel);\n    const time = (us: Trace.Types.Timing.Micro): string =>\n        i18n.TimeUtilities.millisToString(Platform.Timing.microSecondsToMilliSeconds(us));\n\n    if (!this.model.topSelectorMatchAttempts && !this.model.topSelectorElapsedMs) {\n      return html`<div class=\"insight-section\">${i18nString(UIStrings.enableSelectorData)}</div>`;\n    }\n\n    // clang-format off\n    const sections = [html`\n      <div class=\"insight-section\">\n        <devtools-widget .widgetConfig=${widgetConfig(Table, {\n           data: {\n            insight: this,\n            headers: [i18nString(UIStrings.total), ''],\n            rows: [\n              {values: [i18nString(UIStrings.matchAttempts), this.model.totalMatchAttempts]},\n              {values: [i18nString(UIStrings.matchCount), this.model.totalMatchCount]},\n              {values: [i18nString(UIStrings.elapsed), i18n.TimeUtilities.millisToString(this.model.totalElapsedMs)]},\n            ],\n          }})}>\n        </devtools-widget>\n      </div>\n    `];\n    // clang-format on\n\n    if (this.model.topSelectorElapsedMs) {\n      const selector = this.model.topSelectorElapsedMs;\n      // clang-format off\n      sections.push(html`\n        <div class=\"insight-section\">\n          <devtools-widget .widgetConfig=${widgetConfig(Table, {\n           data: {\n              insight: this,\n              headers: [`${i18nString(UIStrings.topSelectorElapsedTime)}: ${time(Trace.Types.Timing.Micro(selector['elapsed (us)']))}`],\n              rows: [{\n                values: [html`${selector.selector} ${Lit.Directives.until(this.getSelectorLinks(cssModel, selector))}`]}]\n            }})}>\n          </devtools-widget>\n        </div>\n      `);\n      // clang-format on\n    }\n\n    if (this.model.topSelectorMatchAttempts) {\n      const selector = this.model.topSelectorMatchAttempts;\n      // clang-format off\n      sections.push(html`\n        <div class=\"insight-section\">\n          <devtools-widget .widgetConfig=${widgetConfig(Table, {\n           data: {\n              insight: this,\n              headers: [`${i18nString(UIStrings.topSelectorMatchAttempt)}: ${selector['match_attempts']}`],\n              rows: [{\n                  values: [html`${selector.selector} ${Lit.Directives.until(this.getSelectorLinks(cssModel, selector))}` as unknown as string],\n              }]\n            }})}>\n          </devtools-widget>\n        </div>\n      `);\n      // clang-format on\n    }\n\n    return html`${sections}`;\n  }\n}\n"]}