{"version":3,"file":"SnapshotTester.js","sourceRoot":"","sources":["../../../../../front_end/testing/SnapshotTester.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\n/**\n * Asserts two strings are equal, and logs the first differing line if not equal.\n */\nfunction assertSnapshotContent(actual: string, expected: string): void {\n  if (actual !== expected) {\n    const actualLines = actual.split('\\n');\n    const expectedLines = expected.split('\\n');\n    for (let i = 0; i < Math.max(actualLines.length, expectedLines.length); i++) {\n      const actualLine = actualLines.at(i);\n      const expectedLine = expectedLines.at(i);\n      if (actualLine !== expectedLine) {\n        const firstDifference = `First differing line:\\nexpected: ${expectedLine}\\nactual:   ${actualLine}`;\n        throw new Error(\n            `snapshot assertion failed! to update snapshot, run \\`npm run test -- --on-diff=update ...\\`\\n\\n${\n                firstDifference}`);\n      }\n    }\n  }\n}\n\n/**\n * Provides snapshot testing for karma unit tests.\n * See README.md for more.\n *\n * Note: karma.conf.ts implements the server logic (see snapshotTesterFactory).\n */\nclass BaseSnapshotTester {\n  static #updateMode: boolean|null = null;\n\n  protected snapshotPath: string;\n  #expected = new Map<string, string>();\n  #actual = new Map<string, string>();\n  #anyFailures = false;\n  #newTests = false;\n\n  constructor(context: Mocha.Suite, meta: ImportMeta) {\n    if (context.timeout() > 0) {\n      // The first usage of SnapshotTester in a test seems to take an extraordinary\n      // amount of time, so let's bump the timeout for all snapshot tests.\n      context.timeout(Math.max(context.timeout(), 45000));\n    }\n\n    context.beforeAll(async () => {\n      await this.load();\n    });\n\n    context.afterAll(async () => {\n      await this.finish();\n    });\n\n    // out/Default/gen/third_party/devtools-frontend/src/front_end/testing/SnapshotTester.test.js?8ee4f2b123e221040a4aa075a28d0e5b41d3d3ed\n    // ->\n    // front_end/testing/SnapshotTester.snapshot.txt\n    this.snapshotPath =\n        meta.url.substring(meta.url.lastIndexOf('front_end')).replace('.test.js', '.snapshot.txt').split('?')[0];\n  }\n\n  async load() {\n    if (BaseSnapshotTester.#updateMode === null) {\n      BaseSnapshotTester.#updateMode = await this.checkIfUpdateMode();\n    }\n    const content = await this.loadSnapshot(this.snapshotPath);\n    if (content) {\n      this.#parseSnapshotFileContent(content);\n    }\n  }\n\n  assert(context: Mocha.Context, actual: string) {\n    const title = context.test?.fullTitle() ?? '';\n\n    if (this.#actual.has(title)) {\n      throw new Error('sorry, currently only support 1 snapshot assertion per test');\n    }\n\n    if (actual.includes('=== end content')) {\n      throw new Error('invalid content');\n    }\n\n    actual = actual.trim();\n    this.#actual.set(title, actual);\n\n    const expected = this.#expected.get(title);\n    if (expected === undefined) {\n      this.#newTests = true;\n      if (BaseSnapshotTester.#updateMode) {\n        return;\n      }\n\n      this.#anyFailures = true;\n      throw new Error(`snapshot assertion failed! new snapshot found (${\n          title}), must run \\`npm run test -- --on-diff=update ...\\` to accept it.`);\n    }\n\n    const isDifferent = actual !== expected;\n    if (isDifferent) {\n      this.#anyFailures = true;\n      if (!BaseSnapshotTester.#updateMode) {\n        assertSnapshotContent(actual, expected);\n      }\n    }\n  }\n\n  async finish() {\n    let didAnyTestNotRun = false;\n    for (const title of this.#expected.keys()) {\n      if (!this.#actual.has(title)) {\n        didAnyTestNotRun = true;\n        break;\n      }\n    }\n\n    const hasChanges = this.#anyFailures || didAnyTestNotRun || this.#newTests;\n    if (!hasChanges) {\n      return;\n    }\n\n    // If the update flag is on, post any and all changes (failures, new tests, removals).\n    if (BaseSnapshotTester.#updateMode) {\n      await this.postUpdate();\n      return;\n    }\n\n    // Note: this does not handle test filtering (.only, --grep). Need a reliable way\n    // to distinguish a deleted test from a test that was filtered out.\n    if (didAnyTestNotRun) {\n      throw new Error(\n          'Snapshots are out of sync (a test was likely deleted or renamed). Run with `--on-diff=update` to fix.');\n    }\n  }\n\n  #parseSnapshotFileContent(content: string): void {\n    const sections = content.split('=== end content').map(s => s.trim()).filter(Boolean);\n    for (const section of sections) {\n      const [titleField, contentField, ...contentLines] = section.split('\\n');\n      const title = titleField.replace('Title:', '').trim();\n      if (contentField !== 'Content:') {\n        throw new Error('unexpected snapshot file');\n      }\n      const content = contentLines.join('\\n').trim();\n      this.#expected.set(title, content);\n    }\n  }\n\n  protected serializeSnapshotFileContent(): string {\n    if (!this.#actual.size) {\n      return '';\n    }\n\n    const lines = [];\n    for (const [title, result] of this.#actual) {\n      lines.push(`Title: ${title}`);\n      lines.push(`Content:\\n${result}`);\n      lines.push('=== end content\\n');\n    }\n    lines.push('');\n\n    return lines.join('\\n').trim() + '\\n';\n  }\n\n  protected async checkIfUpdateMode(): Promise<boolean> {\n    return false;\n  }\n\n  protected async postUpdate(): Promise<void> {\n    throw new Error(`Not implemented`);\n  }\n\n  protected async loadSnapshot(_snapshotPath: string): Promise<string|undefined> {\n    throw new Error('not implemented');\n  }\n}\n\nclass WebSnapshotTester extends BaseSnapshotTester {\n  protected override async checkIfUpdateMode(): Promise<boolean> {\n    const response = await fetch('/snapshot-update-mode');\n    const data = await response.json();\n    return data.updateMode === true;\n  }\n\n  protected override async postUpdate(): Promise<void> {\n    const url = new URL('/update-snapshot', import.meta.url);\n    url.searchParams.set('snapshotPath', this.snapshotPath);\n    const content = this.serializeSnapshotFileContent();\n    const response = await fetch(url, {method: 'POST', body: content});\n    if (response.status !== 200) {\n      throw new Error(`Unable to update snapshot ${url}`);\n    }\n  }\n\n  protected override async loadSnapshot(snapshotPath: string): Promise<string|undefined> {\n    const url = new URL('/snapshot', import.meta.url);\n    url.searchParams.set('snapshotPath', snapshotPath);\n    const response = await fetch(url);\n    if (response.status === 404) {\n      console.warn(`Snapshot file not found: ${snapshotPath}. Will create it for you.`);\n      return;\n    }\n    if (response.status !== 200) {\n      throw new Error('failed to load snapshot');\n    }\n    return await response.text();\n  }\n}\n\nclass NodeSnapshotTester extends BaseSnapshotTester {\n  protected override async checkIfUpdateMode(): Promise<boolean> {\n    // cannot update in node mode yet.\n    return false;\n  }\n\n  protected override async postUpdate(): Promise<void> {\n    const content = this.serializeSnapshotFileContent();\n    // @ts-expect-error no node types here.\n    const fs = await import('node:fs/promises');\n    await fs.writeFile(await this.#getSnapshotPath(this.snapshotPath), content);\n  }\n\n  protected override async loadSnapshot(snapshotPath: string): Promise<string|undefined> {\n    // @ts-expect-error no node types here.\n    const fs = await import('node:fs/promises');\n    return await fs.readFile(await this.#getSnapshotPath(snapshotPath), 'utf-8');\n  }\n\n  async #getSnapshotPath(snapshotPath: string): Promise<string> {\n    // @ts-expect-error no node types here.\n    const path = await import('node:path');\n    // @ts-expect-error no ESM types here.\n    const SOURCE_ROOT = path.join(import.meta.dirname, '..', '..', '..', '..', '..');\n    return path.join(SOURCE_ROOT, snapshotPath);\n  }\n}\n\nexport type SnapshotTester = NodeSnapshotTester|WebSnapshotTester;\n\nconst SnapshotTesterValue = (typeof window === 'undefined') ? NodeSnapshotTester : WebSnapshotTester;\n\nexport {SnapshotTesterValue as SnapshotTester};\n"]}