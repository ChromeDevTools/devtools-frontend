{"version":3,"file":"safe_builder.js","sourceRoot":"","sources":["../../../../../../../../../front_end/third_party/source-map-scopes-codec/package/src/builder/safe_builder.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors. All rights reserved.\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport type {\n  Binding,\n  OriginalPosition,\n  OriginalScope,\n  Position,\n  ScopeInfo,\n} from \"../scopes.d.ts\";\nimport { comparePositions } from \"../util.js\";\nimport { ScopeInfoBuilder, type ScopeKey } from \"./builder.js\";\n\n/**\n * Similar to `ScopeInfoBuilder`, but with checks that scopes/ranges are well\n * nested and don't partially overlap.\n */\nexport class SafeScopeInfoBuilder extends ScopeInfoBuilder {\n  override addNullScope(): this {\n    this.#verifyEmptyScopeStack(\"add null scope\");\n    this.#verifyEmptyRangeStack(\"add null scope\");\n\n    super.addNullScope();\n    return this;\n  }\n\n  override startScope(\n    line: number,\n    column: number,\n    options?: {\n      name?: string;\n      kind?: string;\n      isStackFrame?: boolean;\n      variables?: string[];\n      key?: ScopeKey;\n    },\n  ): this {\n    this.#verifyEmptyRangeStack(\"start scope\");\n\n    const parent = this.scopeStack.at(-1);\n\n    if (parent && comparePositions(parent.start, { line, column }) > 0) {\n      throw new Error(\n        `Scope start (${line}, ${column}) must not precede parent start (${parent.start.line}, ${parent.start.column})`,\n      );\n    }\n\n    const precedingSibling = parent?.children.at(-1);\n    if (\n      precedingSibling &&\n      comparePositions(precedingSibling.end, { line, column }) > 0\n    ) {\n      throw new Error(\n        `Scope start (${line}, ${column}) must not precede preceding siblings' end (${precedingSibling\n          .end.line,\n          precedingSibling.end.column})`,\n      );\n    }\n\n    super.startScope(line, column, options);\n    return this;\n  }\n\n  override setScopeName(name: string): this {\n    this.#verifyScopePresent(\"setScopeName\");\n    this.#verifyEmptyRangeStack(\"setScopeName\");\n\n    super.setScopeName(name);\n    return this;\n  }\n\n  override setScopeKind(kind: string): this {\n    this.#verifyScopePresent(\"setScopeKind\");\n    this.#verifyEmptyRangeStack(\"setScopeKind\");\n\n    super.setScopeKind(kind);\n    return this;\n  }\n\n  override setScopeStackFrame(isStackFrame: boolean): this {\n    this.#verifyScopePresent(\"setScopeStackFrame\");\n    this.#verifyEmptyRangeStack(\"setScopeStackFrame\");\n\n    super.setScopeStackFrame(isStackFrame);\n    return this;\n  }\n\n  override setScopeVariables(variables: string[]): this {\n    this.#verifyScopePresent(\"setScopeVariables\");\n    this.#verifyEmptyRangeStack(\"setScopeVariables\");\n\n    super.setScopeVariables(variables);\n    return this;\n  }\n\n  override endScope(line: number, column: number): this {\n    this.#verifyEmptyRangeStack(\"end scope\");\n\n    if (this.scopeStack.length === 0) {\n      throw new Error(\"No scope to end\");\n    }\n\n    const scope = this.scopeStack.at(-1) as OriginalScope;\n    if (comparePositions(scope.start, { line, column }) > 0) {\n      throw new Error(\n        `Scope end (${line}, ${column}) must not precede scope start (${scope.start.line}, ${scope.start.column})`,\n      );\n    }\n\n    super.endScope(line, column);\n    return this;\n  }\n\n  override startRange(\n    line: number,\n    column: number,\n    options?: {\n      scope?: OriginalScope;\n      scopeKey?: ScopeKey;\n      isStackFrame?: boolean;\n      isHidden?: boolean;\n      values?: Binding[];\n      callSite?: OriginalPosition;\n    },\n  ): this {\n    this.#verifyEmptyScopeStack(\"starRange\");\n\n    const parent = this.rangeStack.at(-1);\n    if (parent && comparePositions(parent.start, { line, column }) > 0) {\n      throw new Error(\n        `Range start (${line}, ${column}) must not precede parent start (${parent.start.line}, ${parent.start.column})`,\n      );\n    }\n\n    const precedingSibling = parent?.children.at(-1);\n    if (\n      precedingSibling &&\n      comparePositions(precedingSibling.end, { line, column }) > 0\n    ) {\n      throw new Error(\n        `Range start (${line}, ${column}) must not precede preceding siblings' end (${precedingSibling\n          .end.line,\n          precedingSibling.end.column})`,\n      );\n    }\n\n    if (\n      options?.scopeKey !== undefined &&\n      !this.isValidScopeKey(options.scopeKey)\n    ) {\n      throw new Error(\n        `${options.scopeKey} does not reference a valid OriginalScope`,\n      );\n    }\n    if (options?.scope && !this.isKnownScope(options.scope)) {\n      throw new Error(\n        \"The provided definition scope was not produced by this builder!\",\n      );\n    }\n\n    if (\n      options?.values?.length && options?.scope === undefined &&\n      options?.scopeKey === undefined\n    ) {\n      throw new Error(\"Provided bindings without providing an OriginalScope\");\n    } else if (\n      options?.values?.length && options?.scope &&\n      options.values.length !== options.scope.variables.length\n    ) {\n      throw new Error(\n        \"Provided bindings don't match up with OriginalScope.variables\",\n      );\n    } else if (options?.values?.length && options?.scopeKey !== undefined) {\n      const scope = this.getScopeByValidKey(options.scopeKey);\n      if (options.values.length !== scope.variables.length) {\n        throw new Error(\n          \"Provided bindings don't match up with OriginalScope.variables\",\n        );\n      }\n    }\n\n    super.startRange(line, column, options);\n    return this;\n  }\n\n  override setRangeDefinitionScope(scope: OriginalScope): this {\n    this.#verifyEmptyScopeStack(\"setRangeDefinitionScope\");\n    this.#verifyRangePresent(\"setRangeDefinitionScope\");\n\n    if (!this.isKnownScope(scope)) {\n      throw new Error(\n        \"The provided definition scope was not produced by this builder!\",\n      );\n    }\n\n    super.setRangeDefinitionScope(scope);\n    return this;\n  }\n\n  override setRangeDefinitionScopeKey(scopeKey: ScopeKey): this {\n    this.#verifyEmptyScopeStack(\"setRangeDefinitionScope\");\n    this.#verifyRangePresent(\"setRangeDefinitionScope\");\n\n    if (!this.isValidScopeKey(scopeKey)) {\n      throw new Error(\n        `The provided scope key ${scopeKey} is not know nto the builder!`,\n      );\n    }\n\n    super.setRangeDefinitionScopeKey(scopeKey);\n    return this;\n  }\n\n  override setRangeStackFrame(isStackFrame: boolean): this {\n    this.#verifyEmptyScopeStack(\"setRangeStackFrame\");\n    this.#verifyRangePresent(\"setRangeStackFrame\");\n\n    super.setRangeStackFrame(isStackFrame);\n    return this;\n  }\n\n  override setRangeHidden(isHidden: boolean): this {\n    this.#verifyEmptyScopeStack(\"setRangeHidden\");\n    this.#verifyRangePresent(\"setRangeHidden\");\n\n    super.setRangeHidden(isHidden);\n    return this;\n  }\n\n  override setRangeValues(values: Binding[]): this {\n    this.#verifyEmptyScopeStack(\"setRangeValues\");\n    this.#verifyRangePresent(\"setRangeValues\");\n\n    const range = this.rangeStack.at(-1)!;\n    if (!range.originalScope) {\n      throw new Error(\n        \"Setting an OriginalScope for a range is required before value bindings can be provided!\",\n      );\n    } else if (range.originalScope.variables.length !== values.length) {\n      throw new Error(\n        \"Provided bindings don't match up with OriginalScope.variables\",\n      );\n    }\n\n    super.setRangeValues(values);\n    return this;\n  }\n\n  override setRangeCallSite(callSite: OriginalPosition): this {\n    this.#verifyEmptyScopeStack(\"setRangeCallSite\");\n    this.#verifyRangePresent(\"setRangeCallSite\");\n\n    super.setRangeCallSite(callSite);\n    return this;\n  }\n\n  override endRange(line: number, column: number): this {\n    this.#verifyEmptyScopeStack(\"endRange\");\n\n    if (this.rangeStack.length === 0) {\n      throw new Error(\"No range to end\");\n    }\n\n    const range = this.rangeStack.at(-1)!;\n    if (comparePositions(range.start, { line, column }) > 0) {\n      throw new Error(\n        `Range end (${line}, ${column}) must not precede range start (${range.start.line}, ${range.start.column})`,\n      );\n    }\n\n    this.#verifyRangeValues(range, { line, column });\n    super.endRange(line, column);\n    return this;\n  }\n\n  override build(): ScopeInfo {\n    if (this.scopeStack.length > 0) {\n      throw new Error(\n        \"Can't build ScopeInfo while an OriginalScope is unclosed.\",\n      );\n    }\n    this.#verifyEmptyRangeStack(\"build ScopeInfo\");\n\n    return super.build();\n  }\n\n  #verifyEmptyScopeStack(op: string): void {\n    if (this.scopeStack.length > 0) {\n      throw new Error(`Can't ${op} while a OriginalScope is unclosed.`);\n    }\n  }\n\n  #verifyEmptyRangeStack(op: string): void {\n    if (this.rangeStack.length > 0) {\n      throw new Error(`Can't ${op} while a GeneratedRange is unclosed.`);\n    }\n  }\n\n  #verifyScopePresent(op: string): void {\n    if (this.scopeStack.length === 0) {\n      throw new Error(`Can't ${op} while no OriginalScope is on the stack.`);\n    }\n  }\n\n  #verifyRangePresent(op: string): void {\n    if (this.rangeStack.length === 0) {\n      throw new Error(`Can't ${op} while no GeneratedRange is on the stack.`);\n    }\n  }\n\n  #verifyRangeValues(\n    range: { start: Position; values: Binding[] },\n    end: Position,\n  ): void {\n    for (const value of range.values) {\n      if (!Array.isArray(value)) {\n        continue;\n      }\n\n      const subRanges = value;\n      if (subRanges.length === 0) {\n        continue;\n      }\n\n      const first = subRanges.at(0)!;\n      if (comparePositions(first.from, range.start) !== 0) {\n        throw new Error(\n          `Sub-range bindings must start at the generated range's start. Expected ${range.start.line}:${range.start.column}, but got ${first.from.line}:${first.from.column}`,\n        );\n      }\n\n      const last = subRanges.at(-1)!;\n      if (comparePositions(last.to, end) !== 0) {\n        throw new Error(\n          `Sub-range bindings must end at the generated range's end. Expected ${end.line}:${end.column}, but got ${last.to.line}:${last.to.column}`,\n        );\n      }\n\n      for (let i = 0; i < subRanges.length; ++i) {\n        const current = subRanges[i];\n        if (comparePositions(current.from, current.to) >= 0) {\n          throw new Error(\n            `Sub-range binding 'from' (${current.from.line}:${current.from.column}) must precede 'to' (${current.to.line}:${current.to.column})`,\n          );\n        }\n\n        if (i > 0) {\n          const prev = subRanges[i - 1];\n          if (comparePositions(prev.to, current.from) !== 0) {\n            throw new Error(\n              `Sub-range bindings must be sorted and not overlap. Found gap between ${prev.to.line}:${prev.to.column} and ${current.from.line}:${current.from.column}`,\n            );\n          }\n        }\n      }\n    }\n  }\n}\n"]}