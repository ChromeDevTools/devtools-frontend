{"version":3,"file":"AiCodeCompletionProvider.js","sourceRoot":"","sources":["../../../../../../../front_end/ui/components/text_editor/AiCodeCompletionProvider.ts"],"names":[],"mappings":"AAAA,sCAAsC;AACtC,yEAAyE;AACzE,6BAA6B;AAE7B,OAAO,KAAK,MAAM,MAAM,gCAAgC,CAAC;AACzD,OAAO,KAAK,IAAI,MAAM,4BAA4B,CAAC;AACnD,OAAO,KAAK,IAAI,MAAM,4BAA4B,CAAC;AACnD,OAAO,KAAK,gBAAgB,MAAM,0DAA0D,CAAC;AAC7F,OAAO,KAAK,WAAW,MAAM,kCAAkC,CAAC;AAChE,OAAO,KAAK,UAAU,MAAM,yDAAyD,CAAC;AACtF,OAAO,KAAK,EAAE,MAAM,wBAAwB,CAAC;AAC7C,OAAO,KAAK,aAAa,MAAM,wCAAwC,CAAC;AAExE,OAAO,EAAC,iCAAiC,EAAC,MAAM,wCAAwC,CAAC;AACzF,OAAO,EACL,8BAA8B,EAC9B,wBAAwB,EACxB,6BAA6B,EAC7B,qBAAqB,EACrB,2BAA2B,EAC3B,kBAAkB,GACnB,MAAM,aAAa,CAAC;AAGrB,MAAM,CAAN,IAAY,0BAIX;AAJD,WAAY,0BAA0B;IACpC,yCAAW,CAAA;IACX,uCAAS,CAAA;IACT,oEAAsC,CAAA;AACxC,CAAC,EAJW,0BAA0B,KAA1B,0BAA0B,QAIrC;AAED,MAAM,CAAC,MAAM,6BAA6B,GAAG,UAAU,CAAC,WAAW,CAAC,MAAM,EAA8B,CAAC;AAEzG,MAAM,CAAC,MAAM,+BAA+B,GAAG,UAAU,CAAC,UAAU,CAAC,MAAM,CAA6B;IACtG,MAAM,EAAE,GAAG,EAAE,CAAC,0BAA0B,CAAC,GAAG;IAC5C,MAAM,CAAC,KAAK,EAAE,EAAE;QACd,OAAO,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,EAAE,CAAC,6BAA6B,CAAC,CAAC,EAAE,KAAK,IAAI,KAAK,CAAC;IAC7F,CAAC;CACF,CAAC,CAAC;AAkBH,MAAM,CAAC,MAAM,gCAAgC,GAAG,GAAG,CAAC;AACpD,MAAM,CAAC,MAAM,gCAAgC,GAAG,GAAG,CAAC;AACpD,MAAM,wBAAwB,GAAG,MAAM,CAAC;AAExC,MAAM,OAAO,wBAAwB;IACnC,WAAW,CAA8B;IACzC,iBAAiB,CAAsD;IACvE,wBAAwB,GAAG,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC,aAAa,CAAC,4BAA4B,EAAE,KAAK,CAAC,CAAC;IAClH,uCAAuC,GACnC,MAAM,CAAC,QAAQ,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC,aAAa,CAAC,qCAAqC,EAAE,KAAK,CAAC,CAAC;IACpG,kBAAkB,GAAG,IAAI,UAAU,CAAC,WAAW,EAAE,CAAC;IAClD,OAAO,CAAsC;IAC7C,2BAA2B,CAAU;IACrC,OAAO,CAAc;IACrB,uBAAuB,CAA0B;IAEjD,mCAAmC,GAAG,IAAI,CAAC,4BAA4B,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;IAEnF,YAAY,sBAA8C;QACxD,MAAM,cAAc,GAAG,IAAI,CAAC,cAAc,CAAC,cAAc,CAAC,QAAQ,EAAE,CAAC;QACrE,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,yBAAyB,CAAC,cAAc,CAAC,MAAM,CAAC,EAAE,CAAC;YACzG,MAAM,IAAI,KAAK,CAAC,4CAA4C,CAAC,CAAC;QAChE,CAAC;QACD,IAAI,CAAC,uBAAuB,GAAG,sBAAsB,CAAC;IACxD,CAAC;IAED,SAAS;QACP,OAAO;YACL,UAAU,CAAC,UAAU,CAAC,cAAc,CAAC,EAAE,CAAC,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC,wBAAwB,CAAC,MAAM,CAAC,CAAC;YACxF,IAAI,CAAC,kBAAkB,CAAC,EAAE,CAAC,EAAE,CAAC;YAC9B,wBAAwB;YACxB,+BAA+B;YAC/B,6BAA6B;YAC7B,UAAU,CAAC,IAAI,CAAC,OAAO,CAAC,UAAU,CAAC,MAAM,CAAC,EAAE,CAAC,IAAI,CAAC,aAAa,EAAE,CAAC,CAAC;SACpE,CAAC;IACJ,CAAC;IAED,OAAO;QACL,IAAI,CAAC,aAAa,EAAE,CAAC;QACrB,IAAI,CAAC,OAAO,GAAG,SAAS,CAAC;QACzB,IAAI,CAAC,wBAAwB,CAAC,oBAAoB,CAAC,IAAI,CAAC,mCAAmC,CAAC,CAAC;QAC7F,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,QAAQ,EAAE,CAAC,mBAAmB,mFACV,IAAI,CAAC,mCAAmC,CAAC,CAAC;QAChG,IAAI,CAAC,wBAAwB,EAAE,CAAC;IAClC,CAAC;IAED,iBAAiB,CAAC,MAAkB;QAClC,IAAI,CAAC,OAAO,GAAG,MAAM,CAAC;QACtB,IAAI,CAAC,IAAI,CAAC,wBAAwB,CAAC,GAAG,EAAE,IAAI,CAAC,IAAI,CAAC,uCAAuC,CAAC,GAAG,EAAE,EAAE,CAAC;YAChG,IAAI,CAAC,OAAO,GAAG,IAAI,WAAW,CAAC,sBAAsB,CAAC;gBACpD,QAAQ,EAAE,GAAG,EAAE,CAAC,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,IAAI,CAAC;aAC9C,CAAC,CAAC;YACH,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,QAAQ,CACxB,EAAC,OAAO,EAAE,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,CAAC,+BAA+B,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,EAAC,CAAC,CAAC;QACvG,CAAC;QACD,IAAI,CAAC,UAAU,CAAC,iBAAiB,CAAC,QAAQ,EAAE,CAAC,gBAAgB,mFACP,IAAI,CAAC,mCAAmC,CAAC,CAAC;QAChG,IAAI,CAAC,wBAAwB,CAAC,iBAAiB,CAAC,IAAI,CAAC,mCAAmC,CAAC,CAAC;QAC1F,KAAK,IAAI,CAAC,4BAA4B,EAAE,CAAC;IAC3C,CAAC;IAED,UAAU;QACR,IAAI,CAAC,iBAAiB,EAAE,kBAAkB,EAAE,CAAC;IAC/C,CAAC;IAED,sBAAsB;QACpB,IAAI,CAAC,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,CAAC,uBAAuB,EAAE,CAAC;YACnD,OAAO;QACT,CAAC;QACD,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE,CAAC;YACtB,IAAI,CAAC,WAAW,GAAG,IAAI,IAAI,CAAC,UAAU,CAAC,UAAU,EAAE,CAAC;QACtD,CAAC;QACD,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAC5B,IAAI,CAAC,iBAAiB,GAAG,IAAI,gBAAgB,CAAC,gBAAgB,CAAC,gBAAgB,CAC3E,EAAC,UAAU,EAAE,IAAI,CAAC,WAAW,EAAC,EAAE,IAAI,CAAC,uBAAuB,CAAC,KAAK,EAAE,SAAS,EAC7E,IAAI,CAAC,uBAAuB,CAAC,iBAAiB,CAAC,aAAa,CAAC,CAAC;QACpE,CAAC;QACD,IAAI,CAAC,uBAAuB,CAAC,gBAAgB,EAAE,CAAC;IAClD,CAAC;IAED,wBAAwB;QACtB,IAAI,IAAI,CAAC,2BAA2B,EAAE,CAAC;YACrC,YAAY,CAAC,IAAI,CAAC,2BAA2B,CAAC,CAAC;YAC/C,IAAI,CAAC,2BAA2B,GAAG,SAAS,CAAC;QAC/C,CAAC;QACD,IAAI,CAAC,OAAO,EAAE,QAAQ,CAAC;YACrB,OAAO,EAAE,2BAA2B,CAAC,EAAE,CAAC,IAAI,CAAC;SAC9C,CAAC,CAAC;QACH,IAAI,CAAC,iBAAiB,GAAG,SAAS,CAAC;QACnC,IAAI,CAAC,uBAAuB,EAAE,iBAAiB,EAAE,CAAC;IACpD,CAAC;IAED,KAAK,CAAC,4BAA4B;QAChC,MAAM,gBAAgB,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,UAAU,CAAC,wBAAwB,EAAE,CAAC;QACrF,MAAM,WAAW,GAAG,gBAAgB,wEAAsD,CAAC;QAC3F,MAAM,SAAS,GAAG,IAAI,CAAC,wBAAwB,CAAC,GAAG,EAAE,CAAC;QACtD,IAAI,WAAW,IAAI,SAAS,EAAE,CAAC;YAC7B,IAAI,CAAC,aAAa,EAAE,CAAC;YACrB,IAAI,CAAC,sBAAsB,EAAE,CAAC;QAChC,CAAC;aAAM,IAAI,WAAW,IAAI,CAAC,SAAS,EAAE,CAAC;YACrC,IAAI,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,CAAC,uCAAuC,CAAC,GAAG,EAAE,EAAE,CAAC;gBACxE,IAAI,CAAC,OAAO,EAAE,MAAM,CAAC,QAAQ,CACzB,EAAC,OAAO,EAAE,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,CAAC,+BAA+B,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC,CAAC,EAAC,CAAC,CAAC;YACvG,CAAC;YACD,IAAI,CAAC,wBAAwB,EAAE,CAAC;QAClC,CAAC;aAAM,IAAI,CAAC,WAAW,EAAE,CAAC;YACxB,IAAI,CAAC,aAAa,EAAE,CAAC;YACrB,IAAI,CAAC,wBAAwB,EAAE,CAAC;QAClC,CAAC;IACH,CAAC;IAED,aAAa;QACX,OAAO;YACL;gBACE,GAAG,EAAE,QAAQ;gBACb,GAAG,EAAE,GAAY,EAAE;oBACjB,IAAI,CAAC,IAAI,CAAC,iBAAiB,IAAI,CAAC,IAAI,CAAC,OAAO,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC;wBAC3F,OAAO,KAAK,CAAC;oBACf,CAAC;oBACD,IAAI,CAAC,OAAO,CAAC,QAAQ,CAAC;wBACpB,OAAO,EAAE,2BAA2B,CAAC,EAAE,CAAC,IAAI,CAAC;qBAC9C,CAAC,CAAC;oBACH,OAAO,IAAI,CAAC;gBACd,CAAC;aACF;YACD;gBACE,GAAG,EAAE,KAAK;gBACV,GAAG,EAAE,GAAY,EAAE;oBACjB,IAAI,CAAC,IAAI,CAAC,iBAAiB,IAAI,CAAC,IAAI,CAAC,OAAO,IAAI,CAAC,qBAAqB,CAAC,IAAI,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE,CAAC;wBAC3F,OAAO,KAAK,CAAC;oBACf,CAAC;oBACD,MAAM,EAAC,QAAQ,EAAE,UAAU,EAAC,GAAG,8BAA8B,CAAC,IAAI,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;oBACnF,IAAI,CAAC,QAAQ,EAAE,CAAC;wBACd,OAAO,KAAK,CAAC;oBACf,CAAC;oBACD,IAAI,UAAU,EAAE,WAAW,EAAE,CAAC;wBAC5B,IAAI,CAAC,iBAAiB,EAAE,sBAAsB,CAAC,UAAU,CAAC,WAAW,EAAE,UAAU,CAAC,QAAQ,CAAC,CAAC;oBAC9F,CAAC;oBACD,IAAI,CAAC,uBAAuB,EAAE,oBAAoB,EAAE,CAAC;oBACrD,OAAO,IAAI,CAAC;gBACd,CAAC;aACF;SACF,CAAC;IACJ,CAAC;IAED,aAAa;QACX,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;YAClB,OAAO;QACT,CAAC;QACD,IAAI,CAAC,OAAO,EAAE,MAAM,CAAC,QAAQ,CAAC,EAAC,OAAO,EAAE,IAAI,CAAC,kBAAkB,CAAC,WAAW,CAAC,EAAE,CAAC,EAAC,CAAC,CAAC;IACpF,CAAC;IAED,wBAAwB,CAAC,MAA6B;QACpD,IAAI,CAAC,MAAM,CAAC,UAAU,IAAI,CAAC,IAAI,CAAC,OAAO,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE,CAAC;YACnE,OAAO;QACT,CAAC;QACD,MAAM,EAAC,GAAG,EAAE,SAAS,EAAC,GAAG,MAAM,CAAC,KAAK,CAAC;QACtC,MAAM,KAAK,GAAG,GAAG,CAAC,QAAQ,EAAE,CAAC;QAC7B,MAAM,MAAM,GAAG,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC;QAEnC,IAAI,MAAM,GAAG,KAAK,CAAC,SAAS,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;QACxC,IAAI,MAAM,CAAC,IAAI,EAAE,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAC/B,OAAO;QACT,CAAC;QACD,MAAM,uBAAuB,GAAG,IAAI,CAAC,uBAAuB,EAAE,iBAAiB,CAAC,SAAS,EAAE,EAAE,CAAC;QAC9F,IAAI,uBAAuB,EAAE,CAAC;YAC5B,MAAM,GAAG,uBAAuB,GAAG,MAAM,CAAC;QAC5C,CAAC;QACD,IAAI,MAAM,CAAC,MAAM,GAAG,wBAAwB,EAAE,CAAC;YAC7C,MAAM,GAAG,MAAM,CAAC,SAAS,CAAC,MAAM,CAAC,MAAM,GAAG,wBAAwB,CAAC,CAAC;QACtE,CAAC;QAED,MAAM,MAAM,GAAG,KAAK,CAAC,SAAS,CAAC,MAAM,EAAE,MAAM,GAAG,wBAAwB,CAAC,CAAC;QAE1E,IAAI,CAAC,+BAA+B,CAChC,MAAM,EAAE,MAAM,EAAE,MAAM,EAAE,IAAI,CAAC,uBAAuB,EAAE,iBAAiB,CAAC,iBAAiB,EACzF,IAAI,CAAC,uBAAuB,EAAE,iBAAiB,CAAC,eAAe,CAAC,CAAC;IACvE,CAAC;IAED,+BAA+B,GAAG,MAAM,CAAC,SAAS,CAAC,QAAQ,CACvD,CAAC,MAAc,EAAE,MAAc,EAAE,uBAA+B,EAC/D,iBAAyD,EACzD,eAAkD,EAAE,EAAE;QACrD,KAAK,IAAI,CAAC,sBAAsB,CAAC,MAAM,EAAE,MAAM,EAAE,uBAAuB,EAAE,iBAAiB,EAAE,eAAe,CAAC,CAAC;IAChH,CAAC,EACD,gCAAgC,CAAC,CAAC;IAEtC,KAAK,CAAC,sBAAsB,CACxB,MAAc,EAAE,MAAc,EAAE,uBAA+B,EAC/D,iBAAyD,EACzD,eAAkD;QACpD,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE,CAAC;YAC5B,gBAAgB,CAAC,QAAQ,CAAC,uCAAuC,CAAC,CAAC;YACnE,IAAI,CAAC,uBAAuB,EAAE,kBAAkB,CAAC,EAAE,CAAC,CAAC;YACrD,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,qBAAqB,CAAC,CAAC;YAC5E,OAAO;QACT,CAAC;QAED,MAAM,SAAS,GAAG,WAAW,CAAC,GAAG,EAAE,CAAC;QACpC,IAAI,CAAC,uBAAuB,EAAE,kBAAkB,EAAE,CAAC;QACnD,+FAA+F;QAC/F,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,gCAAgC,CAAC,CAAC;QAEvF,IAAI,CAAC;YACH,MAAM,kBAAkB,GAAG,MAAM,IAAI,CAAC,iBAAiB,CAAC,YAAY,CAChE,MAAM,EAAE,MAAM,EAAE,uBAAuB,EAAE,iBAAiB,EAAE,eAAe,CAAC,CAAC;YAEjF,IAAI,CAAC,kBAAkB,EAAE,CAAC;gBACxB,IAAI,CAAC,uBAAuB,EAAE,kBAAkB,CAAC,EAAE,CAAC,CAAC;gBACrD,OAAO;YACT,CAAC;YAED,MAAM,EAAC,QAAQ,EAAE,SAAS,EAAC,GAAG,kBAAkB,CAAC;YAEjD,IAAI,CAAC,QAAQ,EAAE,CAAC;gBACd,IAAI,CAAC,uBAAuB,EAAE,kBAAkB,CAAC,EAAE,CAAC,CAAC;gBACrD,OAAO;YACT,CAAC;YAED,MAAM,cAAc,GAAG,MAAM,IAAI,CAAC,yBAAyB,CAAC,QAAQ,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;YACtF,IAAI,CAAC,cAAc,EAAE,CAAC;gBACpB,IAAI,CAAC,uBAAuB,EAAE,kBAAkB,CAAC,EAAE,CAAC,CAAC;gBACrD,OAAO;YACT,CAAC;YAED,MAAM,EACJ,cAAc,EACd,QAAQ,EACR,SAAS,EACT,WAAW,GACZ,GAAG,cAAc,CAAC;YACnB,MAAM,cAAc,GAAG,IAAI,CAAC,GAAG,CAC3B,gBAAgB,CAAC,gBAAgB,CAAC,gCAAgC,GAAG,CAAC,WAAW,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC,EAAE,CAAC,CAAC,CAAC;YAC7G,IAAI,CAAC,2BAA2B,GAAG,MAAM,CAAC,UAAU,CAAC,GAAG,EAAE;gBACxD,MAAM,qBAAqB,GAAG,IAAI,CAAC,OAAO,EAAE,MAAM,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC;gBAC7E,IAAI,qBAAqB,KAAK,uBAAuB,EAAE,CAAC;oBACtD,IAAI,CAAC,uBAAuB,EAAE,kBAAkB,CAAC,EAAE,CAAC,CAAC;oBACrD,OAAO;gBACT,CAAC;gBACD,IAAI,IAAI,CAAC,iBAAiB,EAAE,CAAC;oBAC3B,IAAI,CAAC,OAAO,EAAE,QAAQ,CAAC;wBACrB,OAAO,EAAE,2BAA2B,CAAC,EAAE,CAAC;4BACtC,IAAI,EAAE,cAAc;4BACpB,IAAI,EAAE,uBAAuB;4BAC7B,WAAW;4BACX,QAAQ;4BACR,SAAS;4BACT,kBAAkB,EAAE,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC;4BAC9C,YAAY,EAAE,IAAI,CAAC,iBAAiB,EAAE,sBAAsB,CAAC,IAAI,CAAC,IAAI,CAAC,iBAAiB,CAAC;yBAC1F,CAAC;qBACH,CAAC,CAAC;gBACL,CAAC;gBACD,IAAI,SAAS,EAAE,CAAC;oBACd,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,uCAAuC,CAAC,CAAC;gBAChG,CAAC;gBAED,gBAAgB,CAAC,QAAQ,CACrB,qCAAqC,EAAE,cAAc,EAAE,oBAAoB,EAAE,uBAAuB,CAAC,CAAC;gBAC1G,IAAI,CAAC,uBAAuB,EAAE,kBAAkB,CAAC,SAAS,CAAC,CAAC;YAC9D,CAAC,EAAE,cAAc,CAAC,CAAC;QACrB,CAAC;QAAC,OAAO,CAAC,EAAE,CAAC;YACX,gBAAgB,CAAC,QAAQ,CAAC,4DAA4D,EAAE,CAAC,CAAC,CAAC;YAC3F,IAAI,CAAC,uBAAuB,EAAE,kBAAkB,CAAC,EAAE,CAAC,CAAC;YACrD,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,qBAAqB,CAAC,CAAC;QAC9E,CAAC;IACH,CAAC;IAED,KAAK,CAAC,yBAAyB,CAAC,QAA4C,EAAE,MAAc,EAAE,MAAe;QAO3G,MAAM,gBAAgB,GAAG,IAAI,CAAC,uBAAuB,CAAC,QAAQ,CAAC,CAAC;QAChE,IAAI,CAAC,gBAAgB,EAAE,CAAC;YACtB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,WAAW,GACb,gBAAgB,CAAC,mBAAmB,EAAE,iBAAiB,KAAK,IAAI,CAAC,UAAU,CAAC,gBAAgB,CAAC,KAAK,CAAC;QACvG,IAAI,WAAW,EAAE,CAAC;YAChB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,YAAY,GAAG,IAAI,CAAC,qCAAqC,CAAC,gBAAgB,CAAC,gBAAgB,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;QACnH,IAAI,YAAY,EAAE,CAAC;YACjB,OAAO,IAAI,CAAC;QACd,CAAC;QAED,MAAM,cAAc,GAAG,IAAI,CAAC,sBAAsB,CAAC,gBAAgB,CAAC,gBAAgB,EAAE,MAAM,CAAC,CAAC;QAC9F,IAAI,cAAc,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAChC,OAAO,IAAI,CAAC;QACd,CAAC;QAED,OAAO;YACL,cAAc;YACd,QAAQ,EAAE,gBAAgB,CAAC,QAAQ;YACnC,SAAS,EAAE,gBAAgB,CAAC,mBAAmB,EAAE,SAAS,IAAI,EAAE;YAChE,WAAW,EAAE,QAAQ,CAAC,QAAQ,CAAC,WAAW;SAC3C,CAAC;IACJ,CAAC;IAED,uBAAuB,CAAC,QAA4C;QAClE,IAAI,CAAC,QAAQ,CAAC,gBAAgB,CAAC,MAAM,EAAE,CAAC;YACtC,OAAO,IAAI,CAAC;QACd,CAAC;QAED,sGAAsG;QACtG,2GAA2G;QAC3G,kCAAkC;QAClC,MAAM,iBAAiB,GAAG,IAAI,CAAC,OAAO,EAAE,MAAM,CAAC,MAAM,CAAC,kBAAkB,CAAC,EAAE,WAAW,CAAC;QACvF,IAAI,CAAC,iBAAiB,EAAE,CAAC;YACvB,OAAO,QAAQ,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;QACtC,CAAC;QAED,oGAAoG;QACpG,8BAA8B;QAC9B,8FAA8F;QAC9F,oDAAoD;QACpD,OAAO,QAAQ,CAAC,gBAAgB,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,MAAM,CAAC,gBAAgB,CAAC,UAAU,CAAC,iBAAiB,CAAC,CAAC;YAClG,QAAQ,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;IACnC,CAAC;IAED,qCAAqC,CAAC,gBAAwB,EAAE,MAAc,EAAE,MAAe;QAC7F,OAAO,OAAO,CAAC,MAAM,CAAC,QAAQ,CAAC,gBAAgB,CAAC,IAAI,EAAE,CAAC,IAAI,MAAM,EAAE,QAAQ,CAAC,gBAAgB,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;IACxG,CAAC;IAED;;OAEG;IACH,sBAAsB,CAAC,gBAAwB,EAAE,MAAe;QAC9D,IAAI,CAAC,MAAM,EAAE,CAAC;YACZ,OAAO,gBAAgB,CAAC;QAC1B,CAAC;QAED,iEAAiE;QACjE,KAAK,IAAI,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,MAAM,EAAE,MAAM,CAAC,MAAM,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;YAC1E,MAAM,gBAAgB,GAAG,MAAM,CAAC,SAAS,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC;YAChD,IAAI,gBAAgB,CAAC,QAAQ,CAAC,gBAAgB,CAAC,EAAE,CAAC;gBAChD,OAAO,gBAAgB,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,CAAC;YACvC,CAAC;QACH,CAAC;QACD,OAAO,gBAAgB,CAAC;IAC1B,CAAC;CACF;AAED,SAAS,+BAA+B,CAAC,MAA0C;IACjF,OAAO,UAAU,CAAC,UAAU,CAAC,SAAS,CAAC;QAMhB;QALrB,MAAM,CAAqC;QAC3C,iBAAiB,GAA6B,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC;QACzE,WAAW,CAA6B;QACxC,qBAAqB,CAAU;QAE/B,YAAqB,IAA2B;YAA3B,SAAI,GAAJ,IAAI,CAAuB;YAC9C,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;YACrB,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,+BAA+B,CAAC,CAAC;YACrE,IAAI,CAAC,gBAAgB,EAAE,CAAC;QAC1B,CAAC;QAED,OAAO;YACL,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;QAClD,CAAC;QAED,MAAM,CAAC,MAA6B;YAClC,MAAM,iBAAiB,GAAG,MAAM,CAAC,KAAK,CAAC,KAAK,CAAC,+BAA+B,CAAC,CAAC;YAC9E,IAAI,iBAAiB,KAAK,IAAI,CAAC,WAAW,EAAE,CAAC;gBAC3C,IAAI,CAAC,WAAW,GAAG,iBAAiB,CAAC;gBACrC,IAAI,CAAC,gBAAgB,EAAE,CAAC;gBACxB,OAAO;YACT,CAAC;YACD,IAAI,IAAI,CAAC,WAAW,KAAK,0BAA0B,CAAC,kBAAkB,IAAI,MAAM,CAAC,UAAU,EAAE,CAAC;gBAC5F,IAAI,CAAC,6CAA6C,EAAE,CAAC;YACvD,CAAC;iBAAM,IAAI,IAAI,CAAC,WAAW,KAAK,0BAA0B,CAAC,EAAE,EAAE,CAAC;gBAC9D,IAAI,MAAM,CAAC,UAAU,EAAE,CAAC;oBACtB,IAAI,CAAC,iBAAiB,GAAG,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC;oBACpD,MAAM,CAAC,YAAY,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;oBAChD,IAAI,CAAC,gCAAgC,EAAE,CAAC;gBAC1C,CAAC;qBAAM,IAAI,MAAM,CAAC,YAAY,IAAI,MAAM,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;oBAC9D,IAAI,CAAC,iBAAiB,GAAG,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC;gBACtD,CAAC;YACH,CAAC;QACH,CAAC;QAED,IAAI,WAAW;YACb,OAAO,IAAI,CAAC,iBAAiB,CAAC;QAChC,CAAC;QAED,gBAAgB;YACd,QAAQ,IAAI,CAAC,WAAW,EAAE,CAAC;gBACzB,KAAK,0BAA0B,CAAC,EAAE;oBAChC,IAAI,CAAC,2CAA2C,EAAE,CAAC;oBACnD,OAAO;gBACT,KAAK,0BAA0B,CAAC,kBAAkB;oBAChD,IAAI,CAAC,6CAA6C,EAAE,CAAC;oBACrD,OAAO;gBACT,KAAK,0BAA0B,CAAC,GAAG;oBACjC,IAAI,CAAC,iBAAiB,GAAG,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC;oBACpD,OAAO;YACX,CAAC;QACH,CAAC;QAED,6CAA6C;YAC3C,IAAI,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;gBACrC,IAAI,CAAC,gBAAgB,CAAC,CAAC,CAAC,CAAC;YAC3B,CAAC;iBAAM,CAAC;gBACN,IAAI,CAAC,iBAAiB,GAAG,UAAU,CAAC,UAAU,CAAC,IAAI,CAAC;YACtD,CAAC;QACH,CAAC;QAED,gCAAgC,GAAG,MAAM,CAAC,SAAS,CAAC,QAAQ,CAAC,GAAG,EAAE;YAChE,IAAI,CAAC,qBAAqB,GAAG,MAAM,CAAC,UAAU,CAAC,GAAG,EAAE;gBAClD,IAAI,CAAC,2CAA2C,EAAE,CAAC;gBACnD,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;YACzB,CAAC,EAAE,gCAAgC,CAAC,CAAC;QACvC,CAAC,EAAE,gCAAgC,CAAC,CAAC;QAErC,2CAA2C;YACzC,MAAM,cAAc,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,SAAS,CAAC,IAAI,CAAC,IAAI,CAAC;YAC3D,MAAM,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,MAAM,CAAC,cAAc,CAAC,CAAC;YACxD,IAAI,cAAc,IAAI,IAAI,CAAC,EAAE,EAAE,CAAC;gBAC9B,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,CAAC;YACxC,CAAC;QACH,CAAC;QAED,gBAAgB,CAAC,GAAW;YAC1B,IAAI,CAAC,iBAAiB,GAAG,UAAU,CAAC,UAAU,CAAC,GAAG,CAAC;gBACjD,UAAU,CAAC,UAAU,CAAC,MAAM,CAAC,EAAC,MAAM,EAAE,IAAI,iCAAiC,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE,IAAI,EAAE,CAAC,EAAC,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC;aAC/G,CAAC,CAAC;QACL,CAAC;KACF,EAAE;QACD,WAAW,EAAE,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,WAAW;QAC/B,aAAa,EAAE;YACb,SAAS,CAAC,KAAiB;gBACzB,kFAAkF;gBAClF,OAAO,CAAC,KAAK,CAAC,MAAM,YAAY,IAAI,IAAI,MAAM,CAAC,cAAc,CAAC,QAAQ,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC;YACxF,CAAC;YACD,OAAO,CAAC,KAAoB;gBAC1B,IAAI,CAAC,EAAE,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,yBAAyB,CAAC,KAAK,CAAC,IAAI,CAAC,MAAM,CAAC,SAAS,EAAE,EAAE,CAAC;oBAClG,OAAO,KAAK,CAAC;gBACf,CAAC;gBACD,IAAI,KAAK,CAAC,GAAG,KAAK,GAAG,EAAE,CAAC;oBACtB,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;oBACpB,KAAK,aAAa,CAAC,UAAU,CAAC,KAAK,CAAC,aAAa,EAAE,KAAK,EAAE,+BAA+B,CAAC,CAAC;oBAC3F,KAAK,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,KAAK,CAAC,CAAC;oBACjC,OAAO,IAAI,CAAC;gBACd,CAAC;gBACD,IAAI,KAAK,CAAC,GAAG,KAAK,GAAG,EAAE,CAAC;oBACtB,KAAK,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC;oBACpB,KAAK,aAAa,CAAC,UAAU,CAAC,KAAK,CAAC,aAAa,EAAE,KAAK,EAAE,mCAAmC,CAAC,CAAC;oBAC/F,IAAI,CAAC,MAAM,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;oBAC7B,OAAO,IAAI,CAAC;gBACd,CAAC;gBACD,OAAO,KAAK,CAAC;YACf,CAAC;SACF;KACF,CAAC,CAAC;AACL,CAAC","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as Host from '../../../core/host/host.js';\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport * as AiCodeCompletion from '../../../models/ai_code_completion/ai_code_completion.js';\nimport * as PanelCommon from '../../../panels/common/common.js';\nimport * as CodeMirror from '../../../third_party/codemirror.next/codemirror.next.js';\nimport * as UI from '../../legacy/legacy.js';\nimport * as VisualLogging from '../../visual_logging/visual_logging.js';\n\nimport {AiCodeCompletionTeaserPlaceholder} from './AiCodeCompletionTeaserPlaceholder.js';\nimport {\n  acceptAiAutoCompleteSuggestion,\n  aiAutoCompleteSuggestion,\n  aiAutoCompleteSuggestionState,\n  hasActiveAiSuggestion,\n  setAiAutoCompleteSuggestion,\n  showCompletionHint,\n} from './config.js';\nimport type {TextEditor} from './TextEditor.js';\n\nexport enum AiCodeCompletionTeaserMode {\n  OFF = 'off',\n  ON = 'on',\n  ONLY_SHOW_ON_EMPTY = 'onlyShowOnEmpty',\n}\n\nexport const setAiCodeCompletionTeaserMode = CodeMirror.StateEffect.define<AiCodeCompletionTeaserMode>();\n\nexport const aiCodeCompletionTeaserModeState = CodeMirror.StateField.define<AiCodeCompletionTeaserMode>({\n  create: () => AiCodeCompletionTeaserMode.OFF,\n  update(value, tr) {\n    return tr.effects.find(effect => effect.is(setAiCodeCompletionTeaserMode))?.value ?? value;\n  },\n});\n\nexport interface AiCodeCompletionConfig {\n  completionContext: {\n    additionalFiles?: Host.AidaClient.AdditionalFile[],\n    inferenceLanguage?: Host.AidaClient.AidaInferenceLanguage,\n    getPrefix?: () => string,\n    stopSequences?: string[],\n  };\n  onFeatureEnabled: () => void;\n  onFeatureDisabled: () => void;\n  onSuggestionAccepted: () => void;\n  onRequestTriggered: () => void;\n  // TODO(b/445394511): Move exposing citations to onSuggestionAccepted\n  onResponseReceived: (citations: Host.AidaClient.Citation[]) => void;\n  panel: AiCodeCompletion.AiCodeCompletion.ContextFlavor;\n}\n\nexport const DELAY_BEFORE_SHOWING_RESPONSE_MS = 500;\nexport const AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS = 200;\nconst MAX_PREFIX_SUFFIX_LENGTH = 20_000;\n\nexport class AiCodeCompletionProvider {\n  #aidaClient?: Host.AidaClient.AidaClient;\n  #aiCodeCompletion?: AiCodeCompletion.AiCodeCompletion.AiCodeCompletion;\n  #aiCodeCompletionSetting = Common.Settings.Settings.instance().createSetting('ai-code-completion-enabled', false);\n  #aiCodeCompletionTeaserDismissedSetting =\n      Common.Settings.Settings.instance().createSetting('ai-code-completion-teaser-dismissed', false);\n  #teaserCompartment = new CodeMirror.Compartment();\n  #teaser?: PanelCommon.AiCodeCompletionTeaser;\n  #suggestionRenderingTimeout?: number;\n  #editor?: TextEditor;\n  #aiCodeCompletionConfig?: AiCodeCompletionConfig;\n\n  #boundOnUpdateAiCodeCompletionState = this.#updateAiCodeCompletionState.bind(this);\n\n  constructor(aiCodeCompletionConfig: AiCodeCompletionConfig) {\n    const devtoolsLocale = i18n.DevToolsLocale.DevToolsLocale.instance();\n    if (!AiCodeCompletion.AiCodeCompletion.AiCodeCompletion.isAiCodeCompletionEnabled(devtoolsLocale.locale)) {\n      throw new Error('AI code completion feature is not enabled.');\n    }\n    this.#aiCodeCompletionConfig = aiCodeCompletionConfig;\n  }\n\n  extension(): CodeMirror.Extension[] {\n    return [\n      CodeMirror.EditorView.updateListener.of(update => this.#triggerAiCodeCompletion(update)),\n      this.#teaserCompartment.of([]),\n      aiAutoCompleteSuggestion,\n      aiCodeCompletionTeaserModeState,\n      aiAutoCompleteSuggestionState,\n      CodeMirror.Prec.highest(CodeMirror.keymap.of(this.#editorKeymap())),\n    ];\n  }\n\n  dispose(): void {\n    this.#detachTeaser();\n    this.#teaser = undefined;\n    this.#aiCodeCompletionSetting.removeChangeListener(this.#boundOnUpdateAiCodeCompletionState);\n    Host.AidaClient.HostConfigTracker.instance().removeEventListener(\n        Host.AidaClient.Events.AIDA_AVAILABILITY_CHANGED, this.#boundOnUpdateAiCodeCompletionState);\n    this.#cleanupAiCodeCompletion();\n  }\n\n  editorInitialized(editor: TextEditor): void {\n    this.#editor = editor;\n    if (!this.#aiCodeCompletionSetting.get() && !this.#aiCodeCompletionTeaserDismissedSetting.get()) {\n      this.#teaser = new PanelCommon.AiCodeCompletionTeaser({\n        onDetach: () => this.#detachTeaser.bind(this),\n      });\n      this.#editor.editor.dispatch(\n          {effects: this.#teaserCompartment.reconfigure([aiCodeCompletionTeaserExtension(this.#teaser)])});\n    }\n    Host.AidaClient.HostConfigTracker.instance().addEventListener(\n        Host.AidaClient.Events.AIDA_AVAILABILITY_CHANGED, this.#boundOnUpdateAiCodeCompletionState);\n    this.#aiCodeCompletionSetting.addChangeListener(this.#boundOnUpdateAiCodeCompletionState);\n    void this.#updateAiCodeCompletionState();\n  }\n\n  clearCache(): void {\n    this.#aiCodeCompletion?.clearCachedRequest();\n  }\n\n  #setupAiCodeCompletion(): void {\n    if (!this.#editor || !this.#aiCodeCompletionConfig) {\n      return;\n    }\n    if (!this.#aidaClient) {\n      this.#aidaClient = new Host.AidaClient.AidaClient();\n    }\n    if (!this.#aiCodeCompletion) {\n      this.#aiCodeCompletion = new AiCodeCompletion.AiCodeCompletion.AiCodeCompletion(\n          {aidaClient: this.#aidaClient}, this.#aiCodeCompletionConfig.panel, undefined,\n          this.#aiCodeCompletionConfig.completionContext.stopSequences);\n    }\n    this.#aiCodeCompletionConfig.onFeatureEnabled();\n  }\n\n  #cleanupAiCodeCompletion(): void {\n    if (this.#suggestionRenderingTimeout) {\n      clearTimeout(this.#suggestionRenderingTimeout);\n      this.#suggestionRenderingTimeout = undefined;\n    }\n    this.#editor?.dispatch({\n      effects: setAiAutoCompleteSuggestion.of(null),\n    });\n    this.#aiCodeCompletion = undefined;\n    this.#aiCodeCompletionConfig?.onFeatureDisabled();\n  }\n\n  async #updateAiCodeCompletionState(): Promise<void> {\n    const aidaAvailability = await Host.AidaClient.AidaClient.checkAccessPreconditions();\n    const isAvailable = aidaAvailability === Host.AidaClient.AidaAccessPreconditions.AVAILABLE;\n    const isEnabled = this.#aiCodeCompletionSetting.get();\n    if (isAvailable && isEnabled) {\n      this.#detachTeaser();\n      this.#setupAiCodeCompletion();\n    } else if (isAvailable && !isEnabled) {\n      if (this.#teaser && !this.#aiCodeCompletionTeaserDismissedSetting.get()) {\n        this.#editor?.editor.dispatch(\n            {effects: this.#teaserCompartment.reconfigure([aiCodeCompletionTeaserExtension(this.#teaser)])});\n      }\n      this.#cleanupAiCodeCompletion();\n    } else if (!isAvailable) {\n      this.#detachTeaser();\n      this.#cleanupAiCodeCompletion();\n    }\n  }\n\n  #editorKeymap(): readonly CodeMirror.KeyBinding[] {\n    return [\n      {\n        key: 'Escape',\n        run: (): boolean => {\n          if (!this.#aiCodeCompletion || !this.#editor || !hasActiveAiSuggestion(this.#editor.state)) {\n            return false;\n          }\n          this.#editor.dispatch({\n            effects: setAiAutoCompleteSuggestion.of(null),\n          });\n          return true;\n        },\n      },\n      {\n        key: 'Tab',\n        run: (): boolean => {\n          if (!this.#aiCodeCompletion || !this.#editor || !hasActiveAiSuggestion(this.#editor.state)) {\n            return false;\n          }\n          const {accepted, suggestion} = acceptAiAutoCompleteSuggestion(this.#editor.editor);\n          if (!accepted) {\n            return false;\n          }\n          if (suggestion?.rpcGlobalId) {\n            this.#aiCodeCompletion?.registerUserAcceptance(suggestion.rpcGlobalId, suggestion.sampleId);\n          }\n          this.#aiCodeCompletionConfig?.onSuggestionAccepted();\n          return true;\n        },\n      },\n    ];\n  }\n\n  #detachTeaser(): void {\n    if (!this.#teaser) {\n      return;\n    }\n    this.#editor?.editor.dispatch({effects: this.#teaserCompartment.reconfigure([])});\n  }\n\n  #triggerAiCodeCompletion(update: CodeMirror.ViewUpdate): void {\n    if (!update.docChanged || !this.#editor || !this.#aiCodeCompletion) {\n      return;\n    }\n    const {doc, selection} = update.state;\n    const query = doc.toString();\n    const cursor = selection.main.head;\n\n    let prefix = query.substring(0, cursor);\n    if (prefix.trim().length === 0) {\n      return;\n    }\n    const completionContextPrefix = this.#aiCodeCompletionConfig?.completionContext.getPrefix?.();\n    if (completionContextPrefix) {\n      prefix = completionContextPrefix + prefix;\n    }\n    if (prefix.length > MAX_PREFIX_SUFFIX_LENGTH) {\n      prefix = prefix.substring(prefix.length - MAX_PREFIX_SUFFIX_LENGTH);\n    }\n\n    const suffix = query.substring(cursor, cursor + MAX_PREFIX_SUFFIX_LENGTH);\n\n    this.#debouncedRequestAidaSuggestion(\n        prefix, suffix, cursor, this.#aiCodeCompletionConfig?.completionContext.inferenceLanguage,\n        this.#aiCodeCompletionConfig?.completionContext.additionalFiles);\n  }\n\n  #debouncedRequestAidaSuggestion = Common.Debouncer.debounce(\n      (prefix: string, suffix: string, cursorPositionAtRequest: number,\n       inferenceLanguage?: Host.AidaClient.AidaInferenceLanguage,\n       additionalFiles?: Host.AidaClient.AdditionalFile[]) => {\n        void this.#requestAidaSuggestion(prefix, suffix, cursorPositionAtRequest, inferenceLanguage, additionalFiles);\n      },\n      AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS);\n\n  async #requestAidaSuggestion(\n      prefix: string, suffix: string, cursorPositionAtRequest: number,\n      inferenceLanguage?: Host.AidaClient.AidaInferenceLanguage,\n      additionalFiles?: Host.AidaClient.AdditionalFile[]): Promise<void> {\n    if (!this.#aiCodeCompletion) {\n      AiCodeCompletion.debugLog('Ai Code Completion is not initialized');\n      this.#aiCodeCompletionConfig?.onResponseReceived([]);\n      Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiCodeCompletionError);\n      return;\n    }\n\n    const startTime = performance.now();\n    this.#aiCodeCompletionConfig?.onRequestTriggered();\n    // Registering AiCodeCompletionRequestTriggered metric even if the request is served from cache\n    Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiCodeCompletionRequestTriggered);\n\n    try {\n      const completionResponse = await this.#aiCodeCompletion.completeCode(\n          prefix, suffix, cursorPositionAtRequest, inferenceLanguage, additionalFiles);\n\n      if (!completionResponse) {\n        this.#aiCodeCompletionConfig?.onResponseReceived([]);\n        return;\n      }\n\n      const {response, fromCache} = completionResponse;\n\n      if (!response) {\n        this.#aiCodeCompletionConfig?.onResponseReceived([]);\n        return;\n      }\n\n      const sampleResponse = await this.#generateSampleForRequest(response, prefix, suffix);\n      if (!sampleResponse) {\n        this.#aiCodeCompletionConfig?.onResponseReceived([]);\n        return;\n      }\n\n      const {\n        suggestionText,\n        sampleId,\n        citations,\n        rpcGlobalId,\n      } = sampleResponse;\n      const remainingDelay = Math.max(\n          AiCodeCompletion.AiCodeCompletion.DELAY_BEFORE_SHOWING_RESPONSE_MS - (performance.now() - startTime), 0);\n      this.#suggestionRenderingTimeout = window.setTimeout(() => {\n        const currentCursorPosition = this.#editor?.editor.state.selection.main.head;\n        if (currentCursorPosition !== cursorPositionAtRequest) {\n          this.#aiCodeCompletionConfig?.onResponseReceived([]);\n          return;\n        }\n        if (this.#aiCodeCompletion) {\n          this.#editor?.dispatch({\n            effects: setAiAutoCompleteSuggestion.of({\n              text: suggestionText,\n              from: cursorPositionAtRequest,\n              rpcGlobalId,\n              sampleId,\n              startTime,\n              clearCachedRequest: this.clearCache.bind(this),\n              onImpression: this.#aiCodeCompletion?.registerUserImpression.bind(this.#aiCodeCompletion),\n            })\n          });\n        }\n        if (fromCache) {\n          Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiCodeCompletionResponseServedFromCache);\n        }\n\n        AiCodeCompletion.debugLog(\n            'Suggestion dispatched to the editor', suggestionText, 'at cursor position', cursorPositionAtRequest);\n        this.#aiCodeCompletionConfig?.onResponseReceived(citations);\n      }, remainingDelay);\n    } catch (e) {\n      AiCodeCompletion.debugLog('Error while fetching code completion suggestions from AIDA', e);\n      this.#aiCodeCompletionConfig?.onResponseReceived([]);\n      Host.userMetrics.actionTaken(Host.UserMetrics.Action.AiCodeCompletionError);\n    }\n  }\n\n  async #generateSampleForRequest(response: Host.AidaClient.CompletionResponse, prefix: string, suffix?: string):\n      Promise<{\n        suggestionText: string,\n        citations: Host.AidaClient.Citation[],\n        rpcGlobalId?: Host.AidaClient.RpcGlobalId,\n        sampleId?: number,\n      }|null> {\n    const suggestionSample = this.#pickSampleFromResponse(response);\n    if (!suggestionSample) {\n      return null;\n    }\n\n    const shouldBlock =\n        suggestionSample.attributionMetadata?.attributionAction === Host.AidaClient.RecitationAction.BLOCK;\n    if (shouldBlock) {\n      return null;\n    }\n\n    const isRepetitive = this.#checkIfSuggestionRepeatsExistingText(suggestionSample.generationString, prefix, suffix);\n    if (isRepetitive) {\n      return null;\n    }\n\n    const suggestionText = this.#trimSuggestionOverlap(suggestionSample.generationString, suffix);\n    if (suggestionText.length === 0) {\n      return null;\n    }\n\n    return {\n      suggestionText,\n      sampleId: suggestionSample.sampleId,\n      citations: suggestionSample.attributionMetadata?.citations ?? [],\n      rpcGlobalId: response.metadata.rpcGlobalId,\n    };\n  }\n\n  #pickSampleFromResponse(response: Host.AidaClient.CompletionResponse): Host.AidaClient.GenerationSample|null {\n    if (!response.generatedSamples.length) {\n      return null;\n    }\n\n    // `currentHint` is the portion of a standard autocomplete suggestion that the user has not yet typed.\n    // For example, if the user types `document.queryS` and the autocomplete suggests `document.querySelector`,\n    // the `currentHint` is `elector`.\n    const currentHintInMenu = this.#editor?.editor.plugin(showCompletionHint)?.currentHint;\n    if (!currentHintInMenu) {\n      return response.generatedSamples[0];\n    }\n\n    // TODO(ergunsh): This does not handle looking for `selectedCompletion`. The `currentHint` is `null`\n    // for the Sources panel case.\n    // Even though there is no match, we still return the first suggestion which will be displayed\n    // when the traditional autocomplete menu is closed.\n    return response.generatedSamples.find(sample => sample.generationString.startsWith(currentHintInMenu)) ??\n        response.generatedSamples[0];\n  }\n\n  #checkIfSuggestionRepeatsExistingText(generationString: string, prefix: string, suffix?: string): boolean {\n    return Boolean(prefix.includes(generationString.trim()) || suffix?.includes(generationString.trim()));\n  }\n\n  /**\n   * Removes the end of a suggestion if it overlaps with the start of the suffix.\n   */\n  #trimSuggestionOverlap(generationString: string, suffix?: string): string {\n    if (!suffix) {\n      return generationString;\n    }\n\n    // Iterate from the longest possible overlap down to the shortest\n    for (let i = Math.min(generationString.length, suffix.length); i > 0; i--) {\n      const overlapCandidate = suffix.substring(0, i);\n      if (generationString.endsWith(overlapCandidate)) {\n        return generationString.slice(0, -i);\n      }\n    }\n    return generationString;\n  }\n}\n\nfunction aiCodeCompletionTeaserExtension(teaser: PanelCommon.AiCodeCompletionTeaser): CodeMirror.Extension {\n  return CodeMirror.ViewPlugin.fromClass(class {\n    teaser: PanelCommon.AiCodeCompletionTeaser;\n    #teaserDecoration: CodeMirror.DecorationSet = CodeMirror.Decoration.none;\n    #teaserMode: AiCodeCompletionTeaserMode;\n    #teaserDisplayTimeout?: number;\n\n    constructor(readonly view: CodeMirror.EditorView) {\n      this.teaser = teaser;\n      this.#teaserMode = view.state.field(aiCodeCompletionTeaserModeState);\n      this.#setupDecoration();\n    }\n\n    destroy(): void {\n      window.clearTimeout(this.#teaserDisplayTimeout);\n    }\n\n    update(update: CodeMirror.ViewUpdate): void {\n      const currentTeaserMode = update.state.field(aiCodeCompletionTeaserModeState);\n      if (currentTeaserMode !== this.#teaserMode) {\n        this.#teaserMode = currentTeaserMode;\n        this.#setupDecoration();\n        return;\n      }\n      if (this.#teaserMode === AiCodeCompletionTeaserMode.ONLY_SHOW_ON_EMPTY && update.docChanged) {\n        this.#updateTeaserDecorationForOnlyShowOnEmptyMode();\n      } else if (this.#teaserMode === AiCodeCompletionTeaserMode.ON) {\n        if (update.docChanged) {\n          this.#teaserDecoration = CodeMirror.Decoration.none;\n          window.clearTimeout(this.#teaserDisplayTimeout);\n          this.#updateTeaserDecorationForOnMode();\n        } else if (update.selectionSet && update.state.doc.length > 0) {\n          this.#teaserDecoration = CodeMirror.Decoration.none;\n        }\n      }\n    }\n\n    get decorations(): CodeMirror.DecorationSet {\n      return this.#teaserDecoration;\n    }\n\n    #setupDecoration(): void {\n      switch (this.#teaserMode) {\n        case AiCodeCompletionTeaserMode.ON:\n          this.#updateTeaserDecorationForOnModeImmediately();\n          return;\n        case AiCodeCompletionTeaserMode.ONLY_SHOW_ON_EMPTY:\n          this.#updateTeaserDecorationForOnlyShowOnEmptyMode();\n          return;\n        case AiCodeCompletionTeaserMode.OFF:\n          this.#teaserDecoration = CodeMirror.Decoration.none;\n          return;\n      }\n    }\n\n    #updateTeaserDecorationForOnlyShowOnEmptyMode(): void {\n      if (this.view.state.doc.length === 0) {\n        this.#addTeaserWidget(0);\n      } else {\n        this.#teaserDecoration = CodeMirror.Decoration.none;\n      }\n    }\n\n    #updateTeaserDecorationForOnMode = Common.Debouncer.debounce(() => {\n      this.#teaserDisplayTimeout = window.setTimeout(() => {\n        this.#updateTeaserDecorationForOnModeImmediately();\n        this.view.dispatch({});\n      }, DELAY_BEFORE_SHOWING_RESPONSE_MS);\n    }, AIDA_REQUEST_DEBOUNCE_TIMEOUT_MS);\n\n    #updateTeaserDecorationForOnModeImmediately(): void {\n      const cursorPosition = this.view.state.selection.main.head;\n      const line = this.view.state.doc.lineAt(cursorPosition);\n      if (cursorPosition >= line.to) {\n        this.#addTeaserWidget(cursorPosition);\n      }\n    }\n\n    #addTeaserWidget(pos: number): void {\n      this.#teaserDecoration = CodeMirror.Decoration.set([\n        CodeMirror.Decoration.widget({widget: new AiCodeCompletionTeaserPlaceholder(this.teaser), side: 1}).range(pos),\n      ]);\n    }\n  }, {\n    decorations: v => v.decorations,\n    eventHandlers: {\n      mousedown(event: MouseEvent): boolean {\n        // Required for mouse click to propagate to the \"Don't show again\" span in teaser.\n        return (event.target instanceof Node && teaser.contentElement.contains(event.target));\n      },\n      keydown(event: KeyboardEvent): boolean {\n        if (!UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlEquivalentKey(event) || !teaser.isShowing()) {\n          return false;\n        }\n        if (event.key === 'i') {\n          event.consume(true);\n          void VisualLogging.logKeyDown(event.currentTarget, event, 'ai-code-completion-teaser.fre');\n          void this.teaser.onAction(event);\n          return true;\n        }\n        if (event.key === 'x') {\n          event.consume(true);\n          void VisualLogging.logKeyDown(event.currentTarget, event, 'ai-code-completion-teaser.dismiss');\n          this.teaser.onDismiss(event);\n          return true;\n        }\n        return false;\n      }\n    },\n  });\n}\n"]}