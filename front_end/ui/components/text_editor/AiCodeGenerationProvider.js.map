{"version":3,"file":"AiCodeGenerationProvider.js","sourceRoot":"","sources":["../../../../../../../front_end/ui/components/text_editor/AiCodeGenerationProvider.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2025 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../core/common/common.js';\nimport * as Host from '../../../core/host/host.js';\nimport * as i18n from '../../../core/i18n/i18n.js';\nimport * as AiCodeGeneration from '../../../models/ai_code_generation/ai_code_generation.js';\nimport * as PanelCommon from '../../../panels/common/common.js';\nimport * as CodeMirror from '../../../third_party/codemirror.next/codemirror.next.js';\nimport * as UI from '../../../ui/legacy/legacy.js';\nimport * as VisualLogging from '../../visual_logging/visual_logging.js';\n\nimport {AiCodeCompletionTeaserPlaceholder} from './AiCodeCompletionTeaserPlaceholder.js';\nimport type {TextEditor} from './TextEditor.js';\n\nexport enum AiCodeGenerationTeaserMode {\n  ACTIVE = 'active',\n  DISMISSED = 'dismissed',\n}\n\nexport const setAiCodeGenerationTeaserMode = CodeMirror.StateEffect.define<AiCodeGenerationTeaserMode>();\n\nconst aiCodeGenerationTeaserModeState = CodeMirror.StateField.define<AiCodeGenerationTeaserMode>({\n  create: () => AiCodeGenerationTeaserMode.ACTIVE,\n  update(value, tr) {\n    return tr.effects.find(effect => effect.is(setAiCodeGenerationTeaserMode))?.value ?? value;\n  },\n});\n\nexport class AiCodeGenerationProvider {\n  #devtoolsLocale: string;\n  #aiCodeCompletionSetting = Common.Settings.Settings.instance().createSetting('ai-code-completion-enabled', false);\n  #generationTeaserCompartment = new CodeMirror.Compartment();\n  #generationTeaser: PanelCommon.AiCodeGenerationTeaser;\n  #editor?: TextEditor;\n\n  #boundOnUpdateAiCodeGenerationState = this.#updateAiCodeGenerationState.bind(this);\n\n  private constructor() {\n    this.#devtoolsLocale = i18n.DevToolsLocale.DevToolsLocale.instance().locale;\n    if (!AiCodeGeneration.AiCodeGeneration.AiCodeGeneration.isAiCodeGenerationEnabled(this.#devtoolsLocale)) {\n      throw new Error('AI code generation feature is not enabled.');\n    }\n    this.#generationTeaser = new PanelCommon.AiCodeGenerationTeaser();\n  }\n\n  static createInstance(): AiCodeGenerationProvider {\n    return new AiCodeGenerationProvider();\n  }\n\n  extension(): CodeMirror.Extension[] {\n    return [\n      CodeMirror.EditorView.updateListener.of(update => this.activateTeaser(update)),\n      aiCodeGenerationTeaserModeState,\n      this.#generationTeaserCompartment.of([]),\n      CodeMirror.Prec.highest(CodeMirror.keymap.of(this.#editorKeymap())),\n    ];\n  }\n\n  dispose(): void {\n    this.#cleanupAiCodeGeneration();\n  }\n\n  editorInitialized(editor: TextEditor): void {\n    this.#editor = editor;\n    Host.AidaClient.HostConfigTracker.instance().addEventListener(\n        Host.AidaClient.Events.AIDA_AVAILABILITY_CHANGED, this.#boundOnUpdateAiCodeGenerationState);\n    this.#aiCodeCompletionSetting.addChangeListener(this.#boundOnUpdateAiCodeGenerationState);\n    void this.#updateAiCodeGenerationState();\n  }\n\n  #setupAiCodeGeneration(): void {\n    this.#editor?.dispatch({\n      effects:\n          [this.#generationTeaserCompartment.reconfigure([aiCodeGenerationTeaserExtension(this.#generationTeaser)])],\n    });\n  }\n\n  #cleanupAiCodeGeneration(): void {\n    this.#editor?.dispatch({\n      effects: [this.#generationTeaserCompartment.reconfigure([])],\n    });\n  }\n\n  async #updateAiCodeGenerationState(): Promise<void> {\n    const aidaAvailability = await Host.AidaClient.AidaClient.checkAccessPreconditions();\n    const isAvailable = aidaAvailability === Host.AidaClient.AidaAccessPreconditions.AVAILABLE;\n    const isEnabled = this.#aiCodeCompletionSetting.get();\n    if (isAvailable && isEnabled) {\n      this.#setupAiCodeGeneration();\n    } else {\n      this.#cleanupAiCodeGeneration();\n    }\n  }\n\n  #editorKeymap(): readonly CodeMirror.KeyBinding[] {\n    return [\n      {\n        key: 'Escape',\n        run: (): boolean => {\n          if (!this.#editor || !this.#generationTeaser.isShowing() || !this.#generationTeaser.loading) {\n            return false;\n          }\n          this.#editor.dispatch({effects: setAiCodeGenerationTeaserMode.of(AiCodeGenerationTeaserMode.DISMISSED)});\n          return true;\n        },\n      },\n      {\n        any: (_view: unknown, event: KeyboardEvent) => {\n          if (!this.#editor || !this.#generationTeaser.isShowing()) {\n            return false;\n          }\n          if (UI.KeyboardShortcut.KeyboardShortcut.eventHasCtrlEquivalentKey(event)) {\n            if (event.key === 'i') {\n              event.consume(true);\n              void VisualLogging.logKeyDown(event.currentTarget, event, 'ai-code-generation.triggered');\n              this.#generationTeaser.loading = true;\n              return true;\n            }\n          }\n          return false;\n        }\n      }\n    ];\n  }\n\n  async activateTeaser(update: CodeMirror.ViewUpdate): Promise<void> {\n    const currentTeaserMode = update.state.field(aiCodeGenerationTeaserModeState);\n    if (currentTeaserMode === AiCodeGenerationTeaserMode.ACTIVE) {\n      return;\n    }\n    if (!update.docChanged && update.state.selection.main.head === update.startState.selection.main.head) {\n      return;\n    }\n    update.view.dispatch({effects: setAiCodeGenerationTeaserMode.of(AiCodeGenerationTeaserMode.ACTIVE)});\n  }\n}\n\n// TODO(b/445899453): Handle teaser's discovery mode\nfunction aiCodeGenerationTeaserExtension(teaser: PanelCommon.AiCodeGenerationTeaser): CodeMirror.Extension {\n  return CodeMirror.ViewPlugin.fromClass(class {\n    #teaserMode: AiCodeGenerationTeaserMode;\n\n    constructor(readonly view: CodeMirror.EditorView) {\n      this.#teaserMode = view.state.field(aiCodeGenerationTeaserModeState);\n    }\n\n    update(update: CodeMirror.ViewUpdate): void {\n      const currentTeaserMode = update.state.field(aiCodeGenerationTeaserModeState);\n      if (currentTeaserMode !== this.#teaserMode) {\n        this.#teaserMode = currentTeaserMode;\n      }\n      if (!update.docChanged && update.state.selection.main.head === update.startState.selection.main.head) {\n        return;\n      }\n      if (teaser.loading) {\n        teaser.loading = false;\n      }\n    }\n\n    get decorations(): CodeMirror.DecorationSet {\n      if (this.#teaserMode === AiCodeGenerationTeaserMode.DISMISSED) {\n        return CodeMirror.Decoration.none;\n      }\n      const cursorPosition = this.view.state.selection.main.head;\n      const line = this.view.state.doc.lineAt(cursorPosition);\n      // TODO(b/445899453): Detect all types of comments\n      const isComment = line.text.startsWith('//');\n      const isCursorAtEndOfLine = cursorPosition >= line.to;\n      if (!isComment || !isCursorAtEndOfLine) {\n        return CodeMirror.Decoration.none;\n      }\n      return CodeMirror.Decoration.set([\n        CodeMirror.Decoration.widget({widget: new AiCodeCompletionTeaserPlaceholder(teaser), side: 1})\n            .range(cursorPosition),\n      ]);\n    }\n  }, {\n    decorations: v => v.decorations,\n  });\n}\n"]}