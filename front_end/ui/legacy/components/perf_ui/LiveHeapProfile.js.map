{"version":3,"file":"LiveHeapProfile.js","sourceRoot":"","sources":["../../../../../../../../front_end/ui/legacy/components/perf_ui/LiveHeapProfile.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2019 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n\nimport * as Common from '../../../../core/common/common.js';\nimport * as Host from '../../../../core/host/host.js';\nimport * as SDK from '../../../../core/sdk/sdk.js';\n\nimport {Memory} from './LineLevelProfile.js';\n\nlet liveHeapProfileInstance: LiveHeapProfile;\nexport class LiveHeapProfile implements Common.Runnable.Runnable,\n                                        SDK.TargetManager.SDKModelObserver<SDK.HeapProfilerModel.HeapProfilerModel> {\n  private running: boolean;\n  private sessionId: number;\n  private loadEventCallback: (arg0?: () => void|null) => void;\n  private readonly setting: Common.Settings.Setting<boolean>;\n\n  private constructor() {\n    this.running = false;\n    this.sessionId = 0;\n    this.loadEventCallback = () => {};\n    this.setting = Common.Settings.Settings.instance().moduleSetting('memory-live-heap-profile');\n    this.setting.addChangeListener(event => event.data ? this.startProfiling() : this.stopProfiling());\n    if (this.setting.get()) {\n      void this.startProfiling();\n    }\n  }\n\n  static instance(opts: {forceNew: boolean|null} = {forceNew: null}): LiveHeapProfile {\n    const {forceNew} = opts;\n    if (!liveHeapProfileInstance || forceNew) {\n      liveHeapProfileInstance = new LiveHeapProfile();\n    }\n\n    return liveHeapProfileInstance;\n  }\n\n  async run(): Promise<void> {\n    return;\n  }\n\n  modelAdded(model: SDK.HeapProfilerModel.HeapProfilerModel): void {\n    void model.startSampling(1e4);\n  }\n\n  modelRemoved(_model: SDK.HeapProfilerModel.HeapProfilerModel): void {\n    // Cannot do much when the model has already been removed.\n  }\n\n  private async startProfiling(): Promise<void> {\n    if (this.running) {\n      return;\n    }\n    this.running = true;\n    const sessionId = this.sessionId;\n    SDK.TargetManager.TargetManager.instance().observeModels(SDK.HeapProfilerModel.HeapProfilerModel, this);\n    SDK.TargetManager.TargetManager.instance().addModelListener(\n        SDK.ResourceTreeModel.ResourceTreeModel, SDK.ResourceTreeModel.Events.Load, this.loadEventFired, this);\n\n    do {\n      const models = SDK.TargetManager.TargetManager.instance().models(SDK.HeapProfilerModel.HeapProfilerModel);\n      const profiles = await Promise.all(models.map(model => model.getSamplingProfile()));\n      if (sessionId !== this.sessionId) {\n        break;\n      }\n      Memory.instance().reset();\n      for (let i = 0; i < profiles.length; ++i) {\n        const profile = profiles[i];\n        if (!profile) {\n          continue;\n        }\n\n        Memory.instance().appendHeapProfile(profile, models[i].target());\n      }\n      await Promise.race([\n        new Promise(r => window.setTimeout(r, Host.InspectorFrontendHost.isUnderTest() ? 10 : 5000)),\n        new Promise(r => {\n          this.loadEventCallback = r;\n        }),\n      ]);\n    } while (sessionId === this.sessionId);\n\n    SDK.TargetManager.TargetManager.instance().unobserveModels(SDK.HeapProfilerModel.HeapProfilerModel, this);\n    SDK.TargetManager.TargetManager.instance().removeModelListener(\n        SDK.ResourceTreeModel.ResourceTreeModel, SDK.ResourceTreeModel.Events.Load, this.loadEventFired, this);\n    for (const model of SDK.TargetManager.TargetManager.instance().models(SDK.HeapProfilerModel.HeapProfilerModel)) {\n      void model.stopSampling();\n    }\n    Memory.instance().reset();\n  }\n\n  private stopProfiling(): void {\n    if (!this.running) {\n      return;\n    }\n    this.running = false;\n    this.sessionId++;\n  }\n\n  private loadEventFired(): void {\n    this.loadEventCallback();\n  }\n}\n"]}