{"version":3,"file":"StreamingContentHexView.js","sourceRoot":"","sources":["../../../../../../../../front_end/ui/legacy/components/source_frame/StreamingContentHexView.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2024 The Chromium Authors\n// Use of this source code is governed by a BSD-style license that can be\n// found in the LICENSE file.\n/* eslint-disable @devtools/no-imperative-dom-api */\n\nimport type * as Common from '../../../../core/common/common.js';\nimport * as TextUtils from '../../../../models/text_utils/text_utils.js';\nimport * as LinearMemoryInspectorComponents from '../../../../panels/linear_memory_inspector/components/components.js';\nimport * as UI from '../../legacy.js';\n\nconst MEMORY_TRANSFER_MIN_CHUNK_SIZE = 1000;\n\n/**\n * This is a slightly reduced version of `panels/LinearMemoryInspectorPane.LinearMemoryInspectorView.\n *\n * It's not hooked up to the LinearMemoryInspectorController and it operates on a fixed memory array thats\n * known upfront.\n */\nclass LinearMemoryInspectorView extends UI.Widget.VBox {\n  #memory: Uint8Array = new Uint8Array([0]);\n  #address = 0;\n  #inspector = new LinearMemoryInspectorComponents.LinearMemoryInspector.LinearMemoryInspector();\n\n  constructor() {\n    super();\n    this.#inspector.addEventListener(\n        LinearMemoryInspectorComponents.LinearMemoryInspector.Events.MEMORY_REQUEST, this.#memoryRequested, this);\n    this.#inspector.addEventListener(\n        LinearMemoryInspectorComponents.LinearMemoryInspector.Events.ADDRESS_CHANGED,\n        (event: Common.EventTarget.EventTargetEvent<number>) => {\n          this.#address = event.data;\n        });\n    this.#inspector.show(this.contentElement);\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n    this.refreshData();\n  }\n\n  setMemory(memory: Uint8Array<ArrayBuffer>): void {\n    this.#memory = memory;\n    this.refreshData();\n  }\n\n  refreshData(): void {\n    // TODO(szuend): The following lines are copied from `LinearMemoryInspectorController`. We can't reuse them\n    // as depending on a module in `panels/` from a component is a layering violation.\n\n    // Provide a chunk of memory that covers the address to show and some before and after\n    // as 1. the address shown is not necessarily at the beginning of a page and\n    // 2. to allow for fewer memory requests.\n    const memoryChunkStart = Math.max(0, this.#address - MEMORY_TRANSFER_MIN_CHUNK_SIZE / 2);\n    const memoryChunkEnd = memoryChunkStart + MEMORY_TRANSFER_MIN_CHUNK_SIZE;\n    const memory = this.#memory.slice(memoryChunkStart, memoryChunkEnd);\n    this.#inspector.memory = memory;\n    this.#inspector.address = this.#address;\n    this.#inspector.memoryOffset = memoryChunkStart;\n    this.#inspector.outerMemoryLength = this.#memory.length;\n    this.#inspector.hideValueInspector = true;\n  }\n\n  #memoryRequested(event: Common.EventTarget.EventTargetEvent<{start: number, end: number, address: number}>): void {\n    // TODO(szuend): The following lines are copied from `LinearMemoryInspectorController`. We can't reuse them\n    // as depending on a module in `panels/` from a component is a layering violation.\n\n    const {start, end, address} = event.data;\n    if (address < start || address >= end) {\n      throw new Error('Requested address is out of bounds.');\n    }\n\n    // Check that the requested start is within bounds.\n    // If the requested end is larger than the actual\n    // memory, it will be automatically capped when\n    // requesting the range.\n    if (start < 0 || start > end || start >= this.#memory.length) {\n      throw new Error('Requested range is out of bounds.');\n    }\n\n    const chunkEnd = Math.max(end, start + MEMORY_TRANSFER_MIN_CHUNK_SIZE);\n    const memory = this.#memory.slice(start, chunkEnd);\n\n    this.#inspector.memory = memory;\n    this.#inspector.address = address;\n    this.#inspector.memoryOffset = start;\n    this.#inspector.outerMemoryLength = this.#memory.length;\n    this.#inspector.hideValueInspector = true;\n  }\n}\n\n/**\n * Adapter for the linear memory inspector that can show a {@link StreamingContentData}.\n */\nexport class StreamingContentHexView extends LinearMemoryInspectorView {\n  readonly #streamingContentData: TextUtils.StreamingContentData.StreamingContentData;\n\n  constructor(streamingContentData: TextUtils.StreamingContentData.StreamingContentData) {\n    super();\n    this.#streamingContentData = streamingContentData;\n  }\n\n  override wasShown(): void {\n    super.wasShown();\n    this.#updateMemoryFromContentData();\n    this.#streamingContentData.addEventListener(\n        TextUtils.StreamingContentData.Events.CHUNK_ADDED, this.#updateMemoryFromContentData, this);\n\n    // No need to call super.wasShown() as we call super.refreshData() ourselves.\n  }\n\n  override willHide(): void {\n    super.willHide();\n    this.#streamingContentData.removeEventListener(\n        TextUtils.StreamingContentData.Events.CHUNK_ADDED, this.#updateMemoryFromContentData, this);\n  }\n\n  #updateMemoryFromContentData(): void {\n    const binaryString = window.atob(this.#streamingContentData.content().base64);\n    const memory = Uint8Array.from(binaryString, m => m.codePointAt(0) as number);\n    this.setMemory(memory);\n  }\n}\n"]}